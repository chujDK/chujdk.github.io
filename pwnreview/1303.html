<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>pwn arm 环境——重型解决方案 - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="写在一个月后：这个用法，说实话没什么用，建议不要这么想，光是虚拟机起一下要近十分钟就已经让人无法接受了，而且有各种各样鸡皮的问题，建议通过手"><meta property="og:image" content><meta property="og:title" content="pwn arm 环境——重型解决方案"><meta property="og:description" content="写在一个月后：这个用法，说实话没什么用，建议不要这么想，光是虚拟机起一下要近十分钟就已经让人无法接受了，而且有各种各样鸡皮的问题，建议通过手"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/pwnreview/1303.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-01T21:54:00+00:00"><meta property="article:modified_time" content="2021-05-01T21:54:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="pwn arm 环境——重型解决方案"><meta name=twitter:description content="写在一个月后：这个用法，说实话没什么用，建议不要这么想，光是虚拟机起一下要近十分钟就已经让人无法接受了，而且有各种各样鸡皮的问题，建议通过手"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>pwn arm 环境——重型解决方案</h1><div class=meta>Posted on May 1, 2021</div></div><section class=body><p><strong>写在一个月后：这个用法，说实话没什么用，建议不要这么想，光是虚拟机起一下要近十分钟就已经让人无法接受了，而且有各种各样鸡皮的问题，建议通过手动编译 qemu 来获得更好的调试体验。可以参考<a href=https://www.cjovi.icu/pwnreview/1353.html>此文</a></strong></p><p>国内的 CTF 比赛参加了两场，两次都是通过更换架构来增加难度，实在是很无力评价。通常的做法是用 qemu 虚拟，然后 gdb remote 上去调，可以参考<a href=https://www.anquanke.com/post/id/199112>这篇文章</a></p><p>但是 gdb-multiarch 的内存分析能力太弱等各种问题，再加上自己水平也比较低，对解题造成了极大影响，我觉得还是有必要到真机调试，但是我没有真机。于是这里考虑使用 qemu 的 system 模式装一台虚拟机出来，然后调试就应该会变得容易许多。</p><p>首先安装 qemu，到<a href=https://www.qemu.org/download/>官网</a>下载对应版本的安装包安装（如果使用的是 Linux 那么可以使用包管理器一键安装，但是由于我的物理机是 Windows，还是考虑在 Windows 下搭建）。</p><p>然后使用 qemu-img 创建映象，这里我选择分配 32G 空间（其实完全不用这么大，在配好调试环境之后也只占用了 2.2G，但是由于我是把映象存到U盘上的，所以大一点问题也不大）。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>qemu-img create ubuntu16.04-arm64.img 32G
</span></span></code></pre></div><p>到<a href=https://releases.linaro.org/components/kernel/uefi-linaro/latest/release/qemu64/QEMU_EFI.fd>这里</a>下载引导固件</p><p>用下面的命令安装</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>qemu-system-aarch64 -m <span style=color:#40a070>2048</span> -cpu cortex-a57 -M virt -bios QEMU_EFI.fd -nographic -drive <span style=color:#007020;font-weight:700>if</span><span style=color:#666>=</span>none,file<span style=color:#666>=</span>ubuntu-16.04.7-server-arm64.iso,id<span style=color:#666>=</span>cdrom,media<span style=color:#666>=</span>cdrom -device virtio-scsi-device  -d evice scsi-cd,drive<span style=color:#666>=</span>cdrom -drive <span style=color:#007020;font-weight:700>if</span><span style=color:#666>=</span>none,file<span style=color:#666>=</span>ubuntu16.04-arm64.img,id<span style=color:#666>=</span>hd0 -device virtio-blk-device,drive<span style=color:#666>=</span>hd0
</span></span></code></pre></div><p>其中 <code>-cpu cortex-a57</code> 是指定 CPU 类型，有如下选择</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Supported guest CPU types:
</span></span><span style=display:flex><span>cortex-a7 (32-bit)
</span></span><span style=display:flex><span>cortex-a15 (32-bit; the default)
</span></span><span style=display:flex><span>cortex-a53 (64-bit)
</span></span><span style=display:flex><span>cortex-a57 (64-bit)
</span></span><span style=display:flex><span>cortex-a72 (64-bit)
</span></span><span style=display:flex><span>host (with KVM only)
</span></span><span style=display:flex><span>max (same as host for KVM; best possible emulation with TCG)
</span></span></code></pre></div><p><code>-M</code> 参数指定机器类型，可以用 <code>qemu-system-aarch64 -machine help</code> 查看支持的类型</p><p>敲下回车就可以起了</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/05/2818194177.png></div><p>一路安装下去就可以了，这里要注意，如果和我一样使用 Windows 做宿主机安装的话，之后的安装界面很有可能充满乱码，基本不影响安装，但是在输入账号密码这些信息的时候，<strong>一定一定要先删光前面的乱码</strong>，否则你就不知道自己的用户名了。安装完成后会重启，这个时候基本不会有特别的问题。进入系统后大致看看就可以关机了（<code>sudo poweroff</code>）。</p><p>之后开机可以使用</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>qemu-system-aarch64 -m <span style=color:#40a070>2048</span> -cpu cortex-a57 -M virt -bios QEMU_EFI.fd -nographic -drive <span style=color:#007020;font-weight:700>if</span><span style=color:#666>=</span>none,file<span style=color:#666>=</span>ubuntu16.04-arm64.img,id<span style=color:#666>=</span>hd0 -device virtio-blk-device,drive<span style=color:#666>=</span>hd0
</span></span></code></pre></div><p>此时会碰到</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/05/473454768.png></div><p>输入 exit，进入 UEFI 管理界面</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/05/267080022.png></div><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/05/1136596909.png></div><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/05/342017813.png></div><p>一路这样选下去，进入这个 <code>NO VOLUME LABEL</code> 后就可以看到一个 EFI 文件夹，一路选下去就可以</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/05/919283268.png></div><p>选择这个，回车一敲就起了。</p><p>这样就完成了系统的安装，之后搭建调试环境和 x86_64 下没什么区别。</p><p>不过要注意换源要换到 arm 架构的源上，比如如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-updates main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-backports main restricted universe multiverse
</span></span><span style=display:flex><span>deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-security main restricted universe multiverse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-proposed main restricted universe multiverse
</span></span><span style=display:flex><span># deb-src https://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/ xenial-proposed main restricted universe multiverse
</span></span></code></pre></div><p>然后就是由于 qemu 也是一个用户态的进程，按一下 ctrl-C 就会直接把整台虚拟机结束掉，一不留神就会关机，而此虚拟机的启动又十分的慢，所以有必要做一个 ssh 服务。但是 qemu 的网络配置比较麻烦，我还不知道怎么实现通信，只能暂时在虚拟机里调了，效果其实也还是不错的。</p><p>这种方法非常的笨重，而且 qemu 的性能损耗也比较大，这也算是无奈之举吧。</p><blockquote><p>主要参考<a href=https://blog.csdn.net/chenxiangneu/article/details/78955462>此文</a>，很好地解决了问题。</p></blockquote></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/nonsense>nonsense</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/jchu95495236 rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 © chuj | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>