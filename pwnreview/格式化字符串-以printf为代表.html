<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>格式化字符串——以printf为代表 - blog of chuj</title><link rel=icon type=image/png href=https://chujdk.github.io/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="span
首先我想说，格式化字符串漏洞，会出现再形如printf(&s);这样的语句中，如果输出的参数等与输入有关，那么，就可能会自然的使用这样的方法，然鹅另一方面，漏洞本身有极高的危险性。"><meta property="og:image" content><meta property="og:url" content="https://chujdk.github.io/pwnreview/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2-%E4%BB%A5printf%E4%B8%BA%E4%BB%A3%E8%A1%A8.html"><meta property="og:site_name" content="blog of chuj"><meta property="og:title" content="格式化字符串——以printf为代表"><meta property="og:description" content="span
首先我想说，格式化字符串漏洞，会出现再形如printf(&amp;s);这样的语句中，如果输出的参数等与输入有关，那么，就可能会自然的使用这样的方法，然鹅另一方面，漏洞本身有极高的危险性。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-14T16:05:00+00:00"><meta property="article:modified_time" content="2020-11-14T16:05:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="格式化字符串——以printf为代表"><meta name=twitter:description content="span
首先我想说，格式化字符串漏洞，会出现再形如printf(&amp;s);这样的语句中，如果输出的参数等与输入有关，那么，就可能会自然的使用这样的方法，然鹅另一方面，漏洞本身有极高的危险性。"><script src=https://chujdk.github.io/js/feather.min.js></script><link href=https://chujdk.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://chujdk.github.io/css/main.d24d3471089d3a4f095edc4a6857e25a9f1c6dd3e7d17026141ccad319438873.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://chujdk.github.io/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://chujdk.github.io/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about.html>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>格式化字符串——以printf为代表</h1><div class=meta>Posted on Nov 14, 2020</div></div><section class=body><p>span</p><p>首先我想说，格式化字符串漏洞，会出现再形如<code>printf(&s);</code>这样的语句中，如果输出的参数等与输入有关，那么，就可能会自然的使用这样的方法，然鹅另一方面，漏洞本身有极高的危险性。</p><h3 id=盲打>盲打</h3><p>即便没有二进制文件，如果确定目标程序中存在格式字符串漏洞，也可以利用此漏洞 leak 出整个程序。不过为了 leak 需要一个进程的基址，如果没开启 pie 的话，很可能就在 0x40000 或者 0x8048000 等位置上，通过 <code>%s</code> 即可一句句 leak 出来。</p><h3>小技巧</h3><ul><li>有些时候，我们需要写入的不是一个较小的值，相反可能非常的大，比如写入地址，这个时候我们可以使用<code>%n$hhn</code>(写一个字节)，<code>%n$hn</code>(写两个字节)来减小输出的字符串长度。当然可供我们输入的字符串可能比较短，这个时候就需要进行取舍。</li></ul><h3>hijack got...</h3><p>通过利用格式化字符串漏洞，我们可以劫持许多东西为我们所用，比如<a href=https://chujdk.github.io/WP/xctf-greeting-150-wp.html>劫持got和fini_array</a></p><h3>格式化占位符</h3><p>格式化字符串中，非常重要的组成部分就是格式化占位符，一般来说我们用它可以像控制台方便地输出变量。</p><p>格式化占位符地语法：%[<em>parameter</em>][<em>flags</em>][<em>field width</em>][.<em>precision</em>][<em>length</em>]<em>type</em></p><p>当然一般来讲许多的pattern都会被忽略（以前打OI的时候）比如输出一个长整型，就是<code>%lld</code>，但是在我们利用这个漏洞的时候，许多pattern就会有自己的特殊用途了，接下来我列举一下他们。</p><h4>[parameter]：</h4><figure class="wp-block-table aligncenter"><table><tbody><tr><td>说明符</td><td>描述</td></tr><tr><td>n$</td><td>n来表示这个格式化占位符应该输出第几个参数，这样一个参数可以被<br>输出多次，而不需要多次提供。这属于POSIX拓展，不属于ISO C</td></tr></tbody></table><figcaption>简单的例子，printf("%2$d,%1$d",a,b);输出的就应该是b,a</figcaption></figure><h4>[flag]</h4><figure class=wp-block-table><table><tbody><tr><td>说明符</td><td>描述</td></tr><tr><td>+</td><td>总是输出有符号数的'+'，'-'号，如果不加，则默认省略正数的'+'</td></tr><tr><td>空格</td><td>若有符号数在输出的时候，若没有正负号或没有输出，则前缀<br>一个空格，如果+说明符存在，则空格说明符将被忽略</td></tr><tr><td>-</td><td>改为左对齐，默认为右对齐</td></tr><tr><td>#</td><td>对于'g'与'G'，不删除尾部0以表示精度。对于'f', 'F', 'e', 'E', 'g',<br>'G', 总是输出小数点。对于'o', 'x', 'X', 在非0数值前分别输出前<br>缀0, 0x, and 0X表示数制。</td></tr><tr><td>0</td><td>如果<em>width</em>选项前缀以<code>0</code>，则在左侧用<code>0</code>填充直至达到宽度要求。<br>例如<code>printf("%2d", 3)</code>输出"<code> 3</code>"，而<code>printf("%02d", 3)</code>输出<br>"<code>03</code>"。如果<code>0</code>与<code>-</code>均出现，则<code>0</code>被忽略，即左对齐依然用空格填充。</td></tr></tbody></table></figure><h4>[field width]</h4><p>输出的最小宽度，如果实际输出没达到此值，则会进行填充</p><h4>[<strong>Precision</strong>]</h4><p>输出的最大长度，依赖于特定的格式化类型。对于d、i、u、x、o的整型数值，是指最小数字位数，不足的位要在左侧补0，如果超过也不截断，缺省值为1。对于a,A,e,E,f,F的浮点数值，是指小数点右边显示的数字位数，必要时四舍五入或补0；缺省值为6。对于g,G的浮点数值，是指<a href=https://zh.wikipedia.org/wiki/%E6%9C%89%E6%95%88%E6%95%B0%E5%AD%97>有效数字</a>的最大位数；缺省值为6。对于s的字符串类型，是指输出的字节的上限，超出限制的其它字符将被截断。如果域宽为<code>*</code>，则由对应的函数参数的值为当前域宽。如果仅给出了小数点，则域宽为0。</p><h4>[length]</h4><p>输出的长度</p><figure class=wp-block-table><table><tbody><tr><th>字符</th><th>描述</th></tr><tr><td><code>hh</code></td><td>对于整数类型，<code>printf</code>期待一个从<code>char</code>提升的<code>int</code>尺寸的整型参数。</td></tr><tr><td><code>h</code></td><td>对于整数类型，<code>printf</code>期待一个从<code>short</code>提升的<code>int</code>尺寸的整型参数。</td></tr><tr><td><code>l</code></td><td>对于整数类型，<code>printf</code>期待一个<code>long</code>尺寸的整型参数。对于浮点类型，<code>printf</code>期待一个<code>double</code>尺寸的整型参数。对于字符串s类型，<code>printf</code>期待一个<code>wchar_t</code>指针参数。对于字符c类型，<code>printf</code>期待一个<code>wint_t</code>型的参数。</td></tr><tr><td><code>ll</code></td><td>对于整数类型，<code>printf</code>期待一个<code>long long</code>尺寸的整型参数。Microsoft也可以使用<code>I64</code>。</td></tr><tr><td><code>L</code></td><td>对于浮点类型，<code>printf</code>期待一个<code>long double</code>尺寸的整型参数。</td></tr><tr><td><code>z</code></td><td>对于整数类型，<code>printf</code>期待一个<code>size_t</code>尺寸的整型参数。</td></tr><tr><td><code>j</code></td><td>对于整数类型，<code>printf</code>期待一个<code>intmax_t</code>尺寸的整型参数。</td></tr><tr><td><code>t</code></td><td>对于整数类型，<code>printf</code>期待一个<code>ptrdiff_t</code>尺寸的整型参数。</td></tr></tbody></table></figure><p>以下为平台相关的选项</p><figure class=wp-block-table><table><tbody><tr><th>字符</th><th>描述</th></tr><tr><td><code>I</code></td><td>对于有符号整数类型，<code>printf</code>期待一个<code>ptrdiff_t</code>尺寸的整型参数。对于无符号整数类型，<code>printf</code>期待一个<code>size_t</code>尺寸的整型参数。<em>常见于Win32/Win64平台。</em></td></tr><tr><td><code>I32</code></td><td>对于整数类型，<code>printf</code>期待一个32位（双字）的整型参数。<em>常见于Win32/Win64平台。</em></td></tr><tr><td><code>I64</code></td><td>对于整数类型，<code>printf</code>期待一个64位（四字）的整型参数。<em>常见于Win32/Win64平台。</em></td></tr><tr><td><code>q</code></td><td>对于整数类型，<code>printf</code>期待一个64位（四字）的整型参数。<em>常见于<a href=https://zh.wikipedia.org/wiki/BSD_UNIX>BSD</a>平台。</em></td></tr></tbody></table></figure><p>ISO C99的头文件<code><a href=https://zh.wikipedia.org/wiki/Inttypes.h>inttypes.h</a></code>包含了许多宏，用于平台独立的<code>printf</code>编码。例如：</p><figure class=wp-block-table><table><tbody><tr><th>宏</th><th>定义</th></tr><tr><td><code>PRId32</code></td><td>典型地等效于<code>I32d</code> (<em>Win32/Win64</em>)或<code>d</code></td></tr><tr><td><code>PRId64</code></td><td>典型地等效于<code>I64d</code> (<em>Win32/Win64</em>), <code>lld</code> (<em>32位平台</em>)或<code>ld</code> (<em>64位平台</em>)</td></tr><tr><td><code>PRIi32</code></td><td>典型地等效于<code>I32i</code> (<em>Win32/Win64</em>)或<code>i</code></td></tr><tr><td><code>PRIi64</code></td><td>典型地等效于<code>I64i</code> (<em>Win32/Win64</em>), <code>lli</code> (<em>32位平台</em>)或<code>li</code> (<em>64位平台</em>)</td></tr><tr><td><code>PRIu32</code></td><td>典型地等效于<code>I32u</code> (<em>Win32/Win64</em>)或<code>u</code></td></tr><tr><td><code>PRIu64</code></td><td>典型地等效于<code>I64u</code> (<em>Win32/Win64</em>), <code>llu</code> (<em>32位平台</em>)或<code>lu</code> (<em>64位平台</em>)</td></tr><tr><td><code>PRIx32</code></td><td>典型地等效于<code>I32x</code> (<em>Win32/Win64</em>)或<code>x</code></td></tr><tr><td><code>PRIx64</code></td><td>典型地等效于<code>I64x</code> (<em>Win32/Win64</em>), <code>llx</code> (<em>32位平台</em>)或<code>lx</code> (<em>64位平台</em>)</td></tr></tbody></table></figure><h4>TYPE</h4><p><strong>Type</strong>，也称转换说明（conversion specification/specifier），可以是：</p><figure class=wp-block-table><table><tbody><tr><th>字符</th><th>描述</th></tr><tr><td><code>d</code>, <code>i</code></td><td>有符号十进制数值<code>int</code>。'<code>%d</code>'与'<code>%i</code>'对于输出是同义；但对于<code><a href=https://zh.wikipedia.org/wiki/Scanf>scanf</a>()</code>输入二者不同，其中<code>%i</code>在输入值有前缀<code>0x</code>或0时，分别表示16进制或8进制的值。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td><code>u</code></td><td>十进制<code>unsigned int</code>。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td><code>f</code>, <code>F</code></td><td><code>double</code>型输出10进制<a href=https://zh.wikipedia.org/wiki/%E5%AE%9A%E9%BB%9E>定点</a>表示。'<code>f</code>'与'<code>F</code>'差异是表示无穷与NaN时，'<code>f</code>'输出'<code>inf</code>', '<code>infinity</code>'与'<code>nan</code>'；'<code>F</code>'输出'<code>INF</code>', '<code>INFINITY</code>'与'<code>NAN</code>'。小数点后的数字位数等于精度，最后一位数字<a href=https://zh.wikipedia.org/wiki/%E5%9B%9B%E8%88%8D%E4%BA%94%E5%85%A5>四舍五入</a>。精度默认为6。如果精度为0且没有#标记，则不出现小数点。小数点左侧至少一位数字。</td></tr><tr><td><code>e</code>, <code>E</code></td><td><code>double</code>值，输出形式为10进制的([<code>-</code>]d.ddd <code>e</code>[<code>+</code>/<code>-</code>]ddd). <code>E</code>版本使用的指数符号为<code>E</code>（而不是<code>e</code>）。指数部分至少包含2位数字，如果值为0，则指数部分为<code>00</code>。Windows系统，指数部分至少为3位数字，例如<code>1.5e002</code>，也可用Microsoft版的运行时函数<code>_set_output_format</code> 修改。小数点前存在1位数字。小数点后的数字位数等于精度。精度默认为6。如果精度为0且没有#标记，则不出现小数点。</td></tr><tr><td><code>g</code>, <code>G</code></td><td><code>double</code>型数值，精度定义为全部有效数字位数。当指数部分在<a href=https://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%BA%E9%97%B4>闭区间</a> [-4,5] 内，输出为定点形式；否则输出为指数浮点形式。'<code>g</code>'使用小写字母，'<code>G</code>'使用大写字母。小数点右侧的尾数0不被显示；显示小数点仅当输出的小数部分不为0。</td></tr><tr><td><code>x</code>, <code>X</code></td><td>16进制<code>unsigned int</code>。'<code>x</code>'使用小写字母；'<code>X</code>'使用大写字母。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td><code>o</code></td><td>8进制<code>unsigned int</code>。如果指定了精度，则输出的数字不足时在左侧补0。默认精度为1。精度为0且值为0，则输出为空。</td></tr><tr><td><code>s</code></td><td>如果没有用l标志，输出<a href="https://zh.wikipedia.org/w/index.php?title=Null%E7%BB%93%E5%B0%BE%E5%AD%97%E7%AC%A6%E4%B8%B2&action=edit&redlink=1">null结尾字符串</a>直到精度规定的上限；如果没有指定精度，则输出所有字节。如果用了l标志，则对应函数参数指向wchar_t型的数组，输出时把每个宽字符转化为多字节字符，相当于调用<code>wcrtomb</code>函数。</td></tr><tr><td><code>c</code></td><td>如果没有用l标志，把int参数转为<code>unsigned char</code>型输出；如果用了l标志，把wint_t参数转为包含两个元素的<code>wchart_t</code>数组，其中第一个元素包含要输出的字符，第二个元素为null宽字符。</td></tr><tr><td><code>p</code></td><td><code>void *</code>型</td></tr><tr><td><code>a</code>, <code>A</code></td><td><code>double</code>型的16进制表示，"[−]0<strong>x</strong>h.hhhh <strong>p</strong>±d"。其中指数部分为10进制表示的形式。例如：1025.0<sub>10</sub>输出为0x1.004000p+10。'<code>a</code>'使用小写字母，'<code>A</code>'使用大写字母。<sup><a href=https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2#cite_note-2>[2]</a></sup><sup><a href=https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2#cite_note-3>[3]</a></sup> （C++11流使用<code>hexfloat</code>输出16进制浮点数）</td></tr><tr><td><code>n</code></td><td>不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。</td></tr><tr><td><code>%</code></td><td>'<code>%</code>'字面值，不接受任何flags, width, precision or length。</td></tr></tbody></table></figure><p>宽度与精度格式化参数可以忽略，或者直接指定，或者用星号"<code>*</code>"表示取对应函数参数的值。例如<code>printf("%*d", 5, 10)</code>输出"<code> 10</code>"；<code>printf("%.*s", 3, "abcdef")</code> 输出"<code>abc</code>"。</p><p>如果函数参数太少，不能匹配所有的格式参数说明符，或者函数参数的类型不匹配，将导致未定义（undefined）行为。过多的函数参数被忽略。许多时候，未定义的行为将导致<a href="https://zh.wikipedia.org/w/index.php?title=%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%94%BB%E5%87%BB&action=edit&redlink=1">格式化字符串攻击</a>。</p><p>某些编译器，如<a href=https://zh.wikipedia.org/wiki/GCC>GCC</a>，会静态检查printf这一类函数的格式化参数并编译警告存在的问题（当使用编译标志<code>-Wall</code>或<code>-Wformat</code>）。GCC也会对用户自定义的printf风格函数做静态检查，如果在函数定义时使用了非标准的 <code>__attribute__((format(...)))</code>。</p><hr class=wp-block-separator><p>上面都是从<a href=https://zh.wikipedia.org/wiki/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2>维基百科</a>上摘录的</p></section><div class=post-tags></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a><a class=soc href=https://chujdk.github.io/index.xml rel=me title=Rss><i data-feather=rss></i></a>
<a class=border></a></div><div class=footer-info>2025 © chuj | Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>