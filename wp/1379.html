<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>PWNABLE.TW-food_store-分析 - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="看了一段时间，暂时还没有找出洞，自己还是太菜了，考虑到题目的逻辑较复杂，结构体也较多，在这里先记录一下，免得到时候忘了。 程序总共有 7 个功能，"><meta property="og:image" content><meta property="og:title" content="PWNABLE.TW-food_store-分析"><meta property="og:description" content="看了一段时间，暂时还没有找出洞，自己还是太菜了，考虑到题目的逻辑较复杂，结构体也较多，在这里先记录一下，免得到时候忘了。 程序总共有 7 个功能，"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1379.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-10T23:09:00+00:00"><meta property="article:modified_time" content="2021-06-10T23:09:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PWNABLE.TW-food_store-分析"><meta name=twitter:description content="看了一段时间，暂时还没有找出洞，自己还是太菜了，考虑到题目的逻辑较复杂，结构体也较多，在这里先记录一下，免得到时候忘了。 程序总共有 7 个功能，"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>PWNABLE.TW-food_store-分析</h1><div class=meta>Posted on Jun 10, 2021</div></div><section class=body><p>看了一段时间，暂时还没有找出洞，自己还是太菜了，考虑到题目的逻辑较复杂，结构体也较多，在这里先记录一下，免得到时候忘了。</p><p>程序总共有 7 个功能，在 main 函数中使用一个 switch 来跳转，简单重命名一下如下</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/844816208.png></div><h3 id=recipe>recipe</h3><p>这个函数又有三个功能</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/3962888461.png></div><h4 id=add_recipe>add_recipe</h4><p>重命名一下如下</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/3601842535.png></div><p>这里面涉及到 recipe 的单向链表结构体，我猜测其结构如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>RECIPE_LIST</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> recipe_name[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>INGREDIENT</span> <span style=color:#666>*</span>Ingredient[<span style=color:#40a070>13</span>];
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>RECIPE_LIST</span> <span style=color:#666>*</span>next;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>其中的 <code>struct INGREDIENT</code> 我猜测其结构为</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>INGREDIENT</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> name[<span style=color:#40a070>32</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> price;
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> ingredient_left;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>也就是每一个 recipe 结构体维护其自己的名字和该菜需要使用的食材（ingredient）。而每个 INGREDIENT 结构体则维护自己的名字、价格和所剩的数量。</p><p>recipe 链表的头指针处于偏移 0x2050D0 处，IDA 分析时发现这个指针是通过处于偏移 0x2050C8 的基址寻址的，而此处又是 recipe_info 的地址，所以把二者合成一个结构体</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>LIST_HEAD</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>Recipe_Info</span> <span style=color:#666>*</span>recipe_info; 
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// 上面命名不是很合适，我后来改成了 struct ALL_INGREDIENT *all_ingredient
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>RECIPE_LIST</span> <span style=color:#666>**</span>recipe_list_head;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>这里的 Recipe_Info 结构体（后来改名为 ALL_INGREDIENT）结构我猜测为</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>Recipe_Info</span> <span style=color:#60a0b0;font-style:italic>// 修改为 ALL_INGREDIENT
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>{
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>INGREDIENT</span> <span style=color:#666>*</span>ingredient[<span style=color:#40a070>10</span>];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>LIST_HEAD 中的 recipe_info（改名为 all_ingredient）维护当前所有的食材和其个数。</p><p>说回到函数本身，这是添加食谱（recipe）的函数，我们可以自定义其食材，然后会被链接到食谱链表的尾部。似乎并没有什么洞。</p><h4 id=remove_recipe>remove_recipe</h4><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/1010995755.png></div><p>这里就是根据菜谱的名字来解链特定的菜谱，然后通过 realloc 来对要被删除的食谱进行 free。</p><h4 id=show_recipe>show_recipe</h4><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/14613948.png></div><p>这里可以打出所有菜谱的名称和其食材的名称，如果可以做到在链表中保留一个被 free 过的 chunk 的话就有可能通过该函数实现 leak。</p><h3 id=assignment>Assignment</h3><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/227333245.png></div><p>这个函数主要做的就是给 NPC 吃东西，NPC 会从食谱中随便选一个食物然后要求我们给他吃，如果我们有对应的食物且选择可以提供，那么就可以给 NPC 吃，且可以增加自己的经验（经验到 100 后就会升级），然后增加级别。最后食物会从食物链表中解链，并通过 realloc 进行 free。</p><p>这里的食物链表结构我猜测如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>FOOD_LIST</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> name[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> price;
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> dummy1;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>__int64</span> energy;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>FOOD_LIST</span> <span style=color:#666>*</span>next;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>FOOD_LIST</span> <span style=color:#666>*</span>prev;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>每一个食物维护自己的名字、价格和能量（能量在后面的 eat 功能中有用），并且通过 next 和 prev 指针维护双向链表。</p><p>好像也没有明显的漏洞</p><h3 id=show_chief_info>show_chief_info</h3><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/2031171667.png></div><p>函数很简单，就是输出厨师的信息，可见一个厨师有三个维度的数值</p><ul><li>level：一些对食材的操作对 level 有要求</li><li>power：做食物（do_cooking）需要消耗 power，可以通过 eat 来补充</li><li>money：买食材需要花钱，通过给 NPC 做饭（Assignment）或卖出食物（sell_food）可以获得钱财</li></ul><h3 id=do_shopping>do_shopping</h3><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/3681398449.png></div><p>这个功能里面也有三个子功能，主要是对食材和食物的操作，可以卖出、购买和制作。</p><h4 id=sell_food>sell_food</h4><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/2116536921.png></div><p>卖出指定食物，获得其 price 的钱，然后解链并 free，好像没什么漏洞</p><h4 id=buy_ingredint>buy_ingredint</h4><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/858456494.png></div><p>购买指定个数个食材，每个食材的个数是由位于偏移 0x205080 处的指针来维护的。</p><h4 id=make_food>make_food</h4><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/2620528855.png></div><p>这个函数让我们制作自己的食材（命名有些不恰当，但是我懒得重传图片了，您知晓就行了），每次制作食材都需要花费 100 块钱。</p><h3 id=do_cooking>do_cooking</h3><p>函数比较长，分两段传。</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/2517129919.png></div><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/138789661.png></div><p>这里就是根据菜谱制作食物，看起来很长但是好像还真没有什么洞..</p><p>到这里就功能就分析完了，无奈的确没有发现什么洞，希望明天可以找到洞 PWN 了。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/wp>wp</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 © chuj | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>