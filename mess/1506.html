<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>PWNABLE.TW-seccomp-tools-分析 - blog of chuj</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="有一段时间没更新博客了，一方面是被这道题卡住，另一方面也是最近比较颓废，基本上每天都在睡觉。这道题感觉已经做不出来了，所以我就把分析放在这里"><meta property="og:image" content><meta property="og:title" content="PWNABLE.TW-seccomp-tools-分析"><meta property="og:description" content="有一段时间没更新博客了，一方面是被这道题卡住，另一方面也是最近比较颓废，基本上每天都在睡觉。这道题感觉已经做不出来了，所以我就把分析放在这里"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/mess/1506.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-30T09:06:00+00:00"><meta property="article:modified_time" content="2021-07-30T09:06:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PWNABLE.TW-seccomp-tools-分析"><meta name=twitter:description content="有一段时间没更新博客了，一方面是被这道题卡住，另一方面也是最近比较颓废，基本上每天都在睡觉。这道题感觉已经做不出来了，所以我就把分析放在这里"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>PWNABLE.TW-seccomp-tools-分析</h1><div class=meta>Posted on Jul 30, 2021</div></div><section class=body><p>有一段时间没更新博客了，一方面是被这道题卡住，另一方面也是最近比较颓废，基本上每天都在睡觉。这道题感觉已经做不出来了，所以我就把分析放在这里，以后看看能不能解掉吧。</p><p>程序的功能为：读取、模拟、加载用户输入的 bpf 代码，其中加载时使用的是 prctl 系统调用，功能号为 PR_GET_SECCOMP。</p><p>与 BPF 相关的知识可以参考 <a href=https://cjovi.icu/pwnreview/1495.html>seccomp 中的 bpf</a></p><p>为了分析方便，根据 cBPF 和 filter 的相关定义，可以建立两个结构体</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>sock_filter</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int16</span> code;
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int8</span> jt;
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int8</span> jf;
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#902000>int</span> k;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>sock_fprog</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int16</span> len;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>sock_filter</span> <span style=color:#666>*</span>filter;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>代码量比较大的是在 emulate 里面，这里实现了一个虚拟机，猜测虚拟机结构体为</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>BPF_VM</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  __u32 syscall_num;
</span></span><span style=display:flex><span>  __u32 magic_num;
</span></span><span style=display:flex><span>  __u64 dummy;
</span></span><span style=display:flex><span>  __u64 argv[<span style=color:#40a070>6</span>];
</span></span><span style=display:flex><span>  __u32 PC;
</span></span><span style=display:flex><span>  __u32 ret_val;
</span></span><span style=display:flex><span>  <span style=color:#902000>int</span> BPF_A;
</span></span><span style=display:flex><span>  __u32 BPF_X;
</span></span><span style=display:flex><span>  __u32 mem[<span style=color:#40a070>16</span>];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>对于其中的各个函数我简单重命名了一下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>void</span> <span style=color:#06287e>emulate</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  __u32 result; <span style=color:#60a0b0;font-style:italic>// eax
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#902000>int</span> i; <span style=color:#60a0b0;font-style:italic>// [rsp+Ch] [rbp-14h]
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>BPF_VM</span> <span style=color:#666>*</span>VM; <span style=color:#60a0b0;font-style:italic>// [rsp+18h] [rbp-8h]
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( <span style=color:#666>!</span>bpf_bytes_len )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    puts(<span style=color:#4070a0>&#34;Create a rule first&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  VM <span style=color:#666>=</span> (<span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>BPF_VM</span> <span style=color:#666>*</span>)malloc(<span style=color:#40a070>0x90uLL</span>);
</span></span><span style=display:flex><span>  init_filter_prog(VM);
</span></span><span style=display:flex><span>  printf(<span style=color:#4070a0>&#34;syscall number? &#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( scanf(<span style=color:#4070a0>&#34;%d&#34;</span>, VM) <span style=color:#666>!=</span> <span style=color:#40a070>1</span> )
</span></span><span style=display:flex><span>    exit(<span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>  printf(<span style=color:#4070a0>&#34;arguments? &#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>for</span> ( i <span style=color:#666>=</span> <span style=color:#40a070>0</span>; i <span style=color:#666>&lt;=</span> <span style=color:#40a070>5</span>; <span style=color:#666>++</span>i )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( scanf(<span style=color:#4070a0>&#34;%llu&#34;</span>, <span style=color:#666>&amp;</span>VM<span style=color:#666>-&gt;</span>argv[i]) <span style=color:#666>!=</span> <span style=color:#40a070>1</span> )
</span></span><span style=display:flex><span>      exit(<span style=color:#40a070>1</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>while</span> ( (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int8</span>)run_vm(VM) )
</span></span><span style=display:flex><span>    ;
</span></span><span style=display:flex><span>  result <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>ret_val <span style=color:#666>&amp;</span> <span style=color:#40a070>0x7FFF0000</span>;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( result <span style=color:#666>==</span> <span style=color:#40a070>0x50000</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    printf(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>Result: %s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, <span style=color:#4070a0>&#34;ERRNO&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>else</span> <span style=color:#007020;font-weight:700>if</span> ( result <span style=color:#666>&gt;</span> <span style=color:#40a070>0x50000</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( result <span style=color:#666>==</span> <span style=color:#40a070>0x7FF00000</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      printf(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>Result: %s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, <span style=color:#4070a0>&#34;TRACE&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( result <span style=color:#666>!=</span> <span style=color:#40a070>0x7FFF0000</span> )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span><span style=color:#002070;font-weight:700>LABEL_24</span>:
</span></span><span style=display:flex><span>        printf(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>Result: %s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, <span style=color:#4070a0>&#34;KILL&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>goto</span> LABEL_25;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      printf(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>Result: %s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, <span style=color:#4070a0>&#34;ALLOW&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> ( <span style=color:#666>!</span>result <span style=color:#666>||</span> result <span style=color:#666>!=</span> <span style=color:#40a070>0x30000</span> )
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>goto</span> LABEL_24;
</span></span><span style=display:flex><span>    printf(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>Result: %s</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, <span style=color:#4070a0>&#34;TRAP&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span><span style=color:#002070;font-weight:700>LABEL_25</span>:
</span></span><span style=display:flex><span>  free(VM);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>__int64</span> <span style=color:#007020;font-weight:700>__fastcall</span> <span style=color:#06287e>run_vm</span>(<span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>BPF_VM</span> <span style=color:#666>*</span>VM)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int16</span> last_PC; <span style=color:#60a0b0;font-style:italic>// [rsp+1Ch] [rbp-4h]
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>  last_PC <span style=color:#666>=</span> <span style=color:#40a070>8</span> <span style=color:#666>*</span> VM<span style=color:#666>-&gt;</span>PC;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( last_PC <span style=color:#666>&gt;=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int16</span>)bpf_bytes_len )
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#40a070>0LL</span>;
</span></span><span style=display:flex><span>  emulate_one_insn(<span style=color:#666>&amp;</span>bpf_code_arr[last_PC <span style=color:#666>/</span> <span style=color:#40a070>8u</span>], VM);
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( VM<span style=color:#666>-&gt;</span>PC <span style=color:#666>==</span> <span style=color:#666>-</span><span style=color:#40a070>1</span> )                           <span style=color:#60a0b0;font-style:italic>// ret
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#40a070>0LL</span>;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>if</span> ( (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int16</span>)(<span style=color:#40a070>8</span> <span style=color:#666>*</span> VM<span style=color:#666>-&gt;</span>PC) <span style=color:#666>&gt;</span> last_PC )<span style=color:#60a0b0;font-style:italic>// move forward?
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#40a070>1LL</span>;
</span></span><span style=display:flex><span>  puts(<span style=color:#4070a0>&#34;Loop detected&#34;</span>);                        <span style=color:#60a0b0;font-style:italic>// moved back, err
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>return</span> <span style=color:#40a070>0LL</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span> <span style=color:#007020;font-weight:700>__fastcall</span> <span style=color:#06287e>emulate_one_insn</span>(<span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>sock_filter</span> <span style=color:#666>*</span>insn, <span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>BPF_VM</span> <span style=color:#666>*</span>VM)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span> result; <span style=color:#60a0b0;font-style:italic>// rax
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  __u32 v3; <span style=color:#60a0b0;font-style:italic>// edx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  __u32 v4; <span style=color:#60a0b0;font-style:italic>// edx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  __u32 idx; <span style=color:#60a0b0;font-style:italic>// ecx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  __u32 <span style=color:#666>*</span>v6; <span style=color:#60a0b0;font-style:italic>// rax
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  __u32 <span style=color:#666>*</span>v7; <span style=color:#60a0b0;font-style:italic>// rax
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#902000>int</span> jump_n; <span style=color:#60a0b0;font-style:italic>// eax
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  __u32 PC_next; <span style=color:#60a0b0;font-style:italic>// edx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#902000>bool</span> flag; <span style=color:#60a0b0;font-style:italic>// [rsp+17h] [rbp-19h]
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  __u32 <span style=color:#666>*</span>reg_ptr; <span style=color:#60a0b0;font-style:italic>// [rsp+18h] [rbp-18h] MAPDST
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>  bpf_decode(insn);
</span></span><span style=display:flex><span>  result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span>)BPF_CLASS;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>switch</span> ( BPF_CLASS )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_LD or BPF_LDX
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#666>++</span>VM<span style=color:#666>-&gt;</span>PC;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp )
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)<span style=color:#666>&amp;</span>VM<span style=color:#666>-&gt;</span>BPF_X;  <span style=color:#60a0b0;font-style:italic>// LDX store to X
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)<span style=color:#666>&amp;</span>VM<span style=color:#666>-&gt;</span>BPF_A;  <span style=color:#60a0b0;font-style:italic>// LD  store to A
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      reg_ptr <span style=color:#666>=</span> (__u32 <span style=color:#666>*</span>)result;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_MODE )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> ( BPF_MODE <span style=color:#666>==</span> <span style=color:#40a070>0x60</span> )                 <span style=color:#60a0b0;font-style:italic>// BPF_MEM
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        {
</span></span><span style=display:flex><span>          v3 <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>mem[ret_val_in_interval(BPF_GENERAL, <span style=color:#40a070>0</span>, <span style=color:#40a070>0xFu</span>)];<span style=color:#60a0b0;font-style:italic>// BPF_GENERAL -&gt; idx
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>          result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)reg_ptr;
</span></span><span style=display:flex><span>          <span style=color:#666>*</span>reg_ptr <span style=color:#666>=</span> v3;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          result <span style=color:#666>=</span> BPF_MODE;
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>if</span> ( BPF_MODE <span style=color:#666>==</span> <span style=color:#40a070>0x20</span> )               <span style=color:#60a0b0;font-style:italic>// BPF_ABS
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>          {
</span></span><span style=display:flex><span>            v4 <span style=color:#666>=</span> <span style=color:#666>*</span>(<span style=color:#666>&amp;</span>VM<span style=color:#666>-&gt;</span>syscall_num <span style=color:#666>+</span> ret_val_in_interval(BPF_GENERAL <span style=color:#666>&gt;&gt;</span> <span style=color:#40a070>2</span>, <span style=color:#40a070>0</span>, <span style=color:#40a070>0xFu</span>));
</span></span><span style=display:flex><span>            result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)reg_ptr;
</span></span><span style=display:flex><span>            <span style=color:#666>*</span>reg_ptr <span style=color:#666>=</span> v4;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#666>*</span>(_DWORD <span style=color:#666>*</span>)result <span style=color:#666>=</span> BPF_GENERAL;        <span style=color:#60a0b0;font-style:italic>// BPF_IMM
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      }
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>2</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_ST or BPF_STX
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#666>++</span>VM<span style=color:#666>-&gt;</span>PC;
</span></span><span style=display:flex><span>      idx <span style=color:#666>=</span> ret_val_in_interval(BPF_MODE, <span style=color:#40a070>0</span>, <span style=color:#40a070>0xFu</span>);
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp )
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>BPF_X;                     <span style=color:#60a0b0;font-style:italic>// STX
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span>)VM<span style=color:#666>-&gt;</span>BPF_A;       <span style=color:#60a0b0;font-style:italic>// ST
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      VM<span style=color:#666>-&gt;</span>mem[idx] <span style=color:#666>=</span> result;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>4</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_ALU
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#666>++</span>VM<span style=color:#666>-&gt;</span>PC;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp <span style=color:#666>==</span> <span style=color:#40a070>0x80</span> )                    <span style=color:#60a0b0;font-style:italic>// BPF_NEG
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      {
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>        VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>=</span> <span style=color:#666>-</span>VM<span style=color:#666>-&gt;</span>BPF_A;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> ( BPF_MODE )
</span></span><span style=display:flex><span>          v6 <span style=color:#666>=</span> <span style=color:#666>&amp;</span>VM<span style=color:#666>-&gt;</span>BPF_X;
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>          v6 <span style=color:#666>=</span> <span style=color:#666>&amp;</span>insn<span style=color:#666>-&gt;</span>k;
</span></span><span style=display:flex><span>        reg_ptr <span style=color:#666>=</span> v6;
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>switch</span> ( BPF_tmp )                    <span style=color:#60a0b0;font-style:italic>// calc
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>          {
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x10</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>              VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>-=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x20</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>              VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>*=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x30</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>              VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>/=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x40</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>              VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>|=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x50</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>              VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>&amp;=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x60</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>              VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>&lt;&lt;=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x70</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>              VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span>)VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>&gt;&gt;</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#007020;font-weight:700>default</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>              result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span>)BPF_tmp;
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp <span style=color:#666>==</span> <span style=color:#40a070>0xA0</span> )
</span></span><span style=display:flex><span>              {
</span></span><span style=display:flex><span>                result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>                VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>^=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>              }
</span></span><span style=display:flex><span>              <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>          VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>+=</span> <span style=color:#666>*</span>reg_ptr;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>5</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_JMP
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#666>++</span>VM<span style=color:#666>-&gt;</span>PC;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_MODE )
</span></span><span style=display:flex><span>        v7 <span style=color:#666>=</span> <span style=color:#666>&amp;</span>VM<span style=color:#666>-&gt;</span>BPF_X;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        v7 <span style=color:#666>=</span> <span style=color:#666>&amp;</span>insn<span style=color:#666>-&gt;</span>k;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp )
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>switch</span> ( BPF_tmp )
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x20</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>            flag <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>&gt;</span> <span style=color:#666>*</span>v7;             <span style=color:#60a0b0;font-style:italic>// jump above
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>            <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x30</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>            flag <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>&gt;=</span> <span style=color:#666>*</span>v7;            <span style=color:#60a0b0;font-style:italic>// jump above equal
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>            <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x10</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>            flag <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>==</span> <span style=color:#666>*</span>v7;            <span style=color:#60a0b0;font-style:italic>// jump equal
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>            <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>          <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0x40</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>            flag <span style=color:#666>=</span> (VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>&amp;</span> <span style=color:#666>*</span>v7) <span style=color:#666>!=</span> <span style=color:#40a070>0</span>;      <span style=color:#60a0b0;font-style:italic>// JSET
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>            <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>if</span> ( flag )
</span></span><span style=display:flex><span>          jump_n <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>jt;
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>          jump_n <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>jf;
</span></span><span style=display:flex><span>        PC_next <span style=color:#666>=</span> jump_n <span style=color:#666>+</span> VM<span style=color:#666>-&gt;</span>PC;
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>        VM<span style=color:#666>-&gt;</span>PC <span style=color:#666>=</span> PC_next;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;          <span style=color:#60a0b0;font-style:italic>// always jump
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        VM<span style=color:#666>-&gt;</span>PC <span style=color:#666>+=</span> insn<span style=color:#666>-&gt;</span>k;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>6</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_RET
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      VM<span style=color:#666>-&gt;</span>PC <span style=color:#666>=</span> <span style=color:#666>-</span><span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>      result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp <span style=color:#666>&gt;=</span> <span style=color:#40a070>0</span> )
</span></span><span style=display:flex><span>        VM<span style=color:#666>-&gt;</span>ret_val <span style=color:#666>=</span> BPF_tmp;                  <span style=color:#60a0b0;font-style:italic>// BPF_RET + BPF_else, k; ret k
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        VM<span style=color:#666>-&gt;</span>ret_val <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>BPF_A;                <span style=color:#60a0b0;font-style:italic>// BPF_RET + BPF_A
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>7</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_MISC
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#666>++</span>VM<span style=color:#666>-&gt;</span>PC;
</span></span><span style=display:flex><span>      result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#007020;font-weight:700>__int64</span>)VM;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>if</span> ( BPF_tmp )
</span></span><span style=display:flex><span>        VM<span style=color:#666>-&gt;</span>BPF_A <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>BPF_X;                  <span style=color:#60a0b0;font-style:italic>// BPF_MISC + 0x80
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        VM<span style=color:#666>-&gt;</span>BPF_X <span style=color:#666>=</span> VM<span style=color:#666>-&gt;</span>BPF_A;                  <span style=color:#60a0b0;font-style:italic>// BPF_MISC + 0x00
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>default</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#007020;font-weight:700>__int64</span> <span style=color:#007020;font-weight:700>__fastcall</span> <span style=color:#06287e>bpf_decode</span>(<span style=color:#007020;font-weight:700>struct</span> <span style=color:#0e84b5;font-weight:700>sock_filter</span> <span style=color:#666>*</span>insn)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>__int64</span> result; <span style=color:#60a0b0;font-style:italic>// rax
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>  BPF_CLASS <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>7</span>;                   <span style=color:#60a0b0;font-style:italic>// get instruction classes
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>  result <span style=color:#666>=</span> (<span style=color:#902000>unsigned</span> <span style=color:#902000>int</span>)BPF_CLASS;
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>switch</span> ( BPF_CLASS )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>0</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_LD
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>1</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_LDX
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      BPF_tmp <span style=color:#666>=</span> BPF_CLASS <span style=color:#666>==</span> <span style=color:#40a070>1</span>;
</span></span><span style=display:flex><span>      BPF_CLASS <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>      BPF_MODE <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>0xE0</span>;             <span style=color:#60a0b0;font-style:italic>// get instruction mode
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      result <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>k;
</span></span><span style=display:flex><span>      BPF_GENERAL <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>k;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>2</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_ST
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>3</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_STX
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      BPF_tmp <span style=color:#666>=</span> BPF_CLASS <span style=color:#666>==</span> <span style=color:#40a070>3</span>;
</span></span><span style=display:flex><span>      BPF_CLASS <span style=color:#666>=</span> <span style=color:#40a070>2</span>;
</span></span><span style=display:flex><span>      result <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>k;
</span></span><span style=display:flex><span>      BPF_MODE <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>k;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>4</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_ALU
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      BPF_tmp <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>0xF0</span>;
</span></span><span style=display:flex><span>      result <span style=color:#666>=</span> (insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>8</span>) <span style=color:#666>!=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>      BPF_MODE <span style=color:#666>=</span> (insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>8</span>) <span style=color:#666>!=</span> <span style=color:#40a070>0</span>;         <span style=color:#60a0b0;font-style:italic>// get reg
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>5</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_JMP
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      BPF_tmp <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>0x70</span>;
</span></span><span style=display:flex><span>      result <span style=color:#666>=</span> (insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>8</span>) <span style=color:#666>!=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>      BPF_MODE <span style=color:#666>=</span> (insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>8</span>) <span style=color:#666>!=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>6</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_RET
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>if</span> ( (insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>0x18</span>) <span style=color:#666>==</span> <span style=color:#40a070>0x10</span> )
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> <span style=color:#40a070>0xFFFFFFFFLL</span>;                  <span style=color:#60a0b0;font-style:italic>// BPF_RET + BPF_A
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>        result <span style=color:#666>=</span> insn<span style=color:#666>-&gt;</span>k;                       <span style=color:#60a0b0;font-style:italic>// BPF_RET + else
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      BPF_tmp <span style=color:#666>=</span> result;                         <span style=color:#60a0b0;font-style:italic>// ret k
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>case</span> <span style=color:#40a070>7</span><span style=color:#666>:</span>                                     <span style=color:#60a0b0;font-style:italic>// BPF_MISC
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>      result <span style=color:#666>=</span> (insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>0x80</span>) <span style=color:#666>!=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>      BPF_tmp <span style=color:#666>=</span> (insn<span style=color:#666>-&gt;</span>code <span style=color:#666>&amp;</span> <span style=color:#40a070>0x80</span>) <span style=color:#666>!=</span> <span style=color:#40a070>0</span>;
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>default</span><span style=color:#666>:</span>
</span></span><span style=display:flex><span>      <span style=color:#007020;font-weight:700>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#007020;font-weight:700>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>简单地分析了一下虚拟机的实现，只发现 Loop 检测有问题，跳转到负数是可以的，但是似乎没啥用。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/nonsense>nonsense</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/jchu95495236 rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>