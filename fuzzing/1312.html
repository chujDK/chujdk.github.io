<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>AFL学习记录（四）——使用 LAVA-M/BASE64 测试集进行表现测试 - blog of chuj</title><link rel=icon type=image/png href=https://www.cjovi.icu/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="这个测试本来我应该在一个月前完成，但是由于各种各样的原因拖到了现在哈哈哈。 之前一直因为无法完成插桩编译，所以只能用 qemu 模式来整，这个模式就会慢"><meta property="og:image" content><meta property="og:title" content="AFL学习记录（四）——使用 LAVA-M/BASE64 测试集进行表现测试"><meta property="og:description" content="这个测试本来我应该在一个月前完成，但是由于各种各样的原因拖到了现在哈哈哈。 之前一直因为无法完成插桩编译，所以只能用 qemu 模式来整，这个模式就会慢"><meta property="og:type" content="article"><meta property="og:url" content="https://www.cjovi.icu/fuzzing/1312.html"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-06T16:42:00+00:00"><meta property="article:modified_time" content="2021-05-06T16:42:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="AFL学习记录（四）——使用 LAVA-M/BASE64 测试集进行表现测试"><meta name=twitter:description content="这个测试本来我应该在一个月前完成，但是由于各种各样的原因拖到了现在哈哈哈。 之前一直因为无法完成插桩编译，所以只能用 qemu 模式来整，这个模式就会慢"><script src=https://www.cjovi.icu/js/feather.min.js></script>
<link href=https://www.cjovi.icu/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.cjovi.icu/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})})</script><link rel=stylesheet type=text/css href=https://www.cjovi.icu/css/font.e98a2c89163f90d6fa6d8baf5a50a6561f8ff3d0be1551265f364d138d75df33.css></head><body><div class=content><header><div class=main><a href=https://www.cjovi.icu/>blog of chuj</a></div><nav><a href=/>Home</a>
<a href=/posts.html>All posts</a>
<a href=/about.html>About</a>
<a href=/tags.html>Tags</a></nav></header><main><article><div class=title><h1 class=title>AFL学习记录（四）——使用 LAVA-M/BASE64 测试集进行表现测试</h1><div class=meta>Posted on May 6, 2021</div></div><section class=body><p>这个测试本来我应该在一个月前完成，但是由于各种各样的原因拖到了现在哈哈哈。</p><p>之前一直因为无法完成插桩编译，所以只能用 qemu 模式来整，这个模式就会慢很多了，我用了 6 个线程跑了两个多小时什么都没跑出来，遂放弃。今天灵光一闪，自己手动编译了一下，不知道为什么就完成了插桩编译。然后也发现了之前跑不出结果的原因——没加 <code>-d</code> 参数（哈哈哈也是很呆了）。这里简单记录一下测试过程。</p><h3 id=插桩编译>插桩编译</h3><p>这里我使用 <a href=https://github.com/google/AFL>Google 维护的 AFL</a> 并使用 LLVM 模式进行测试。</p><p>首先安装 libacl</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get install libacl1-dev
</span></span></code></pre></div><p>然后下载测试集 <code>wget http://panda.moyix.net/~moyix/lava_corpus.tar.xz</code>，然后解压</p><p>进入 <code>lava_corpus/LAVA-M/base64/coreutils-8.24-lava-safe</code> 目录，依次执行如下指令</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#bb60d5>CC</span><span style=color:#666>=</span>afl-clang-fast <span style=color:#bb60d5>CXX</span><span style=color:#666>=</span>afl-clang-fast++ ./configure --prefix<span style=color:#666>=</span><span style=color:#4070a0>`</span><span style=color:#007020>pwd</span><span style=color:#4070a0>`</span>/lava-install <span style=color:#bb60d5>LIBS</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;-lacl&#34;</span>
</span></span></code></pre></div><p>注意这里使用 <code>pwd</code> 可能会报错，如果报错手动换成当前目录路径就可以了。</p><p>然后 make</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make -j <span style=color:#007020;font-weight:700>$(</span>nproc<span style=color:#007020;font-weight:700>)</span>
</span></span></code></pre></div><p>这里的 <code>$(nproc)</code> 是你的机器的线程数，多线程编译可以加快编译速度。</p><p>再安装</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>make install
</span></span></code></pre></div><p>在 make 和 make install 的过程中可能会出现各种依赖错误，仔细看报错信息都可以解决。</p><h3 id=检测>检测</h3><p>编译好后可以使用在 <code>lava_corpus/LAVA-M/base64/</code> 目录中的 validate.sh 检测编译出的程序是否被插入 bug，注意要先把该脚本中的编译代码注释掉，如下</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#007020>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#007020></span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>PROG</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;base64&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>PROGOPT</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;-d&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>INPUT_PATTERN</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;inputs/utmp-fuzzed-%s.b64&#34;</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>INPUT_CLEAN</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;inputs/utmp.b64&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#echo &#34;Building buggy ${PROG}...&#34;</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#cd coreutils-8.24-lava-safe</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#make clean &amp;&gt; /dev/null</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#./configure --prefix=`pwd`/lava-install LIBS=&#34;-lacl&#34; &amp;&gt; /dev/null</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#make -j $(nproc) &amp;&gt; /dev/null</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#make install &amp;&gt; /dev/null</span>
</span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>#cd ..</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;Checking if buggy </span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROG</span><span style=color:#70a0d0>}</span><span style=color:#4070a0> succeeds on non-trigger input...&#34;</span>
</span></span><span style=display:flex><span>./coreutils-8.24-lava-safe/lava-install/bin/<span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROG</span><span style=color:#70a0d0>}</span> <span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROGOPT</span><span style=color:#70a0d0>}</span> <span style=color:#70a0d0>${</span><span style=color:#bb60d5>INPUT_CLEAN</span><span style=color:#70a0d0>}</span> &amp;&gt; /dev/null 
</span></span><span style=display:flex><span><span style=color:#bb60d5>rv</span><span style=color:#666>=</span><span style=color:#bb60d5>$?</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>if</span> <span style=color:#666>[</span> <span style=color:#bb60d5>$rv</span> -lt <span style=color:#40a070>128</span> <span style=color:#666>]</span>; <span style=color:#007020;font-weight:700>then</span>
</span></span><span style=display:flex><span>    <span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;Success: </span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROG</span><span style=color:#70a0d0>}</span><span style=color:#4070a0> </span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROGOPT</span><span style=color:#70a0d0>}</span><span style=color:#4070a0> </span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>INPUT_CLEAN</span><span style=color:#70a0d0>}</span><span style=color:#4070a0> returned </span><span style=color:#bb60d5>$rv</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>else</span>
</span></span><span style=display:flex><span>    <span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;ERROR: </span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROG</span><span style=color:#70a0d0>}</span><span style=color:#4070a0> </span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROGOPT</span><span style=color:#70a0d0>}</span><span style=color:#4070a0> </span><span style=color:#70a0d0>${</span><span style=color:#bb60d5>INPUT_CLEAN</span><span style=color:#70a0d0>}</span><span style=color:#4070a0> returned </span><span style=color:#bb60d5>$rv</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;Validating bugs...&#34;</span>
</span></span><span style=display:flex><span>cat validated_bugs | <span style=color:#007020;font-weight:700>while</span> <span style=color:#007020>read</span> line ; <span style=color:#007020;font-weight:700>do</span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>INPUT_FUZZ</span><span style=color:#666>=</span><span style=color:#007020;font-weight:700>$(</span><span style=color:#007020>printf</span> <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$INPUT_PATTERN</span><span style=color:#4070a0>&#34;</span> <span style=color:#bb60d5>$line</span><span style=color:#007020;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#666>{</span> ./coreutils-8.24-lava-safe/lava-install/bin/<span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROG</span><span style=color:#70a0d0>}</span> <span style=color:#70a0d0>${</span><span style=color:#bb60d5>PROGOPT</span><span style=color:#70a0d0>}</span> <span style=color:#70a0d0>${</span><span style=color:#bb60d5>INPUT_FUZZ</span><span style=color:#70a0d0>}</span> ; <span style=color:#666>}</span> &amp;&gt; /dev/null
</span></span><span style=display:flex><span>    <span style=color:#007020>echo</span> <span style=color:#bb60d5>$line</span> <span style=color:#bb60d5>$?</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>done</span> &gt; validated.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>awk <span style=color:#4070a0>&#39;BEGIN {valid = 0} $2 &gt; 128 { valid += 1 } END { print &#34;Validated&#34;, valid, &#34;/&#34;, NR, &#34;bugs&#34; }&#39;</span> validated.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;You can see validated.txt for the exit code of each buggy version.&#34;</span>
</span></span></code></pre></div><p>我跑了一下发现只有 43 个 bug，少一个问题也不是很大。</p><h3 id=fuzzing>fuzzing</h3><p>然后用 afl-fuzz 测试就可以了。</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>afl-fuzz -i ./fuzzer_input -o fuzzer_output ./base64 -d @@
</span></span></code></pre></div><p>一定要注意这里的 <code>-d</code>，不写这个的话是基本上是跑不出来的（确定有的 bug 是在 -d 模式下的）。</p><h3 id=结果>结果</h3><div style=text-align:center><img src=https://www.cjovi.icu/usr/uploads/2021/05/98844576.png></div><p>使用一个线程进行了一个多小时的测试，总共仅跑出了 5 个 unique crash，其中还有一个实际是重复的。最后发现了 1，774，792，804 四个漏洞。</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/fuzzing>fuzzing</a></li><li><a href=/tags/afl>AFl</a></li></ul></nav></div><script src=https://giscus.app/client.js data-repo=chujDK/chujdk.github.io data-repo-id=R_kgDOI__mNg data-category=Announcements data-category-id=DIC_kwDOI__mNs4CYoyP data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN data-loading=lazy crossorigin=anonymous async></script></article></main><footer><div style=display:flex><a class=soc href=https://github.com/chujDK rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/chujdk rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a></div><div class=footer-info>2023 © chuj | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>